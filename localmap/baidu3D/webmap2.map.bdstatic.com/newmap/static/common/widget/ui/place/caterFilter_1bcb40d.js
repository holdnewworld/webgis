define("common:widget/ui/place/caterFilter.js",function(require,exports,module){var COM_TAG="cater-common-tag",place=window.place||{};place.cater=place.cater||{};var caterFilterTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div id="caterFilter">    <ul class="toolbar clearfix">        '),curFilterObj.isnbSearch?_template_fun_array.push('        <li class="tool-item city-item hide" data-type="city-panel">            <label>',"undefined"==typeof(curFilterObj.defArea||"所有地区")?"":curFilterObj.defArea||"所有地区",'</label>            <i class="icon-cater arrow"></i>        </li>        '):_template_fun_array.push('        <li class="tool-item city-item" data-type="city-panel">            <label>',"undefined"==typeof(curFilterObj.defArea||"所有地区")?"":curFilterObj.defArea||"所有地区",'</label>            <i class="icon-cater arrow"></i>        </li>        '),_template_fun_array.push('        <li class="tool-item tag-item botn-line" data-type="tag-panel">            <label>',"undefined"==typeof(curFilterObj.defTag||"所有餐厅")?"":curFilterObj.defTag||"所有餐厅",'</label>            <i class="icon-cater arrow"></i>        </li>        <li class="tool-item sort-item" data-type="sort-panel">            <label>',"undefined"==typeof(curFilterObj.defSort||"默认排序")?"":curFilterObj.defSort||"默认排序",'</label>            <i class="icon-cater arrow"></i>        </li>    </ul>    <div class="place-filter-cb">        <!--<a class="placeFilter ',"undefined"==typeof curFilterObj.defPremium?"":curFilterObj.defPremium,'" data-type="premium" href="javascript:void(0);">            <em class="checkbox"></em><span>有优惠</span>        </a>        -->        <a class="placeFilter ',"undefined"==typeof curFilterObj.defGroupon?"":curFilterObj.defGroupon,'" data-type="groupon" href="javascript:void(0);">            <em class="checkbox"></em><span>正在团购</span>            <img src="',"undefined"==typeof hotImg?"":hotImg,'">        </a><!--         <a class="placeFilter ',"undefined"==typeof curFilterObj.defBook?"":curFilterObj.defBook,'" data-type="book" href="javascript:void(0);">            <em class="checkbox"></em><span>在线订座</span>        </a> -->    </div>    <div class="select-panel-city clearfix">        <div class="hd-list-wrap">            <ul class="areaList hd-list">            </ul>        </div>            <ul class="bdList bd-list">            </ul>        </div>        <div class="select-panel-tag">            ');for(var i=0;i<tagFilter.value.length;i++){_template_fun_array.push('            <dl class="clearfix">                <dt>                    '),_template_fun_array.push("常用"http://webmap2.map.bdstatic.com/newmap/static/common/widget/ui/place/===tagFilter.value[i].name?'                    <h2 style="color: #e10724;">                    ':"                    <h2>                    "),_template_fun_array.push("                    ","undefined"http://webmap2.map.bdstatic.com/newmap/static/common/widget/ui/place/==typeof tagFilter.value[i].name?"":tagFilter.value[i].name,'                </h2></dt>                <dd>                    <ul class="tag-list">                        ');for(var j=0;j<tagFilter.value[i].value.length;j++)_template_fun_array.push('                            <li>                                <a data-value="',"undefined"==typeof tagFilter.value[i].value[j].value?"":tagFilter.value[i].value[j].value,'" data-district="',"undefined"==typeof tagFilter.value[i].value?"":tagFilter.value[i].value,'" class="selectItem item" href="javascript:;">                                    ',"undefined"http://webmap2.map.bdstatic.com/newmap/static/common/widget/ui/place/==typeof tagFilter.value[i].value[j].name?"":tagFilter.value[i].value[j].name,"                                </a>                            </li>                        ");_template_fun_array.push("                    </ul>                </dd>            </dl>            ")}_template_fun_array.push("        </div>                "),_template_fun_array.push(curFilterObj.isnbSearch?'        <div class="select-panel-sort select-panel-sort-noarea">        ':'        <div class="select-panel-sort">        '),_template_fun_array.push("            <ul>                ");for(var i=0;i<sortFilter.value.length;i++)_template_fun_array.push('                <li>                    <a data-value="sort:',"undefined"==typeof sortFilter.value[i].value?"":sortFilter.value[i].value,'" href="javascript:;" class="selectItem item">                        ',"undefined"http://webmap2.map.bdstatic.com/newmap/static/common/widget/ui/place/==typeof sortFilter.value[i].name?"":sortFilter.value[i].name,"                    </a>                </li>                ");_template_fun_array.push("            </ul>        </div></div>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],hotImg="../../../../../../../webmap1.map.bdstatic.com/newmap/static/common/images/hot_103bb48.png"/*tpa=http://webmap1.map.bdstatic.com/newmap/static/common/images/hot_103bb48.png*/,caterFilterData=require("common:widget/ui/place/caterFilterData.js"),locObj=require("common:widget/ui/place/localStorage.js"),areaMap={},tagSearchMap="",sortNameMap={"data_type,0":"默认排序","overall_rating,0":"按评分排序","hot_value,0":"按人气排序","price,1":"按价格低到高","price,0":"按价格高到低"},statSortMap={"data_type,0":"default","overall_rating,0":"rating","hot_value,0":"hot","price,1":"price_asc","price,0":"price_desc",premium:"discount",groupon:"tuan",book:"seatreserving"},filterMap={premium:"pl_discount2_section",groupon:"pl_groupon_section",book:"pl_cater_book_pc_section"},searchInTag=function(){for(var e,a,t=[],r=caterFilterData.tagFilter.value,l=0;l<r.length;l++){e=r[l].value||[];for(var i=0;i<e.length;i++)a=e[i],t.push(a.name),t.push(a.value)}return t=t.join(","),function(e){return t.indexOf(e)>=0}}(),comTag=function(){return{set:function(e){if("餐饮"!==e){var a=this.get(),t=T.array(a).indexOf(e);t>=0&&a.splice(t,1),a.unshift(e),a.length>4&&(a.length=4),locObj.set(COM_TAG,a.join(","))}},get:function(){var e=locObj.get(COM_TAG);return e&&"null"!==e?e.split(","):[]}}}(),sectionDiscount=Math.floor((new Date-Date.parse("01/01/2012"))/864e5)+",+";T.extend(place.cater,{filterHtml:function(e,a,t){var r=a.place_info||{},l=r.d_sort_type+","+r.d_sort_rule,i=comTag.get(),c={name:"常用",value:[{name:"所有餐厅",value:"tag:餐饮"}]};if(i.length){for(var s=0;s<i.length;s++)c.value.push({name:i[s],value:"tag:"+i[s]});caterFilterData.tagFilter.value[0].value=c.value}return this.city=a.current_city.up_cityid||a.current_city.code,this.wd=a.result.wd,this.sub_type=r.d_sub_type,this.curTag=this.wd.split(" ")[0]||this.wd,this.curArea=a.result.where,this.guid=e,caterFilterData.curFilterObj={defArea:this.curArea,defTag:searchInTag(this.curTag)?"餐饮"===this.curTag?"所有餐厅":this.curTag:"所有餐厅",defSort:sortNameMap[l]||"默认排序",defGroupon:r.d_groupon_section===sectionDiscount.replace(",","-")?"item-selected":"",defPremium:r.d_discount2_section===sectionDiscount.replace(",","-")?"item-selected":"",defBook:"1-1"===r.d_cater_book_pc_section?"item-selected":"",isnbSearch:t},caterFilterData.hotImg=hotImg,caterFilterTmpl(caterFilterData)},getAreaData:function(e){return areaMap[e]?this.buildAreaMenu(areaMap[e]):void T.ajax("http://webmap2.map.bdstatic.com/cater/index.php",{type:"GET",dataType:"json",context:this,data:{qt:"bc",c:e,from:"maponline"},success:function(a){areaMap[e]=a,this.buildAreaMenu(a)}})},placeRequest:function(e){"cater"==e.pl_business_type&&(e.wd=this.wd),"data_type"==e.pl_sort_type&&(e.pl_sort_type="default"),Instance(this.guid).searchByFilter(e),"cater"==e.pl_business_type&&delete e.wd},openList:function(e){window.open("/detail?qt=cater_home&type=tpl&from=map&s="+encodeURIComponent("s&c="+e.curCity.code))},bindEvent:function(){var e=T.dom("#caterFilter"),a=this;e.delegate(".tool-item","click",function(){var a=T.dom(this),t=a.data("type");e.attr("class",e.hasClass(t)?"":t)}),e.delegate(".areaItem","mouseover",function(){var t=T.dom(this);a.catertimer=setTimeout(function(){e.find(".areaItem").removeClass("active"),t.addClass("active"),a.buildBdMenu(t.data("value"))},150)}),e.delegate(".areaItem","mouseout",function(){a.catertimer&&clearTimeout(a.catertimer),a.catertimer=""}),e.delegate(".placeFilter","click",function(){{var e=T.dom(this),t=e.data("type"),r=e.hasClass("item-selected"),l=r?"removeClass":"addClass";T.dom(".placeFilter")}e[l]("item-selected"),r?delete place.cater.urlParam[filterMap[t]]:place.cater.urlParam[filterMap[t]]="book"===t?"1,1":sectionDiscount,addStat("poilistnormal.poi."+statSortMap[t],"click",{da_trd:"cater",da_abtest:!0}),a.placeRequest(place.cater.urlParam)}),e.delegate(".selectItem","click",function(){var t=T.dom(this),r=t.data("value")||"";switch(r=r.split(":"),r[0]){case"tag":a.curTag=r[1],a.wd=[a.curTag,a.curArea].join(" "),comTag.set(a.curTag),addStat("poilistnormal.poi.foodsort","click",{da_trd:"cater",da_abtest:!0});break;case"area":a.curArea=r[1],a.wd=[a.curTag,a.curArea].join(" "),addStat("poilistnormal.poi.areasort","click",{da_trd:"cater",da_abtest:!0});break;case"sort":var l=r[1].split(",");place.cater.urlParam.pl_sort_type=l[0],place.cater.urlParam.pl_sort_rule=l[1],addStat("poilistnormal.poi."+statSortMap[r[1]],"click",{da_trd:"cater",da_abtest:!0})}e.attr("class",""),a.placeRequest(place.cater.urlParam)})},buildBdMenu:function(e){for(var a,t=this.bdMap[e]||[],r=[],l=T.dom("#caterFilter"),i=0;i<t.length;i++)a="全部"===t[i]?e:t[i],a="所有地区"===a?"":a,r.push('<li><a data-value="area:'+a+'" data-district="'+e+'" class="selectItem item" href="javascript:;">'+t[i]+"</a></li>");l.find(".bdList").html(r.join(""))},buildAreaMenu:function(e){var a=[{n:"全部",sub:["所有地区"]}],t=e.data||{},r=t.content||{},l=a.concat(r.place_tag||[]),i=[],c=T.dom("#caterFilter"),s="",n="";this.bdMap={};for(var o=0;o<l.length;o++)1===o&&(s=l[o].n),n=1===o?"active":"",i.push('<li class="areaItem '+n+'" data-value="'+l[o].n+'"><span class="label">'+l[o].n+"</span></li>"),this.bdMap[l[o].n]=l[o].sub;c.find(".areaList").html(i.join("")),this.buildBdMenu(s)},initialize:function(){try{{var e=this;T.dom(".n_p_lineheight .book-cater")}place.cater.urlParam=T.extend({wd:e.wd,pl_data_type:"cater"},place.urlParam),this.getAreaData(this.city),this.bindEvent()}catch(a){"undefined"!=typeof alog&&alog("http://webmap2.map.bdstatic.com/newmap/static/common/widget/ui/place/exception.fire","catch",{msg:a.message||a.description,path:"common:widget/ui/place/caterFilter.js",ln:289})}}}),module.exports=place.cater});