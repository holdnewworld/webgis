define("common:widget/ui/StreetViewUtil/StreetViewUtil.js",function(e,t,i){function o(e){T.lang.Class.call(this),this.cinfo=e||{},this.initialize(e)}{var n=window.Pano=window.Pano||{},a=e("common:widget/ui/StreetViewOverlay/StreetViewOverlay.js"),s=e("common:widget/ui/PanoService/PanoService.js"),r=e("common:widget/pano/PanoInterface/PanoInterface.js"),l=e("common:widget/ui/PanoUtil/PanoUtil.js");e("common:widget/ui/config/config.js")}T.lang.inherits(o,T.lang.Class,"StreetViewUtil"),T.object.extend(o.prototype,{mapDragging:!1,hasEvents:!1,initialize:function(){try{var e=this.cinfo;this._map=e.map||map,this.panoTool=e.panoTool||{},this.defaultCursor=this._map.config.defaultCursor,this.draggingCursor=this._map.config.draggingCursor,this.bindEvents();var t=-100,i=-100,o=this.getMapPoint(t,i);this.addPanoOverlay(o)}catch(n){"undefined"!=typeof alog&&alog("http://webmap2.map.bdstatic.com/newmap/static/common/widget/ui/StreetViewUtil/exception.fire","catch",{msg:n.message||n.description,path:"common:widget/ui/StreetViewUtil/StreetViewUtil.js",ln:49})}},bindEvents:function(){if(!this.hasEvents){{var e=this,t=window,i=(this.guid,this._map),o=i.getContainer(),n=e.panoTool.getDom();baidu.g("tool_container")}i.disableKeyboard(),i.disableDoubleClickZoom(),i.setDefaultCursor("pointer"),e.streetViewMove=function(t){if(e.panoMarker){if(e.panoTool&&e.panoTool.isOpen){if(t.overlay&&"indoorIcon"!==t.overlay._type&&!(t.overlay instanceof BMap.Polygon))return void e.panoMarker.hide();e.dragging=!0,e.movePanoOverlay(t.point,t.pixel,t.overlay&&"indoorIcon"===t.overlay._type)}}else e.dragging=!1,e.addPanoOverlay(t.point)},e.setPanoStatus=function(t){var i=t.type;e.panoMarker&&e.panoTool.isOpen&&("onmouseover"==i||"mouseover"==i?e.panoMarker.hide():("onmouseout"==i||"mouseout"==i)&&e.panoMarker.show())},baidu.on(o,"mouseleave",function(){e.panoMarker&&e.panoMarker.hide()}),baidu.on(n,"mouseover",e.setPanoStatus),baidu.on(n,"mouseout",e.setPanoStatus),t.stdMapCtrl.addEventListener("mouseover",e.setPanoStatus),t.stdMapCtrl.addEventListener("mouseout",e.setPanoStatus),t.maptypeCtrl.addEventListener("mouseover",e.setPanoStatus),t.maptypeCtrl.addEventListener("mouseout",e.setPanoStatus);var a=["tool_fullScr","tool_tollCon","link","print"];baidu("#tool_container_con").delegate(".toolBtn","click",function(t){baidu.array(a).contains(this.id)||(e.resetStatus(),e.panoTool.resetStatus()),t.preventDefault()}),baidu("#tools_box").delegate(".toolBox-item","click",function(t){baidu.array(a).contains(this.id)||(e.resetStatus(),e.panoTool.resetStatus()),t.stopPropagation()}),this.bindMapEvents(),this.hasEvents=!0}},bindMapEvents:function(){var e=this,t=this._map,i=(t.getContainer(),this.panoTool,this.guid);t.addEventListener("click",function(t){t.overlay||(baidu.event.preventDefault(t.domEvent),baidu.event.stopPropagation(t.domEvent),e.streetViewMapClick(t))},i+"_map_click"),t.addEventListener("mousemove",this.streetViewMove),t.addEventListener("rightclick",function(t){baidu.event.preventDefault(t.domEvent),baidu.event.stopPropagation(t.domEvent),e.mapRightClick(t),window.contextMenu.disable(),setTimeout(function(){window.contextMenu.enable()},250)},i+"_map_right_click"),t.addEventListener("moving",function(){e.mapDragging=!0},i+"_moving"),t.addEventListener("moveend",function(){e.mapDragging=!1},i+"_moveend")},removeEvents:function(){{var e=this,t=window,i=this.guid,o=this._map,n=(o.getContainer(),e.panoTool.getDom());baidu.g("tool_container")}o.enableKeyboard(),o.enableDoubleClickZoom(),baidu.un(n,"mouseover",e.setPanoStatus),baidu.un(n,"mouseout",e.setPanoStatus),o.removeEventListener("mousemove",this.streetViewMove),o.removeEventListener("moving",i+"_moving"),o.removeEventListener("moveend",i+"_moveend"),o.removeEventListener("click",i+"_map_click"),o.removeEventListener("rightclick",i+"_map_right_click"),t.stdMapCtrl.removeEventListener("mouseover",e.setPanoStatus),t.stdMapCtrl.removeEventListener("mouseout",e.setPanoStatus),t.maptypeCtrl.removeEventListener("mouseover",e.setPanoStatus),t.maptypeCtrl.removeEventListener("mouseout",e.setPanoStatus),baidu("#tool_container_con").undelegate(".toolBtn","click"),baidu("#tools_box").undelegate(".toolBox-item","click"),this.hasEvents=!1},streetViewMapClick:function(e){this.guid,this._map.getContainer();this._map.removeEventListener("mousemove",this.streetViewMove),this.panoMarker&&this.panoMarker.dragTimer&&window.clearTimeout(this.panoMarker.dragTimer),this.showStreetView(e.point)},mapRightClick:function(){this.resetStatus(),this.panoTool&&this.panoTool.resetStatus()},resetStatus:function(){this.isOpen=!1,this.mapDragging=!1,this.curPixel=null,this.removeEvents(),this.panoMarker&&this.panoMarker.hide(),this.tipLabel&&this.tipLabel.hide(),this._map.setDefaultCursor(this.defaultCursor),this._map.setDraggingCursor(this.draggingCursor)},miniful:function(){return function(e){if(e){this.isMiniful=!0,this.panoMarker.miniful(!0)}else this.isMiniful=!1,this.panoMarker.miniful(!1)}}(),getMapPoint:function(e,t){if(!isNaN(e)&&!isNaN(t)){var i=this._map,o=i.getContainer(),n=T.dom.getPosition(o),a=e-n.left,s=t-n.top,r=new BMap.Pixel(a,s);return i.pixelToPoint(r)}},addPanoOverlay:function(e){this.panoMarker||(this.panoMarker=new a(e,{}),this._map.addOverlay(this.panoMarker),l.panoMarker&&l.panoMarker.remove(),l.panoMarker=this.panoMarker)},movePanoOverlay:function(e,t,i){this.tipLabel&&this.tipLabel.hide(),this.panoMarker.enableMove&&(this.mapDragging||(this.panoMarker.setPosition(e,t,i),this.curPixel=t))},showStreetView:function(e){var t=(this._map.getContainer(),this);s.getStreetBriefByLocation({point:e,level:t._map.getZoom(),from:"mapclick"http://webmap2.map.bdstatic.com/newmap/static/common/widget/ui/StreetViewUtil/},function(e){0==e.error&&e.content&&e.content.id?(t.setPanoMap(e),t.panoMarker&&t.panoMarker.hide(),setTimeout(function(){t._map.addEventListener("mousemove",t.streetViewMove)},500)):t._map.addEventListener("mousemove",t.streetViewMove)},t)},setPanoMap:function(e){var t=e.content.id,i=e.content.point,o=(this._map.getSize(),{panoId:t,panoType:"street",interPosition:i});r.showPano(o),addStat(STAT_CODE.STAT_PANORAMA,{item:n.PANO_TYPE_STREET,catalog:"map",func:"click",from:"pc-map"})},showTip:function(e){if(this.tipLabel)this.tipLabel.setPoint(e),this.tipLabel.show(),this.panoMarker.hideBubble(),this.delayHide();else{var t={point:e,offset:new BMap.Size(-40,30)};this.tipLabel=new BMap.Label("<div style='text-align:center;margin-top:5px;'>此处无全景</div ><div style='color:#4869a5;' >请点击蓝色路网</div>",t),this.tipLabel.setStyle({backgroundColor:"#fff",borderColor:"#b1b1b1",borderWidth:"1px",fontSize:"12px",height:"50px",lineHeight:"20px",fontFamily:"微软雅黑"}),this._map.addOverlay(this.tipLabel),this.panoMarker.hideBubble(),this.delayHide()}},delayHide:function(){var e=this;this.tipTimer&&window.clearTimeout(this.tipTimer),this.tipTimer=window.setTimeout(function(){e.tipLabel.hide()},3e3)}}),i.exports=o});