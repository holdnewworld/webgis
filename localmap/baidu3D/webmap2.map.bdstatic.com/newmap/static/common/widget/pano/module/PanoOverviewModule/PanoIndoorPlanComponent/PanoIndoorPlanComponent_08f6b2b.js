define("common:widget/pano/module/PanoOverviewModule/PanoIndoorPlanComponent/PanoIndoorPlanComponent.js",function(t,o,e){function i(t,o){T.lang.Class.call(this),this.mapContainer=t,this.opts=o||{}}var n=t("common:widget/pano/module/PanoOverviewModule/PanoIndoorPlanComponent/PanoIndoorOverlayComponent/PanoIndoorOverlayComponent.js"),r=t("common:widget/ui/util/util.js");baidu.lang.inherits(i,baidu.lang.Class,"PanoIndoorPlanComponent"),baidu.object.extend(i.prototype,{initialize:function(){try{this.isOpen=!1,this.tileSign={},this.viewport=null,this.VIEWPORTLT={x:0,y:0},this.panoMarker=null,this.mapDragging=!1,this.indoorInfo=null,this.tileWrap=null,this.tileLayer=null,this.markerLayer=null;var t=this.opts.context.panoContext.getPanoUrlConfig();this.udtVersion=t.UDT_VERSION||"20130819",this.tileUrl=t.PANO_SERVICE_URL+"?udt="+this.udtVersion+"&qt=tdata",this.markers=[],this.EVENT={},this.indoorInfo=this.adjustIndoorData(this.opts.data),this.opts.parent.style.display="block",this.createDomElements(),this.createOverlay(),this.initIndoorView(),this.initScaleControl(),this.bindDomEvent()}catch(o){"undefined"!=typeof alog&&alog("http://webmap2.map.bdstatic.com/newmap/static/common/widget/pano/module/PanoOverviewModule/PanoIndoorPlanComponent/exception.fire","catch",{msg:o.message||o.description,path:"common:widget/pano/module/PanoOverviewModule/PanoIndoorPlanComponent/PanoIndoorPlanComponent.js",ln:73})}},createDomElements:function(){var t=this,o=t.opts;return t.indoorViewContainer=T.dom.create("div",{id:"panoIndoorMap",style:"position:relative;width:100%; height:100%; background-color: #fff; overflow: hidden; z-index: "+o.zIndex}),t.tileWrap=T.dom.create("div",{id:"tileWrap",style:"position: absolute; left: 0; top: 0; width: 512px; height: 256px; color: green;"}),t.tileLayer=T.dom.create("div",{style:"position:absolute;top:0;left:0;right:0;bottom:0;z-index:11"}),t.markerLayer=T.dom.create("div",{style:"position:absolute;top:0;left:0;right:0;bottom:0;z-index:12"}),t.tileWrap.appendChild(t.tileLayer),t.tileWrap.appendChild(t.markerLayer),this.indoorViewContainer.appendChild(t.tileWrap),this.mapContainer&&this.mapContainer.appendChild(t.indoorViewContainer),t.viewport=t.indoorViewContainer,!0},createOverlay:function(){var t=this,o=t.opts,e=o.data.currentPoint?o.data.currentPoint:{x:o.data.x,y:o.data.y};t.overlay=new n({type:"indoorOverlay",position:e,dom:t.indoorViewContainer,zIndex:o.zIndex})},checkIndoorInfo:function(t){var o=this;return o.indoorInfo=o.adjustIndoorData(t.data),!!o.indoorInfo},renderView:function(t){try{var o=baidu.g("panoIndoorMap"),e=o.clientWidth,i=o.clientHeight,n={x:-t.x,y:-t.y},r={x:n.x+e,y:n.y+i};t.x>0&&(n.x=0,r.x=parseInt(this.tileWrap.style.width)),t.y>0&&(n.y=0,r.y=parseInt(this.tileWrap.style.height));var a=this._filterTile(n,r,{mw:this.indoorInfo.width,mh:this.indoorInfo.height,tw:this.indoorInfo.tileWidth,th:this.indoorInfo.tileHeight});this.addTileLayer({dom:this.tileLayer,area:a,tile:{width:this.indoorInfo.tileWidth,height:this.indoorInfo.tileHeight}})}catch(s){"undefined"!=typeof alog&&alog("http://webmap2.map.bdstatic.com/newmap/static/common/widget/pano/module/PanoOverviewModule/PanoIndoorPlanComponent/exception.fire","catch",{msg:s.message||s.description,path:"common:widget/pano/module/PanoOverviewModule/PanoIndoorPlanComponent/PanoIndoorPlanComponent.js",ln:185})}},adjustIndoorData:function(t){this._getDefZoom(t.width,t.height,512,512);t.defZoom=t.zoomLevel>1?2:1,t.tileWidth=256,t.tileHeight=256;var o=Math.pow(2,t.defZoom-1);t.width=t.width/o,t.height=t.height/o,t.currZoom=t.defZoom;for(var e=0,i=t.points.length;i>e;e++)t.points[e].x/=o,t.points[e].y/=o;t.currPoint={};var n=t.currentPid||t.uid;if(t.points.length)for(var e=0;e<t.points.length;e++)if(t.points[e].id===n){t.currPoint.x=t.points[e].x,t.currPoint.y=t.points[e].y;break}return t.uid&&t.currPoint.x&&t.currPoint.y||(t.currPoint.x=t.points[0].x,t.currPoint.y=t.points[0].y),t},initIndoorView:function(){this.tileSign={},this.markers=[],this.markerLayer.innerHTML="",this.tileLayer.innerHTML="";var t=this.adjustCenter(this.indoorInfo.currPoint);this.tileWrap.style.width=this.indoorInfo.width+"px",this.tileWrap.style.height=this.indoorInfo.height+"px",this.renderView({x:t.left,y:t.top}),this.addMarkers()},initScaleControl:function(){var t=this,o=T('<div id="scale-controll-area"><a id="map-zoomout" title="放大一级" href="javascript:void(0)" class="fishbone_button"><span></span></a><div id="map-zoom-line"><div></div></div><a id="map-zoomin" href="javascript:void(0)" title="缩小一级" class="fishbone_button"><span></span></a></div>');this._fishBone=o[0],this.indoorViewContainer.appendChild(this._fishBone);var e=T.g("map-zoomout"),i=T.g("map-zoomin");baidu.on(e,"click",function(o){baidu.event.preventDefault(o),baidu.event.stopPropagation(o),t.indoorInfo.currZoom>1&&t.zoom(1,{x:t.viewport.offsetWidth/2,y:t.viewport.offsetHeight/2})}),baidu.on(i,"click",function(o){baidu.event.preventDefault(o),baidu.event.stopPropagation(o),t.indoorInfo.currZoom<t.indoorInfo.zoomLevel&&t.zoom(-1,{x:t.viewport.offsetWidth/2,y:t.viewport.offsetHeight/2})})},bindDomEvent:function(){this._bindMouseDragEvent(),this._bindMouseWheelEvent(),this._bindClickEvent()},removeEvents:function(){var t=this;t.EVENT&&(t.overlay.removeEventListener("ondragend",t.EVENT._cameraDragEnd),T(t.indoorViewContainer).off("mousedown",t.EVENT._mouseDown),T(t.indoorViewContainer).off("mousemove",t.EVENT._mouseMove),T(t.indoorViewContainer).off("mouseup",t.EVENT._mouseUp),T(t.indoorViewContainer).off("mouseleave",t.EVENT._mouseOut),T(document.body).off("mouseup",t.EVENT._bodymouseUp),T.un(t.viewport,T.browser.firefox?"DOMMouseScroll":"onmousewheel"),T(t.viewport).off("click",t.EVENT._clickPoint),t.EVENT=null)},_bindMouseDragEvent:function(){function t(t){MS_POS.x=t.pageX,MS_POS.y=t.pageY,r.preventDefault(t)}window.MS_POS={initX:0,initX:0,y:0,MOUSEDOWN:!1,DRAG:!1};var o=(this.tileWrap,this);o.EVENT._mouseDown=function(e){this.style.cursor="url('http://webmap1.map.bdstatic.com/newmap/static/common/images/api/closedhand.cur'), move",MS_POS.MOUSEDOWN=!0,t(e),MS_POS.initX=e.pageX,MS_POS.initY=e.pageY,o._isDrag=!0},o.EVENT._mouseMove=function(e){MS_POS.MOUSEDOWN&&(this.style.cursor="url('http://webmap1.map.bdstatic.com/newmap/static/common/images/api/closedhand.cur')",MS_POS.DRAG=!0,o._drag({x:e.pageX-MS_POS.x,y:e.pageY-MS_POS.y}),t(e))},o.EVENT._mouseUp=function(e){this.style.cursor="pointer",MS_POS.DRAG&&Math.abs(e.pageX-MS_POS.initX)<3&&Math.abs(e.pageY-MS_POS.initY)<3&&(MS_POS.DRAG=!1),MS_POS.MOUSEDOWN=!1,t(e),o.renderView({x:parseInt(o.tileWrap.style.left),y:parseInt(o.tileWrap.style.top)})},o.EVENT._bodymouseUp=function(){o._isDrag&&(o._isDrag=!1,window._pano_overviewmap_leaved&&(window._mouseleave_trigger_source="map",baidu("#panoMapOuterWapper").trigger("mouseleave")))},o.EVENT._mouseOut=function(e){MS_POS.MOUSEDOWN&&(MS_POS.MOUSEDOWN=!1,MS_POS.DRAG=!1,t(e),o.renderView({x:parseInt(o.tileWrap.style.left),y:parseInt(o.tileWrap.style.top)}))},o.EVENT._cameraDragEnd=function(t){o.EVENT._setCameraPos(t.point.x-parseInt(o.tileWrap.style.left),t.point.y-parseInt(o.tileWrap.style.top))},o.overlay.addEventListener("ondragend",o.EVENT._cameraDragEnd),T.on(this.indoorViewContainer,"mousedown",o.EVENT._mouseDown),T.on(this.indoorViewContainer,"mousemove",o.EVENT._mouseMove),T.on(this.indoorViewContainer,"mouseup",o.EVENT._mouseUp),T.on(document.body,"mouseup",o.EVENT._bodymouseUp),T.on(this.indoorViewContainer,"mouseleave",o.EVENT._mouseOut)},_bindMouseWheelEvent:function(){var t=this,o=T.browser.firefox?"DOMMouseScroll":"onmousewheel";t.EVENT._zoomMouseWheel=function(o){r.stopBubble(o);var e=T(this).offset(),i=-o.detail/3||o.wheelDelta/120,n=o.pageX-e.left,a=o.pageY-e.top;t.zoom(i,{x:n,y:a})},T.on(this.viewport,o,t.EVENT._zoomMouseWheel)},_bindClickEvent:function(){var t=this;t.EVENT._clickPoint=function(o){if(MS_POS.DRAG)return void(MS_POS.DRAG=!1);var e=T(t.tileWrap).offset(),i=o.pageX-e.left,n=o.pageY-e.top;t.EVENT._setCameraPos(i,n),t.renderView({x:parseInt(t.tileWrap.style.left),y:parseInt(t.tileWrap.style.top)})},t.EVENT._setCameraPos=function(o,e){if(t.markers.length){for(var i,n,r=0,a=0,s=0;s<t.markers.length;s++)n=t.markers[s],i=Math.pow(Math.abs(n.x-o),2)+Math.pow(Math.abs(n.y-e),2),0===s?a=i:a>i&&(a=i,r=s);t._clickMarker(t.markers[r])}},t.EVENT._zoomIn=function(o){r.stopBubble(o),t.zoom(1,{x:t.viewport.offsetWidth/2,y:t.viewport.offsetHeight/2})},t.EVENT._zoomOut=function(o){r.stopBubble(o),t.zoom(-1,{x:t.viewport.offsetWidth/2,y:t.viewport.offsetHeight/2})},t.EVENT._zoomInMouseMove=function(){1!=t.indoorInfo.currZoom&&(this.style.backgroundPosition="-31px 0")},t.EVENT._zoomOutMouseMove=function(){t.indoorInfo.currZoom!=t.indoorInfo.zoomLevel&&(this.style.backgroundPosition="0 -25px")},t.EVENT._zoomInMouseLeave=function(){1!=t.indoorInfo.currZoom&&(this.style.backgroundPosition="0 0")},t.EVENT._zoomOutMouseLeave=function(){t.indoorInfo.currZoom!=t.indoorInfo.zoomLevel&&(this.style.backgroundPosition="-31px -25px")},T.on(this.viewport,"click",t.EVENT._clickPoint)},_drag:function(t){var o,e,i=parseInt(this.tileWrap.style.left),n=parseInt(this.tileWrap.style.top),r=this.viewport.offsetWidth,a=this.viewport.offsetHeight,s=r-parseInt(this.tileWrap.style.width),d=a-parseInt(this.tileWrap.style.height),l=i,p=n;i=i+t.x>0?0:i+t.x,n=n+t.y>0?0:n+t.y,i=i>s?i:s,n=n>d?n:d,this.tileWrap.style.left=i+"px",this.tileWrap.style.top=n+"px",this._checkAdjustTileWrap(r,a,this.tileWrap),o=s>0?0:i-l,e=d>0?0:n-p;var h={x:this.overlay.getPosition().x+o,y:this.overlay.getPosition().y+e};this.overlay.setPosition(h)},_checkAdjustTileWrap:function(t,o,e){var i=parseInt(e.style.left),n=parseInt(e.style.top),r=parseInt(e.style.width),a=parseInt(e.style.height);return t>r&&(i=(t-r)/2),o>a&&(n=(o-a)/2),e.style.left=i+"px",e.style.top=n+"px",!0},adjustCenter:function(t){var o,e,i=this.opts.parent,n=i.offsetWidth,r=i.offsetHeight,a=this.indoorInfo.width,s=this.indoorInfo.height,d=this.tileWrap;return e=r>=s?(r-s)/2:t.y<=r/2?0:s-t.y<r/2?r-s:r/2-t.y,d.style.top=e+"px",o=n>=a?(n-a)/2:t.x<=n/2?0:a-t.x<n/2?n-a:n/2-t.x,d.style.left=o+"px",{left:o,top:e}},addTileLayer:function(t){var o,e,i=(t.dom,t.area),n=(t.tile.height,t.tile.width,t.tile),r=t.dom,a=null,s=this;s._totalTileImg=(i.maxCol+1-i.minCol)*(i.maxRow+1-i.minRow),s._tileImgLoaded=0;for(var d=i.minCol;d<=i.maxCol;d++)for(var l=i.minRow;l<=i.maxRow;l++)this.tileSign[d+"_"+l]||(this.tileSign[d+"_"+l]=!0,e=n.width*d,o=n.height*l,a=T.dom.create("img",{src:this.tileUrl+"&iid="+this.indoorInfo.innerId+"&f="+this.indoorInfo.realFloor+"&l="+this.indoorInfo.currZoom+"&pos="+d+"_"+l,style:"position: absolute; top: "+o+"px; left:"+e+"px; width: 256px; height: 256px; display: block;"}),a.complete?s._tileImgLoadHandler():a.onload=function(){s._tileImgLoadHandler()},r.appendChild(a))},_tileImgLoadHandler:function(){var t=this;t._tileImgLoaded++,t._tileImgLoaded==t._totalTileImg&&(t.dispatchEvent("tiles_loaded"),t.opts.parent.style.visibility="visible")},_filterTile:function(t,o,e){var i=e.tw,n=e.th,r=o.x-t.x>e.mw?t.x+e.mw:o.x,a=o.y-t.y>e.mh?t.y+e.mh:o.y,s=Math.floor(t.y/i),d=Math.floor(t.x/i),l=Math.ceil(a/n)-1,p=Math.ceil(r/i)-1;return{minRow:s,minCol:d,maxRow:l,maxCol:p}},_getDefZoom:function(t,o,e,i){var n=1,r=e+512,a=i+512;if(r>=t||a>=o)n=1;else{for(;t>=r&&o>=a;)t/=2,o/=2,n++;n--}return n},zoom:function(t,o){if(this._zoomData(t)){var e=this.viewport.offsetWidth,i=this.viewport.offsetHeight,n=this.indoorInfo.width,r=this.indoorInfo.height,a=parseInt(this.tileWrap.style.left),s=parseInt(this.tileWrap.style.top),d=o.x-(o.x-a)*Math.pow(2,t),l=o.y-(o.y-s)*Math.pow(2,t);this.tileSign={},this.markerLayer.innerHTML="",this.tileLayer.innerHTML="",this.tileWrap.style.width=this.indoorInfo.width+"px",this.tileWrap.style.height=this.indoorInfo.height+"px",d=d>0?0:d,l=l>0?0:l,d=e>n+d?e-n:d,l=i>r+l?i-r:l,d=e>n?(e-n)/2:d,l=i>r?(i-r)/2:l,this.tileWrap.style.left=d+"px",this.tileWrap.style.top=l+"px",this.renderView({x:d,y:l}),this.addMarkers()}},_zoomData:function(t){var o=this.indoorInfo.zoomLevel,e=this.indoorInfo.currZoom,i=this.indoorInfo;if(0>t&&e===o||t>0&&1===e)return!1;if(t>0){i.currZoom-=1,i.width*=2,i.height*=2;for(var n in i.points)i.points[n].x*=2,i.points[n].y*=2;i.currPoint.x*=2,i.currPoint.y*=2}else{i.currZoom+=1,i.width/=2,i.height/=2;for(var n in i.points)i.points[n].x/=2,i.points[n].y/=2;i.currPoint.x/=2,i.currPoint.y/=2}var r=T.g("map-zoomout"),a=T.g("map-zoomin");return baidu.dom.removeClass(a,"disabled"),baidu.dom.removeClass(r,"disabled"),1==i.currZoom?baidu.dom.addClass(r,"disabled"):i.currZoom==o&&baidu.dom.addClass(a,"disabled"),!0},addMarkers:function(){var t,o,e,i,n=[[10,10,0,-46],[16,16,0,-30],[30,30,0,0]],r=this.indoorInfo.zoomLevel-this.indoorInfo.currZoom,a=this.indoorInfo.currPoint,s=Math.floor((this.indoorInfo.zoomLevel+1)/3),d=this.indoorInfo.zoomLevel-2*s;s>r&&(i=0),r>=s&&s+d>r&&(i=1),r>=s+d&&(i=2);var l="../../../../../../../../../webmap0.map.bdstatic.com/newmap/static/common/images/panorama/indoor_marker_24_c5cb82c.png"/*tpa=http://webmap0.map.bdstatic.com/newmap/static/common/images/panorama/indoor_marker_24_c5cb82c.png*/,p="../../../../../../../../../webmap0.map.bdstatic.com/newmap/static/common/images/panorama/indoor_marker_8_2851109.png"/*tpa=http://webmap0.map.bdstatic.com/newmap/static/common/images/panorama/indoor_marker_8_2851109.png*/;this.markers=[];var h={x:a.x+parseInt(this.tileWrap.style.left),y:a.y+parseInt(this.tileWrap.style.top)};this.overlay.setPosition(h),this.overlay.setDirection(a.defaultAngle);for(var u=0;u<this.indoorInfo.points.length;u++)o=this.indoorInfo.points[u],e=n[i],t={dom:T.dom.create("div",{"data-id":o.id,title:o.name,style:"position:absolute; width:"+e[0]+"px; height:"+e[1]+"px;top:"+(o.y-e[1]/2)+"px;left:"+(o.x-e[0]/2)+"px;background:url("+l+") no-repeat "+e[2]+"px "+e[3]+"px; _background:url("+p+") no-repeat  "+e[2]+"px "+e[3]+"px;"}),id:o.id,x:o.x,y:o.y},0==o.pin&&(t.dom.style.display="none"),this.markers.push(t),this.markerLayer.appendChild(t.dom)},redraw:function(){var t=this.indoorInfo.currPoint;if(this.adjustCenter(t),this.overlay){var o={x:t.x+this.tileWrap.offsetLeft,y:t.y+this.tileWrap.offsetTop};this.overlay.setPosition(o),t.heading&&this.overlay.setDirection(t.heading)}this.renderView({x:parseInt(this.tileWrap.style.left),y:parseInt(this.tileWrap.style.top)})},_clickMarker:function(t){this.setCenter(t),this.dispatchEvent("pano_changed",{data:{panoId:t.id,panoType:"inter"}})},event_povChanged:function(t){this.overlay.setDirection(t)},event_indoorIdChanged:function(t){var o=this,e=t.data.id=t.data.pid;for(var i in o.markers)o.markers[i].id===e&&(t.data.x=o.markers[i].x,t.data.y=o.markers[i].y);this.setCenter(t.data)},event_exitIndoor:function(){this.removeEvents()},destroyAll:function(){this.indoorViewContainer.removeChild(this._fishBone);var t=baidu.g("panoIndoorMap");t&&t.parentNode&&t.parentNode.removeChild(t)},getCurrentCity:function(t){var o=this;if(o._currentCity)return void t(o._currentCity);var e=o.opts.data,i=(new Date).getTime(),n=e.x-1+","+(e.y-1)+";"+(e.x+1)+","+(e.y+1);baidu.ajax("/?newmap=1&qt=ncent&ie=utf-8&b="+n+"&l=16&t="+i,{dataType:"json",success:function(e){if(e&&e.content&&e.current_city){var i=e.current_city;o._currentCity={cityId:i.code,cityName:i.name},t&&t(o._currentCity)}},error:function(){}})},getBounds:function(){},setCenter:function(t){t&&(this.indoorInfo.currPoint=t),this.redraw()},getInnerId:function(){return this.opts.data.innerId},getLevel:function(){return void 0}}),e.exports=i});