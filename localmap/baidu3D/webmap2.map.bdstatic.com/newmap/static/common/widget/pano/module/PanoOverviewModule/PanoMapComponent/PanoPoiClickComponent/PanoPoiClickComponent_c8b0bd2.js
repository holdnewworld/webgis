define("common:widget/pano/module/PanoOverviewModule/PanoMapComponent/PanoPoiClickComponent/PanoPoiClickComponent.js",function(e,t,o){function n(e){this._opts=e,this._map=e.map,this.cbfunction=e.callback,this.cacheData={},this.maxCache=8,this.cacheIds=[],this.poiSpotId=null,this.spotOnId="",this.spotOnUid=null,this.mkr=null,this.label=null,this.squareSide=4,this.tMkr=null,this.tempMarker=null,this.tempLabel=null,this.overSpotPoint=null,this.isMoving=!1,this.fetchId="",this.curTileId="",this.labelName="",this.ic=new BMap.Icon("../../../../../../../../../../webmap1.map.bdstatic.com/newmap/static/common/images/panorama/pano_click_poi_9d48465.png"/*tpa=http://webmap1.map.bdstatic.com/newmap/static/common/images/panorama/pano_click_poi_9d48465.png*/,new BMap.Size(20,24),{offset:new BMap.Size(10,12),infoWindowOffset:new BMap.Size(5,0)});var t=e.context.panoContext,o=t.getPanoUrlConfig();this.clickVersion=o.PANO_INDOOR_CLICK_VERSION||"1003",this.initialize()}baidu.lang.inherits(n,baidu.lang.Class,"PanoPoiClickComponent"),baidu.object.extend(n.prototype,{initialize:function(){try{this.bind()}catch(e){"undefined"!=typeof alog&&alog("http://webmap2.map.bdstatic.com/newmap/static/common/widget/pano/module/PanoOverviewModule/PanoMapComponent/PanoPoiClickComponent/exception.fire","catch",{msg:e.message||e.description,path:"common:widget/pano/module/PanoOverviewModule/PanoMapComponent/PanoPoiClickComponent/PanoPoiClickComponent.js",ln:51})}},refresh:function(e){var t=this;t.clearPoiCache(),t.hideOverlays(),t.tMkr=null,t.tempMarker=null,t.tempLabel=null,t.spotOnId=null,t._map=e,t.init()},bind:function(){this.bindMapRequest(),this.bindMouseMove(),this.bindSpotEvent()},bindMapRequest:function(){var e=this,t=e._map;t.addEventListener("tilesloaded",function(){t.getZoom()<10&&e.clearPoiCache()}),t.addEventListener("zoomend",function(){e.clearPoiCache(),e.hideOverlays()})},bindMouseMove:function(){var e=this,t=e._map;e._panomouseMoveEvent||(e._panomouseMoveEvent=function(t){e._mouseMoveEvent(t)}),t.addEventListener("mousemove",e._panomouseMoveEvent)},_mouseMoveEvent:function(e){var t=this,o=t._map;if(o.getZoom()<10)t.clearPoiCache();else{if(!e||!e.point)return;t.overSpotPoint=e.point,t.isMoving=!0;var n=o.getTileId(e.point,o.getZoom());if(!n.row||!n.column||!n.level)return;t.curTileId=n.level+"_"+n.row+"_"+n.column;var a=n.level+"_"+t.m1(n.row)+"_"+t.m1(n.column);t.cacheData[a]?t.spotOnId!=t.curTileId&&(t.clearPoiCache(),t._addSpot(t.curTileId)):t.sendRequest({l:n.level,x:t.m1(n.row),y:t.m1(n.column)})}},_addSpot:function(e){var t=this,o=t._map,n=e.split("_"),a=n[0]+"_"+t.m1(n[1])+"_"+t.m1(n[2]);if(t.cacheData[a]){var i=t.cacheData[a][e]?t.cacheData[a][e]:!1;if(i){t.poiSpotId=o.addSpots(i,{enableMultiResponse:!1}),t.spotOnId=e;for(var p=-1,r=0,l=t.cacheIds.length;l>r;r++)if(a==t.cacheIds[r]){p=r;break}p>=0&&(t.cacheIds.splice(p,1),t.cacheIds.push(a))}}},sendRequest:function(e){var t=this;if(e&&t.fetchId!=e.l+"_"+e.x+"_"+e.y){t.fetchId=e.l+"_"+e.x+"_"+e.y;var o=e.x+"_"+e.y+"_"+e.l+"_"+this.clickVersion;baidu.jsonp("http://pcsv0.map.bdimg.com/?qt=ck&tid="+o,{cbtype:"fn",success:function(e){e=e&&e.content||{},e&&e.length>0&&t.getPoiData(e)},error:function(){}})}},getPoiData:function(e){for(var t={},o=!1,n=this,a=n._map,i=0,p=e.length;p>i;i++){for(var r=[],l=e[i],s=0,c=l.uids.length;c>s;s++){var m=l.uids[s],d=(m.bound.xmax+m.bound.xmin)/2,u=(m.bound.ymax+m.bound.ymin)/2,v=a.pointToPixel(new BMap.Point(m.bound.xmin,m.bound.ymin)),h=a.pointToPixel(new BMap.Point(m.bound.xmax,m.bound.ymax)),f=[(v.x-h.x)/2,(h.y-v.y)/2,(h.x-v.x)/2,(v.y-h.y)/2];"street_1"!=m.catalog&&r.push({pt:new BMap.Point(d,u),bd:f,userdata:{name:m.name?m.name:"",uid:m.uid,type:m.type,iconpoint:m.icon?new BMap.Point(m.icon.x,m.icon.y):""},tag:"MAP_SPOT_INFO"})}n.curTileId&&n.curTileId==l.tileid&&(o=!0),t[l.tileid]=r}var _=e[0].tileid.split("_"),b=_[0]+"_"+n.m1(_[1])+"_"+n.m1(_[2]);if(n.cacheData[b]=t,n.cacheIds.push(b),n.cacheIds.length>n.maxCache){var M=n.cacheIds.shift();delete n.cacheData[M],delete M}o&&n._addSpot(n.curTileId)},bindSpotEvent:function(){var e=this;e.addSpotEvent()},addSpotEvent:function(){var e=this,t=e._map;e._panomoveOverSpot||(e._panomoveOverSpot=function(t){e.stopAndPrevent(t),e._moveOverSpot(t)}),e._panomoveOutSpot||(e._panomoveOutSpot=function(t){e._moveOutSpot(t)}),t.addEventListener("spotmouseover",e._panomoveOverSpot),t.addEventListener("spotmouseout",e._panomoveOutSpot)},removeSpotEvent:function(){var e=this,t=e._map;t.removeEventListener("mousemove",e._panomouseMoveEvent),t.removeEventListener("spotmouseover",e._panomoveOverSpot),t.removeEventListener("spotmouseout",e._panomoveOutSpot)},_moveOverSpot:function(e){var t=this,o=t._map;if(!(o.getZoom()<10)){var n=e.spots;if(n&&!(n.length<1)&&n[0].tag&&"MAP_SPOT_INFO"==n[0].tag){"_panoPoiClick"==t.cbfunction&&PanoUtil.panoMarker&&PanoUtil.panoMarker.disable();var a=n[0].userdata.iconpoint?n[0].userdata.iconpoint:n[0].pt;t.tempMarker&&t.tempMarker.map?(t.tempMarker.setPoint(a),t.tempMarker.show(),t.spotOnUid=n[0].userdata.uid):(t.tempMarker=new BMap.Marker(a,{icon:t.ic,zIndexFixed:!0,baseZIndex:3e6}),t.spotOnUid=n[0].userdata.uid,o.addOverlay(t.tempMarker),t.mkr=t.tempMarker,t.tempMarker.addEventListener("click",function(e){t.clickMkr(e),t.stopAndPrevent(e)})),t.tempMarker.setTop(!0),t.tMkr=t.tempMarker;var i={backgroundColor:"#FFFFE1",borderColor:"#8C8C8C",color:"#4D4D4D"http://webmap2.map.bdstatic.com/newmap/static/common/widget/pano/module/PanoOverviewModule/PanoMapComponent/PanoPoiClickComponent/};t.labelName=n[0].userdata.name,t.tempLabel&&t.tempLabel.map?(t.tempLabel.setPoint(a),t.tempLabel.setOffset(new BMap.Size(-6*t.labelName.length,16)),t.tempLabel.setContent(t.labelName),t.label=t.tempLabel,t.label.show()):(t.tempLabel=new BMap.Label(t.labelName,{point:a}),t.tempLabel.setOffset(new BMap.Size(-6*t.labelName.length,16)),t.tempLabel.setStyle(i),t.label=t.tempLabel,o.addOverlay(t.label))}}},_moveOutSpot:function(){var e=this,t=e._map;t.getZoom()<10||("_panoPoiClick"==e.cbfunction&&PanoUtil.panoMarker&&PanoUtil.panoMarker.enable(),e.tMkr=null,e.hideOverlays())},moveSpot:function(e){me.stopAndPrevent(e)},clickMkr:function(e){{var t=this,o=t._map;t.tMkr}o.removeOverlay(t.tempMarker),t.tMkr=null,t.tempMarker=null,t.tempLabel=null,t.spotOnId=null;var n="inter";t.dispatchEvent("click",{panoUid:t.spotOnUid,panoType:n}),t.stopAndPrevent(e),addStat(STAT_CODE.STAT_PANORAMA,{item:Pano.PANO_TYPE_INDOOR,catalog:"map",func:"click",from:"overview-map"})},clearPoiCache:function(){var e=this,t=e._map;e.poiSpotId&&(t.removeSpots(e.poiSpotId),e.poiSpotId=null,e.spotOnId=null)},hideOverlays:function(){var e=this;e.mkr&&e.mkr.hide(),e.label&&e.label.hide()},m1:function(e){return Math.floor(parseInt(e,10)/this.squareSide)},stopAndPrevent:function(e){var e=window.event||e;baidu.event.stopPropagation(e),baidu.event.preventDefault(e)}}),o.exports=n});