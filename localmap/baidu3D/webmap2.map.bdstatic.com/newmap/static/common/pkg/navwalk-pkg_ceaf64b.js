define("common:widget/com/NavWalk/NavWalk.js",function(require,exports,module){function NavWalk(){if(MapComponent.apply(this,arguments),this.rettype=["","从起点出发","到达目的地","途经点","走"],this.roadtype=["","环岛","无属性道路","主路","高速连接路","交叉点内路段","连接道路","停车场内部道路","服务区内部道路","桥","步行街","辅路","匝道","全封闭道路","未定义交通区域","POI连接路","隧道","步行道","公交专用道","提前右转道","广场内部道路","公园内部道路"],this.worktype=["","人行道","天桥","地下通道","人行通道","直梯","扶梯","阶梯","斜坡","索道"],this.noName="未知路段",this.json){var t=this.json.result;this.result=t,this.total=t.total,this.start=t.start,this.end=t.end,this.end=this.end[this.end.length-1],this.waypoints=t.waypoints,this.sCity=t.start_city,this.eCity=t.end_city,this.eCity=this.eCity[this.eCity.length-1],this.startName=this.start.wd,this.endName=this.end.wd,this.s_query=t.s_query?t.s_query:this.start.wd,this.e_query=t.e_query?t.e_query:this.end.wd,this.strategy=t.sy,this.currentCity=modelConfig.cityCode,this.drag=t.drag||0,window.cxtBusPoints||(window.cxtBusPoints=[]);var e=this.start.pt.split(","),i=new BMap.Point(e[0],e[1]);window.cxtBusPoints[0]={p:i,n:this.startName,t:0};var e=this.end.pt.split(","),n=new BMap.Point(e[0],e[1]);if(window.cxtBusPoints[1]={p:n,n:this.endName,t:1},this.total){var a=this.generateNavListData();this.navListView=new NavListView(a)}}}var componentManager=require("common:widget/com/componentManager.js"),MapComponent=require("common:widget/com/MapComponent.js"),config=require("common:widget/ui/config/config.js"),MapConfig=config.mapConfig,modelConfig=config.modelConfig,util=require("common:widget/ui/util/util.js"),mapUtil=require("common:widget/ui/mapUtil/mapUtil.js"),searchBox=require("common:widget/ui/searchBox/searchBox.js"),setComplaintCenterURL=require("common:widget/ui/SetComplaintCenter/SetComplaintCenter.js"),SchemeFaver=require("common:widget/ui/SchemeFaver/SchemeFaver.js"),BoxContainer=require("common:widget/ui/BoxContainer/BoxContainer.js"),SyncMgr=require("common:widget/ui/SyncMgr/SyncMgr.js"),mapInfoScrollPanel=require("common:widget/ui/mapInfoScroll/mapInfoScroll.js"),PanoUtil=require("common:widget/ui/PanoUtil/PanoUtil.js"),NavListView=require("common:widget/view/NavList/NavList.js"),NavMap=require("common:widget/com/NavWalk/NavMap.js");T.lang.inherits(NavWalk,MapComponent,"NavWalk"),T.object.extend(NavWalk.prototype,{render:function(){try{if(this.total){var template=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div id="nav_container">  <div class="route_contentWrapper" style="padding-top:15px">      <div id="route_content_walk">        <div class="special">          <div class="drive_total">查看：<a tid="routeReturn" id="routeReturn">返程</a><span style="display:',"undefined"==typeof bus_display?"":bus_display,'">&nbsp;|&nbsp;<a id="routeBus">公交</a></span><span>&nbsp;|&nbsp;<a id="routeNav">驾车</a></span></div>          <div class="bus_walk_tip" style="display:',"undefined"==typeof tip_display?"":tip_display,'">起点与终点距离较近，建议您<span>步行前往</span></div>          <div class="drive">              <div class="con">              </div>          </div>        </div>        <div id="route_tips" class="route_tips" style="padding:10px 0">百度提醒您：如果您有任何意见和建议，请到<a id="mapComplaintCenter" target="_blank" href="http://tousu.baidu.com/map/add">百度地图投诉中心</a>反馈。</div>      </div>  </div></div>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],style=".drive_total{padding:5px 0 8px}.drive_total a{color:#3d6dcc;text-decoration:none;cursor:pointer}.drive_total a:hover{text-decoration:underline}.bus_walk_tip{padding-left:5px;height:25px;line-height:25px;background:#FFF3CB;margin-bottom:5px}.bus_walk_tip span{font-weight:700}";require.loadCss({content:style,name:"NavWalk"}),addStat("http://webmap2.map.bdstatic.com/newmap/static/common/pkg/nav.navscheme.walk","show");var templateObj={guid:this.guid};templateObj.busInfo=this.sCity.code!=this.eCity.code?"":0==modelConfig.supBus&&2==modelConfig.cityType?"|&nbsp;暂无公交":"公交";var result=this.json.result;templateObj.tip_display="bus"==result.w_type?"block":"none",templateObj.bus_display="bus"==result.w_type?"none":"",this.$el=T(template(templateObj)),this.$el.find(".con").append(this.navListView.render())}else{var template=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div id="nav_container">    <div class="mapinfo_con">        <p>未能计算出从“<span class="nr_kw">',"undefined"==typeof data.startName?"":baidu.template._encodeHTML(data.startName),'</span>”到“<span class="nr_kw">',"undefined"==typeof data.endName?"":baidu.template._encodeHTML(data.endName),'</span>”的步行路线，抱歉。</P>        <div class="nr_suggest">百度建议您：            <ul>                <li>看看地图当前城市是否有误，尝试更换城市</li>                <li>您可在地图上移动起点、终点，再次尝试</li>                <li>您可更换关键词再次尝试。</li>            </ul>        </div>        <div id="route_tips" class="route_tips">百度提醒您：如果您有任何意见和建议，请到<a id="mapComplaintCenter" target="_blank" href="http://tousu.baidu.com/map/add">百度地图投诉中心</a>反馈。</div>    </div></div>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0];this.$el=T(template({data:{startName:this.start.wd,endName:this.end.wd}}))}return this.$el}catch(e){"undefined"!=typeof alog&&alog("http://webmap2.map.bdstatic.com/newmap/static/common/pkg/exception.fire","catch",{msg:e.message||e.description,path:"common:widget/com/NavWalk/NavWalk.js",ln:125})}},initialize:function(){try{var t=this.json;2!=searchBox._curSelIndex&&searchBox.setSwitchTab(2);var e=t.result.end[t.result.end.length-1];searchBox.setValue("BusSearchSta"http://webmap2.map.bdstatic.com/newmap/static/common/pkg/,null==t.result.start.wd?"":t.result.start.wd),searchBox.setValue("BusSearchEnd"http://webmap2.map.bdstatic.com/newmap/static/common/pkg/,null==e.wd?"":e.wd),searchBox.busSSG1&&searchBox.busSSG1.setValue(document.fmbus.word_from.value),searchBox.busSSG2&&searchBox.busSSG2.setValue(document.fmbus.word_to.value),this.isMainRequest===!1&&(window.currentComponent.modelQuery=this.modelQuery),searchBox.driveSSG1?searchBox.driveSSG1.setValue(this.start.wd):searchBox.setValue("DriveSearchSta",this.start.wd),searchBox.driveSSG2?searchBox.driveSSG2.setValue(this.end.wd):document.fmnav.word_to.value=this.end.wd;var i=this.generateNavMapData();if(this.navMap=new NavMap(i),this.navMap.drawLine(),!this.total)return;window.trafficMgr&&window.trafficMgr.setTrafficDiv(),window.searchInViewCtrl&&window.searchInViewCtrl.exit(),this.navMap.addWalkIcon(this.json.content.rss),this.navMap.addDrPoi(),this.navMap.addPopInfoWin(),this.navListView.initialize(),this._binder(),this.processState(),map.mapType==BMAP_TYPE_DIMENSIONAL&&this.navWalkFor3D(!1),setComplaintCenterURL(map,this),SchemeFaver.isRepeat.call(this,{pathtype:2,dom:T.G("driveFavBtn")}),BoxContainer&&BoxContainer.resetStatus(),this.json.content&&PanoUtil.isPanoStatus()&&PanoUtil.closePano("search"),window.weipaiTool&&window.weipaiTool.resetStatus(),mapInfoScrollPanel?mapInfoScrollPanel.show():T.g("MapInfo").style.overflowY="auto"}catch(n){"undefined"!=typeof alog&&alog("http://webmap2.map.bdstatic.com/newmap/static/common/pkg/exception.fire","catch",{msg:n.message||n.description,path:"common:widget/com/NavWalk/NavWalk.js",ln:223})}},unload:function(){window.cxtBusPoints=null,window.startPoi=null,window.endPoi=null,window.dropRoutes=[],this.navMap.unload(),this.navListView&&this.navListView.unload(),MapComponent.prototype.unload.apply(this)},generateNavListData:function(){var t=this.json.content.kps,e=this.json.content.rss,i={type:"walk",hidePrint:!0,hideSms:!0,extInfo:this.getExtInfo(),start:{name:this.start.wd,uid:this.start.uid,points:mapUtil.parse2Geo(t[0].pt).points,poiType:"FF0301",direction:t[0].a},end:{name:this.end.wd,uid:this.end.uid,points:mapUtil.parse2Geo(t[t.length-1].pt).points,poiType:"FF0302",direction:t[t.length-1].a},routes:[],showScrollPanel:!1},n=[];n.hasSubList=!1;for(var a=0;a<t.length;a++){var s=t[a].rt,r=parseInt(e[a].d),o="";if(o=10>=r?"10米":1e3>r?10*(r/10).toFixed(0)+"米":(r/1e3).toFixed(1)+"公里",0==a){var p=this.getTurStr(t[a].tt,e[a].wt,t[a].extt);n.push({title:"从<span>起点</span>向"+p+"出发，",points:mapUtil.parse2Geo(t[a+1].pt).points,direction:t[a+1].a})}else if(1==a){var d=this.getPreRoadStr(e[a],a>0?e[a-1]:null),l=T.trim(e[a+1].n);d=""==d?this.roadtype[e[a].t]:d,l=""==l?this.roadtype[e[a+1].t]:l;var h="进入",u=e[a+1].t;9==u||12==u?h="上":(0==u||u>=22||e[a].n==e[a+1].n&&1!=u)&&(h="",l=""),(9==t[a].tt||10==t[a].tt||11==t[a].tt||12==t[a].tt)&&(h="",l="");var p=this.getTurStr(t[a].tt,e[a].wt,t[a].extt),c=20==e[a].t||21==e[a].t?"<span>离开"+e[a].n+"</span>，":"",v=e[a].t>=22?"":this.rettype[t[a].rt]+o;if(n[0].title+=d+v+"，"+c+"<span>"+p+"</span>"+h+"<span>"+l+"</span>",3==t[a+1].rt){var s=t[a+1].rt,m=this.rettype[s];n[0].title+="到达<span>"+m+"</span>"}}else if(a==t.length-2){var d=this.getPreRoadStr(e[a],a>0?e[a-1]:null);d=""==d?this.roadtype[e[a].t]:d;var c="",p=this.getTurStr(t[a].tt,e[a].wt,t[a].extt),v=e[a].t>=22?"":this.rettype[t[a].rt]+o;n.push({title:d+v+c+p,points:mapUtil.parse2Geo(t[a].pt).points,direction:t[a].a})}else if(a==t.length-1&&2==s)t.length>3?n[n.length-1].title+="，到达<strong>终点</strong></td>":(3==t.length&&0!=e[1].wt&&(n[n.length-1].title+="，"),n[n.length-1].title+="到达<strong>终点</strong></td>");else if(a<t.length-2&&3!=s){var d=this.getPreRoadStr(e[a],a>0?e[a-1]:null),l=e[a+1].n;d=""==d?this.roadtype[e[a].t]:d,l=""==l?this.roadtype[e[a+1].t]:l,d=T.trim(d),l=T.trim(l);var s=t[a+1].rt,h="进入",u=e[a+1].t;9==u||12==u?h="上":(0==u||u>=22||e[a].n==e[a+1].n&&1!=u)&&(h="",l=""),(9==t[a].tt||10==t[a].tt||11==t[a].tt||12==t[a].tt)&&(h="",l="");var f="";if(3==s){var m=this.rettype[s];f=d+this.rettype[t[a].rt]+o+"，到达<span>"+m+"</span></td>"}else{var p=this.getTurStr(t[a].tt,e[a].wt,t[a].extt),c=20==e[a].t||21==e[a].t?"<span>离开"+e[a].n+"</span>，":"",v=e[a].t>=22?"":this.rettype[t[a].rt]+o;f=d+v+"，"+c+"<span>"+p+"</span>"+h+"<span>"+l+"</span></td>"}n.push({title:f,points:mapUtil.parse2Geo(t[a].pt).points,direction:t[a].a})}}return i.routes.push(n),i},generateNavMapData:function(){var t=[],e=[],i=[],n=[],a=[],s=[],r=this.json.content.kps,o=this.json.content.rss,p={drag:this.drag,total:this.total,start:this.start,end:this.end,sCity:this.sCity,eCity:this.eCity,driveBounds:t,drivePoints:e,routePoints:i,popPoints:n,dragPoints:a,popInfos:s,currentCity:this.currentCity};if(!r||!o)return p;for(var d=0;d<r.length;d++){var l=r[d].rt,h=parseInt(o[d].d),u="";if(u=10>=h?"10米":1e3>h?10*(h/10).toFixed(0)+"米":(h/1e3).toFixed(1)+"公里",0==d){a.push({p:mapUtil.parse2Geo(r[d].pt).points,n:this.startName}),n.push({p:this.start.pt,a:-1});var c=T.trim(o[d+1].n);c=""==c?this.roadtype[o[d+1].t]:c,s.push({title:this.startName,info:"",next:c||this.noName});var v=T.trim(o[d+1].n);v=""==v?this.roadtype[o[d+1].t]:c;var m=T.trim(o[d+2].n);m=""==m?this.roadtype[o[d+2].t]:m;var f="进入",g=o[d+2].t;9==g||12==g?f="上":(0==g||g>=22||o[d+1].n==o[d+2].n&&1!=g)&&(f="",m="");var y=parseInt(o[d+1].d),w="";if(10>=y?w="10米":y>10&&(w=1e3>y?10*(y/10).toFixed(0)+"米":(y/1e3).toFixed(1)+"公里"),n.push({p:mapUtil.parse2Geo(r[d].pt).points,a:r[d].a}),d+2==r.length-1)s.push({title:v||this.noName,info:this.rettype[r[d+1].rt]+w,next:"路口"});else{l=r[d+2].rt,3==l&&(m=T.trim(o[d+1].n),m=""==m?this.roadtype[o[d+2].t]:m,m="到达"+this.rettype[l]);var _=this.getTurStr(r[d+1].tt,o[d+1].wt,r[d+1].extt);s.push({title:v||this.noName,info:this.rettype[r[d+1].rt]+w+"，"+_+f+m,next:m||this.noName})}}else if(1==d){var x=this.getPreRoadStr(o[d],d>0?o[d-1]:null),c=T.trim(o[d+1].n);x=""==x?this.roadtype[o[d].t]:x,c=""==c?this.roadtype[o[d+1].t]:c;var f="进入",g=o[d+1].t;9==g||12==g?f="上":(0==g||g>=22||o[d].n==o[d+1].n&&1!=g)&&(f="",c=""),(9==r[d].tt||10==r[d].tt||11==r[d].tt||12==r[d].tt)&&(f="",c="");var _=this.getTurStr(r[d].tt,o[d].wt,r[d].extt),C=(20==o[d].t||21==o[d].t?"<span>离开"+o[d].n+"</span>，":"",o[d].t>=22?"":this.rettype[r[d].rt]+u,mapUtil.parse2Geo(o[d].g));e.push(C.points),t.push(C.bound),i[i.length]||(i[i.length]=[]),i[i.length-1].push({p:C.points,d:h,b:C.bound});var v=T.trim(o[d+1].n);v=""==v?this.roadtype[o[d].t]:x;var m="",f="进入";if(o[d+2]){m=T.trim(o[d+2].n),m=""==m?this.roadtype[o[d+1].t]:m;var g=o[d+2].t;9==g||12==g?f="上":(0==g||g>=22||o[d+1].n==o[d+2].n&&1!=g)&&(f="",m="")}var y=parseInt(o[d+1].d),w="";if(10>=y?w="10米":y>10&&(w=1e3>y?10*(y/10).toFixed(0)+"米":(y/1e3).toFixed(1)+"公里"),n.push({p:mapUtil.parse2Geo(r[d].pt).points,a:r[d].a}),d+1==r.length-1)s.push({title:"路口",info:this.rettype[r[d+1].rt],next:"终点"});else if(d+1==r.length-2)s.push({title:c||this.noName,info:this.rettype[r[d+1].rt]+w,next:"路口"});else if(3==r[d+2].rt){var l=r[d+2].rt,S=this.rettype[l];s.push({title:c||this.noName,info:this.rettype[r[d+1].rt]+w+"，到达"+S,next:m||this.noName})}else{var l=r[d+1].rt;if(3==l&&d+2==r.length){c=x;var N=parseInt(o[d+2].d),b="";N>0&&10>=N?b="10米":N>10&&(b=1e3>N?10*(N/10).toFixed(0)+"米":(N/1e3).toFixed(1)+"公里"),k=this.rettype[r[d+2].rt]+b+"，到达路口"}else{c=T.trim(o[d+2].n);var N=parseInt(o[d+1].d),b="";if(N>0&&10>=N?b="10米":N>10&&(b=1e3>N?10*(N/10).toFixed(0)+"米":(N/1e3).toFixed(1)+"公里"),d+2==r.length-2)if(3==l){x=T.trim(o[d].n),m="路口";var N=parseInt(o[d+2].d),b="";N>0&&10>=N?b="10米":N>10&&(b=1e3>N?10*(N/10).toFixed(0)+"米":(N/1e3).toFixed(1)+"公里");var _=this.getTurStr(r[d+1].tt,o[d+2].wt,r[d+1].extt);k=this.rettype[r[d].rt]+b+","+_+"，到达路口"}else{x=T.trim(o[d+1].n),m=T.trim(o[d+2].n);var _=this.getTurStr(r[d+1].tt,o[d+1].wt,r[d+1].extt);k=this.rettype[r[d].rt]+b+","+_}else if(3==l){x=T.trim(o[d].n),x=""==x?this.roadtype[o[d].t]:x,m=T.trim(o[d+3].n),m=""==m?this.roadtype[o[d+3].t]:m;var N=parseInt(o[d+2].d),b="";N>0&&10>=N?b="10米":N>10&&(b=1e3>N?10*(N/10).toFixed(0)+"米":(N/1e3).toFixed(1)+"公里");var g=o[d+3].t;9==g||12==g?f="上":0==g&&(f=""),(9==r[d].tt||10==r[d].tt||11==r[d].tt||12==r[d].tt)&&(f="",m="");var _=this.getTurStr(r[d].tt,o[d].wt,r[d].extt);k=this.rettype[r[d].rt]+b+"，"+_+f+m}else{x=T.trim(o[d+1].n),x=""==x?this.roadtype[o[d].t]:x,m=T.trim(o[d+2].n),m=""==m?this.roadtype[o[d+2].t]:m,(9==r[d+1].tt||10==r[d+1].tt||11==r[d+1].tt||12==r[d+1].tt||o[d+2].t>=22)&&(f="",m="");var _=this.getTurStr(r[d+1].tt,o[d+1].wt,r[d+1].extt);k=this.rettype[r[d].rt]+b+","+_+f+m}}s.push({title:x||this.noName,info:k,next:m||this.noName})}}else if(d==r.length-2){var C=mapUtil.parse2Geo(o[d].g);e.push(C.points),i[i.length-1].push({p:C.points,d:h,b:C.bound}),t.push(C.bound);var v=T.trim(o[d+1].n);v=""==v?this.roadtype[o[d].t]:x;var y=parseInt(o[d+1].d),w="";10>=y?w="10米":y>10&&(w=1e3>y?10*(y/10).toFixed(0)+"米":(y/1e3).toFixed(1)+"公里"),n.push({p:mapUtil.parse2Geo(r[d].pt).points,a:r[d].a}),s.push({title:"路口",info:"前往终点",next:this.endName})}else if(d==r.length-1&&2==l)a.push({p:mapUtil.parse2Geo(r[d].pt).points,n:this.endName}),n.push({p:this.end.pt,a:-1}),s.push({title:this.endName,info:"",next:""});else if(d<r.length-2)if(3!=l){var C=mapUtil.parse2Geo(o[d].g);e.push(C.points),i[i.length-1].push({p:C.points,d:h,b:C.bound}),t.push(C.bound);var v=T.trim(o[d+1].n);v=""==v?this.roadtype[o[d+1].t]:x;var m=T.trim(o[d+2].n);m=""==m?this.roadtype[o[d+2].t]:m;var f=""==this.roadtype[o[d+2].t]?"":"进入",y=parseInt(o[d+1].d),w="";10>=y?w="10米":y>10&&(w=1e3>y?10*(y/10).toFixed(0)+"米":(y/1e3).toFixed(1)+"公里"),n.push({p:mapUtil.parse2Geo(r[d].pt).points,a:r[d].a});var k="";if(d==r.length-3&&(k="到达路口",m="路口"),3==r[d+2].rt){var l=r[d+2].rt,S=this.rettype[l],m=T.trim(o[d+3].n);s.push({title:c||this.noName,info:this.rettype[r[d+1].rt]+w+"，到达"+S,next:m||this.noName})}else if(3==r[d+1].rt){S=this.rettype[l];var y=parseInt(o[d+2].d),w="";10>=y?w="10米":y>10&&(w=1e3>y?10*(y/10).toFixed(0)+"米":(y/1e3).toFixed(1)+"公里"),c=T.trim(o[d].n);var m=T.trim(o[d+3].n),f=""==this.roadtype[o[d+3].t]?"":"进入";(9==r[d+2].tt||10==r[d+2].tt||11==r[d].tt||12==r[d].tt||o[d+1].n==o[d+3].n||o[d+3].t>=22)&&(f="",m="");var _=this.getTurStr(r[d+2].tt,o[d+2].wt,r[d+2].extt);s.push({title:c||this.noName,info:this.rettype[r[d+2].rt]+w+"，"+_+f+m+k,next:m||this.noName})}else{(9==r[d+1].tt||10==r[d+1].tt||11==r[d+1].tt||12==r[d+1].tt||o[d+2].t>=22)&&(f="",m=""),2==r[d+2].rt&&(f="到达",m="路口");var _=this.getTurStr(r[d+1].tt,o[d+1].wt,r[d+1].extt);s.push({title:c||this.noName,info:this.rettype[r[d+1].rt]+w+","+_+f+m,next:m||this.noName})}}else{var S=T.trim(o[d+1].n);S=S||this.noName,a.push({p:mapUtil.parse2Geo(r[d].pt).points,n:S}),i[i.length]||(i[i.length]=[])}}return p},_binder:function(){var t=this;this.navListView.addEventListener("kmclick",function(){t.navMap.resetDrv()}),this.navListView.addEventListener("h3click",function(e,i){t.navMap.clickStop(i)}),this.navListView.addEventListener("mainlistclick",function(e,i){t.navMap.highRoute(i.groupIndex)}),this.navListView.addEventListener("mainlistmouseover",function(e,i){t.navMap.addTips(i.groupIndex)}),this.navListView.addEventListener("mainlistmouseout",function(){t.navMap.removeTips()}),this.navListView.addEventListener("panodataready",function(e,i){t.navMap.updatePanoPopWins(i)}),this.navMap.addEventListener("poiinfoopen",function(e,i){t.navListView.hightLightTitle(i.index)}),this.$el.find("#driveFavBtn").click(function(e){t.addToFav(this,e)}),this.$el.find("#routeReturn").click(function(){t.returnDr()}),this.$el.find("#routeNav").click(function(){t.navigate()}),this.$el.find("#routeBus").click(function(){t.busChange()})},processState:function(){var t=this;if(void 0!=t.cinfo._index){var e=t.cinfo._index.split(",");if(isNaN(e[0]))return;t.navMap.highRoute(parseInt(e[0]),parseInt(e[1])),t.cinfo._index=null}if(void 0!=t.cinfo._popIndex){var i=parseInt(t.cinfo._popIndex),n=t.navMap.popPoints[i].p,a=t.navMap.popPoints[i].a,s=t.navMap.popWins[i];if(0!=i&&i!=t.navMap.popPoints.length-1){var r=mapUtil.addDrvDirIcon(n,a);r.addEventListener("click",t.navMap.getClickMarker(s,r,i)),r.openInfoWindow(s),t.navMap.popPois.push(r)}else 0==i?t.navMap.clickStop(null,0):i==t.popPoints.length-1&&t.navMap.clickStop(null,1)}},getTurStr:function(t,e,i){var n=["","直走","向右前方转","右转","向右后方转","向后转","向左后方转","左转","向左前方转","左转穿过马路继续向前","右转穿过马路继续向前","左转穿过马路往回走","右转穿过马路往回走","正北方向","东北方向","正东方向","东南方向","正南方向","西南方向","正西方向","西北方向","经#WalkType#穿过马路并往回走","经#WalkType#穿过马路并继续向前","到路口斜对面并继续向前","到路口斜对面，向左前方转","到路口斜对面，左转","到路口斜对面，向左后方转","到路口斜对面，向右前方转","到路口斜对面，右转","到路口斜对面，向右后方转","到路口斜对面，直走","继续向前","向左前方转过#WalkType#","左转过#WalkType#","向左后方转过#WalkType#","向右前方转过#WalkType#","右转过#WalkType#","向右后方转过#WalkType#","直走过#WalkType#","继续向前"],a=["","直走","向右前方转","右转","向右后方转","向后转","向左后方转","左转","向左前方转"],s="";if(e>0){var r=i>0?21==t||22==t?"<span>"+a[i]+"</span>，":"<span>"+a[i]+"过"+this.worktype[e]+"</span>，":"<span>过"+this.worktype[e]+"</span>，";t>0&&13>t?s=r+n[t]:t>=21?s=r+n[t].replace(/#WalkType#/gi,"<span>"+this.worktype[e]+"</span>"):(s="<span>"+a[i]+"过"+this.worktype[e]+"</span>",0!=t&&(s+="，"))}else s=n[t].replace(/#WalkType#/gi,"<span>"+this.worktype[e]+"</span>");return s},getPreRoadStr:function(t,e){var i=e&&t.n==e.n?"继续":"",n=""==t.n?this.roadtype[t.t]:"过街天桥"==t.n?"天桥":t.n,a=t.t>=22?"过":"沿";return 0==t.d?0==t.wt?""==n?"":"至<span>"+n+"</span>":"过<span>"+this.worktype[t.wt]+"</span>至<span>"+n+"</span>":""==this.roadtype[t.t]?"":i+a+"<span>"+n+"</span>"},navWalkFor3D:function(t){var e=this;MapConfig.navWalk.enableDragging=!t,window.startPoi&&(window.startPoi.enableDragging(t),t||window.startPoi.addEventListener("domready",function(){window.startPoi.getDom().innerHTML=""})),window.endPoi&&(window.endPoi.enableDragging(t),t||window.endPoi.addEventListener("domready",function(){window.endPoi.getDom().innerHTML=""})),t?e.tipLabel&&map.addOverlay(e.tipLabel):e.tipLabel&&map.removeOverlay(e.tipLabel)},getExtInfo:function(){var t,e=this.json.content.dis;t=10>e?"10米":1e3>e?10*(e/10).toFixed(0)+"米":(e/1e3).toFixed(1)+"公里";var i="";return t&&(i+=t),i="约"+i},addToFav:function(t,e){util.stopBubble(window.event||e),SyncMgr.checkFav(function(){SchemeFaver.toClound.call(this,{pathtype:2,dom:t})},this)},navigate:function(){var t=this;t.cinfo&&1==t.cinfo.isSingle&&(t.cinfo.q=t.cinfo.q.replace(/^bse&/,"nse&")),componentManager.go("nav&navtp=0&c="+t.currentCity+"&sy=0&drag=0&sc="+t.sCity.code+"&st=1&ec="+t.eCity.code+"&et=1&sn=1$$$$"+t.start.pt+"$$"+encodeURIComponent(t.start.wd)+"$$$$$$&en=1$$$$"+t.end.pt+"$$"+encodeURIComponent(t.end.wd)+"$$$$$$&sq="+encodeURIComponent(t.s_query)+"&eq="+encodeURIComponent(t.e_query),{cinfo:t.cinfo})},returnDr:function(){var t=this;t.cinfo&&1==t.cinfo.isSingle&&(t.cinfo.t=0==t.cinfo.t?1:0),componentManager.go("walk&version=2.0&navtp=1&c="+t.currentCity+"&drag=0&sc="+t.eCity.code+"&ec="+t.sCity.code+"&sy="+t.strategy+"&en=1$$$$"+t.start.pt+"$$"+encodeURIComponent(t.start.wd)+"$$&sn=1$$$$"+t.end.pt+"$$"+encodeURIComponent(t.end.wd)+"$$&sq="+encodeURIComponent(t.e_query)+"&eq="+encodeURIComponent(t.s_query),{cinfo:t.cinfo})},busChange:function(){var t=this,e=t.start.uid,i=t.end.uid,n=1==t.sBus?0:1,a=1==t.eBus?0:1,s="dep",r="",o=5;t.cinfo&&1==t.cinfo.isSingle&&(t.cinfo.q=t.cinfo.q.replace(/^nse&/,"bse&")),componentManager.go("bt&bttp=1&c="+t.currentCity+"&sn="+n+"$$"+e+"$$"+t.start.pt+"$$"+encodeURIComponent(t.start.wd)+"$$&en="+a+"$$"+i+"$$"+t.end.pt+"$$"+encodeURIComponent(t.end.wd)+"$$&sq="+encodeURIComponent(t.s_query)+"&eq="+encodeURIComponent(t.e_query)+"&exptype="+s+"&exptime="+r+"&version="+o,{cinfo:t.cinfo})},getOverlays:function(){return this.navMap.exportOverlays}}),module.exports=NavWalk});
;define("common:widget/com/NavWalk/NavMap.js",function(t,e,i){function o(t){T.lang.Class.call(this),this.noName="未知路段",this.sended=0,this.popWins=[],this.popPois=[],this.walkMkrs=[],this.ajax=new T.Ajax,this.ajax.async=!0,this.queryWalk=[],this.strategy=0,this.tipLabel=r.createDrvMidLabel("拖动以更改路线"),window.dropRoutes=[],this.exportOverlays={drRoutes:[],destMarkers:[]},this.mapZoomLevel=map.zoomLevel,T.object.extend(this,t),map.clearOverlays()}var n=t("common:widget/com/componentManager.js"),a=t("common:widget/ui/util/util.js"),s=t("common:widget/ui/constant/Constant.js"),r=t("common:widget/ui/mapUtil/mapUtil.js"),d=t("common:widget/ui/transInfoWindow/transInfoWindow.js"),p=t("common:widget/ui/config/config.js"),h=p.mapConfig,g=p.modelConfig,u=t("common:widget/ui/PanoEntranceUtil/PanoEntranceUtil.js"),l=t("common:widget/ui/mapShare/MapShare.js");T.inherits(o,T.lang.Class,"NavMap"),T.object.extend(o.prototype,{drawLine:function(){var t=this;if(!t.total||0==t.total){t.dragPoints.push({p:t.start.pt,n:t.start.wd});var e=r.addDestPoi(t.start.pt,"",s.DEST_START);return e.enableDragging(!0),e.addEventListener("ondragging",function(e){t.addViaRoute2(e,1)}),e.addEventListener("onmouseover",function(e){t.onViaPoiOver(e,1)}),e.addEventListener("onmouseout",function(e){t.onRemoveTips(e,1)}),e.addEventListener("ondragend",function(e){t.addViaPoi2(e,1)}),e.index=0,window.startPoi=e,window.startPoi._sc=t.sCity.code,t.dragPoints.push({p:t.end.pt,n:t.end.wd}),e=r.addDestPoi(t.end.pt,"",s.DEST_END),e.addEventListener("ondragging",function(e){t.addViaRoute2(e,2)}),e.addEventListener("onmouseover",function(e){t.onViaPoiOver(e,2)}),e.addEventListener("onmouseout",function(e){t.onRemoveTips(e,2)}),e.addEventListener("ondragend",function(e){t.addViaPoi2(e,2)}),e.index=1,e.enableDragging(!0),window.endPoi=e,void(window.endPoi._ec=t.eCity.code)}r.addDrRoute(!1,this),this.exportOverlays.drRoutes.push({flag:!1,obj:this})},unload:function(){},addDrPoi:function(){for(var t=this.dragPoints,e=t.length,i=this,o=0;e>o;o++){var n;0==o?(n=r.addDestPoi(this.start.pt,"",s.DEST_START),this.exportOverlays.destMarkers.push({point:this.start.pt,text:"",type:s.DEST_START}),n.addEventListener("ondragging",function(t){i.addViaRoute2(t,1)}),n.addEventListener("onmouseover",function(t){i.onViaPoiOver(t,1)}),n.addEventListener("onmouseout",function(t){i.onRemoveTips(t,1)}),n.addEventListener("ondragend",function(t){i.addViaPoi2(t,1)}),window.startPoi=n,window.startPoi._sc=i.sCity.code):o==e-1&&(n=r.addDestPoi(this.end.pt,"",s.DEST_END),this.exportOverlays.destMarkers.push({point:this.end.pt,text:"",type:s.DEST_END}),n.addEventListener("ondragging",function(t){i.addViaRoute2(t,2)}),n.addEventListener("onmouseover",function(t){i.onViaPoiOver(t,2)}),n.addEventListener("onmouseout",function(t){i.onRemoveTips(t,2)}),n.addEventListener("ondragend",function(t){i.addViaPoi2(t,2)}),window.endPoi=n,window.endPoi._ec=i.eCity.code),this.dragPois||(this.dragPois=[]),n.addEventListener("ondragstart",function(t){i.dragViaPoi(t)}),n.enableDragging(!0),n.index=o,this.dragPois.push(n)}},addPopInfoWin:function(){for(var t=this.popPoints.length,e=0;t>e;e++)this.popWins.push(d.createTransInfoWnd({title:this.popInfos[e].title,content:this.popInfos[e].info,curIndex:e,total:t,obj:this,nextInfo:this.popInfos[e].next,nextTransCbk:this.nextTransCbk,zoomTransCbk:this.zoomTransCbk}));var i=this,o=this.popWins[0];i.openSWin=function(){i.getClickMarker(o,i.dragPois[0],0)()};var n=this.popWins[this.popWins.length-1];i.openEWin=function(){i.getClickMarker(n,i.dragPois[i.dragPois.length-1],i.dragPois.length-1)()},this.dragPois&&(this.dragPois[0].addEventListener("click",i.openSWin),this.dragPois[this.dragPois.length-1].addEventListener("click",i.openEWin))},addPopPoi:function(t){for(var e=0;e<this.popPois.length;e++)map.removeOverlay(this.popPois[e]),this.popPois[e]=null;if(this.popPois=[],!this.popPois.length){if(null!=t&&!isNaN(t)){var i=this.popPoints[t+1].p.toString(),o=this.popPoints[t+2].p.toString(),n=parseInt(this.popPoints[t+1].a),a=parseInt(this.popPoints[t+2].a),s=r.addDrvDirIcon(i,n);t+2==this.popPoints.length-2&&(a=12);var d=r.addDrvDirIcon(o,a),p=this.popWins[t+1],h=this.popWins[t+2];s.addEventListener("click",this.getClickMarker(p,s,t+1)),d.addEventListener("click",this.getClickMarker(h,d,t+2))}s.disableDragging(),d.disableDragging(),this.popPois.push(s),this.popPois.push(d)}},addWalkIcon:function(t){this.walkMkrs=[];for(var e=0,i=t.length;i>e;e++)this._addWalkIcon(t[e])},_addWalkIcon:function(t){function e(){map.getZoom()<16?T.browser.ie>=8?setTimeout(function(){p&&p.hide()},100):p&&p.hide():p&&p.show()}if(t.ipt){var i=r.parse2Geo(t.ipt).points,o=a.getPoiPoint(i);if(o&&0!=o.lng&&0!=o.lat){var n=[{wd:"非步行设施"},{wd:"人行道"},{wd:"天桥",img:[0,-20],w:18},{wd:"地下通道",img:[0,0],w:18},{wd:"人行通道"},{wd:"直梯"},{wd:"扶梯"},{wd:"阶梯"},{wd:"斜坡"},{wd:"索道"},{wd:"广场",img:[0,-40],w:18},{wd:"公园"}],s=null;if(1*t.t>19&&1*t.t<25)switch(1*t.t){case 20:case 21:s=n[1*t.t-10];break;case 23:s=n[2];break;case 24:s=n[3]}else s=n[1*t.wt];if(s&&s.img){var d=new BMap.Icon("../images/walkflag_16127a7.png"/*tpa=http://webmap2.map.bdstatic.com/newmap/static/common/images/walkflag_16127a7.png*/,new BMap.Size(s.w,s.w),{offset:new BMap.Size(s.w/2,s.w/2),imageOffset:new BMap.Size(s.img[0],s.img[1])}),p=new BMap.Marker(o,{icon:d});map.addOverlay(p),this.walkMkrs.push(p),map.getZoom()<16?p.hide():p.show(),map.addEventListener("zoomend",e),p.addEventListener("remove",function(){map.removeEventListener("zoomend",e)});var h=new BMap.Label(s.wd);map.addOverlay(h),h.setStyle({backgroundColor:"#EEFFED",borderColor:"#6D8760",color:"#4D6B37",lineHeight:"16px",paddingTop:"0px",paddingBottom:"0px"}),h.setPoint(o),h.setOffset(new BMap.Size(1*s.w/2+2,0-1*s.w/2)),h.hide();var g=!1;p.addEventListener("onmouseover",function(){g=!0,setTimeout(function(){g&&h.show()},500)}),p.addEventListener("onmouseout",function(){h.hide(),g=!1})}}}},onRemoveTips:function(){if(this.tipLabel&&map.removeOverlay(this.tipLabel),this.dragVia&&this.dragVia.isVisible()){var t=this.dragVia.getDom().style;t&&(this.dragVia.getDom().style.visibility="hidden")}},removeTimer:function(){this.distime&&window.clearTimeout(this.distime)},dragViaPoi:function(t){var e=this;e.dateStart=(new Date).getTime(),e.removeTimer(t)},onViaPoiOver:function(t,e){if(!this.draging&&window.dropRoutes){var i=t.target.index;switch(e){case 0:this.tempDrag=[window.dropRoutes[i-1],window.dropRoutes[i]];break;case 1:this.tempDrag=[window.dropRoutes[i]];break;case 2:this.tempDrag=[window.dropRoutes[i-1]]}}h.navWalk.enableDragging&&t.target.setLabel(this.tipLabel)},removeDraw:function(){var t=this;if(t.tempDrag&&t.tempDrag.length>0)for(var e=0;e<t.tempDrag.length;e++){var i=t.tempDrag[e];i&&r.removeRoute(i)}},addViaPoi2:function(t,e,i){var o=this;if(1!=o.dflag){o.ajax.duration=1,o.ajax.onsuccess=null,o.draging=!1,o.sended=1;var a=t?t.target:i;a.dis=0;var s=a.index;if(!o.queryWalk||!o.queryWalk.length)return;var r=(o.queryWalk[o.queryWalk.length-1],a.point.lng+","+a.point.lat),d=r,p=a.viaName;p=p||o.noName;var h="",g="",u="";o.dragPoints.splice(s,1,{p:r,n:a.viaName});for(var l=1;l<o.dragPoints.length-1;l++)g+="1$$$$"+o.dragPoints[l].p+"$$$$+to:",u+="0 +to:";switch(e){case 0:h="walk&version=2.0&c="+o.currentCity+"&drag=1&sc="+o.sCity.code+"&ec="+u+o.eCity.code+"&sy="+o.strategy+"&sn=1$$$$"+o.popPoints[1].p+"$$"+encodeURIComponent(o.start.wd)+"$$"+o.start.pt+"$$$$&st=0&en="+g+"1$$$$"+o.popPoints[o.popPoints.length-2].p+"$$"+encodeURIComponent(o.end.wd)+"$$"+o.end.pt+"$$&et=0";break;case 1:h="walk&version=2.0&c="+o.currentCity+"&drag=1&sc="+o.sCity.code+"&ec="+u+o.eCity.code+"&sy="+o.strategy+"&sn=1$$$$"+r+"$$"+encodeURIComponent(p)+"$$"+d+"$$&st=1&en="+g+"1$$$$"+o.end.pt+"$$"+encodeURIComponent(o.end.wd)+"$$&et=0&de=1";break;case 2:h="walk&version=2.0&c="+o.currentCity+"&drag=1&sc="+o.sCity.code+"&ec="+u+o.eCity.code+"&sy="+o.strategy+"&sn=1$$$$"+o.start.pt+"$$"+encodeURIComponent(o.start.wd)+"$$&st=0&en="+g+"1$$$$"+r+"$$"+encodeURIComponent(p)+"$$"+d+"$$&et=1&de=1"}n.go(h),o.dflag=1,o.dragpt=""}},addViaRoute2:function(t,e){for(var i=0,o=this.walkMkrs.length;o>i;i++)this.walkMkrs[i]&&this.walkMkrs[i].hide();this.dateEnd=(new Date).getTime();var n=this.dateEnd-this.dateStart,a=t.target.index,s=t.target;s.failure=0,n>10&&this.dragPois&&(this.dragPois[0].removeEventListener("click",this.openSWin),this.dragPois[this.dragPois.length-1].removeEventListener("click",this.openEWin));var r=s.point,d="",p=1,h=1;switch(this.sp="",this.ep="",e){case 0:this.sp=this.dragPoints[a-1].p,this.ep=this.dragPoints[a+1].p;break;case 1:this.ep=this.dragPoints[a+1].p;break;case 2:this.sp=this.dragPoints[a-1].p}p=1,h=1,d="wdrag&sy="+this.strategy+"&pt="+r.lng+","+r.lat+"&sn="+this.sp+"&st="+p+"&en="+this.ep+"&et="+h+"&r=5000";var g={url:d,flag:0,dragpt:r};if(this.ajax.duration=-1,this.draging){n>2e3&&(this.timeout&&clearTimeout(this.timeout),this.dateStart=(new Date).getTime(),this.dragRequest2(g,a,e,s),this.queryWalk.push(g));var u=this;this.timeout=setTimeout(function(){if(u.queryWalk&&u.queryWalk.length){var t=u.queryWalk[u.queryWalk.length-1];t&&0==t.flag&&u.queryWalk&&!u.draging&&0==u.dflag&&u.dragRequest2(t,a,e,s)}},3e3)}else this.dragRequest2(g,a,e,s),this.queryWalk.push(g)},dragRequest2:function(t,e,i,o){var n=this;n.draging=!0,this.sended=0;var a=Math.pow(2,BMap.MapType[map.mapType].zoomLevelMax-map.zoomLevel-3);this.ajax.onsuccess=function(d){try{if(n.data=baidu.json.parse(d.responseText),n.data&&n.data.result&&0==n.data.result.error&&n.data.content){var p=n.data.result,h=n.data.content,g=r.parse2Geo(h.geo,a),u=g.points,l=h.name;("undefined"==typeof l||""==l)&&(l=n.noName),o.viaName=l,o.dis=h.dis,o.failure=0;var c=o.dis||0,m="0米",v=n.routePoints.length;if(1!=v&&1!=e)for(var f=0;v>f;f++){var w=n.routePoints[f];if(f!=e-1&&1!=i||f!=e&&1==i)for(var P=0;P<w.length;P++)c+=parseFloat(w[P].d)}if(m=10>c?"10米":1e3>c?10*(c/10).toFixed(0)+"米":(c/1e3).toFixed(1)+"公里",n.tipLabel.setContent(l+"("+m+")"),o.setLabel(n.tipLabel),n.dragpt=r.parse2Geo(h.dragpt).points,n.mousept=p.pt,n.popPois){for(var f=0;f<n.popPois.length;f++)map.removeOverlay(n.popPois[f]);n.popPois=null}if(n.tempDrag&&n.tempDrag.length>0)for(var f=0;f<n.tempDrag.length;f++){var k=n.tempDrag[f];k&&r.removeRoute(k)}if(n.tempDrag=[],1==i||2==i){var k=r.addRoute(u,s.ROUTE_TYPE_DRIVE);n.tempDrag.push(k),1==i?(k.index=e,window.dropRoutes.splice(e,1,k)):(k.index=e-1,window.dropRoutes.splice(e-1,1,k))}else for(var f=0;f<u.length;f++){var k=r.addRoute(u[f],s.ROUTE_TYPE_DRIVE);k.index=e-1+f,n.tempDrag.push(k),0==f?window.dropRoutes.splice(e-1,1,k):window.dropRoutes.splice(e-1+f,0,k)}n.draging=!1,n.dflag=0,t.flag=1}else o.failure=1,o.draging=!1,t.flag=0}catch(R){o.failure=1,o.draging=!1,t.flag=0}};var d=map.getBounds(),p=location.pathname+g.DATA_URL+t.url+"&ie=utf-8&l="+map.zoomLevel+"&b=("+d.minX+","+d.minY+";"+d.maxX+","+d.maxY+")&newmap=1&t="+(new Date).getTime();this.ajax.request(p)},onRouteOver:function(){},onRouteOut:function(){},onRouteMove:function(){},removeDrag:function(){},updatePanoPopWins:function(t){if(t&&t.length){var e=T.object.clone(t);e.unshift(e[0]),this.popWins=u.addPanoThumbnailsInInfoWnd(this.popWins,e,t,"walk")}},clickStop:function(t){if(0==t){var e=this.popWins[0];window.startPoi.openInfoWindow(e),l.popIndex=0}else{var e=this.popWins[this.popPoints.length-1];window.endPoi.openInfoWindow(e),l.popIndex=this.popPoints.length-1}},nextTransCbk:function(t,e){for(var i=e.popPoints[t].p,o=e.popPoints[t].a,n=e.popWins[t],a=0;a<e.popPois.length;a++)map.removeOverlay(e.popPois[a]),e.popPois[a]=null;if(e.dispatchEvent("poiinfoopen",{index:t-1}),t>0&&t<e.popPoints.length-1){t==e.popPoints.length-2&&(o=12);var s=r.addDrvDirIcon(i,o);s.addEventListener("click",e.getClickMarker(n,s,t)),e.popPois.push(s),s.openInfoWindow(n)}0==t&&window.startPoi?(window.startPoi.openInfoWindow(n),l.popIndex=0):t==e.popPoints.length-1&&window.endPoi&&(window.endPoi.openInfoWindow(n),l.popIndex=e.popPoints.length-1)},zoomTransCbk:function(t,e){var i=BMap.MapType[map.mapType].zoomLevelMax;map.zoomTo(0==t?i:e.mapZoomLevel!=map.zoomLevel?e.mapZoomLevel:i-3)},getClickMarker:function(t,e,i){return function(){l.popIndex=i,e.openInfoWindow(t)}},addTips:function(t,e){if(!this.draging){var i=Math.pow(2,BMap.MapType[map.mapType].zoomLevelMax-map.zoomLevel-3);this.tempRoute&&(r.unSelectRoute(this.tempRoute),r.removeRoute(this.tempRoute));var o=[];if(null==e||isNaN(e)){var n=r.cutPoints(this.drivePoints[t],i);o.push(this.popPoints[t+1].p),o.push(n)}else if(this.groupPoints[e])for(var a=0;a<this.groupPoints[e].length;a++){var n=r.cutPoints(this.groupPoints[e][a],i);o.push(n)}this.tempRoute=r.addRoute(o.join(";"),s.ROUTE_TYPE_DRIVE),r.selectRoute(this.tempRoute)}},removeTips:function(){this.tempRoute&&(r.unSelectRoute(this.tempRoute),r.removeRoute(this.tempRoute))},highRoute:function(t){if(map.closeInfoWindow(),this.mapZoomLevel=map.zoomLevel,null!=t&&this.driveBounds[t]){var e=[this.driveBounds[t]],i=a.getBPoints(e);r.setViewport(i,60)}r.addDrRoute(!0,this),this.addPopPoi(t),l.listIndex=t+",0",this.addTips(t)},resetDrv:function(){if(window.dropRoutes){for(var t=0;t<window.dropRoutes.length;t++){var e=window.dropRoutes[t];e&&r.removeRoute(e)}window.dropRoutes=[]}if(this.popPois){for(var t=0;t<this.popPois.length;t++)map.removeOverlay(this.popPois[t]);this.popPois=[]}r.addDrRoute(!1,this)}}),i.exports=o});