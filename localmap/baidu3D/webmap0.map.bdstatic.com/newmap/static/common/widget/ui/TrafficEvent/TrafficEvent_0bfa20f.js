define("common:widget/ui/TrafficEvent/TrafficEvent.js",function(e,t,i){var a=e("common:widget/ui/areaCfg/areaCfg.js"),n=e("common:widget/ui/config/config.js"),r=(n.mapConfig,n.modelConfig),o=function(){T.lang.Class.call(this),this.opened=!1,this.bindEvent=!1,this.ishide=!1,this.time="",this.markers=[],this.iconType="big",this.bigIconZoom=14,this.baseUrl="http://its.map.baidu.com:8001/showevents.php?qt=traeve_data",this.showCitys=[{code:a["北京"],minZoom:6,ename:"beijing"},{code:a["上海"],minZoom:6,ename:"shanghai"},{code:a["广州"],minZoom:6,ename:"guangzhou"}],this.ctrlTimer="",this.dataTimer="",this.curCityCode="",this.curDataTime="",this.preGetDataTime="",this.data=[],this.intervalTime=3e5,this.markers=[],this.mapEvent=null,this.initialize()};o.prototype=new BMap.Control,o.iconIndex=[0,1,2,0,0,3,4,0,5,0,6,7,8,9,9,10],T.extend(o.prototype,{initialize:function(){try{var e=this;e._cityZoomConfig={},e._cityEnameConfig={};for(var t=0;t<e.showCitys.length;t++)e._cityZoomConfig[e.showCitys[t].code]=e.showCitys[t].minZoom,e._cityEnameConfig[e.showCitys[t].ename]=e.showCitys[t].code}catch(i){"undefined"!=typeof alog&&alog("http://webmap0.map.bdstatic.com/newmap/static/common/widget/ui/TrafficEvent/exception.fire","catch",{msg:i.message||i.description,path:"common:widget/ui/TrafficEvent/TrafficEvent.js",ln:78})}},open:function(e){var t=this,e=e||{},i=e.cityName||"";if(19!=map.getZoom()){t.opened||t.bindEvent||t.bind(),t.opened=!0;for(var a=[],n=0;n<t.showCitys.length;n++)a.push(t.showCitys[n].code);if(t.markers&&t.markers.length&&map.getZoom()>=t.bigIconZoom&&"small"==t.iconType||map.getZoom()<t.bigIconZoom&&"big"==t.iconType)for(var n=0;n<t.markers.length;n++){var o=t.markers[n];o.setIcon(t.createIcon(o.trafficEveType))}t.doHideMark(i),t.ctrlTimer&&clearTimeout(t.ctrlTimer),t.ctrlTimer=setTimeout(function(){if(!t.doHideMark(i)){var e=(new Date).getTime(),a=e-t.preGetDataTime,n=i?t._cityEnameConfig[i]:r.cityCode;if(n==t.curCityCode&&a<t.intervalTime){if(t.ishide&&t.markers&&t.markers.length)for(var o=0;o<t.markers.length;o++){var s=t.markers[o];0==s.isVisible()?s.show():null}}else t.update({cityCode:n});t.ishide=!1}},300)}},doHideMark:function(e){e?this._cityEnameConfig[e]:r.cityCode;return map.getZoom()<6?(this.hide(),!0):!1},bind:function(){var e=this,t=function(){return window.trafficCtrl&&(trafficCtrl.opened||trafficCtrl.ishide&&1==trafficCtrl.ishide)?void e.open():void e.close()};e.mapEvent=t,map.addEventListener("load",t,"TrafficEvent"),map.addEventListener("moveend",t,"TrafficEvent"),map.addEventListener("resize",t,"TrafficEvent"),map.addEventListener("dragend",t,"TrafficEvent"),map.addEventListener("zoomend",t,"TrafficEvent"),e.bindEvent=!0},close:function(){var e=this;map.removeEventListener("load",e.mapEvent),map.removeEventListener("moveend",e.mapEvent),map.removeEventListener("resize",e.mapEvent),map.removeEventListener("dragend",e.mapEvent),map.removeEventListener("zoomend",e.mapEvent),e.hide(),e.removeMarker(),e.preGetDataTime="",e.curCityCode="",e.curDataTime="",e.bindEvent=!1,e.opened=!1},hide:function(){for(var e=this,t=0;t<e.markers.length;t++){var i=e.markers[t];i.isVisible()?i.hide():null}e.ishide=!0,e.ctrlTimer&&clearTimeout(e.ctrlTimer),e.dataTimer&&clearTimeout(e.dataTimer)},update:function(e){e=e||{};var t=e.cityCode||"",i=this;i.dataTimer&&clearTimeout(i.dataTimer);var a=t||r.cityCode;i.getData(a),i.dataTimer=setTimeout(function(){i.update()},i.intervalTime)},createIcon:function(e){var t=this,i=map.getZoom(),a=0,n=o.iconIndex[e]||0,r=22,s=20,m="../../../images/tfc_event_icon_f7bd599.png"/*tpa=http://webmap0.map.bdstatic.com/newmap/static/common/images/tfc_event_icon_f7bd599.png*/;t.iconType="big",i<t.bigIconZoom&&(a=22,r=17,s=15,t.iconType="small");var c=new BMap.Icon(m,new BMap.Size(r,s),{imageOffset:new BMap.Size(-a,20*-n),infoWindowOffset:new BMap.Size(15,0)});return c},formatTrafficTime:function(e,t){e=1e3*e;var i=new Date(e),a="";a+="iw"==t?i.getFullYear()+"年":i.getFullYear()+"-",a+="iw"==t?i.getMonth()+1+"月":i.getMonth()+1+"-",a+="iw"==t?i.getDate()+"日":i.getDate()+"";var n=" ";return"ymd"===t?a:("hm"===t&&(a="",n=""),a+=i.getHours()<10?n+"0"+i.getHours():n+i.getHours(),a+=i.getMinutes()<10?":0"+i.getMinutes():":"+i.getMinutes())},addMarker:function(e){if(e&&e.length){var t=this;t.removeMarker();for(var i=[],a=86400,n=0;n<e.length;n++){var r=e[n];if(r.geo){var o=r.geo.split("|"),s=o[1];2==o[0]&&(s=s.split("|")[0]);var m=s.split(","),c=new BMap.Point(m[0],m[1]),d=t.createIcon(r.type),f=new BMap.Marker(c,{icon:d,enableMassClear:!1});f.trafficEveType=r.type;var p=r.starttime,l=r.endtime,v=t.formatTrafficTime(r.endtime,"ymd");a>l-p&&(v="今天"+t.formatTrafficTime(r.endtime,"hm"));var h=new BMap.Label(r.title+'<br/><span style="color:#676767">预计'+v+"结束</span>",{offset:new BMap.Size(13,-15)});h.setStyle({borderColor:"#acaba9",color:"#4d4a43",cursor:"pointer",padding:"1px 3px"}),h.hide(),f.setLabel(h),function(){var e=f,i='<div class="iw_poi_content" style="color:#4c4942;line-height:23px;">';r.starttime&&(i+="起始时间："+t.formatTrafficTime(r.starttime,"iw")+"<br/>"),r.endtime&&(i+="预计结束时间："+t.formatTrafficTime(r.endtime,"iw")+"<br/>"),r.des&&(i+='<p style="margin-top:10px;">详情：<span style="color:#666666">'+r.des+"</span></p>"),i+="</div>";var a=new BMap.InfoWindow(i,{title:'<span class="iw_poi_title" style="padding-right:10px;white-space:normal;word-wrap:break-word">'+r.title+"</span>",width:304});e.addEventListener("mouseover",function(){if(this.setTop(!0),!a.isOpen()){this.getLabel().show()}}),e.addEventListener("mouseout",function(){a.isOpen()||(this.getLabel().hide(),this.setTop(!1))}),e.addEventListener("click",function(){this.getLabel().hide(),this.openInfoWindow(a)}),e.addEventListener("infowindowopen",function(){this.setTop(!0)}),e.addEventListener("infowindowclose",function(){this.setTop(!1)})}(),map.addOverlay(f),i.push(f)}}t.markers=i}},removeMarker:function(){for(var e=this,t=0;t<e.markers.length;t++)map.removeOverlay(e.markers[t]);e.markers=[]},getData:function(e){var t=this,i=t.baseUrl;i+="&city_code="+e,e==t.curCityCode&&""!=t.curDataTime&&(i+="&time="+t.curDataTime),i+="&call_back="+t.guid+"&t="+(new Date).getTime(),baidu.sio.callByBrowser(i,null,"traffic_event_"+t.guid),t.preGetDataTime=(new Date).getTime()},setData:function(e){if(e&&e.time&&e.city_code&&e.content&&e.content.length){var t=this,i=e;t.curCityCode=i.city_code,t.curDataTime=i.time,t.data=i.content,t.intervalTime=60*i.interval*1e3||t.intervalTime,t.addMarker(t.data)}}}),i.exports=BMap.TrafficEvent=o});