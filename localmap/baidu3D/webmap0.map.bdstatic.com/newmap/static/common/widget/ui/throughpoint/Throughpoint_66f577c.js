define("common:widget/ui/throughpoint/Throughpoint.js",function(t,e,n){var s=t("common:widget/ui/mapUtil/mapUtil.js"),a=t("common:widget/ui/util/util.js"),o=t("common:widget/ui/config/config.js"),r=o.modelConfig,p=(o.mapConfig,t("common:widget/ui/setMyPlace/SetMyPlaceMgr.js")),u={tpList:[],tpListInMap:[],status:"",support:function(t){return t||(t=this.curType),"3"==t},onContextMenu:function(){return this.canAddNewPoint()&&this.support()?!0:!1},highLightInput:function(t){for(var e,n=0;e=this.allInputs[n];n++)n==t?T.ac(e.parentNode,"inputHighLight"):T.rc(e.parentNode,"inputHighLight");t>0?this.showExtendPanel():(this.onfocusInput=null,this.hiddenOtherPoints())},clearHighLightInput:function(){if(this.allInputs)for(var t,e=0;t=this.allInputs[e];e++)T.rc(t.parentNode,"inputHighLight")},getReturnIcon:function(t){t||(t=this.curType);var e=3==t?"nav":"bus",n=this.ei;return n||(n=this.ei={}),n[e]||(n[e]=T.g(e+"ReturnIcon")),n[e]},state:"",onSwitchTab:function(t){if(this.curType!=t){this.curType=t;var e=this,n=T.g(3==t?"DriveSearchEndSpan":"BusSearchEndSpan");if(this.inputSpan=n,this._countDom&&(this._countDom.style.cssText=""),1!=t)if(e.support(t)){if(this.getTPPanel().parentNode==this.inputSpan.parentNode){this.adjustInputStyle(n.parentNode);var e=this;window.setTimeout(function(){e.displayTpCount()},100)}else this.adjustInputStyle(n.parentNode,!0);e.createAddTPointIcon(n,t);for(var i,s=0;i=this.tpList[s];s++)i.marker&&i.marker.show()}else{this.onfocusInput=null,this.hiddenOtherPoints();for(var i,s=0;i=this.tpList[s];s++)i.marker&&i.marker.hide();this.clearTpListInMap()}}},clearTpListInMap:function(){for(var t,e=0;t=this.tpListInMap[e];e++)t.marker&&map.removeOverlay(t.marker);this.tpListInMap=[]},addTPointByPoint:function(t){if("nav"==this.state){var e={point:t},n=this.tpListInMap.length;return this.tpListInMap.push(e),this.createMarkerByTp(e,n),s.getGEORevertAddress(t,function(t){u.addTPointCBK(t)}),void(this.needRaiseAdd=!0)}var e,i=this.tpList,n=0;if(!window.isPrint)if(0==i.length)this.createInputItem();else{for(;(e=i[n])&&this.isOnePointEnsured(e);n++);if(e)if(0==n)this.getTPPanel().parentNode!=this.inputSpan.parentNode&&this.createInputItem();else{var a=this.attachPanel().getElementsByTagName("input").length;n>a&&this.createInputItem()}else 5>n&&this.createInputItem()}if(5>n)e||(e=this.tpList[n]),e.query="未知路段",this.suggests[n].setValue(e.query),e.point=t,T.rc(this.allInputs[n],"tpInput_bg"),T.rc(this.allInputs[n],"tpInput_bg_focus"),s.getGEORevertAddress(t,function(t){u.addTPointCBK(t)}),this.createMarkerByTp(e,n),this.afterAddByPoint&&this.afterAddByPoint({tp:e,index:n}),this.displayTpCount();else{var o=this.createAddTPointIcon(this.inputSpan,this.curType);T.rc(o,"add_tpoint_icon_on"),T.ac(o,"add_tpoint_icon_disable"),T.un(o,"mouseover",this.addTPointIconHoverFunc)}addStat("navscheme.navscheme.addtp","click")},createMarkerByTp:function(t,e,n){if(isNaN(e)&&(e=T.array.indexOf(this.tpList,t)),t.point||t.rPoint){{var i=this.getIconByIndex(e),a=t.point?t.point:t.rPoint,o=baidu.encodeHTML(t.query);t.query?t.query:"途经点"+(e+1)}t.marker=new BMap.Marker(a,{icon:i,title:o}),map.addOverlay(t.marker),n||(t.marker.addEventListener("mouseover",function(){if("route"!=u.state){u.isOverTp=!0;var t=u;t.curSelMarker!=this&&t.getRemoveIconInMap(this)}else this.disableDragging()}),t.marker.addEventListener("mouseout",function(){u.isOverTp=!1,u.hideRemoveIconInMap()}),t.marker.addEventListener("dragend",function(t){""==u.state&&s.getGEORevertAddress(t.point,function(t){u.addTPointCBK(t)})}),t.marker.enableDragging())}return t.marker},hideRemoveIconInMap:function(){window.setTimeout(function(){var t=u;t.isOverTp||t.isOverIcon||(t.curSelMarker=null,map.removeOverlay(t.removeMarker))},200)},getRemoveIconInMap:function(t){var e;this.removeMarker&&map.removeOverlay(this.removeMarker),e=new BMap.Label("<div style='position:relative;'><div id='tppoint_remove_icon' class='tppoint_remove_icon' title='删除途经点'></div></div>",{offset:{width:40,height:-10}}),t.setLabel(e),this.curSelMarker=t,e.addEventListener("mouseover",function(){u.isOverIcon=!0}),e.setStyle({zIndex:25}),e.addEventListener("mouseout",function(){u.hideRemoveIconInMap(),u.isOverIcon=!1}),T.on("tppoint_remove_icon","click",function(){var t=u;if(map.removeOverlay(t.removeMarker),"nav"==t.state){if(t.curSelMarker){for(var e,n=a.getOverlayPoint(t.curSelMarker),i=0;e=t.tpListInMap[i];i++){var s=e.point?e.point:e.rPoint;if(s.lat==n.lat||s.lng==n.lng){t.tpListInMap.splice(i,1),t.onDeleteTp&&t.onDeleteTp({tp:e,index:i});break}}var o=t.createAddTPointIcon(t.inputSpan,t.curType);T.rc(o,"add_tpoint_icon_disable"),T.on(o,"mouseover",t.addTPointIconHoverFunc)}}else if(t.curSelMarker){var r=a.getOverlayPoint(t.curSelMarker),p=t.getTPAndIndexByPoint(r).index;t.removeItemByIndex(p),map.removeOverlay(t.curSelMarker)}t.onfocusInput=null,t.hiddenOtherPoints(!0),addStat("navscheme.navscheme.removetp","click")}),this.removeMarker=e},getTPAndIndexByPoint:function(t){t.lat=t.y?t.y:t.lat,t.lng=t.x?t.x:t.lng;for(var e,n={},i="nav"==this.state?this.tpListInMap:this.tpList,s=0;e=i[s];s++)if(e.marker){var o=a.getOverlayPoint(e.marker);o.lat==t.lat&&o.lng==t.lng&&(n.index=s,n.tp=e)}return n},getIconByIndex:function(t){return new BMap.Icon("../../../../../../../webmap2.map.bdstatic.com/newmap/static/common/images/tpicon_ea18b98.png"/*tpa=http://webmap2.map.bdstatic.com/newmap/static/common/images/tpicon_ea18b98.png*/,new BMap.Size(36,36),{imageOffset:new BMap.Size(-62-36*t,0)})},addTPointCBK:function(t){if(this.setSearchBox(),this.setValueByCBK=!0,window.setTimeout(function(){u.setValueByCBK=!1},50),t.content){var e=t.content,n=this.getTPAndIndexByPoint({x:t.result.x,y:t.result.y});if(n.tp){if(""===e.address&&(e.address="未知路段"),n.tp.query=e.address,"nav"!=this.state){var i=this.allInputs[n.index];this.suggests[n.index].setValue(n.tp.query),n.tp.marker&&n.tp.marker.setTitle(e.address),T.rc(i,"tpInput_bg"),T.rc(i,"tpInput_bg_focus")}this.afterAddByPoint&&this.needRaiseAdd&&(this.afterAddByPoint({tp:n.tp,index:n.index}),this.needRaiseAdd=!1)}}},addTPointIconHoverFunc:function(){T.ac(this,"add_tpoint_icon_on")},createAddTPointIcon:function(t,e){var n="addTPointIcon"+e,i=T.g(n);return i||(i=T.dom.create("span",{className:"add_tpoint_icon",title:"增加途经点",id:n}),i.style.width="21px",T.on(i,"mouseover",this.addTPointIconHoverFunc),T.on(i,"mouseout",function(){T.rc(this,"add_tpoint_icon_on")}),T.on(i,"mousedown",function(t){a.preventDefault(t)}),T.on(i,"click",function(t){addStat("indexheader.searchbox.addpassbypoints"),addStat("navscheme.navscheme.addtp","click"),u.createInputItem(!0),a.stopBubble(t)}),t.parentNode.insertBefore(i,t.nextSibling)),i},getTPPanel:function(){var t="tppoint_panel",e=T.g(t);return e||(e=T.dom.create("span",{id:t,className:"tppoint_panel"}),this.getRecycle().appendChild(e)),e},attachPanel:function(){var t="tppoint_panel_attach",e=T.g(t);return e||(e=T.dom.create("div",{id:t,className:"tppoint_panel_attach"}),document.body.appendChild(e),T.on(e,"click",function(t){a.stopBubble(t)})),e},removeItem:function(t){if(t){var e=t.getElementsByTagName("input")[0];this.removeItemByInput(e),addStat("navscheme.navscheme.removetp","click")}},removeItemByIndex:function(t){this.removeItemByInput(this.allInputs[t])},removeItemByInput:function(t){this.setSearchBox();var e=this.attachPanel(),n=baidu(e).find("input").get(),i=-1;if(t.value="",0==n.length)this.getRecycle().appendChild(t.parentNode),this.adjustInputStyle(null,!0);else{t.parentNode.parentNode==e&&(i=T.array(n).indexOf(t));for(var s,a=i;s=n[a+1];a++){var o;-1==a?(o=t,t.value=s.value):(o=n[a],n[a].value=s.value),""!=o.value&&(T.rc(o,"tpInput_bg_focus"),T.rc(o,"tpInput_bg"))}n[n.length-1].value="",this.getRecycle().appendChild(e.lastChild)}0==n.length&&(this.removeFirstRowOrderNumber(),this._countDom&&(this._countDom.style.cssText=""));var r=this.tpListInMap[i+1];this.tpListInMap.splice(i+1,1),u.onDeleteTp&&u.onDeleteTp({tp:r,index:i+1}),""==e.style.cssText&&this.displayTpCount();var p=this.createAddTPointIcon(this.inputSpan,this.curType);T.rc(p,"add_tpoint_icon_disable"),T.on(p,"mouseover",this.addTPointIconHoverFunc)},disposeOnePoint:function(t,e){t.query="",t.uid="",t.point="",t.addr="",t.cityCode="",t.rPoint="",t.marker&&!e&&map.removeOverlay(t.marker)},isOnePointEdit:function(t){return t.query||t.point||t.uid||t.addr},isOnePointEnsured:function(t){return t.point||t.addr||t.rPoint},addExtendItem:function(t,e){var n="tppoint_panel_"+e,i=T.g(n),s=this.allInputs[e];i||(i=this.createDomByHtml("<span id="+n+' class="tppoint_panel" style="width: 144px;_width:144px;margin:0px;background-color:#ffffff;"></span>')),t.appendChild(i),i.appendChild(s),this.addRemoveIcon(i),this.addOrderNumber(s,e),this.suggests[e]||this.bindMapSuggest(e)},getStyleWidth:function(t){var e=t.style.width;return parseInt(e.substr(0,e.length-2))},addOrderNumber:function(t,e){var n=this.createOrderNumber(e+1),i=this.getStyleWidth(t);n.parentNode!=t.parentNode&&(t.parentNode.appendChild(n),t.parentNode.style.paddingLeft=this.ORDERWIDTH+"px",t.parentNode.style.width=this.getStyleWidth(t.parentNode)-this.ORDERWIDTH+7+"px",t.style.width=0!=e?i-this.ORDERWIDTH+5+"px":"83px")},setTPPointBySmp:function(t,e){var n=T.g(t),i={point:a.getPoiPoint(e.point),query:e.note},s=0;s=T.array.indexOf(this.allInputs,n),s>=0&&this.insertTP(s,i)},FWIDTH:115,OWIDTH:148,ORDERWIDTH:27,bindMapSuggest:function(e){var n=this.allInputs[e];this.suggests||(this.suggests=[]);var s=4,a=8;T.browser.ie&&(s=3),7==T.browser.ie&&(a=7),cityCode=r.cityCode,this.tpList[e]||(this.tpList[e]={}),this.tpList[e].cityCode&&(cityCode=this.tpList[i].cityCode),this.tpList[e].query&&(this.setSearchBox(),n.value=this.tpList[e]);var o=this;t.async("common:widget/ui/MapSuggest/MapSuggest.js",function(t){o.suggests.push(new t({inputid:n.id,closeTip:1,offset1:[-s,0]},function(t){var e=this.I,n=u.tpList[T.array.indexOf(u.allInputs,e)];n.query=e.value,n.addr=t},function(){CloseSuggestion.showTip(n)}))})},removeFirstRowOrderNumber:function(){var t=this.allInputs[0],e=t.parentNode,n=this.createOrderNumber(1);n.parentNode==e&&(this.getRecycle().appendChild(this.createOrderNumber(1)),t.style.width=this.getStyleWidth(t)+this.ORDERWIDTH-5+"px",e.style.paddingLeft="",e.style.width=this.getStyleWidth(e)+this.ORDERWIDTH-7+"px")},getSearchableTpCount:function(){for(var t,e=0,n=0;t=this.tpList[n];n++)this.isOnePointEdit(t)&&e++;return e},displayTpCount:function(){this._countDom||(this._countDom=document.getElementById("ditu_tpm_count"),this._countDom||(this._countDom=this.createDomByHtml("<span class='ditu_tpm_count' id='ditu_tpm_count'></span>"),document.body.appendChild(this._countDom)));var t=this.getSearchableTpCount(),e=this.getTPPanel(),n=this.attachPanel(),i=n.getElementsByTagName("input");this._countDom.innerHTML=t;var s=T.dom.getPosition(e);return t>1&&i.length>0&&s.left>0?void(this._countDom.style.cssText="left:"+(s.left+145)+"px;top:"+(s.top-7)+"px"):void(this._countDom.style.cssText="")},hiddenOtherPoints:function(t){if(!this.onfocusInput){{var e=this.attachPanel();this.getTPPanel()}if(""==e.style.cssText&&!t)return;{var e=this.attachPanel();e.getElementsByTagName("input"),this.getTPPanel()}e.style.cssText="",3==this.curType&&this.displayTpCount(),t||this.removeFirstRowOrderNumber()}},getQueryParam:function(t){for(var e,n=[],i=0;e=this.tpList[i];i++)this.isOnePointEdit(e)&&("function"==typeof t&&t(),n.push(this.getTPointQueryParam(e)));return n.join("")},isAllPointSure:function(t){for(var e,n=(t?5:this.tpList.length,0);e=this.tpList[n];n++)if(this.isOnePointEdit(e)&&!this.isOnePointEnsured(e))return!1;return!0},canAddNewPoint:function(){if(this.tpList.length<5)return!0;if("nav"==this.state){if(this.tpListInMap.length<5)return!0}else for(var t=0;5>t;t++){var e=this.tpList[t];if(!this.isOnePointEnsured(e))return!0}return!1},getCityCode:function(){for(var t,e=[],n=r.cityCode||1,i=0;t=this.tpList[i];i++)this.isOnePointEdit(t)&&e.push(n+"+to:");return e.join("")},getTPointQueryParam:function(t,e){var n=2,i="",s="",a="",o="0",r="",p="",u="1";return(t.point||t.rPoint)&&(n=1,s=t.point?t.point.lng+","+t.point.lat:t.rPoint.lng+","+t.rPoint.lat,t.uid&&(n=2,i=t.uid)),t.query&&(a=encodeURIComponent(t.query)),t.addr&&(o="1",r=encodeURIComponent(t.addr)),isNaN(e)||(n=e),n+"$$"+i+"$$"+s+"$$"+a+"$$"+o+"$$"+r+"$$"+p+"$$"+u+"$$+to:"},addRemoveIcon:function(t){var e=t.getElementsByTagName("input")[0],n=document.getElementById("i_"+e.id),i=t==this.getTPPanel();n||(n=this.createDomByHtml('<span class="tppoint_remove" id="i_'+e.id+'"" title="删除途经点" ></span>'),i&&(n.style.right="19px"),e.style.width=i?this.getStyleWidth(e)-8+"px":this.getStyleWidth(e)-25+"px"),t.appendChild(n);var s=this;baidu("#i_"+e.id).off("click"),baidu("#i_"+e.id).on("click",function(t){s.removeItem(this.parentNode),t.stopPropagation()})},createInputBox:function(){if(this.allInputs||(this.allInputs=[]),(l=this.allInputs.length)<5){var t=T.dom.create("input",{type:"text",className:"tpInput tpInput_bg",autoComplete:"off",_from:"onway",maxLength:"256",id:"onway_"+(l+1)});this.allInputs.push(t),T.on(t,"focus",function(){u.onfocusInput=this,""==this.value&&T.ac(this,"tpInput_bg_focus"),u.showExtendPanel()}),T.on(t,"mouseover",function(){u.imTimer||(u.imTimer=window.setTimeout(function(){u.showExtendPanel(),u.imTimer=null},100))}),T.on(t,"blur",function(){u.onfocusInput=null,""==this.value&&(T.rc(this,"tpInput_bg_focus"),T.ac(this,"tpInput_bg"))}),t.style.width=0==l?this.FWIDTH+"px":this.OWIDTH+"px";var e=function(t){var e=!t.propertyName||"value"==t.propertyName;if(e){var n=u,i=t.srcElement?t.srcElement:t.target,s=n.tpList[T.array.indexOf(n.allInputs,i)];n.onfocusInput==i&&n.disposeOnePoint(s),s.addr="",""==i.value?i==n.onfocusInput?T.ac(i,"tpInput_bg_focus"):T.ac(i,"tpInput_bg"):(T.rc(i,"tpInput_bg"),T.rc(i,"tpInput_bg_focus"http://webmap0.map.bdstatic.com/newmap/static/common/widget/ui/throughpoint/)),s.query=i.value}};T.browser.ie?t.attachEvent("onpropertychange",e):T.on(t,"input",e)}},setInputValue:function(t,e){var n=this.allInputs[t];""!=e?(T.rc(n,"tpInput_bg"),T.rc(n,"tpInput_bg_focus")):T.ac(n,"tp_Input_bg"),this.suggests[t].setValue(e)},getRecycle:function(){return this._recycle||(this._recycle=document.getElementById("ditu_tpm_recycle"),this._recycle||(this._recycle=T.dom.create("div",{id:"ditu_tpm_recycle"}),this._recycle.style.display="none",document.body.appendChild(this._recycle))),this._recycle},createDomByHtml:function(t){if(!this._fragment){var e=document.createDocumentFragment(),n=document.createElement("div");e.appendChild(n),this._fragment=n}return this._fragment.innerHTML=t,this._fragment.childNodes[0]},createInputItem:function(t){var e=this.getTPPanel(),n=this.inputSpan.parentNode;if(this.createInputBox(),e.parentNode!=n){if(n.insertBefore(e,this.inputSpan),0==e.childNodes.length){e.appendChild(this.allInputs[0]);var n=e.parentNode;this.bindSmpPlace(this.allInputs[0]),this.suggests&&this.suggests[0]||this.bindMapSuggest(0),t?(this.allInputs[0].focus(),this.onfocusInput=this.allInputs[0]):this.onfocusInput=null}this.adjustInputStyle(n),this.addRemoveIcon(e)}else{var i=this.attachPanel(e),s=i.getElementsByTagName("input"),a=s.length;if(4>a&&(a++,this.addExtendItem(i,a)),t?(this.showExtendPanel(e),this.allInputs[a].focus(),this.onfocusInput=this.allInputs[a]):(this.onfocusInput=null,this.hiddenOtherPoints(!0)),a>=4){var i=this.createAddTPointIcon(this.inputSpan,this.curType);T.rc(i,"add_tpoint_icon_on"),T.ac(i,"add_tpoint_icon_disable"),T.un(i,"mouseover",this.addTPointIconHoverFunc)}}},showExtendPanel:function(t){t||(t=this.getTPPanel());var e=T.dom.getPosition(t),n=this.attachPanel(),i=this.allInputs[0];""==n.style.cssText&&0!=n.getElementsByTagName("input").length&&(this.addOrderNumber(i,0),e.left>0&&(n.style.cssText="width:160px;height:"+30*length+"px;left:"+e.left+"px;top:"+(e.top+31)+"px;_top:"+(e.top+33)+"px;"),this._countDom&&(this._countDom.style.cssText=""),this.hasBindBodyClick||(this.hasBindBodyClick=!0,T.on(document.body,"click",function(){u.hiddenOtherPoints()}),map.addEventListener("mousedown",function(){u.hiddenOtherPoints()})))},bindSmpPlace:function(t){var e=this.createDomByHtml('<span class="smp_navt_btn" style="right:1px;" title="常用地点"></span>');T.dom.insertAfter(e,t),baidu(".smp_navt_btn").on("click",function(e){p.openList(t.id,e)})},createOrderNumber:function(t){var e=document.getElementById("tp_point_order_"+t);return e?e:this.createDomByHtml("<span class='tppoint_order' id='tp_point_order_"+t+"'>"+t+"</span>")},adjustInputStyle:function(t,e){t||(t=this.inputSpan.parentNode);var n=e?"search_input_tp":"search_input_tp_explode",i=e?"width:192px;":"width:144px",s=e?"170px":"115px",a=e?"460px":"487px",o=e?"0":"4",r=T.g("MaptoDown_tip");r&&(T.g("MaptoDown_tip").style.left=e?"742px":"772px"),baidu.dom.hasClass(t,"drive_flag")?(baidu.dom.setStyle(t,"width",a),baidu.dom.setStyle(t,"z-index",o),t.parentNode.className=n):t.className=n;for(var p,u=0;p=t.childNodes[u];u++)if(p.getElementsByTagName){var d=p.getElementsByTagName("input");d.length>0&&(p.style.cssText=i,d[0].style.width=s)}this.getReturnIcon().style.display=e?"":"none",e&&this._countDom&&(this._countDom.style.cssText="")},reset:function(){try{this.onfocusInput=null,this.hiddenOtherPoints();for(var t,e=0;t=this.tpList[e];e++)this.disposeOnePoint(t),this.tpList[e]={},this.allInputs[e]&&(this.allInputs[e].value="",T.ac(this.allInputs[e],"tpInput_bg"),this.getRecycle().appendChild(this.allInputs[e].parentNode));this.getRecycle().appendChild(this.getTPPanel()),u.clearTpListInMap(),this.adjustInputStyle(null,!0)}catch(n){console.log("TPM reset:",n)}},insertTP:function(t,e){if(!window.isPrint){var n=T.extend({},e);if(this.tpList.length>t)if(this.tpList[t]=e,t>0){var i=this.attachPanel(),s=i.getElementsByTagName("input");s.length<t&&this.createInputItem()}else{var a=this.getTPPanel(),o=this.inputSpan.parentNode;a.parentNode!=o&&this.createInputItem()}else{if(this.tpList.length!=t)return;this.tpList.push(e),this.createInputItem()}this.tpList[t]=n,this.setInputValue(t,this.tpList[t].query),this.displayTpCount()}},setSearchBox:function(){var e=t("common:widget/ui/searchBox/searchBox.js");e.notShowSuggest.run()}};n.exports=u});