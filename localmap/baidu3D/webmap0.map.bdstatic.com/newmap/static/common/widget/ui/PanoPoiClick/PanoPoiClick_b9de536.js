define("common:widget/ui/PanoPoiClick/PanoPoiClick.js",function(t,o,n){function a(e){var e=window.event||e;baidu.event.stopPropagation(e),baidu.event.preventDefault(e)}var i=t("common:widget/ui/config/config.js"),r=t("common:widget/ui/PanoUtil/PanoUtil.js"),p=t("common:widget/pano/PanoInterface/PanoInterface.js"),s=(i.mapConfig,i.modelConfig,i.mapVersion),c=null,m=function(e,t){this._map=e,this.cbfunction=t,this.cacheData={},this.maxCache=8,this.cacheIds=[],this.poiSpotId=null,this.spotOnId="",this.spotOnUid=null,this.mkr=null,this.label=null,this.squareSide=4,this.tMkr=null,this.tempMarker=null,this.overSpotPoint=null,this.isMoving=!1,this.fetchId="",this.curTileId="",this.labelName="",this.ic=new BMap.Icon("../../../../../../../webmap1.map.bdstatic.com/newmap/static/common/images/panorama/pano_click_poi_9d48465.png"/*tpa=http://webmap1.map.bdstatic.com/newmap/static/common/images/panorama/pano_click_poi_9d48465.png*/,new BMap.Size(20,24),{offset:new BMap.Size(10,12),infoWindowOffset:new BMap.Size(5,0)}),this.clickVersion=s.INDOOR_CLICK_VER||"1003",this.init()};c=m.prototype,c.init=function(){this.bind()},c.refresh=function(e){var t=this;t.clearPoiCache(),t.hideOverlays(),t.tMkr=null,t.tempMarker=null,t.spotOnId=null,t._map=e,t.init()},c.bind=function(){this.bindMapRequest(),this.bindMouseMove(),this.bindSpotEvent()},c.bindMapRequest=function(){var e=this;e._map.addEventListener("tilesloaded",function(){map.getZoom()<10&&e.clearPoiCache()}),e._map.addEventListener("zoomend",function(){e.clearPoiCache(),e.hideOverlays()})},c.bindMouseMove=function(){var e=this;e._panomouseMoveEvent||(e._panomouseMoveEvent=function(t){e.mouseMoveEvent(t)}),e._map.addEventListener("mousemove",e._panomouseMoveEvent)},c.mouseMoveEvent=function(e){var t=this;if(t._map.getZoom()<10)t.clearPoiCache();else{if(!e||!e.point)return;t.overSpotPoint=e.point,t.isMoving=!0;var o=t._map.getTileId(e.point,t._map.getZoom());if(!o.row||!o.column||!o.level)return;t.curTileId=o.level+"_"+o.row+"_"+o.column;var n=o.level+"_"+t.m1(o.row)+"_"+t.m1(o.column);t.cacheData[n]?t.spotOnId!=t.curTileId&&(t.clearPoiCache(),t._addSpot(t.curTileId)):t.sendRequest({l:o.level,x:t.m1(o.row),y:t.m1(o.column)})}},c._addSpot=function(e){var t=this,o=e.split("_"),n=o[0]+"_"+t.m1(o[1])+"_"+t.m1(o[2]);if(t.cacheData[n]){var a=t.cacheData[n][e]?t.cacheData[n][e]:!1;if(a){t.poiSpotId=t._map.addSpots(a,{enableMultiResponse:!1}),t.spotOnId=e;for(var i=-1,r=0,p=t.cacheIds.length;p>r;r++)if(n==t.cacheIds[r]){i=r;break}i>=0&&(t.cacheIds.splice(i,1),t.cacheIds.push(n))}}},c.sendRequest=function(e){var t=this;if(e&&t.fetchId!=e.l+"_"+e.x+"_"+e.y){t.fetchId=e.l+"_"+e.x+"_"+e.y;var o=e.x+"_"+e.y+"_"+e.l+"_"+this.clickVersion;baidu.jsonp("http://pcsv0.map.bdimg.com/?qt=ck&tid="+o,{cbtype:"fn",success:function(e){e=e&&e.content||{},e&&e.length>0&&t.getPoiData(e)},error:function(){}})}},c.getPoiData=function(e){for(var t={},o=!1,n=this,a=0,i=e.length;i>a;a++){for(var r=[],p=e[a],s=0,c=p.uids.length;c>s;s++){var m=p.uids[s],d=(m.bound.xmax+m.bound.xmin)/2,u=(m.bound.ymax+m.bound.ymin)/2,l=n._map.pointToPixel(new BMap.Point(m.bound.xmin,m.bound.ymin)),v=n._map.pointToPixel(new BMap.Point(m.bound.xmax,m.bound.ymax)),h=[(l.x-v.x)/2,(v.y-l.y)/2,(v.x-l.x)/2,(l.y-v.y)/2];"street_1"!=m.catalog&&r.push({pt:new BMap.Point(d,u),bd:h,userdata:{name:m.name?m.name:"",uid:m.uid,type:m.type,iconpoint:m.icon?new BMap.Point(m.icon.x,m.icon.y):""},tag:"MAP_SPOT_INFO"})}n.curTileId&&n.curTileId==p.tileid&&(o=!0),t[p.tileid]=r}var _=e[0].tileid.split("_"),f=_[0]+"_"+n.m1(_[1])+"_"+n.m1(_[2]);if(n.cacheData[f]=t,n.cacheIds.push(f),n.cacheIds.length>n.maxCache){var M=n.cacheIds.shift();delete n.cacheData[M],delete M}o&&n._addSpot(n.curTileId)},c.bindSpotEvent=function(){var e=this;e.addSpotEvent()},c.addSpotEvent=function(){var e=this;e._panomoveOverSpot||(e._panomoveOverSpot=function(t){a(t),e.moveOverSpot(t)}),e._panomoveOutSpot||(e._panomoveOutSpot=function(t){e.moveOutSpot(t)}),e._map.addEventListener("spotmouseover",e._panomoveOverSpot),e._map.addEventListener("spotmouseout",e._panomoveOutSpot)},c.removeSpotEvent=function(){var e=this;e._map.removeEventListener("mousemove",e._panomouseMoveEvent),e._map.removeEventListener("spotmouseover",e._panomoveOverSpot),e._map.removeEventListener("spotmouseout",e._panomoveOutSpot)},c.moveOverSpot=function(e){var t=this;if(!(t._map.getZoom()<10)){var o=e.spots;if(o&&!(o.length<1)&&o[0].tag&&"MAP_SPOT_INFO"==o[0].tag){var n=o[0].userdata.iconpoint?o[0].userdata.iconpoint:o[0].pt;if(t.tempMarker&&t.tempMarker.map?(t.tempMarker.setPoint(n),t.tempMarker.show(),t.spotOnUid=o[0].userdata.uid):(t.tempMarker=new BMap.Marker(n,{icon:t.ic,zIndexFixed:!0,baseZIndex:3e6}),t.tempMarker._type="indoorIcon",t.spotOnUid=o[0].userdata.uid,t._map.addOverlay(t.tempMarker),t.mkr=t.tempMarker,t.tempMarker.addEventListener("click",function(e){t.clickMkr(),a(e)})),t.tempMarker.setTop(!0),t.tMkr=t.tempMarker,"_panoPoiClick"==t.cbfunction&&r.panoMarker){var i=o[0].userdata;r.panoMarker.enableIndoorOverlay(n,i.uid,i.name)}}}},c.moveOutSpot=function(){var e=this;e._map.getZoom()<10||("_panoPoiClick"==e.cbfunction&&r.panoMarker&&r.panoMarker.disableIndoorOverlay(),e.tMkr=null,e.hideOverlays())},c.moveSpot=function(e){a(e)},c.clickMkr=function(){{var t=this;t.tMkr}t._map.removeOverlay(t.tempMarker),t.tMkr=null,t.tempMarker=null,t.spotOnId=null;var o={panoIId:t.spotOnUid,panoType:"inter"};p.showPano(o),a(e),addStat(STAT_CODE.STAT_PANORAMA,{item:Pano.PANO_TYPE_INDOOR,catalog:"map",func:"click",from:"pc-map"})},c.clearPoiCache=function(){var e=this;e.poiSpotId&&(e._map.removeSpots(e.poiSpotId),e.poiSpotId=null,e.spotOnId=null)},c.hideOverlays=function(){var e=this;e.mkr&&e.mkr.hide(),e.label&&e.label.hide()},c.m1=function(e){return Math.floor(parseInt(e,10)/this.squareSide)},n.exports=m});