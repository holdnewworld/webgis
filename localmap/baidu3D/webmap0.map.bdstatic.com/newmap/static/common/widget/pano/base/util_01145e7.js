define("common:widget/pano/base/util.js",function(e,n,t){var r=e("common:widget/ui/config/config.js"),o=e("common:widget/ui/mapUtil/mapUtil.js"),a=r.modelConfig,i=function(){},u=/<[^>]*>|<\/[^>]*>/gm,c={trim:function(){return String.prototype.trim?function(e){return e.trim()}:function(e){return e.replace(/(^\s*)|(\s*$)/g,"")}}(),converToArray:function(e){var n=c.each(e,function(e){return e},!0);return n},getUniqueId:function(){var e=1;return function(n,t){n?"number"==typeof n?(t=n,n="_$unique_id_"):"undefined"==typeof t&&(t=1):(t=1,n="_$unique_id_");var r=c.each(new Array(t||1),function(t,r){return n+(e+r)},!0);return e+=t||1,1===r.length?r[0]:r}}(),log:function(){return console?function(){console.log.apply(console,arguments)}:i}(),merge:function(){for(var e=c.converToArray(arguments),n={},t=0,r=e.length;r>t;t++){var o=e[t]||{};for(var a in o)o.hasOwnProperty(a)&&(n[a]=o[a])}return n},getRandom:function(){var e=0;return function(){return"_$rid"+e++}}(),each:function(e,n,t){var r,o,a=[],i=e.length;if(t){for(o=0;i>o&&(r=n.call(e,e[o],o,a),void 0!==r&&a.push(r),r!==!0);o++);return a}for(o=0;i>o&&n.call(e,e[o],o)!==!0;o++);return void 0},some:function(e,n){for(var t=0,r=e.length;r>t;t++)if(n(e[t],t)===!0)return!0;return!1},isIE:function(){return!1},setOpacity:function(e,n){e.style.opacity=n},showDetail:function(e,n,t,r,o,a,i,u){window.place.showDetail(e,n,t,r,o,a,i,u)},getSearchResultFromUrl:function(e){var n=new T.Deferred;return T.ajax(e,{dataType:"json",success:function(t){return t&&t.result?void n.resolve(t,e):void n.resolve(null)},error:function(){n.resolve(null)}}),n},getImage3DUrl:function(e,n,t,o,a,i){e=e||r.urlConfig.PANO_3DIMAGE_URL;var u="{baseURL}/?qt=pr3d&fovy=75&quality=80&panoid={panoId}&heading={panoHeading}&pitch={panoPitch}&width={width}&height={height}",c={baseURL:e,panoId:n,panoHeading:t||0,panoPitch:o||0,width:a,height:i};return u.replace(/\{(.*?)\}/g,function(e,n){return c[n]})},getBusLineInfoFromPCMap:function(e,n){function t(e,n,t){var o=0,a=null,i=1/0,u="";return c.each(e,function(e){a=r(e.geo),o=Math.pow(a.x-n,2)+Math.pow(a.y-t,2),i>o&&(i=o,u=e.uid)}),u}function r(e){var n=e.split("|")[2].split(";")[0],t=n.split(",");return{x:t[0],y:t[1]}}var o=window.componentManager.get("PoiSearch"),a="",i="";o&&o.curBslUid&&(a=t(currentComponent.curStops,e,n),i=o.curBslUid);var u=window.componentManager.get("LinesQuery");u&&u.curBslUid&&(a=t(currentComponent.curStops,e,n),i=u.curBslUid);var s=window.componentManager.get("BusLines");return s&&s.json&&s.json.content&&s.json.content[0]&&(a=t(currentComponent.json.content[0].stations,e,n),i=s.json.content[0].uid),i&&a?{buslineUid:i,closestBusStationUid:a}:null},getSearchResultFromPCMap:function(e){var n=window.componentManager.get("PoiSearch")||window.componentManager.get("SearchInView");if(!n)return null;var t=n.modelQuery,r=location.pathname,o=map.getBounds(),i="&l="+map.zoomLevel,u="";if(document.location.href.indexOf("format=1")>-1&&(u="&format=1"),t.indexOf("&l=")>-1&&(i=""),t=t.replace(/%3C/gi,encodeURIComponent(" ")).replace(/%3E/gi,encodeURIComponent(" "))+"&tn="+map.mapType,t.indexOf("&nn=")<0&&(t+="&nn=0"),t.indexOf("b=(")>-1)t=r+a.DATA_URL+t+u+"&ie=utf-8"+i+"&t="+(new Date).getTime();else{var c=Math.min(o.minX,o.maxX),s=Math.max(o.minX,o.maxX),l=Math.min(o.minY,o.maxY),p=Math.max(o.minY,o.maxY);t=r+a.DATA_URL+t+u+"&ie=utf-8"+i+"&b=("+c+","+l+";"+s+","+p+")&t="+(new Date).getTime()}var d=null;if(e){var f=null;for(var m in e)f=m+"="+e[m],t.indexOf(m+"=")>-1?(d=new RegExp(m+"=[^&]+","g"),t=t.replace(d,f)):t+="&"+f}var h=new T.Deferred;return T.ajax(t,{dataType:"json",success:function(e){return e&&e.result?(!e.content||2!=e.content[0].poiType&&4!=e.content[0].poiType||(e.busLineUid=e.content[0].uid),void h.resolve(e,t)):void h.resolve(null)},error:function(){h.resolve(null)}}),h},getCurrentCityByArea:function(e,n,t,r,o){var a=(new Date).getTime(),i=e+","+n+";"+t+","+r;baidu.ajax("/?newmap=1&qt=ncent&ie=utf-8&b="+i+"&l=16&t="+a,{dataType:"json",success:function(e){if(e&&e.content&&e.current_city){return void o(e)}},error:function(){}})},hasRouteVideo:function(){function e(){T.jsonp(t,function(e){if(e)for(var t=0,r=e.length;r>t;t++)if(o==e[t].cityCode)return void n.resolve(!0);n.resolve(!1)})}var n=new T.Deferred,t="/?newmap=1&qt=panoRouteVideo",r=window.currentComponent,o=a.cityCode;return r&&"NavTrans"==r.name?r.tpList.length>0?n.resolve(!1):r.sCity.code==r.eCity.code?e():this.getUpCity(r.sCity.cname,r.eCity.cname).then(function(t,r){t.upCityCode==r.upCityCode?e():n.resolve(!1)}):n.resolve(!1),n},getUpCity:function(){function e(e){var n=new T.Deferred,t="newmap=1&wd="+encodeURI(e);return baidu.ajax("/?qt=s",{method:"get",dataType:"json",data:t,success:function(e){var t=e?e.current_city:null;n.resolve(t)}}),n}for(var n=new T.Deferred,t=Array.prototype.slice,r=[],o=t.call(arguments),a=[],i=0,u=o.length;u>i;i++)a.push(e(o[i]));var c=T.when.apply(null,a);return c.then(function(){for(var e=t.call(arguments),o=0,a=e.length;a>o;o++){var i=e[o];r.push({upCityCode:i.up_cityid?i.up_cityid:i.code})}n.resolve.apply(null,r)}),n},getRouteVideoParamFromPCMap:function(e){var n=new T.Deferred;if("NavTrans"==currentComponent.name){for(var t=r.urlConfig.PANO_ROUTE_VIDEO_URL,o=r.urlConfig.PANO_VIDEO_SERVER_URL,a=r.urlConfig.PANO_3DIMAGE_URL,i=null,u=0,c=e.length;c>u;u++)if(e[u].src){i=e[u];break}var s=i?i.src.replace("?qt=pr3d","?qt=share").replace("&width=196&height=100",""):"",l=currentComponent.getPanoNavParams(),p={currentCity:l.currentCity,sc:l.sc,ec:l.ec,strategy:l.strategy,drag:-1,day:l.day,bound:l.bound,t:(new Date).getTime(),time_index:l.time_index,extinfo:l.extinfo,start:encodeURI(l.start),end:encodeURI(l.end),level:l.level,et:-1,st:-1,udt:"201400616",qt:"routeVideo"},d=new T.Deferred;if(p.sc!=p.ec){var f=currentComponent;this.getUpCity(f.sCity.cname,f.eCity.cname).then(function(e,n){p.sc=e.upCityCode,p.ec=n.upCityCode,d.resolve()})}else d.resolve();return d.then(function(){var e={imageUrl:s,videoParam:t+"/?"+T.url.jsonToQuery(p),playerUrl:"../../../swf/pano_whole/StreetscapePlayer_d23678a.swf"/*tpa=http://webmap0.map.bdstatic.com/newmap/static/common/swf/pano_whole/StreetscapePlayer_d23678a.swf*/,offsetLeft:314,errorImageUrl:"../../../images/pano_whole/img_error_8d3eb72.png"/*tpa=http://webmap0.map.bdstatic.com/newmap/static/common/images/pano_whole/img_error_8d3eb72.png*/,videoServerUrl:o+"/?qt=video",imageServerUrl:a+"?newmap=1&qt=pr3d"};n.resolve(e)}),n}},copy:function(e,n){var t=typeof e;if(t=t.toLowerCase(),T.isArray(e))return c.each(e,function(e){return c.copy(e,n)},!0);if(T.isObject(e)){var r,o={};for(var a in e)r=n?a.toLowerCase():a,o[r]=c.copy(e[a],n);return o}return e},bind:function(e,n){return function(){e.apply(n,arguments)}},clearTag:function(e){return e?e.replace(u,""):""},parse2Geo:function(e){return o.parse2Geo(e)},getPointFromGeoStr:function(e){var n=e.split("|");if("1"!==n[0])return null;var t=n[2].split(";")[0];return t=t.split(","),new BMap.Point(t[0],t[1])},getAngleFromP2P:function(e,n){var t=e,r=180*Math.atan(Math.abs((n.x-t.x)/(n.y-t.y)))/Math.PI;return n.x>=t.x&&n.y<=t.y&&(r=180-r),n.x<=t.x&&n.y<=t.y&&(r=180+r),n.x<=t.x&&n.y>=t.y&&(r=360-r),r},getDomSize:function(e){var n=e.parentNode,t=e.nextSibling,r=document.createElement("div");r.style.cssText="position:absolute;top:-9999px;left:-9999px",n.removeChild(e),r.appendChild(e),document.body.appendChild(r);var o=e.offsetWidth,a=e.offsetHeight;return r.removeChild(e),n.insertBefore(e,t),document.body.removeChild(r),{width:o,height:a}},parseUrlParam:function(e){if(e.indexOf("?")>-1)var n=e.slice(e.indexOf("?")+1);else{if(!(e.indexOf("#")>-1))return;var n=e.slice(e.indexOf("#")+1)}if(""!=n){for(var t={},r=n.split("&"),o=0;o<r.length;o++){var a=r[o].split("=");if(a[1]){var i=a[1].indexOf("#");a[1]=i>-1?a[1].slice(0,i):a[1],t[a[0]]=a[1]}}return t}},monitorReport:function(e,n,t,r,o,a){function i(e,n){var t="",r="";return e?n>2e3?(t="slow",r=3e3>n?"req_slow2":6e3>n?"req_slow3":"req_slow6"):(t="succ",r="succ"):(t="fail",r="con_fail"),{subtype:t,subvalue:r}}function u(e){var n=[];for(var t in e)n.push(t+"="+e[t]);n=n.join("&");var r="http://log.map.baidu.com/tn.gif?"+n,o=new Image;o.src=r}var c=i(n,t);"succ"==c.subtype&&(o=.01*o),Math.random()<o&&u({product:"Pano",module:"Pano_"+e,subtype:c.subtype,subvalue:c.subvalue,value:t,detail:encodeURIComponent(r),logid:a,represent:o>1?1:o,time:Math.floor(.001*(new Date).getTime())})},startClock:function(e,n){var t=this;window._pano_timer||(window._pano_timer={});var r=window._pano_timer;window.onbeforeunload=function(){t.stopClock(e)},r[e]||(r[e]={name:e,state:1,start:(new Date).getTime(),fn:n})},stopClock:function(e){var n=window._pano_timer;if(n&&n[e]){var t=n[e],r=t.fn;r&&r.call(t,Math.round(((new Date).getTime()-t.start)/1e3)),delete n[e]}},onHashChange:function(e){function n(){var e=location.href,t=e.slice(e.indexOf("#")+1);t!=o&&(o=t,_applyHashChangeHandler()),window._checkHashTimer=setTimeout(n,500)}if(window._hashChangeHandlers)e&&window._hashChangeHandlers.push(e);else{var t=window._hashChangeHandlers=[];if(e&&t.push(e),window._applyHashChangeHandler=function(){for(var e=0;e<t.length;e++)t[e].apply(null)},"addEventListener"in document.body)window.addEventListener("hashchange",window._applyHashChangeHandler);else{var r=location.href,o=r.slice(r.indexOf("#")+1);n()}}},offHashChange:function(){window._hashChangeHandlers=null,"removeEventListener"in document.body&&(window.removeEventListener("hashchange",window._applyHashChangeHandler),window._applyHashChangeHandler=null),window._checkHashTimer&&clearTimeout(window._checkHashTimer)},revertStreetView:function(e){var n="",t="";return e.pid?(t=e.pid,n=e.iid||""):"inter"===e.panotype?n=e.panoid:t=e.panoid,"alamap"===e.from&&addStat(STAT_CODE.STAT_PANORAMA,{item:e.panotype,catalog:"alamap",func:"alamap",query:e.pword}),{panoId:t,panoIId:n,panoType:e.panotype,panoHeading:e.heading,panoPitch:e.pitch,panoZoom:e.l,panoShareParam:e.psp,from:"share"}},getUgcUploadUrl:function(){return"http://pai.baidu.com/?from=pcmap"},isSupportVideo:function(){var e=navigator.appVersion;if(-1!==e.indexOf("MSIE 9.0"))return!1;try{var n=document.createElement("video");return n&&n.canPlayType?!0:!1}catch(t){return!1}}};!function(e){var n=document.body.filters;n&&(e.isIE=function(){return!0},e.setOpacity=function(e,n){e.style.filter="alpha(opacity="+parseInt(100*n)+")"})}(c),function(){var e=history.replaceState,n=navigator.userAgent.toLowerCase(),t=n.indexOf("lbbrowser")>-1;c.isSupportPushStatus=!e||t?function(){return!1}:function(){return!0}}(c),c.createTask=function(){var e=function(e){this._opts=c.merge({timeout:5e3},e),this._queue=[]};return e.prototype={add:function(e,n){return this._queue.push({fn:e,timeout:void 0===n?this._opts.timeout:n}),this},start:function(){for(var e,n,t=this._queue,r=0,o=t.length;o>r;r++)if(n=t[r],0===r){var a=n.fn.call(null);a&&"function"==typeof a.state&&"resolved"!==a.state(),e=baidu.when(a)}else e=e.then(function(e){return function(){var n=e.fn.call(null);return n&&"function"==typeof n.state&&"resolved"!==n.state(),n}}(n,r));return e}},e.prototype.constructor=e,function(n){return new e(n)}}(),t.exports=c});