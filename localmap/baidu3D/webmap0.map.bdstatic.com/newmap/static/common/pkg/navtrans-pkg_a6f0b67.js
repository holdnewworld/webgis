define("common:widget/com/NavTrans/NavTrans.js",function(require,exports,module){function NavTrans(){if(window.NavTransInst=this,MapComponent.apply(this,arguments),this.cinfo&&1==this.cinfo.isPos&&(0==this.cinfo.destFlag?(window.conType=0,window.conPoint=this.cinfo.point):(window.conType=1,window.conPoint=this.cinfo.point),this.setContext(window.conPoint)),this.json){var t=this.json.result;this.result=t,this.total=t.total,this.start=t.start,this.end=t.end,this.end=this.end[this.end.length-1],this.waypoints=t.waypoints,this.sCity=t.start_city,this.eCity=t.end_city,this.eCity=this.eCity[this.eCity.length-1],this.strategy=t.sy,this.drag=t.drag||0,this.currentCity=modelConfig.cityCode,this.s_query=t.s_query?t.s_query:this.start.wd,this.e_query=t.e_query?t.e_query:this.end.wd,window.cxtBusPoints||(window.cxtBusPoints=[]),this.total&&(this.start.pt=mapUtil.parse2Geo(this.json.content.kps[0].pt).points,this.end.pt=mapUtil.parse2Geo(this.json.content.kps[this.json.content.kps.length-1].pt).points);var e=this.start.pt.split(",");this.sp=new BMap.Point(e[0],e[1]),window.cxtBusPoints[0]={p:this.sp,n:this.start.wd,t:0},e=this.end.pt.split(","),this.ep=new BMap.Point(e[0],e[1]),window.cxtBusPoints[1]={p:this.ep,n:this.end.wd,t:1},this.taxi=this.json.content.taxi,this.mainRouteIndex=[],this.mainRouteStart=[0],this.mainRoute=[],this.tpList=[],this.wpList=[],this.noName="未知路段",this.rettype=["","从起点出发","到达目的地","途经点","行驶","到达目的地(在左侧)","到达目的地(在右侧)"],this.total&&(this.routeIndex=this.generateRouteIndex(),this.navListData=this.generateNavListData(),this.navListView=new NavListView(this.navListData)),mapInfoScrollPanel&&mapInfoScrollPanel.hide()}}function startGo(t,e,n){var i=window.startPoi.point,a=window.endPoi.point,s=TPM.getQueryParam(function(){}),o=TPM.getCityCode(),r=a.lng+","+a.lat;window.cxtBusPoints[1].route&&(r=window.cxtBusPoints[1].route);var d="nav&c="+modelConfig.cityCode+"&drag=1&sc="+t+"&st=1&ec="+o+e+"&et=1&sy="+n+"&sn=1$$$$"+i.lng+","+i.lat+"$$"+encodeURIComponent(window.cxtBusPoints[0].n)+"$$$$$$&en="+s+"1$$$$"+a.lng+","+a.lat+"$$"+encodeURIComponent(window.cxtBusPoints[1].n)+"$$$$$$";componentManager.go(d)}function endGo(t,e,n){var i=window.startPoi.point,a=window.endPoi.point,s=TPM.getQueryParam(function(){}),o=TPM.getCityCode(),r=i.lng+","+i.lat;window.cxtBusPoints[0].route&&(r=window.cxtBusPoints[0].route);var d="nav&c="+modelConfig.cityCode+"&drag=1&sc="+t+"&st=1&ec="+o+e+"&et=1&sy="+n+"&sn=1$$$$"+i.lng+","+i.lat+"$$"+encodeURIComponent(window.cxtBusPoints[0].n)+"$$$$$$&en="+s+"1$$$$"+a.lng+","+a.lat+"$$"+encodeURIComponent(window.cxtBusPoints[1].n)+"$$$$$$";componentManager.go(d)}var componentManager=require("common:widget/com/componentManager.js"),config=require("common:widget/ui/config/config.js"),constants=require("common:widget/ui/constant/Constant.js"),MapComponent=require("common:widget/com/MapComponent.js"),util=require("common:widget/ui/util/util.js"),indexUtil=require("common:widget/ui/indexUtil/IndexUtil.js"),mapUtil=require("common:widget/ui/mapUtil/mapUtil.js"),transUtil=require("common:widget/ui/transUtil/transUtil.js"),taxi=require("common:widget/ui/taxiMgr/TaxiMgr.js"),SchemeFaver=require("common:widget/ui/SchemeFaver/SchemeFaver.js"),sms=require("common:widget/ui/sms/sms.js"),setComplaintCenterURL=require("common:widget/ui/SetComplaintCenter/SetComplaintCenter.js"),transInfo=require("common:widget/ui/transInfoWindow/transInfoWindow.js"),BoxContainer=require("common:widget/ui/BoxContainer/BoxContainer.js"),PanoUtil=require("common:widget/ui/PanoUtil/PanoUtil.js"),mapInfoScrollPanel=require("common:widget/ui/mapInfoScroll/mapInfoScroll.js"),Share=require("common:widget/ui/mapShare/MapShare.js"),searchBox=require("common:widget/ui/searchBox/searchBox.js"),searchData=require("common:widget/ui/searchData/searchData.js"),iKnow=require("common:widget/ui/iKnow/iKnow.js"),modelConfig=config.modelConfig,MapConfig=config.mapConfig,NavListView=require("common:widget/view/NavList/NavList.js"),NavMap=require("common:widget/com/NavTrans/NavMap.js");T.lang.inherits(NavTrans,MapComponent,"NavTrans"),T.object.extend(NavTrans.prototype,{render:function(){try{if(!this.json)return;var style="#route_contentWrapper{padding:0 5px 0 10px}.drivingRouteFeedback{width:315px;margin:10px 0 0 10px}";if(require.loadCss({content:style,name:"NavTrans"}),addStat("navscheme.navscheme.render"),this.total){addStat("navscheme.navscheme.hasresultrender","click"),this.result.end.length>1&&addStat("navscheme.navscheme.withtp","click");var template=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div id="nav_container"><div id="navAdContainer">',"undefined"==typeof data.new_cms_ad?"":data.new_cms_ad,'</div>     <div id="route_top" class="route_top">        <div class="drivingRouteFeedback">            <div class="feedBackImg">                                <a href="http://tiyan.baidu.com/index.php?r=imap/index" title="驾车路线反馈" target="_blank">                    <img height="50" width="315" src="',"../../../../../webmap1.map.bdstatic.com/newmap/static/common/images/feedback.bak_80444ac.png"/*tpa=http://webmap1.map.bdstatic.com/newmap/static/common/images/feedback.bak_80444ac.png*/,'" alt="驾车路线反馈，反馈有好礼" />                </a>            </div>        </div>        <div style="padding:10px 0 0 9px;text-indent:4px;"><a id="route_survey" class="textLineA" target="_blank" href="">推荐的路线满意吗？给个评价吧！</a></div>                '),data.cbtLink&&_template_fun_array.push('            <div style="padding:10px 0 0 9px">                <div class="cbtLink">                    <img class="cbtLinkLogo" src="',"/newmap/static/common/images/transparent.gif",'" >&nbsp;<span>从',"undefined"==typeof data.startName?"":baidu.template._encodeHTML(data.startName),"到","undefined"==typeof data.endName?"":baidu.template._encodeHTML(data.endName),'的跨城公交 </span><a href="javascript:void(0)" id="showCBusRoute" tid="showCBusRoute">查看线路</a>                </div>            </div>        '),_template_fun_array.push("        "),data.taxi&&_template_fun_array.push('        <div id="newBsTaxi" class="MapInfo_taxiCost">            <span class="textLineA">打车费用: ',"undefined"http://webmap0.map.bdstatic.com/newmap/static/common/pkg/==typeof data.taxi?"":baidu.template._encodeHTML(data.taxi),'元</span> <span style="color:#999999" id="totalPriceResult">(按驾车的最短路程计算)</span>        </div>        '),_template_fun_array.push('        <div id="route_type" class="drive strategySel">             <div class="strategySel_r" id="navStrategy">                <span class="leftBorLine"></span>                <div class="noSel" id="type0">推荐路线</div>                <div class="noSel" id="type1"><span class="lineBg">最短路程</span></div>                <div class="noSel" id="type2"><span class="lineBg">不走高速</span></div>                <span class="rightBorLine"></span>            </div>        </div>    </div>    <div class="route_contentWrapper">    </div>    <div id="drive_bottom" class="route_bottom black navtran">        <p class="lp">            <a id="reChoice" tid="reChoice" href="javascript:void(0)">',"undefined"==typeof data.reChoice?"":data.reChoice,'</a>        </p>        <p class="rp">            查看：<a id="routeReturn" href="javascript:void(0)" tid="routeReturn">返程</a>&nbsp;|&nbsp;            '),data.busInfo?_template_fun_array.push('            <a href="javascript:void(0)" id="routeBus" data-stat="',"undefined"http://webmap0.map.bdstatic.com/newmap/static/common/pkg/==typeof data.busInfo.stat?"":baidu.template._encodeHTML(data.busInfo.stat),'">',"undefined"http://webmap0.map.bdstatic.com/newmap/static/common/pkg/==typeof data.busInfo.text?"":baidu.template._encodeHTML(data.busInfo.text),"</a>            "):_template_fun_array.push("            暂无公交            "),_template_fun_array.push("            &nbsp;            "),data.walkInfo&&_template_fun_array.push('            |&nbsp;<a href="javascript:void(0)" id="routeWalk">步行</a>            '),_template_fun_array.push("        </p>    </div></div>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],taxi="";this.sCity.code==this.eCity.code&&util.isActiveCity("taxi",this.sCity.code)&&this.taxi&&(taxi=this.taxi.detail[0].totalPrice,addStat("navscheme.navscheme.texifee"));var cmsAdStr=this._setNewCms();this.navListView.setNavCmsAdStrFlag(cmsAdStr?1:0);var cbtLink=!1,busInfo;this.sCity.code!=this.eCity.code?(cbtLink=!0,busInfo={stat:"crosscitybusscheme.crosscitybl.tipsforcrossbl",text:"跨城市公交"}):busInfo=0==modelConfig.supBus&&2==modelConfig.cityType?void 0:{stat:"navscheme.navscheme.showbl",text:"公交"};var reChoice=1==this.routeIndex.length?"重选起终点":"重选起终点和途经点",dis=parseFloat(BMap.Project.getDistanceByMC(this.sp,this.ep)),walkInfo=!1;1500>dis&&(walkInfo=!0),this.$el=T(template({data:{new_cms_ad:cmsAdStr,cbtLink:cbtLink,startName:this.start.wd,endName:this.end.wd,taxi:taxi,reChoice:reChoice,busInfo:busInfo,walkInfo:walkInfo}})),this.$el.find(".route_contentWrapper").append(this.navListView.render())}else{addStat("navscheme.navscheme.noresultrender","click");var template=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div id="nav_container">    <div class="mapinfo_con">        <p style="text-indent:5px;line-height:25px;background:#FFF5CA">未能计算出从“<span class="nr_kw">',"undefined"http://webmap0.map.bdstatic.com/newmap/static/common/pkg/==typeof data.start.wd?"":baidu.template._encodeHTML(data.start.wd),"</span>”","undefined"http://webmap0.map.bdstatic.com/newmap/static/common/pkg/==typeof data.tp1?"":baidu.template._encodeHTML(data.tp1),'到“<span class="nr_kw">',"undefined"http://webmap0.map.bdstatic.com/newmap/static/common/pkg/==typeof data.end.wd?"":baidu.template._encodeHTML(data.end.wd),"</span>”的驾车路线，抱歉。</p>        ","undefined"==typeof ss?"":ss,'        <div class="nr_suggest">您还可以：            <ul>                <li>看看地图当前城市是否有误，尝试更换城市</li>                <li>您可在地图上移动起点、终点，再次尝试</li>", "<li>您可更换关键词再次尝试。</li>            </ul>        </div>    </div></div>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0];this.$el=T(template({data:this.getNoResultTemplateData()})),this.result.end.length>1&&addStat("navscheme.navscheme.withtp","click")}return this.$el}catch(e){"undefined"!=typeof alog&&alog("http://webmap0.map.bdstatic.com/newmap/static/common/pkg/exception.fire","catch",{msg:e.message||e.description,path:"common:widget/com/NavTrans/NavTrans.js",ln:214})}},initialize:function(){try{var t=window;this.busQueryString=this.buildBusQueryString(),t.searchInViewCtrl&&t.searchInViewCtrl.exit(),t.weipaiTool&&t.weipaiTool.resetStatus(),BoxContainer&&BoxContainer.resetStatus(),this.json.content&&PanoUtil.isPanoStatus()&&PanoUtil.closePano("search"),searchBox.setSwitchTab(3),searchBox.driveSSG1?searchBox.driveSSG1.setValue(this.start.wd):searchBox.setValue("DriveSearchSta",this.start.wd),searchBox.driveSSG2?searchBox.driveSSG2.setValue(this.end.wd):searchBox.setValue("DriveSearchEnd",this.end.wd);var e=this.generateNavMapData();if(this.navMap=new NavMap(e),this.navMap.drawLines(),!this.total)return;this.navMap.addPopInfoWin(),this.modelQuery=this.navMap.buildQuery().url,this.isMainRequest===!1&&(t.currentComponent.modelQuery=this.modelQuery),this.navListView.initialize(),1==this.navListData.routes.length&&this.showSendTipOnResultPage(),this.processState(),this._panoNavParams=this._generatePanoNavPrams(),this.changStrategy(this.strategy),this._binder(),map.mapType==BMAP_TYPE_DIMENSIONAL&&this.navMap.navTranFor3D(!1),this.cinfo&&"nav"==this.cinfo.sms&&(sms.ready("","nav"),Share.setSmSCode("nav")),SchemeFaver.isRepeat.call(this,{pathtype:0,dom:T.G("driveFavBtn")}),setComplaintCenterURL(map,this),this.setSurveyLink(),mapInfoScrollPanel?mapInfoScrollPanel.hide():T.g("MapInfo").style.overflowY="hidden"}catch(n){"undefined"!=typeof alog&&alog("http://webmap0.map.bdstatic.com/newmap/static/common/pkg/exception.fire","catch",{msg:n.message||n.description,path:"common:widget/com/NavTrans/NavTrans.js",ln:322})}},getNoResultTemplateData:function(){var t=this.result,e={ss:"",tp1:"",start:this.start,end:this.end},n="";if("未知路段"==this.start.wd||"未知路段"==this.end.wd);else{for(var i=0;i<t.end.length-1;i++)i==t.end.length-2?(n+=t.end[i].wd,e.tp1+="“<span class='nr_kw'>"+t.end[i].wd+"</span>”"):(n+=t.end[i].wd+"、",e.tp1+="“<span class='nr_kw'>"+t.end[i].wd+"</span>”、");n&&(n="经"+n,e.tp1="经"+e.tp1),e.ss=iKnow.getIknowCode("想知道:"+modelConfig.cityName+"从"+this.start.wd+n+"到"+this.end.wd+"开车怎么走？")}return e},buildBusQueryString:function(){var t=this,e=1==t.start.bus_stop?0:1,n=1==t.end.bus_stop?0:1,i=t.start.uid||"",a=t.end.uid||"",s=indexUtil.getBusExpTime(),o=window.BusTransInst?BusTransInst.exptype:"dep",r=window.BusTransInst?BusTransInst.version:5,d="bt&bttp=1&c="+t.currentCity+"&sc="+t.sCity.code+"&ec="+t.eCity.code+"&sn="+e+"$$"+i+"$$"+t.start.pt+"$$"+encodeURIComponent(t.start.wd)+"$$$$$$&en="+n+"$$"+a+"$$"+t.end.pt+"$$"+encodeURIComponent(t.end.wd)+"$$$$$$&sq="+encodeURIComponent(t.s_query)+"&eq="+encodeURIComponent(t.e_query)+"&exptype="+o+"&exptime="+s+"&version="+r;return d},processState:function(){var t=this;if(void 0!=t.cinfo._index){var e=t.cinfo._index.split("-");if(t.cinfo._index.indexOf("showAll")>-1)t.navListView.showAllDes();else if(e[1]){for(var n=e[1].split(","),i=0;i<n.length;i++)isNaN(n[i])||t.navListView.expandItem(parseInt(n[i]));Share.listIndex="0-"+n}t.cinfo._index=null}if(void 0!=t.cinfo._popIndex){var a=parseInt(t.cinfo._popIndex);if(a>0&&a<t.navMap.popPoints.length){var s=t.navMap.popPoints[a].p,o=t.navMap.popPoints[a].a,r=t.navMap.popWins[a];if(0!=a&&a!=t.navMap.popPoints.length-1){var d=mapUtil.addDrvDirIcon(s,o);d.addEventListener("click",t.getClickMarker(r,d,a)),transInfo.transInfoWindow(d,r,{showLine:!0}),t.navMap.popPois.push(d)}else 0==a?t.navMap.clickStop(a):a==t.navMap.popPoints.length-1&&t.navMap.clickStop(this.tpList.length+1)}}},_binder:function(){var t=this;this.navListView.addEventListener("kmclick",function(){t.navMap.resetDrv()}),this.navListView.addEventListener("delviaclick",function(e,n){addStat("navscheme.navscheme.removetp","click"),t.navMap.delVia(n)}),this.navListView.addEventListener("h3click",function(e,n){t.navMap.clickStop(n)}),this.navListView.addEventListener("mainlistclick",function(e,n){t.navMap.mainRoudeClick(n.itemIndex,n.groupIndex)}),this.navListView.addEventListener("mainlistmouseover",function(e,n){t.navMap.mainRoudeOn(n.itemIndex,n.groupIndex)}),this.navListView.addEventListener("mainlistmouseout",function(e,n){t.navMap.mainRoudeOut(n.itemIndex,n.groupIndex)}),this.navListView.addEventListener("sublistclick",function(e,n){t.navMap.highRoute(n.itemIndex)}),this.navListView.addEventListener("sublistmouseover",function(e,n){t.navMap.addTips(n.itemIndex)}),this.navListView.addEventListener("sublistmouseout",function(e,n){t.navMap.removeTips(n.itemIndex)}),this.navListView.addEventListener("panodataready",function(e,n){var i=t.getPopWndAndLineRelation();t.navMap.updatePanoPopWins(n,i)}),this.navMap.addEventListener("poiinfoopen",function(e,n){t.navListView.hightLightItem(n.index)}),this.$el.find("#newBsTaxi").click(function(){t.getTaxi(this)}),this.$el.find("#routeReturn").click(function(){t.returnDr()}),this.$el.find("#reChoice").click(function(){t.backAddr()}),this.$el.find("#showCBusRoute").click(function(){addStat("navscheme.navscheme.cbuschange","click"),t.busChange()}),this.$el.find("#routeBus").click(function(){addStat(this.getAttribute("data-stat")),t.busChange()}),this.$el.find("#routeWalk").click(function(){t.navWalk()}),this.$el.find("#driveSmSBtnID").click(function(e){t.sendSMS(this,e)}),this.$el.find("#driveFavBtn").click(function(e){t.addToFav(this,e)}),this.$el.find("#drivePrintBtnID").click(function(){t.print(this)}),baidu.on("navAdClose","click",function(){baidu.g("navAdContainer").innerHTML="",T.cookie.set("navCmsAd","2",{expires:6048e5})})},changStrategy:function(t){var e=this;if(T.g("navStrategy")){var n=T.g("navStrategy");if(n)for(var i=n.getElementsByTagName("div"),a=0;a<i.length;a++){var s=i[a];if(t==s.id.charAt(4)){s.className="sel";var o=T.g("totalPriceResult");o&&(0==t?o.innerHTML="(按驾车的最少时间计算)":1==t?o.innerHTML="(按驾车的最短路程计算)":2==t&&(o.innerHTML="(按照不走高速的方案计算)")),s.checked=1}s.style.cursor="pointer",s.onclick=function(){T.g("type"+e.strategy)?T.g("type"+e.strategy).className="noSel":null,e.strategy=this.id.charAt(4),this.className="sel",this.checked=1,navigator.cookieEnabled&&T.cookie.set("Map_navTranType",e.strategy,{expires:new Date((new Date).getTime()+31536e6)});var t=e.navMap.buildQueryOnlyByTp(null,4);addStat("navscheme.navscheme.clickstrategy"+e.strategy),componentManager.go("nav&c="+e.currentCity+"&drag=0&sc="+e.sCity.code+"&ec="+t.tc+e.eCity.code+"&sy="+e.strategy+"&sn=1$$$$"+e.start.pt+"$$"+encodeURIComponent(e.start.wd)+"$$$$$$&en="+t.tp+"1$$$$"+e.end.pt+"$$"+encodeURIComponent(e.end.wd)+"$$$$$$&sq="+encodeURIComponent(e.s_query)+"&eq="+encodeURIComponent(e.e_query)+"&reqtp=1",{isMainRequest:"no"})},s.onmouseover=function(){for(var t=this,n=t.getElementsByTagName("span"),i=T.g("navStrategy").getElementsByTagName("span"),a=0,s=t.id.charAt(4),o=0;o<i.length;o++)i[o]==n[0]&&(a=o);s==e.strategy?(T.ac(T.g("route_type"),"bus_strategySel_on"),0==s?i[0].className="leftBorLine leftBorLine_active_on":2==s&&(i[i.length-1].className="rightBorLine rightBorLine_active_on")):(t.className="noSel noSel_on",0==s?i[0].className="leftBorLine leftBorLine_on":2==s&&(i[i.length-1].className="rightBorLine rightBorLine_on")),n[0]&&(n[0].className="lineBg lineBg_on"),a+2<i.length&&i[a+1]&&(i[a+1].className="lineBg lineBg_on")},s.onmouseout=function(){for(var t=this,n=t.getElementsByTagName("span"),i=T.g("navStrategy").getElementsByTagName("span"),a=0,s=t.id.charAt(4),o=0;o<i.length;o++)i[o]==n[0]&&(a=o);s==e.strategy?(T.rc(T.g("route_type"),"bus_strategySel_on"),0==s?i[0].className="leftBorLine":2==s&&(i[i.length-1].className="rightBorLine")):(t.className="noSel",0==s?i[0].className="leftBorLine":2==s&&(i[i.length-1].className="rightBorLine")),n[0]&&(n[0].className="lineBg"),a+2<i.length&&i[a+1]&&(i[a+1].className="lineBg")}}}},unload:function(){TPM.state="",TPM.clearTpListInMap(),TPM.afterAddByPoint=void 0,window.cxtBusPoints=null,window.startPoi=null,window.endPoi=null,window.dropRoutes=[];var t=T.G("defCityTip");t&&(t.style.display="none"),this.navListView&&this.navListView.unload(),this.navMap&&this.navMap.unload(),MapComponent.prototype.unload.apply(this,arguments)},getTaxi:function(t){taxi.openTaxi(t,{data:this.taxi,from:"nav"})},isCrossCity:function(){return this.sCity&&this.eCity?this.sCity.code!=this.eCity.code:!1},addFeedback:function(){},setSurveyLink:function(){var t=T.g("route_survey"),e=new Date,n=[e.getFullYear(),e.getMonth()+1<10?"0"+(e.getMonth()+1):e.getMonth()+1,e.getDate()<10?"0"+e.getDate():e.getDate(),e.getHours()<10?"0"+e.getHours():e.getHours(),e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes(),e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds()].join("-"),i="http://tiyan.baidu.com/index.php?r=survey%2Fjump&version=old&citycode="+[this.sCity.code,this.eCity.code].join(",")+"&start="+encodeURIComponent(this.start.wd)+"&end="+encodeURIComponent(this.end.wd)+"&searchtime="+n;t.href=i},_setNewCms:function(){var t="";if(window._OLR&&_OLR.index){var e=baidu.json.parse(_OLR.index)||{},n=e.special&&e.special.data&&e.special.data.top.nav?e.special.data.top.nav:"";if("2"!==T.cookie.get("navCmsAd")){var i=n?n.length:0;if(n&&i>0){var a=new Date,s=a.getHours()%i;t=n[s].icon?'<div class="newCmsAd" style="background-image:url('+n[s].icon+') !important;">':'<div class="newCmsAd">',t=n[s].link2?t+n[s].title+'<a href="'+n[s].link1+"\" target=\"_blank\" onclick=\"addStat('indexleftmenu.links.navlink', 'click', {da_trd:'"+n[s].title+"'});\">"+n[s].link_text1+'</a>&nbsp;&nbsp;<span>|</span>&nbsp;&nbsp;<a href="'+n[s].link2+"\" target=\"_blank\" onclick=\"addStat('indexleftmenu.links.navlink', 'click', {da_trd:'"+n[s].title+"'});\">"+n[s].link_text2+'</a><a id="navAdClose" class="closeBtn" href="#"></a></div>':t+n[s].title+'<a href="'+n[s].link1+"\" target=\"_blank\" onclick=\"addStat('indexleftmenu.links.navlink', 'click', {da_trd:'"+n[s].title+"'});\">"+n[s].link_text1+'</a><a id="navAdClose" class="closeBtn" href="#"></a></div>'}else t=""}}return""!=t&&addStat("indexleftmenu.links.navlink","show"),t},getPopWndAndLineRelation:function(){for(var t=[],e=this.json.content.kps,n=e.length,i=[],a=0,s=0,o=0;o<this.tpList.length;o++)t.push(this.tpList[o].index);for(i.push(s),i.push(s),s+=1;n-2>a;)0==a?(this.mainRoute.length>0&&(s+=1),i.push(s),s+=1,a+=2):-1!==T.array.indexOf(this.mainRoute,a)?(s+=1,i.push(s),s+=1,a+=1):-1!==T.array.indexOf(t,a)?(s+=1,a+=1):(i.push(s),s+=1,a+=1);return i.push(s),i.push(s),i},generateRouteIndex:function(){for(var t=this.json.content.kps,e=this.json.content.rss,n=0,i=[{start:0,mn:[]}],a=0;a<e.length;a++){var s=e[a],o=t[a];if(s.mn&&1==s.mn.m&&s.n&&s.mn.mg&&(i[i.length-1].mn.push(a),this.mainRouteStart.push(a),this.mainRoute.push(a)),3==o.rt){var r=this.waypoints?this.waypoints[n].if_wp:!1;r?(i[i.length-1].end=a,i.push({start:a,mn:[]}),this.tpList.push({name:this.waypoints[n].wd||e[a+1].n||this.noName,index:a,tpIndex:n,direction:t[a].a,points:mapUtil.parse2Geo(t[a].pt).points}),-1==T.array.indexOf(this.mainRouteStart,a)&&this.mainRouteStart.push(a)):this.wpList.push({name:e[a+1].n||this.noName,index:a,tpIndex:n}),n++}else a===e.length-1&&(i[i.length-1].end=a)}return i},generateNavListData:function(){for(var t=this.json.content.kps,e=this.json.content.rss,n={type:"nav",start:{name:this.json.result.start.wd,uid:this.start.uid,points:mapUtil.parse2Geo(t[0].pt).points,poiType:"FF0201",direction:t[0].a},end:{name:this.json.result.end[this.json.result.end.length-1].wd,uid:this.end.uid,points:mapUtil.parse2Geo(t[t.length-1].pt).points,poiType:"FF0202",direction:t[t.length-1].a},routes:[],tpList:this.tpList,wpList:this.wpList,showScrollPanel:!0},i=0,a=0;a<this.routeIndex.length;a++){var s=this.routeIndex[a],o=[];o.hasSubList=!1;for(var r=s.start;r<=s.end;r++){var d=t[r].rt,p=parseInt(e[r].d);e[r].poi&&(p-=e[r].poi.pd);var c=this.roundDis(p);if(0==s.mn.length)0===o.length&&o.push({subList:[]});else if(r===s.start){var h="";h=s.start===s.mn[0]?"从"+e[r].n+"出发":-1!==T.array.indexOf(s.mn,r+1)?".从"+e[s.mn[0]].n+"出发":"从"+(0==r?"起点":"途经点")+"到"+e[s.mn[0]].n,-1===T.array.indexOf(s.mn,r+1)&&(o.push({title:h,points:mapUtil.parse2Geo(t[r].pt).points,direction:t[r].a,subList:[]}),this.mainRouteIndex.push(i))}else T.array.indexOf(s.mn,r)>-1&&(o.push(T.array.indexOf(s.mn,r)===s.mn.length-1?{title:e[r].n+"到"+(a===this.routeIndex.length-1?"终点":"途经点"),points:mapUtil.parse2Geo(t[r].pt).points,direction:t[r].a,subList:[]}:{title:e[r].n,points:mapUtil.parse2Geo(t[r].pt).points,direction:t[r].a,subList:[]}),this.mainRouteIndex.push(i));if(r==s.start)o.length&&(o[o.length-1].subList.push({desc:"从<span>"+(0==a?"起点":"途经点")+"</span>向"+this.getTurType(t[r].ett)+"出发，",points:mapUtil.parse2Geo(t[r+1].pt).points,direction:t[r+1].a}),o.hasSubList=!0,i++);else if(r==s.start+1){var l=this.getSubListDesc(r,c,"mid");T.array.indexOf(s.mn,r)>-1?(o[o.length-1].subList.push({desc:"从<span>"+(0==a?"起点":"途经点")+"</span>向"+e[r].n+"出发，"+l,points:mapUtil.parse2Geo(t[r].pt).points,direction:t[r].a}),o.hasSubList=!0,i++):o[o.length-1].subList[0].desc+=l}else if(r==s.end-1){var l=this.getSubListDesc(r,c,"end");o[o.length-1].subList.push({desc:l,points:mapUtil.parse2Geo(t[r].pt).points,direction:t[r].a}),o.hasSubList=!0,i++}else if(r==s.end){var d=this.leftOrRight(e,t,r),u=this.getTr(r-1);if(a===this.routeIndex.length-1)var m=2==d?"到达<span>终点</span>":5==d?"到达<span>终点</span>(在道路<span>左侧</span>)":6==d?"到达<span>终点</span>(在道路<span>右侧</span>)":"";else var m=2==d?"到达<span>途经点</span>":5==d?"到达<span>途经点</span>(在道路<span>左侧</span>)":6==d?"到达<span>途经点</span>(在道路<span>右侧</span>)":"";o[o.length-1].subList[o[o.length-1].subList.length-1].desc+=m+u}else if(3!==d){var l=this.getSubListDesc(r,c,"mid");o[o.length-1].subList.push({desc:l,points:mapUtil.parse2Geo(t[r].pt).points,direction:t[r].a}),o.hasSubList=!0,i++}}n.routes.push(o)}return n.extInfo=this.getExtInfo(),n.distanceValue=this.json.content.dis,n.cmsAds=this.getCmsAds(),n.navAds=!0,n},getSubListDesc:function(t,e,n){var i=["","朝"],a=this.json.content.rss,s=this.json.content.kps,o=this.getRoadName(a[t-1].t,a[t-1].n),r=this.getRoadName(a[t].t,a[t].n),d=this.getRoadName(a[t+1].t,a[t+1].n),p=(""!=r&&o==r?"继续":"")+this.getRoadAct(a[t].t,a[t].n),c="mid"==n?this.getTicInfo(s,t):this.getTicInfo(s,t+1),h=a[t].poi,l=this.getPoiInfo(a,h,t),u=p+"<span>"+r+"</span>"+this.rettype[s[t].rt]+e+"，"+l+c;if("mid"==n){var m=this.getTr(t),g=i[s[t].dw]||"",v=s[t].dr?g+"<span>"+s[t].dr+"</span>，":"",f=this.getRetType(a[t+1].t,0,a[t+1].n),w=r==d?"":f+"<span>"+d+"</span>";u+=v+"<span>"+this.getTurType(s[t].ett)+"</span>"+w+m}return u},getTr:function(t){var e=this.json.content.rss;return 1==e[t].tr?"<br><font color='#CA0000'>全路段收费</font>":2==e[t].tr?"<br><font color='#CA0000'>部分路段收费</font>":""},generateNavMapData:function(){for(var t=[],e=[],n=[],i=[],a=[],s=[],o=[],r=[],d=[],p=[],c=this.json.content.kps,h=this.json.content.rss,l=-1,u=0,m=0;m<this.routeIndex.length;m++)for(var g=this.routeIndex[m],v=g.start;v<=g.end;v++){-1!==T.array.indexOf(this.mainRouteStart,v)&&(v!==l&&v-1!==g.start&&(i.push([]),a.push([])),l=v),-1!==T.array.indexOf(this.mainRoute,v)&&u++;var f=c[v].rt,w=parseInt(h[v].d);if(v==g.start){if(t.push({p:mapUtil.parse2Geo(c[v].pt).points,n:this.start.wd}),0===m)var y={p:this.start.pt,a:-1};else var y={p:mapUtil.parse2Geo(c[v].pt).points,a:c[v].a};r.push(y);var _={};_.popPoint=y,0==m&&(s.push(y),a[a.length-1].push({p:mapUtil.parse2Geo(c[v].pt).points,a:c[v].a}));var x=this.getRoadName(h[v+1].t,h[v+1].n),P={title:0==m?this.start.wd:this.getTpName(v),info:"",next:x||this.noName};d.push(P),_.popInfo=P,p.push(0==m?0:_);var $=this.getRoadName(h[v+1].t,h[v+1].n),b=this.getRoadName(h[v+2].t,h[v+2].n),C=parseInt(h[v+1].d),S=this.roundDis(C);if(r.push({p:mapUtil.parse2Geo(c[v].pt).points,a:c[v].a}),0==m&&s.push(r[r.length-1]),v+2==g.end)d.push({title:$||this.noName,info:this.rettype[c[v+1].rt]+S,next:"停车点"});else{f=c[v+2].rt;var I=this.getRetType(h[v+1].t,1,h[v+1].n);3==f&&(b="到达"+this.rettype[f],I="，");var L=this.getTicInfo(c,v+1);d.push({title:$||this.noName,info:L+this.getTurType(c[v+1].ett)+I+b,next:b||this.noName})}}else if(v==g.start+1){var B=mapUtil.parse2Geo(h[v].g);n.push(B.points),e.push(B.bound),i[i.length-1].push(B.bound),o[o.length]||(o[o.length]=[]),o[o.length-1].push({p:B.points,d:w,b:B.bound});var N=this.getRoadName(h[v].t,h[v].n),$=this.getRoadName(h[v+1].t,h[v+1].n),b=h[v+2]?this.getRoadName(h[v+2].t,h[v+2].n):"",C=parseInt(h[v+1].d),S=this.roundDis(C);if(r.push({p:mapUtil.parse2Geo(c[v].pt).points,a:c[v].a}),s.push(r[r.length-1]),1==a.length?a[a.length-1].push({p:mapUtil.parse2Geo(c[v].pt).points,a:c[v].a}):u>0&&h[v].n==h[this.mainRoute[u-1]].n&&a[a.length-1].push({p:mapUtil.parse2Geo(c[v].pt).points,a:c[v].a}),v+1==g.end)d.push({title:"停车点",info:this.rettype[c[v+1].rt],next:m==this.routeIndex.length-1?"终点":"途经点"});else if(v+2==g.end)d.push({title:x||this.noName,info:this.rettype[c[v+1].rt]+S,next:"停车点"});else if(3==c[v+2].rt){var f=c[v+2].rt,k=this.rettype[f];d.push({title:x||this.noName,info:this.rettype[c[v+1].rt]+S+"，到达"+k,next:b||this.noName})}else{var M,f=c[v+1].rt;if(3==f&&v+2==c.length){x=N;var R=parseInt(h[v+2].d),U=this.roundDis(R);M=this.rettype[c[v+2].rt]+U+"，到达停车点"}else{x=T.trim(h[v+2].n);var R=parseInt(h[v+1].d),U=this.roundDis(R);if(v+3==g.end)if(3!=f||this.isTp(v)){N=this.getRoadName(h[v+1].t,h[v+1].n),b=this.getRoadName(h[v+2].t,h[v+2].n);var L=this.getTicInfo(c,v+1);M=L+this.getTurType(c[v+1].ett)+","}else{N=this.getRoadName(h[v].t,h[v].n),b="停车点";var R=parseInt(h[v+2].d),U=this.roundDis(R);M=this.rettype[c[v].rt]+U+this.getTurType(c[v+1].ett)+"，到达停车点"}else if(3!=f||this.isTp(v)){N=this.getRoadName(h[v+1].t,h[v+1].n),b=this.getRoadName(h[v+2].t,h[v+2].n);var I=this.getRetType(h[v+2].t,1,h[v+2].n),L=this.getTicInfo(c,v+1);M=L+this.getTurType(c[v+1].ett)+I+b}else{N=this.getRoadName(h[v].t,h[v].n),b=this.getRoadName(h[v+3].t,h[v+3].n);var R=parseInt(h[v+2].d),U=this.roundDis(R),I=this.getRetType(h[v+3].t,1,h[v+3].n),L=this.getTicInfo(c,v+1);M=L+this.getTurType(c[v].ett)+I+b}}d.push({title:N||this.noName,info:M,next:b||this.noName})}}else if(v==g.end-1){var B=mapUtil.parse2Geo(h[v].g);n.push(B.points),o[o.length-1].push({p:B.points,d:w,b:B.bound}),e.push(B.bound),i[i.length-1].push(B.bound),r.push({p:mapUtil.parse2Geo(c[v].pt).points,a:c[v].a}),s.push(r[r.length-1]),1==a.length?a[a.length-1].push({p:mapUtil.parse2Geo(c[v].pt).points,a:c[v].a}):u>0&&h[v].n==h[this.mainRoute[u-1]].n&&(0==a[a.length-1].length&&a[a.length-1].push({p:mapUtil.parse2Geo(c[v-1].pt).points,a:c[v-1].a}),a[a.length-1].push({p:mapUtil.parse2Geo(c[v].pt).points,a:c[v].a})),d.push({title:"停车点",info:"步行前往"+(m==this.routeIndex.length-1?"终点":"途经点"),next:m==this.routeIndex.length-1?this.end.wd:this.getTpName(g.end)})}else if(v==g.end)m===this.routeIndex.length-1&&(t.push({p:mapUtil.parse2Geo(c[v].pt).points,n:this.end.wd}),r.push({p:this.end.pt,a:-1}),s.push(r[r.length-1]),1==a.length?a[a.length-1].push({p:mapUtil.parse2Geo(c[v].pt).points,a:c[v].a}):u>0&&h[v].n==h[this.mainRoute[u-1]].n&&a[a.length-1].push({p:this.end.pt,a:-1}),d.push({title:this.end.wd,info:"",next:""}),p.push(d.length-1));else if(3===f){var k=T.trim(h[v+1].n);k=k||this.noName,t.push({p:mapUtil.parse2Geo(c[v].pt).points,n:k}),o[o.length]||(o[o.length]=[])}else{var N=(this.getRoadName(h[v-1].t,h[v-1].n),this.getRoadName(h[v].t,h[v].n)),x=this.getRoadName(h[v+1].t,h[v+1].n),L=this.getTicInfo(c,v),f=c[v+1].rt,$=this.getRoadName(h[v+1].t,h[v+1].n),b=this.getRoadName(h[v+2].t,h[v+2].n),C=parseInt(h[v+1].d),S=this.roundDis(C),B=mapUtil.parse2Geo(h[v].g);if(n.push(B.points),o[o.length-1].push({p:B.points,d:w,b:B.bound}),e.push(B.bound),i[i.length-1].push(B.bound),r.push({p:mapUtil.parse2Geo(c[v].pt).points,a:c[v].a}),s.push(r[r.length-1]),1==a.length?a[a.length-1].push({p:mapUtil.parse2Geo(c[v].pt).points,a:c[v].a}):u>0&&h[v].n==h[this.mainRoute[u-1]].n&&(0==a[a.length-1].length&&a[a.length-1].push({p:mapUtil.parse2Geo(c[v-1].pt).points,a:c[v-1].a}),a[a.length-1].push({p:mapUtil.parse2Geo(c[v].pt).points,a:c[v].a})),3==c[v+2].rt){var f=c[v+2].rt,k=this.rettype[f],b=T.trim(h[v+3].n);d.push({title:x||this.noName,info:this.rettype[c[v+1].rt]+S+"，到达"+k,next:b||this.noName})}else if(3==c[v+1].rt){k=this.rettype[f];var C=parseInt(h[v+2].d),S=this.roundDis(C);x=T.trim(h[v].n);var b=T.trim(h[v+3].n),I=this.getRetType(h[v+3].t,1,h[v+3].n),L=this.getTicInfo(c,v+2);d.push({title:x||this.noName,info:L+this.getTurType(c[v+2].ett)+I+b,next:b||this.noName})}else{var I=this.getRetType(h[v+2].t,1,h[v+2].n),L=this.getTicInfo(c,v+1);(2==c[v+2].rt||5==c[v+2].rt||6==c[v+2].rt)&&(I="到达",b="停车点"),d.push({title:x||this.noName,info:L+this.getTurType(c[v+1].ett)+I+b,next:b||this.noName})}}}return{dragPoints:t,driveBounds:e,drivePoints:n,driveTargetPoints:s,groupBounds:i,groupPopPoints:a,routePoints:o,popPoints:r,popInfos:d,keyPopInfos:p,start:this.start,end:this.end,endArray:this.json.result.end,sCity:this.sCity,eCity:this.eCity,endCityArray:this.json.result.end_city,total:this.total,drag:this.drag,cinfo:this.cinfo,waypoints:this.waypoints,strategy:this.strategy,mainRouteIndex:this.mainRouteIndex}},getTurType:function(t){var e=["","直行","右前方转弯","右转","右后方转弯","调头","左后方转弯","左转","左前方转弯","稍向左转","直行","稍向右转","正北方向","东北方向","正东方向","东南方向","正南方向","西南方向","正西方向","西北方向"];return e[t]},getRoadName:function(t,e){var n=["","环岛","无属性道路","主路","高速连接路","交叉点内路段","连接道路","停车场内部道路","服务区内部道路","桥","步行街","辅路","匝道","全封闭道路","未定义交通区域","POI连接路","隧道","步行道","公交专用道","提前右转道"];return""!=e&&e||(9==t||12==t||1==t||16==t)&&(e=n[t]),e},getRetType:function(t,e,n){var i="";return 0==e?(i="进入",n||9!=t&&12!=t?(0==t||!n&&1!=t&&16!=t)&&(i=""):i="上"):1==e&&(i="，进入",n||9!=t&&12!=t?(0==t||!n&&1!=t&&16!=t)&&(i=""):i="，上"),i},roundDis:function(t){var e="";return t>0&&10>=t?e="10米":t>10&&(e=1e3>t?10*(t/10).toFixed(0)+"米":(t/1e3).toFixed(1)+"公里"),e},getRoadAct:function(t,e){var n="沿";return(0==t||!e&&1!=t&&16!=t&&9!=t&&12!=t)&&(n=""),n},getTicInfo:function(t,e){var n=["在","从","从"],i=["","","离开"],a=t[e].iw;return""==t[e].ic?"":(n[a]||"")+"<span>"+t[e].ic+"</span>"+(i[a]||"")
},getPoiInfo:function(t,e,n){var i="",a=["过","在"],s=["左侧的","右侧的",""];if(e){var o=s[e.ps]||"",r=a[e.pw]||"",d=e.pd<(13==t[n].t||4==t[n].t?1e3:50)?"":"约"+this.roundDis(e.pd)+"后";i=r+o+"<span class='b'>"+e.pn+"</span>"+d+(""==o?"":"，")}return i},leftOrRight:function(t,e,n){var i,a,s,o=mapUtil.parse2Geo(t[n-1].g).points.split(";"),r=this.end.pt.split(",");if(o&&o.length>=2){var d=o.length;a=o[d-1].split(","),s=o[d-2].split(",")}else a=mapUtil.parse2Geo(e[n-1].pt).points.split(","),s=mapUtil.parse2Geo(e[n-2].pt).points.split(",");var p=(a[0]-r[0])*(s[1]-r[1])-(a[1]-r[1])*(s[0]-r[0]);0==p?i=2:p>0?i=6:0>p&&(i=5);var c=BMap.Project.getDistanceByMC(new BMap.Point(r[0],r[1]),new BMap.Point(a[0],a[1]));return 10>c&&(i=2),i},getExtInfo:function(){var t=this.json.content.dis,e=this.roundDis(t),n=this.json.content.time,i="";return e&&(i+=e),n&&(i+="/"+transUtil.formatTime(n,"nav")),i="约"+i},getCmsAds:function(){return""},getPanoNavParams:function(){return this._panoNavParams},_generatePanoNavPrams:function(){var t=searchData.setUrl(this.modelQuery),e=util.getParam(t);if(e&&e.sn&&e.en)var n={start:e.sn,end:e.en,level:e.l,bound:e.b,currentCity:e.c,sc:e.sc,ec:e.ec,strategy:e.sy,extinfo:e.extinfo,time_index:-1,day:-1};else n="";return n},getTpName:function(t){for(var e=0;e<this.tpList.length;e++)if(this.tpList[e].index===t)return this.tpList[e].name;var n=this.json.content.rss[t+1].n;return n=n?n:this.noName},isTp:function(t){for(var e=!1,n=0;n<this.tpList.length;n++)if(this.tpList[n].index===t){e=!0;break}return e},returnDr:function(){addStat("navscheme.navscheme.showreturn");var t=this;t.cinfo&&1==t.cinfo.isSingle&&(t.cinfo.t=0==t.cinfo.t?1:0),t.navMap.dragPoints.reverse();var e=this.navMap.buildQueryOnlyByTp(null,5);componentManager.go("nav&navtp=1&c="+t.currentCity+"&drag=0&sc="+t.eCity.code+"&ec="+e.tc+t.sCity.code+"&sy="+t.strategy+"&en="+e.tp+"1$$$$"+t.start.pt+"$$"+encodeURIComponent(t.start.wd)+"$$$$$$&sn=1$$$$"+t.end.pt+"$$"+encodeURIComponent(t.end.wd)+"$$$$$$&sq="+encodeURIComponent(t.e_query)+"&eq="+encodeURIComponent(t.s_query),{cinfo:t.cinfo})},busChange:function(){searchBox.setSwitchTab(2);var t=this;searchBox._ByClickTab=!1,t.cinfo&&1==t.cinfo.isSingle&&(t.cinfo.q=t.cinfo.q.replace(/^nse&/,"bse&")),t.cinfo._maplevel=map.getZoom(),t.cinfo._centerPoint=map.getCenter(),componentManager.go(this.busQueryString,{cinfo:t.cinfo})},backAddr:function(){addStat("navscheme.navscheme.reslectterminal");var t=this;if(t.cinfo&&1==t.cinfo.isSingle)componentManager.go(t.cinfo.q+"&src=4",{cinfo:t.cinfo});else{var e=this.navMap.buildQueryOnlyByTp(2,6);componentManager.go("nav&c="+t.currentCity+"&drag=0&sc="+t.sCity.code+"&ec="+e.tc+t.eCity.code+"&sy="+t.strategy+"&sn=2$$$$"+t.start.pt+"$$"+encodeURIComponent(this.s_query)+"$$$$$$&en="+e.tp+"2$$$$"+t.end.pt+"$$"+encodeURIComponent(this.e_query)+"$$$$$$&src=4")}},navWalk:function(){var t=this;t.cinfo&&1==t.cinfo.isSingle&&(t.cinfo.t=0==t.cinfo.t?1:0),componentManager.go("walk&version=2.0&walktp=1&c="+t.currentCity+"&wdrag=0&sc="+t.sCity.code+"&ec="+t.eCity.code+"&sy="+t.strategy+"&en=1$$$$"+t.end.pt+"$$"+encodeURIComponent(t.end.wd)+"$$$$$$&sn=1$$$$"+t.start.pt+"$$"+encodeURIComponent(t.start.wd)+"$$$$$$&sq="+encodeURIComponent(t.s_query)+"&eq="+encodeURIComponent(t.e_query),{cinfo:t.cinfo})},sendSMS:function(t,e){var e=e||window.event;sms.ready(this,"nav"),addStat("navscheme.navscheme.navtomb"),util.stopBubble(e)},addToFav:function(t,e){addStat("navscheme.navscheme.navfavourite");var n=this;util.stopBubble(window.event||e),SyncMgr.checkFav(function(){SchemeFaver.toClound.call(n,{pathtype:0,dom:t})},this)},print:function(t){addStat("navscheme.navscheme.navschemeprint"),require.async("common:widget/ui/PrintMap/PrintMap.js",function(e){e.printMap(t.getElementsByTagName("a")[0])})},navTranFor3D:function(t){var e=this;MapConfig.navTrans.enableDragging=t,window.startPoi&&(t?window.startPoi.enableDragging():window.startPoi.disableDragging()),window.endPoi&&(t?window.endPoi.enableDragging():window.endPoi.disableDragging()),t?e.navMap.tipLabel&&map.addOverlay(e.navMap.tipLabel):e.navMap.tipLabel&&map.removeOverlay(e.navMap.tipLabel);for(var n=0;n<e.navMap.dragPois.length;n++)t?e.navMap.dragPois[n].enableDragging():e.navMap.dragPois[n].disableDragging()},setContext:function(t){var e=this;t&&(mapUtil.getGEORevertAddress(t,function(t){e.setValue(t)}),0==window.conType?this.startP=t:this.endP=t)},setValue:function(t){function e(t){var e=t.target.getPoint();util.loadSearchInfo(function(n){var i=n.createSearchInfoWnd({title:p},{x:e.lng,y:e.lat,isMenu:!0});n.openSearchInfoWnd(i,t.target),i.addEventListener("open",function(){n.switchInfoWndTab(1,"iw_esn")})})}function n(t){var e=t.target.getPoint();util.loadSearchInfo(function(n){var i=n.createSearchInfoWnd({title:p},{x:e.lng,y:e.lat,isMenu:!0});n.openSearchInfoWnd(i,t.target),i.addEventListener("open",function(){n.switchInfoWndTab(0,"iw_ssn")})})}var i=t.content,a=this,s="0",o="0",r=0,d=0==window.conType?this.startP:this.endP;if(!i)return void(0==window.conType?(map.removeOverlay(window.startPoi),window.startPoi=null):(map.removeOverlay(window.endPoi),window.endPoi=null));if(i){var p=i.address||"未知路段",c=map.temp.infoWin;if(window.cxtBusPoints||(window.cxtBusPoints=[]),0==window.conType)return window.cxtBusPoints[0]={p:d,n:p},window.startPoi?window.startPoi.setPoint(window.cxtBusPoints[0].p):(window.startPoi=mapUtil.addDestPoi(window.cxtBusPoints[0].p,"",constants.DEST_START),window.startPoi.enableDragging()),searchBox.busSSG1.setValue(p),searchBox.inputInfo.BusSearchSta.note=p,searchBox.inputInfo.BusSearchSta.point=window.startPoi.point.lng+","+window.startPoi.point.lat,searchBox.driveSSG1.setValue(p),searchBox.inputInfo.DriveSearchSta.note=p,searchBox.inputInfo.DriveSearchSta.point=window.startPoi.point.lng+","+window.startPoi.point.lat,window.startPoi.addEventListener("click",e),window.startPoi.addEventListener("dragging",function(){this.closeInfoWindow(),window.startPoi.removeEventListener("click",e)}),window.startPoi.addEventListener("dragend",function(){a.dragPointEnd(this,0)}),window.startPoi&&window.endPoi?startGo(s,o,r):c&&c.isOpen()&&c._ext&&"未知地点"!=c._ext.name&&(window.endPoi=mapUtil.addDestPoi(c.getPoint(),"",constants.DEST_END),window.endPoi.addEventListener("dragstart",function(t){a.dragStart(t)}),window.endPoi.addEventListener("dragging",function(t){a.draging(t)}),window.endPoi.addEventListener("dragend",function(t){a.dragEnd(t,1)}),window.endPoi.enableDragging(),window.cxtBusPoints[1]={p:c.getPoint(),n:c._ext.name||"未知地点",t:1},window.startPoi&&window.endPoi&&startGo(s,o,r)),void(i=null);if(1==window.conType)return window.cxtBusPoints[1]={p:d,n:p},window.endPoi?window.endPoi.setPoint(window.cxtBusPoints[1].p):(window.endPoi=mapUtil.addDestPoi(window.cxtBusPoints[1].p,"",constants.DEST_END),window.endPoi.enableDragging()),searchBox.busSSG2.setValue(p),searchBox.inputInfo.BusSearchEnd.note=p,searchBox.inputInfo.BusSearchEnd.point=window.endPoi.point.lng+","+window.endPoi.point.lat,searchBox.driveSSG2.setValue(p),searchBox.inputInfo.DriveSearchEnd.note=p,searchBox.inputInfo.DriveSearchEnd.point=window.endPoi.point.lng+","+window.endPoi.point.lat,window.endPoi.addEventListener("click",n),window.endPoi.addEventListener("dragging",function(){this.closeInfoWindow(),window.endPoi.removeEventListener("click",n)}),window.endPoi.addEventListener("dragend",function(){a.dragPointEnd(this,1)}),window.startPoi&&window.endPoi?endGo(s,o,r):c&&c.isOpen()&&c._ext&&"未知地点"!=c._ext.name&&(window.startPoi=mapUtil.addDestPoi(c.getPoint(),"",constants.DEST_START),window.startPoi.addEventListener("dragstart",function(t){a.dragStart(t)}),window.startPoi.addEventListener("dragging",function(t){a.draging(t)}),window.startPoi.addEventListener("dragend",function(t){a.dragEnd(t,0)}),window.startPoi.enableDragging(),window.cxtBusPoints[0]={p:c.getPoint(),n:c._ext.name||"未知地点",t:0},window.startPoi&&window.endPoi&&endGo(s,o,r)),void(i=null)}},dragPointEnd:function(t,e){if(t){window.conType=e;var n=util.getOverlayPoint(t),i=this;mapUtil.getGEORevertAddress(n,function(t){i.setValue(t)}),0==window.conType?this.startP=n:this.endP=n}},removeTipOnResultPage:function(t){t&&(t.style.display="none",modelConfig.notShowTipInResultPage=!0)},showSendTipOnResultPage:function(){if(!isPrint){var t,e,n=this,i=/(sn=\d.*en=\d.*\$)/;if(!T.G("defCityTip")){var a='<div id="defCityTip" class="GR_Tip def_city_tip"></div>';util.beforeEndHTML(document.body,a)}this.modelQuery.match(i)&&(t=this.modelQuery.match(i)[1],e="http://tiyan.baidu.com/index.php?r=imap/post&tabs=0&source=1&start="+this.start.wd+"&end="+this.end.wd+"&"+t,e=encodeURI(e).replace(/'/g,escape("'")),T.G("defCityTip").innerHTML='<div class="tip_cont"><div class = "feedbackPop"><span>如果遇到问题，请您直接<a href = "'+e+'" title = "百度反馈专区" target = "_blank">告诉百度地图</a></span></div><button id="defCityTip-close-btn" onclick=";"></button>',this.setTipPos(T.G("defCityTip")),T("#defCityTip-close-btn").on("click",function(){n.removeTipOnResultPage(T.G("defCityTip"))}))}},setTipPos:function(t){t.style.display="block";var e=T.g("MapInfoCon").clientWidth,n=util.getClientSize().width,i=t.clientWidth,a=n/2-i/2;map.fullScreenMode?t.style.top="38px":(t.style.top="145px",a+=e/2),t.style.left=a+"px"},getOverlays:function(){return this.navMap.exportOverlays}}),module.exports=NavTrans});
;define("common:widget/com/NavTrans/NavMap.js",function(t,i,e){function n(t){T.lang.Class.call(this),T.object.extend(this,t),this.ajax=new T.Ajax,this.ajax.async=!0,this.currentCity=h.cityCode,this.queryObj=[],this.popWins=[],this.popPois=[],this.tipLabel=s.createDrvMidLabel("拖动以更改路线"),this.noName="未知路段",this.maxDragVia=10,this.exportOverlays={drRoutes:[],destMarkers:[],markers:[]},TPM.state="nav",TPM.reset()}var a=t("common:widget/com/componentManager.js"),o=t("common:widget/ui/util/util.js"),s=t("common:widget/ui/mapUtil/mapUtil.js"),r=t("common:widget/ui/transUtil/transUtil.js"),d=t("common:widget/ui/transInfoWindow/transInfoWindow.js"),p=t("common:widget/ui/constant/Constant.js"),g=t("common:widget/ui/config/config.js"),u=t("common:widget/ui/PanoEntranceUtil/PanoEntranceUtil.js"),h=g.modelConfig,l=g.mapConfig,c=t("common:widget/ui/mapShare/MapShare.js");T.inherits(n,T.lang.Class,"NavMap"),T.object.extend(n.prototype,{drawLines:function(){var t=this;if(map.clearOverlays(),!t.total||0==t.total){t.dragPoints.push({p:t.start.pt,n:t.start.wd});var i=s.addDestPoi(t.start.pt,"",p.DEST_START);return i.enableDragging(),i.addEventListener("dragging",function(i){t.addViaRoute2(i,1)}),i.addEventListener("mouseover",function(i){t.onViaPoiOver(i,1)}),i.addEventListener("mouseout",function(i){t.onRemoveTips(i,1)}),i.addEventListener("dragend",function(i){t.addViaPoi3(i,1)}),i.index=0,window.startPoi=i,t.dragPoints.push({p:t.end.pt,n:t.end.wd}),i=s.addDestPoi(t.end.pt,"",p.DEST_END),i.addEventListener("dragging",function(i){t.addViaRoute2(i,2)}),i.addEventListener("mouseover",function(i){t.onViaPoiOver(i,2)}),i.addEventListener("mouseout",function(i){t.onRemoveTips(i,2)}),i.addEventListener("dragend",function(i){t.addViaPoi3(i,2)}),i.index=1,i.enableDragging(),void(window.endPoi=i)}this.sended=0,this.addDrPoi(),s.addDrRoute(!1,this,this.cinfo?this.cinfo.fromBdyx:!1),this.exportOverlays.drRoutes.push({flag:!1,obj:this}),this._bindTPM()},unload:function(){this.routePoints=[],this.queryObj=[],this.dragPoints=[]},addDrPoi:function(){for(var i=this.dragPoints,e=i.length,n=this,a=0,r=this.waypoints,d=0;e>d;d++){var g;if(0==d)g=s.addDestPoi(this.start.pt,"",p.DEST_START),this.exportOverlays.destMarkers.push({point:this.start.pt,text:"",type:p.DEST_START}),g.addEventListener("dragging",function(t){n.addViaRoute2(t,1)}),g.addEventListener("mouseover",function(t){n.onViaPoiOver(t,1)}),g.addEventListener("mouseout",function(t){n.onRemoveTips(t,1)}),g.addEventListener("dragend",function(t){n.addViaPoi3(t,1)}),window.startPoi=g;else if(d==e-1)g=s.addDestPoi(this.end.pt,"",p.DEST_END),this.exportOverlays.destMarkers.push({point:this.end.pt,text:"",type:p.DEST_END}),g.addEventListener("dragging",function(t){n.addViaRoute2(t,2)}),g.addEventListener("mouseover",function(t){n.onViaPoiOver(t,2)}),g.addEventListener("mouseout",function(t){n.onRemoveTips(t,2)}),g.addEventListener("dragend",function(t){n.addViaPoi3(t,2)}),window.endPoi=g;else if(d>0&&e-1>d){var u=new BMap.Icon("../../../../../webmap2.map.bdstatic.com/newmap/static/common/images/drv_m_234b1a3.png"/*tpa=http://webmap2.map.bdstatic.com/newmap/static/common/images/drv_m_234b1a3.png*/,p.MARKER_11_11_SIZE,{offset:p.MARKER_11_11_OFFSET,infoWindowOffset:p.MARKER_11_11_INFOWND_OFFSET}),h=o.getPoiPoint(i[d].p),c=!1;if(r&&r[d-1].if_wp&&(c=!0),c){var v,m=r[d-1],f={point:o.getPoiPoint(this.endArray[d-1].pt),query:m.wd,addr:m.sug,uid:this.endArray[d-1].uid},P=T.extend({},f);TPM.insertTP(a,P),P.point||(P.point=h),TPM.tpListInMap.push(f),v=!f.query,f.rPoint=h,f.query=v?i[d].n:f.query,g=TPM.createMarkerByTp(f,a),g.addEventListener("mouseover",function(t){n.onViaPoiOver(t,0)}),g.addEventListener("mouseout",function(t){n.onRemoveTips(t,0)}),this.exportOverlays.markers.push({point:f.point,icon:new BMap.Icon("../../../../../webmap2.map.bdstatic.com/newmap/static/common/images/tpicon_ea18b98.png"/*tpa=http://webmap2.map.bdstatic.com/newmap/static/common/images/tpicon_ea18b98.png*/,new BMap.Size(36,36),{imageOffset:new BMap.Size(-62-36*a,0)}),title:f.query}),f.query=v?"":f.query,i[d].tp=f,a++}else g=new BMap.Marker(h,{icon:u}),this.exportOverlays.markers.push({point:h,icon:u}),function(){var i=d;g.addEventListener("domready",function(){var e=this;t.async("common:widget/ui/contextMenu/ContextMenu.js",function(t){e.viaContext=t.create([{text:"删除该点",callback:n.delContext(i),width:60}],e.getDom(),"pointer")})})}(),map.addOverlay(g),g.enableDragging(),g.addEventListener("mouseover",function(t){n.onViaPoiOver(t,0)}),g.addEventListener("mouseout",function(t){n.onRemoveTips(t,0)});g._stCode=p.OVERLAY_STYLE.DRV_M_MKR,g.addEventListener("dragging",function(t){n.addViaRoute2(t,0)}),g.addEventListener("dragend",function(t){n.addViaPoi3(t,0)})}this.dragPois||(this.dragPois=[]),g.addEventListener("dragstart",function(t){n.dragViaPoi(t)}),l.navTrans.enableDragging&&g.enableDragging(),g.index=d,this.dragPois.push(g)}},_bindTPM:function(){var t=this;TPM.afterAddByPoint=function(i){var e=t.dragPoints,n=e[e.length-1];e.push(n),e[e.length-2]={p:i.tp.point.lng+","+i.tp.point.lat,n:i.tp.query,tp:i.tp},t.buildQuery(!0,8)},TPM.onDeleteTp=function(i){for(var e,n=t.dragPoints,a=0;e=n[a];a++)if(i.tp&&e.p==i.tp.rPoint.lng+","+i.tp.rPoint.lat){t.delVia(a,8);break}}},delContext:function(t){var i=this;return function(){i.delVia(t)}},onRouteOver:function(t){if(l.navTrans.enableDragging&&!(this.dragPoints&&this.dragPoints.length>=this.maxDragVia+2)){var i=t.target,e=map.pointToPixel(i.getPoints()[0]),n=map.pointToPixel(i.getPoints()[i.getPoints().length-1]);if(!(r.getDistanceByPixel(t.pixel,e)<=20||r.getDistanceByPixel(t.pixel,n)<=20)){var a=this,o=t.point||t.domEvent.point;if(!this.dragVia&&o)this.dragVia=s.addDestPoi(o,"",p.DEST_MIDDLE),this.dragVia.viaName="",this.dragVia.dis="",this.dragVia.setTop(!0),this.dragVia.setLabel(this.tipLabel),this.dragVia.addEventListener("dragstart",function(t){a.dragViaPoi(t)}),this.dragVia.addEventListener("dragging",function(t){a.addViaRoute(t)}),this.dragVia.addEventListener("dragend",function(t){a.addViaPoi(t)});else if(this.dragVia&&o){var d=!0;d?(this.dragVia.setPoint(t.point),this.dragVia.show(),this.dragVia.setLabel(this.tipLabel)):this.dragVia.hide()}this.draging||(this.dragIndex=t.target.index,this.tempDrag=[window.dropRoutes[this.dragIndex]])}}},onRouteMove:function(t){this.distime&&(window.clearTimeout(this.distime),this.distime=null);var i=t.target,e=map.pointToPixel(i.getPoints()[0]),n=map.pointToPixel(i.getPoints()[i.getPoints().length-1]);if(r.getDistanceByPixel(t.pixel,e)<=20||r.getDistanceByPixel(t.pixel,n)<=20)return void(this.dragVia&&this.dragVia.hide());if(this.dragVia){var a=!0;a?(this.dragVia.setPoint(t.point),this.dragVia.show(),this.dragVia.setLabel(this.tipLabel)):this.dragVia.hide()}},onRemoveTips:function(){this.tipLabel&&map.removeOverlay(this.tipLabel);var t=this;t.dragVia&&t.dragVia.hide()},removeTimer:function(){this.distime&&(window.clearTimeout(this.distime),this.distime=null)},dragViaPoi:function(t){var i=this;i.dateStart=(new Date).getTime(),i.removeTimer(t)},onViaPoiOver:function(t,i){if(!this.draging&&window.dropRoutes){var e=t.target.index;switch(i){case 0:this.tempDrag=[window.dropRoutes[e-1],window.dropRoutes[e]];break;case 1:this.tempDrag=[window.dropRoutes[e]];break;case 2:this.tempDrag=[window.dropRoutes[e-1]]}}l.navTrans.enableDragging&&t.target.setLabel(this.tipLabel)},removeDraw:function(){var t=this;if(t.tempDrag&&t.tempDrag.length>0)for(var i=0;i<t.tempDrag.length;i++){var e=t.tempDrag[i];e&&s.removeRoute(e)}},addViaPoi:function(t){var i=this;if(i.ajax.duration=1,!(i.dragVia&&i.dragPoints&&i.dragPoints.length>=i.maxDragVia+2)){i.ajax.onsuccess=null,i.onRouteOut(t);var e=this.dragIndex;if(i.queryObj&&i.queryObj.length){var n=i.queryObj[i.queryObj.length-1],o=i.dragVia.point.lng+","+i.dragVia.point.lat;if(n.flag&&1==n.flag&&n.dragpt){var r=n.dragpt;o=r.lng+","+r.lat}i.dragpt&&(o=i.dragpt),i.dragPoints.splice(e+1,0,{p:o,n:i.dragVia.viaName});var d=s.addDestPoi(o,"",p.DEST_MIDDLE);addStat("navscheme.navscheme.addtp","click"),d.addEventListener("dragstart",function(t){i.dragViaPoi(t)}),d.addEventListener("dragging",function(t){i.addViaRoute2(t)}),d.index=e,i.draging=!1,i.sended=1,i.sp=null,i.ep=null;var g="",u="",n=this.buildQuery(!1,3);g=n.tp,u=n.tc,a.go("nav&c="+i.currentCity+"&drag=1&sc="+i.sCity.code+"&ec="+u+i.eCity.code+"&sy="+i.strategy+"&sn=1$$$$"+i.popPoints[1].p+"$$"+encodeURIComponent(i.start.wd)+"$$$$$$"+i.start.pt+"$$&en="+g+"1$$$$"+i.popPoints[i.popPoints.length-2].p+"$$"+encodeURIComponent(i.end.wd)+"$$$$$$"+i.end.pt+"$$",{keepTpList:!0,isMainRequest:"no"}),i.queryObj=[]}}},dragRequest:function(t){var i=this,e=i.dragIndex;i.draging=!0,this.sended=0;var n=Math.pow(2,BMap.MapType[map.mapType].zoomLevelMax-map.zoomLevel-7);i.ajax.onsuccess=function(a){try{if(i.data=baidu.json.parse(a.responseText),i.data&&i.data.result&&0==i.data.result.error&&i.data.content){var o=i.data.content,r=s.parse2Geo(o.geo,n),d=r.points,g=o.name;("undefined"==typeof g||""==g)&&(g=i.noName),i.dragVia.viaName=g,i.dragVia.dis=o.dis;for(var u=i.dragVia.dis||0,h=0;h<i.routePoints.length;h++){var l=i.routePoints[h];if(h!=e)for(var c=0;c<l.length;c++)u+=l[c].d}0==u&&(u=i.dis);var v=1e3>u?u.toFixed(1)+"米":(u/1e3).toFixed(1)+"公里";if(i.tipLabel.setContent(g+"("+v+")"),i.dragVia.setLabel(i.tipLabel),i.dragpt=s.parse2Geo(o.dragpt).points,i.popPois){for(var h=0;h<i.popPois.length;h++)map.removeOverlay(i.popPois[h]);i.popPois=null}i.removeDraw(),i.dragingSTime=(new Date).getTime(),i.tempDrag=[];for(var h=0;h<d.length;h++){var m=s.addRoute(d[h],p.ROUTE_TYPE_DRIVE);m.index=e+h,i.tempDrag.push(m),0==h?window.dropRoutes.splice(e,1,m):window.dropRoutes.splice(e+h,0,m)}i.draging=!1,t.flag=1,i.dragVia.failure=0}else i.dragVia.failure=1,i.draging=!1,t.flag=0}catch(f){i.dragVia.failure=1,i.draging=!1,t.flag=0}};var a=map.getBounds();this.dragSTime=(new Date).getTime(),this.ajax.request("/"+h.DATA_URL+t.url+"&ie=utf-8&l="+map.zoomLevel+"&b=("+a.minX+","+a.minY+";"+a.maxX+","+a.maxY+")&newmap=1&t="+(new Date).getTime())},addViaRoute:function(){if(!(this.dragVia&&this.dragPoints&&this.dragPoints.length>=this.maxDragVia+2)){this.dateEnd=(new Date).getTime();var t=this.dateEnd-this.dateStart,i=this.dragVia.point;this.dragVia.failure=0;var e=this.dragIndex,n=this.dragVia.viaName;("undefined"==typeof n||""==n)&&(n=this.noName),this.sp="",this.ep="",this.sp||(this.sp=this.dragPoints[e].p),this.ep||(this.ep=this.dragPoints[e+1].p);{var a="";et=1}a="drag&sy="+this.strategy+"&pt="+i.lng+","+i.lat+"&sn="+this.sp+"&st=1&en="+this.ep+"&et=1&r=5000";var o={url:a,flag:0,dragpt:i};this.ajax.duration=-1,this.draging?t>2e3&&(this.timeout&&clearTimeout(this.timeout),this.dateStart=(new Date).getTime(),this.queryObj.push(o),this.dragRequest(o)):(this.queryObj.push(o),this.dragRequest(o));var s=this;this.timeout=setTimeout(function(){if(s.queryObj&&s.queryObj.length){var t=s.queryObj[s.queryObj.length-1];t&&0==t.flag&&s.queryObj&&!s.draging&&0==s.dflag&&s.dragRequest(t)}},3e3)}},addViaPoi3:function(t,i,e){o.stopBubble(t);var n=t?t.target:e;if(0==i&&"image/tpicon.png"/*tpa=http://webmap0.map.bdstatic.com/newmap/static/common/pkg/image/tpicon.png*/!=n.getIcon().imageUrl)return void this.addViaPoi2(t,i,e);var a=this;s.getGEORevertAddress(o.getOverlayPoint(n),function(t){a.addViaPoiCBK(t)})},addViaPoiCBK:function(t){for(var i,e,n=t.content,a=o.getPoiPoint(t.result.x+","+t.result.y),s=0,r=0;e=this.dragPois[r];r++)if(i=o.getOverlayPoint(e),i.lat==a.lat&&i.lng==a.lng){r==this.dragPois.length-1?s=2:0==r&&(s=1),this.addViaPoi2(null,s,e,n.address);break}},addViaPoi2:function(t,i,e,n){var s=this;if(1!=s.dflag){s.ajax.duration=1,s.ajax.onsuccess=null,s.draging=!1,s.sended=1;var r=t?t.target:e;r.dis=0;var d=r.index;if(!s.queryObj||!s.queryObj.length)return;var p=s.queryObj[s.queryObj.length-1],g=r.point.lng+","+r.point.lat,u=g,h=r.viaName;h=n||h||s.noName;var l="",c="",v="",m=s.dragPoints[d];m.p=g,m.n=h,m.tp&&(m.tp.point=o.getPoiPoint(g),m.tp.query=m.n);var p=this.buildQuery(!1,0!=i?8:m.tp?8:3);switch(c=p.tp,v=p.tc,i){case 0:l="nav&c="+s.currentCity+"&drag=1&sc="+s.sCity.code+"&ec="+v+s.eCity.code+"&sy="+s.strategy+"&sn=1$$$$"+s.popPoints[1].p+"$$"+encodeURIComponent(s.start.wd)+"$$$$$$"+s.start.pt+"$$$$&st=0&en="+c+"1$$$$"+s.popPoints[s.popPoints.length-2].p+"$$"+encodeURIComponent(s.end.wd)+"$$$$$$"+s.end.pt+"$$&et=0";break;case 1:l="nav&c="+s.currentCity+"&drag=1&sc="+s.sCity.code+"&ec="+v+s.eCity.code+"&sy="+s.strategy+"&sn=1$$$$"+g+"$$"+encodeURIComponent(h)+"$$$$$$"+u+"$$&st=1&en="+c+"1$$$$"+s.end.pt+"$$"+encodeURIComponent(s.end.wd)+"$$$$$$&et=0&de=1";break;case 2:l="nav&c="+s.currentCity+"&drag=1&sc="+s.sCity.code+"&ec="+v+s.eCity.code+"&sy="+s.strategy+"&sn=1$$$$"+s.start.pt+"$$"+encodeURIComponent(s.start.wd)+"$$$$$$&st=0&en="+c+"1$$$$"+g+"$$"+encodeURIComponent(h)+"$$$$$$"+u+"$$&et=1&de=1"}a.go(l,{keepTpList:!0,isMainRequest:"no"}),s.dflag=1,s.dragpt=""}s.queryObj=[]},addViaRoute2:function(t,i){this.dateEnd=(new Date).getTime();var e=this.dateEnd-this.dateStart,n=t.target.index,a=t.target;a.failure=0,e>10&&this.dragPois&&(this.dragPois[0].removeEventListener("click",this.openSWin),this.dragPois[this.dragPois.length-1].removeEventListener("click",this.openEWin));var o=a.point,s="",r=1,d=1;switch(this.sp="",this.ep="",i){case 0:this.sp=this.dragPoints[n-1].p,this.ep=this.dragPoints[n+1].p;break;case 1:this.ep=this.dragPoints[n+1].p;break;case 2:this.sp=this.dragPoints[n-1].p}r=1,d=1,s="drag&sy="+this.strategy+"&pt="+o.lng+","+o.lat+"&sn="+this.sp+"&st="+r+"&en="+this.ep+"&et="+d+"&r=5000";var p={url:s,flag:0,dragpt:o};if(this.ajax.duration=-1,this.draging){e>2e3&&(this.timeout&&clearTimeout(this.timeout),this.dateStart=(new Date).getTime(),this.dragRequest2(p,n,i,a),this.queryObj.push(p));var g=this;this.timeout=setTimeout(function(){if(g.queryObj&&g.queryObj.length){var t=g.queryObj[g.queryObj.length-1];t&&0==t.flag&&g.queryObj&&!g.draging&&0==g.dflag&&g.dragRequest2(t,n,i,a)}},3e3)}else this.dragRequest2(p,n,i,a),this.queryObj.push(p)},dragRequest2:function(t,i,e,n){var a=this;a.draging=!0,this.sended=0;var o=Math.pow(2,BMap.MapType[map.mapType].zoomLevelMax-map.zoomLevel-7);this.ajax.onsuccess=function(r){try{if(a.data=baidu.json.parse(r.responseText),a.data&&a.data.result&&0==a.data.result.error&&a.data.content){var d=a.data.result,g=a.data.content,u=s.parse2Geo(g.geo,o),h=u.points,l=g.name;("undefined"==typeof l||""==l)&&(l=a.noName),n.viaName=l,n.dis=g.dis,n.failure=0;var c=n.dis||0,v=a.routePoints.length;if(v>1)for(var m=0;v>m;m++){var f=a.routePoints[m];if(m>i||i-1>m||m>i&&1==i||i-1>m&&i==v-1)for(var P=0;P<f.length;P++)c+=parseFloat(f[P].d)}var $=a.roundDis(c);if(a.tipLabel.setContent(l+"("+$+")"),n.setLabel(a.tipLabel),a.dragpt=s.parse2Geo(g.dragpt).points,a.mousept=d.pt,a.popPois){for(var m=0;m<a.popPois.length;m++)map.removeOverlay(a.popPois[m]);a.popPois=null}if(a.removeDraw(),a.tempDrag=[],1==e||2==e){var y=s.addRoute(h,p.ROUTE_TYPE_DRIVE);a.tempDrag.push(y),1==e?(y.index=i,window.dropRoutes.splice(i,1,y)):(y.index=i-1,window.dropRoutes.splice(i-1,1,y))}else for(var m=0;m<h.length;m++){var y=s.addRoute(h[m],p.ROUTE_TYPE_DRIVE);y.index=i-1+m,a.tempDrag.push(y),0==m?window.dropRoutes.splice(i-1,1,y):window.dropRoutes.splice(i-1+m,0,y)}a.draging=!1,a.dflag=0,t.flag=1}else n.failure=1,n.draging=!1,t.flag=0}catch(w){n.failure=1,n.draging=!1,t.flag=0}};var r=map.getBounds();this.ajax.request("/"+h.DATA_URL+t.url+"&ie=utf-8&l="+map.zoomLevel+"&b=("+r.minX+","+r.minY+";"+r.maxX+","+r.maxY+")&newmap=1&t="+(new Date).getTime())},onRouteOut:function(){var t=this;t.dragVia&&(t.distime=setTimeout(function(){t.removeDrag()},250))},removeDrag:function(){var t=this;t.dragVia&&t.dragVia.hide()},delVia:function(t,i){i=i||3,this.dragPoints.splice(t,1),this.buildQuery(!0,i)},buildQueryOnlyByTp:function(t){for(var i={tp:"",tc:""},e=!1,n=1;n<this.dragPoints.length-1;n++){var a=this.dragPoints[n];a.tp&&(e=!0,i.tp+=TPM.getTPointQueryParam(a.tp,t),this.endCityArray[n]&&(cityCode=this.endCityArray[n].code),i.tc+=cityCode+"+to:")}return i},buildQuery:function(t){var i="",e="",n=h.cityCode,o=!1;n=isNaN(n)?1:n;for(var s=1;s<this.dragPoints.length-1;s++){var r=this.dragPoints[s];r.tp?(i+=TPM.getTPointQueryParam(r.tp),o=!0):i+="1$$$$"+r.p+"$$$$+to:",this.endCityArray[s-1]&&(n=this.endCityArray[s-1].code),e+=n+"+to:"}var d="nav&navtp=2&c="+this.currentCity+"&drag=1&sc="+this.sCity.code+"&ec="+e+this.eCity.code+"&sy="+this.strategy+"&sn=1$$$$"+(this.popPoints[1]?this.popPoints[1].p:"")+"$$"+encodeURIComponent(this.start.wd)+"$$$$$$"+this.start.pt+"$$&en="+i+"1$$$$"+(this.popPoints[this.popPoints.length-2]?this.popPoints[this.popPoints.length-2].p:"")+"$$"+encodeURIComponent(this.end.wd)+"$$$$$$"+this.end.pt+"$$";return t&&a.go(d,{keepTpList:!0,isMainRequest:"no"}),{url:d,tp:i,tc:e}},roundDis:function(t){var i="";return t>0&&10>=t?i="10米":t>10&&(i=1e3>t?10*(t/10).toFixed(0)+"米":(t/1e3).toFixed(1)+"公里"),i},mainRoudeOn:function(t,i){var e=this;e.addTips(t,i)},mainRoudeOut:function(t,i,e,n,a){var o=this;o.removeTips(e)},mainRoudeClick:function(t,i){var e=this;e.highRoute(t,i)},highRoute:function(t,i){if(map.closeInfoWindow(),this.mapZoomLevel=map.zoomLevel,null!=i){if(this.groupBounds[i]){var e=this.groupBounds[i],n=o.getBPoints(e);s.setViewport(n,60)}}else if(null!=t&&this.driveBounds[t]){var e=[this.driveBounds[t]],n=o.getBPoints(e);s.setViewport(n,60)}s.addDrRoute(!0,this),this.addPopPoi(t,i),this.addTips(t,i)},addTips:function(t,i,e){var n=this,a=a||{};if(1!=n._tempLinkOver){var o=Math.pow(2,BMap.MapType[map.mapType].zoomLevelMax-map.zoomLevel-7);if(!n.draging){n.lastOver=e;var r=[];if("mk"==a.from)for(var d=0;d<n.mainRoud[a.i].points.length;d++){var g=s.cutPoints(n.mainRoud[a.i].points[d],o);r.push(g)}else if(null==i||isNaN(i)){var g=s.cutPoints(n.drivePoints[t],o);r.push(n.driveTargetPoints[t+1].p),r.push(g)}else{var u=n.mainRouteIndex.length,h=n.drivePoints.length,l=i+1>=u?h:n.mainRouteIndex[i+1];r.push(n.driveTargetPoints[t+1].p);for(var d=n.mainRouteIndex[i];l>d;d++){var g=s.cutPoints(n.drivePoints[d],o);r.push(g)}}n.tempRoute&&(s.unSelectRoute(n.tempRoute),s.removeRoute(n.tempRoute),n.tempRoute=null),n.tempRoute=s.addRoute(r.join(";"),p.ROUTE_TYPE_DRIVE),s.selectRoute(n.tempRoute)}}},removeTips:function(t){var i=this;return-1==i._tempLinkOver?void(i._tempLinkOver=0):(i.tempRoute&&(s.unSelectRoute(i.tempRoute),s.removeRoute(i.tempRoute),i.tempRoute=null),this.lastOver=t,void(i.tempLink&&(baidu.dom.remove(i.tempLink),i.tempLink=null)))},addPopPoi:function(t,i){for(var e=0;e<this.popPois.length;e++)map.removeOverlay(this.popPois[e]),this.popPois[e]=null;if(this.popPois=[],!this.popPois.length){if(null==i||isNaN(i)){if(null!=t&&!isNaN(t)){var n=this.popPoints[t+1].p.toString(),a=this.popPoints[t+2].p.toString(),o=parseInt(this.popPoints[t+1].a),r=parseInt(this.popPoints[t+2].a),d=s.addDrvDirIcon(n,o);t+2==this.popPoints.length-2&&(r=12);var p=s.addDrvDirIcon(a,r),g=this.popWins[t+1],u=this.popWins[t+2];d.addEventListener("click",this.getClickMarker(g,d,t+1)),p.addEventListener("click",this.getClickMarker(u,p,t+2))}}else{var h=this.groupPopPoints[i][0];if(!h)return;var l=this.groupPopPoints[i][this.groupPopPoints[i].length-1],n=h.p.toString(),a=(this.sgi-1,l.p.toString()),o=parseInt(h.a),r=parseInt(l.a),d=s.addDrvDirIcon(n,o),p=s.addDrvDirIcon(a,r),g=this.popWins[1],u=this.popWins[this.sgi-1];d.addEventListener("click",this.getClickMarker(g,d,1)),p.addEventListener("click",this.getClickMarker(u,p,this.sgi-1))}d.disableDragging(),p.disableDragging(),this.popPois.push(d),this.popPois.push(p)}},getClickMarker:function(t,i,e){return function(){c.popIndex=e,d.transInfoWindow(i,t,{showLine:!1})}},clickStop:function(t){t=this.keyPopInfos[t];var i,e,n=t,a=this;if(0!=n&&n!=a.popPoints.length-1){var r=n.popPoint.p,p=n.popPoint.a,g=T.array.indexOf(this.popPoints,n.popPoint);return e=a.popWins[g],i=s.addDrvDirIcon(r,p),a.popPois.push(i),i.addEventListener("click",a.getClickMarker(e,i,g)),d.transInfoWindow(i,e,{showLine:!1}),c.popIndex=g,void(o.isInBounds(o.getOverlayPoint(i))||map.setCenter(o.getOverlayPoint(i)))}0==n?i=window.startPoi:n==a.popPoints.length-1&&(i=window.endPoi),e=a.popWins[n],d.transInfoWindow(i,e,{showLine:!1}),c.popIndex=t,o.isInBounds(o.getOverlayPoint(i))||map.setCenter(o.getOverlayPoint(i))},addPopInfoWin:function(){for(var t=this.popPoints.length,i=this.start.uid,e=this.end.uid,n=0;t>n;n++){var a=null;0==n&&(a=i),n==t-1&&(a=e),this.popWins.push(d.createTransInfoWnd({title:this.popInfos[n].title,content:this.popInfos[n].info,curIndex:n,total:t,obj:this,nextInfo:this.popInfos[n].next,nextTransCbk:this.nextTransCbk,zoomTransCbk:this.zoomTransCbk,transUid:a}))}var o=this,s=this.popWins[0];o.openSWin=function(){o.getClickMarker(s,o.dragPois[0],0)()};var r=this.popWins[this.popWins.length-1];o.openEWin=function(){o.getClickMarker(r,o.dragPois[o.dragPois.length-1],o.popPoints.length-1)()},this.dragPois&&(this.dragPois[0].addEventListener("click",o.openSWin),this.dragPois[this.dragPois.length-1].addEventListener("click",o.openEWin))},nextTransCbk:function(t,i){for(var e=i.popPoints[t].p,n=i.popPoints[t].a,a=i.popWins[t],o=0;o<i.popPois.length;o++)map.removeOverlay(i.popPois[o]),i.popPois[o]=null;if(i.dispatchEvent("poiinfoopen",{index:t-1}),t>0&&t<i.popPoints.length-1){t==i.popPoints.length-2&&(n=12);var r=s.addDrvDirIcon(e,n);r.addEventListener("click",i.getClickMarker(a,r,t)),i.popPois.push(r),r.openInfoWindow(a)}0==t&&window.startPoi?(d.transInfoWindow(window.startPoi,a,{showLine:!1}),c.popIndex=0):t==i.popPoints.length-1&&window.endPoi&&(d.transInfoWindow(window.endPoi,a,{showLine:!1}),c.popIndex=i.popPoints.length-1)},zoomTransCbk:function(t,i){var e=BMap.MapType[map.mapType].zoomLevelMax;map.zoomTo(0==t?e:i.mapZoomLevel!=map.zoomLevel?i.mapZoomLevel:e-3)},getClickMarker:function(t,i,e){return function(){c.popIndex=e,d.transInfoWindow(i,t,{showLine:!1})}},updatePanoPopWins:function(t,i){if(t&&0!=t.length)for(var e=0,n=this.popWins.length;n>e;e++){var a=i[e],o=t[a];this.popWins[e]=u.addPanoThumbnailsInInfoWnd([this.popWins[e]],[o],t,"nav")[0]}},resetDrv:function(){if(window.dropRoutes){for(var t=0;t<window.dropRoutes.length;t++){var i=window.dropRoutes[t];i&&s.removeRoute(i)}window.dropRoutes=[]}if(this.popPois){for(var t=0;t<this.popPois.length;t++)map.removeOverlay(this.popPois[t]);this.popPois=[]}s.addDrRoute(!1,this)}}),e.exports=n});