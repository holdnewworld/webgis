define("common:widget/pano/model/IndoorData.js",function(t,i,o){var n=t("common:widget/pano/base/CatalogMap.js"),a=t("common:widget/pano/base/util.js"),r=t("common:widget/pano/base/service.js"),e={unfetch:1,fetching:2,fetched:3},s={},h=function(t,i){var o=Math.cos(i*Math.PI/180),n=Math.sin(i*Math.PI/180),a=t.x*o-t.y*n,r=t.x*n+t.y*o;return{x:a,y:r}},u=function(t,i){var o=t.imgwidth,n=t.imgheight,r=t.scale,e=360-t.northdir,s=t.ltpoint,u=Math.ceil(Math.log(o/256)/Math.log(2))+1,c=Math.ceil(Math.log(n/256)/Math.log(2))+1,d=Math.min(u,c),f=Math.ceil((d+1)/2),l=256*Math.pow(2,u-1),g=256*Math.pow(2,c-1),p=Math.floor(l-o)/2,_=Math.floor(g-n)/2,v=[],v=a.each(t.points,function(t){var i=(t.x-s.x)/100/r,o=(t.y-s.y)/100/r,n=h({x:i,y:o},e);return n.x=n.x+p,n.y=-n.y+_,{id:t.pid,pin:t.pin,name:t.name,catlog:t.catalog,panox:t.x/100,panoy:t.y/100,x:n.x,y:n.y,defaultAngle:0}},!0);return{realFloor:t.floor,floor:i,width:l,height:g,points:v,zoomLevel:d,defZoom:f,startid:t.startid,uid:t.startid}},c=function(t){var i=t.entrances&&t.entrances[0]&&t.entrances[0].uid?t.entrances[0]:t;return{x:i.breakx/100,y:i.breaky/100,pid:i.breakid}},d=function(t){var i={},o=[];a.each(t,function(t){a.each(t.points,function(t){if(t.catalog){var o=n.getCatalogInfo(t.catalog);i[o.label]||(i[o.label]=[]),i[o.label].push(t)}})});for(var r in i)o.push({id:1*i[r][0].catalog,label:r,points:i[r]});return o.sort(function(t,i){return t.id>i.id?1:-1}),o},f=function(t){return"f53e5bf37bf62ebfb34c4992"===t.iid,{pid:t.pid,imagetype:void 0===t.imagetype?t.hasimg:t.imagetype,poiuid:t.uid,exitInfo:c(t),floors:a.each(t.floors,u,!0),catalogInfo:d(t.floors)}},l=function(t,i){return s[t]?s[t]:(s[t]=this,this._iid=t,this._data={},this._status=e.unfetch,this._fetchPromise=null,this._currentFloor=void 0,void(i||this.fetch()))};l.prototype={fetch:function(t){if(this._status==e.unfetch){this._status=e.fetching;var i=this;this._fetchPromise=r.getIndoorData(this._iid).then(function(t){return void 0===t?void(i._basicData=void 0):(i._basicData=t,i._currentFloor=Math.max(t.defaultfloor-1,0),i._data=f(t),i._status=e.fetched,i._data)})}return t&&this.onLoad(t),this},isLoaded:function(){return this._status===e.fetched},getIID:function(){return this._iid},onLoad:function(t){return this.isLoaded()?t():this._fetchPromise.then(t),this},setCurrentPid:function(t){var i=this.getFloorInfo(),o=void 0,n=void 0;return a.each(i,function(i,r){return a.each(i.points,function(i,a){return i.id==t?(o=r,n=a,!0):void 0}),void 0===o&&i.startid===t?(o=r,!0):void 0!==o?!0:void 0}),this._currentPoint=n,this._currentFloor=void 0===o?this._basicData.defaultfloor-1:o,this._currentFloor<0&&(this._currentFloor=0),o},getExitInfo:function(){return this._data.exitInfo},getFloorInfo:function(t){return 0===arguments.length?this._data.floors:this._data.floors[t]},getPointInfo:function(t,i){return this._data.floors[t].points[i]},getBasicData:function(){return this._basicData},getCurrentFloor:function(){return this._currentFloor},getCurrentPoint:function(){return this._currentPoint},hasIndoorData:function(){return void 0!==this._basicData},hasPlanMap:function(){return 1==this._data.imagetype},has2DMap:function(){return 2==this._data.imagetype},getCatalogList:function(){return this._data.catalogInfo},getCurrentPointData:function(){var t=this.getPointInfo(this._currentFloor,this._currentPoint),i={pid:t.id,x:t.panox,y:t.panoy};return i},getCurrentFloorData:function(){var t=this.getFloorInfo(this._currentFloor),i=this.getExitInfo(),o=a.copy(t);if(o.innerId=this._iid,o.poiuid=this._data.poiuid,o.hasImage=this.hasPlanMap()?1:0,o.floor=this._currentFloor+1,o.x=i.x,o.y=i.y,o.pid=i.pid,void 0!==this.getCurrentPoint()){var n=this.getPointInfo(this.getCurrentFloor(),this.getCurrentPoint());o.currentPid=n.id}return o},get2DMapData:function(){return{mode:"day",panoHeading:0,panoId:this._basicData.breakid,panoMCPoint:{x:this._basicData.breakx/100,y:this._basicData.breaky/100},panoPitch:0,panoType:"inter",panoZoom:1}},getTopologyPoints:function(){var t=this.getFloorInfo(this._currentFloor),i=a.each(t.points,function(t){return t.pin?t:void 0},!0);return i},equal:function(t){return t instanceof l&&this.getIID()===t.getIID()?!0:!1}},o.exports=l});