define("common:widget/pano/module/PanoModule/PanoModule.js",function(e,a,t){var n=e("common:widget/pano/base/ModuleClass.js"),o=e("common:widget/pano/module/PanoModule/FlashRender/Render.js"),i=e("common:widget/pano/base/service.js"),r=e("common:widget/pano/model/IndoorData.js"),d=(e("common:widget/pano/model/PanoPoi.js"),e("common:widget/pano/base/util.js")),s=e("common:widget/pano/Transition/Transition.js"),p={},h="",_=null,l=void 0,c=0,u=n.extend("PanoModule",{constructor:function(){this._panoModuleContainer=null,this._panoConfigUrl=null,this._panoFlashWraper=null,this._asynCacheMethodDataMap={},this._flashInterfaceReady=!1,this._panoModuleMarkerIds=null,this._enableShareMarker=!0,this._returnMarkVars={panoUid:"",poiDetailUid:"",panoType:"",panoLastStreetPanoOptions:null},this._isVisiable=!0},initialize:function(e,a,t){try{if(this._panoModuleContainer=e,this._panoConfigUrl=a,this._mapContext=t,this.$shareParam){var n=this.$shareParam.markerUid;this._addMarkerByUid(n)}}catch(o){"undefined"!=typeof alog&&alog("http://webmap1.map.bdstatic.com/newmap/static/common/widget/pano/module/PanoModule/exception.fire","catch",{msg:o.message||o.description,path:"common:widget/pano/module/PanoModule/PanoModule.js",ln:72})}},showPano:function(e,a,t){if(l=t,this._panoFlashWraper)this._flashInterfaceReady&&(a&&(e.uid||e.tourId)?this._panoFlashWraper.gotoPOI(e):this._panoFlashWraper.set("panoOptions",e));else{{e.uid}this._initPanoFlash(e),this.dispatchEvent("visible_changed",{data:{visible:!0,panoOptions:e}})}if(e.panoMarkers){var n=this;this._panoModuleMarkerIds=[],d.each(e.panoMarkers,function(e){e.markerId=d.getUniqueId("MARKER_"),n._panoModuleMarkerIds.push(e.markerId)}),this.addMarkers(e.panoMarkers)}("inter"===e.panoType||e.panoIId)&&(this._returnMarkVars.panoUid=this._returnMarkVars.poiDetailUid)},setPov:function(e){this._flashInterfaceReady?this._panoFlashWraper.set("pov",{heading:e.panoHeading,pitch:e.panoPitch}):this._asynCacheMethodDataMap.setPov=e},setZoom:function(e){if(this._flashInterfaceReady){var a=this._panoFlashWraper.get("zoom");this._panoFlashWraper.set("zoom",a+e)}else this._asynCacheMethodDataMap.setZoom=e},addMarkers:function(e){return e&&e.length&&0!==e.length?(this._panoFlashWraper&&this._flashInterfaceReady?(this._panoFlashWraper.addMarkers(e),1==e.length&&this.dispatchEvent("add_search_marker",{markers:e})):this._asynCacheMethodDataMap.addMarkers=e,this):this},_addMarkerByUid:function(e){var a=this;i.getPanoInfoByUid(e,function(e){if(e&&e.content&&e.content[0]&&e.content[0].poiinfo){var t=e.content[0].poiinfo,n={markerId:d.getUniqueId("MARKER_"),poiuid:t.UID,pid:t.PID,panoIId:t.IID,poiType:t.belonging?"interPoi":"poi",catalog:t.Catalog,name:t.name,heading:t.Dir,pitch:t.Pitch,x:t.X,y:t.Y,px:t.PanoX,py:t.PanoY,index:-1};a.addMarkers([n])}})},removeMarkers:function(e){return this._panoFlashWraper&&this._flashInterfaceReady?this._panoFlashWraper.removeMarkers(e):this._asynCacheMethodDataMap.removeMarkers=e,this},removePanoModuleMarker:function(){return this._panoModuleMarkerIds&&this._panoModuleMarkerIds.length&&(this.removeMarkers(this._panoModuleMarkerIds),this._panoModuleMarkerIds=null),this},drawLineToPoint:function(e,a,t,n,o,i,r){this._panoFlashWraper.drawLineToPoint(e,a,t,n,o,i,r)},closePano:function(e){var a=this.getPanoOptions(),t=this,n=function(){t._panoFlashWraper&&(t._panoFlashWraper.closePano(),t._removePanoFlashEvents(),t._panoFlashWraper=null,t._flashInterfaceReady=!1,h=""),_&&_.has2DMap()||a&&(a.currentPoint=null),e||t.dispatchEvent("visible_changed",{data:{visible:!1,panoOptions:a}})};if(!a)return void n();var o=this._mapContext.getOverviewLevel(),i=new BMap.Point(a.panoMCPoint.x,a.panoMCPoint.y),r=a.panoHeading||0;s.exit(i,o,i,r,function(){n()})},setRoutParam:function(e){this._flashInterfaceReady?this._panoFlashWraper.setRoutParam(e):this._asynCacheMethodDataMap.setRoutParam=e},hideRegion:function(){this._flashInterfaceReady?this._panoFlashWraper.hideRegion():this._asynCacheMethodDataMap.hideRegion=[]},playRouteVideo:function(e,a){this._flashInterfaceReady&&(c=e,this._panoFlashWraper.playRouteVideo(a),addStat(STAT_CODE.STAT_PANORAMA,{item:"pano-route-video"}),d.startClock("panoVideoPlayTime",function(e){addStat(STAT_CODE.STAT_PANORAMA,{item:"pano-route-video-play-time",time:e})}))},closeRouteVideo:function(){this._flashInterfaceReady&&(c=0,this._panoFlashWraper.closeRouteVideo(),d.stopClock("panoVideoPlayTime"))},getPanoOptions:function(){if(this._panoFlashWraper&&this._flashInterfaceReady){var e=this._panoFlashWraper.get("panoOptions"),a=this._panoFlashWraper.get("mercatorPosition");return e.currentPoint={x:a.mercatorX,y:a.mercatorY},e}return null},getPanoTimeline:function(){if(!this._panoFlashWraper)return null;var e=this._panoFlashWraper.get("sData");try{var a=e.content[0].TimeLine.length>0?e.content[0].TimeLine:null,t=e.content[0].MoveDir;if("inter"===e.content[0].Type)return null;if(a){for(var n=0,o=a.length;o>n;n++)a[n].dir=t;return a}}catch(i){return null}return null},_getSdata:function(){if(!this._panoFlashWraper)return null;var e=this._panoFlashWraper.get("sData"),a=e.content[0]||e.content,t=d.copy(a,!0);return t},getPanoCopyright:function(){if(this._panoFlashWraper&&this._flashInterfaceReady){var e=this._getSdata(),a={dataProviderIndex:e.provider,admission:e.admission,photoDate:e.date,roadName:e.rname||"",username:e.username||"",userid:e.userid};return a}return null},getPanoIndoorData:function(){if(this._panoFlashWraper&&this._flashInterfaceReady&&_){var e=_.getCurrentFloorData(),a=this._getSdata(),t=this._panoFlashWraper.get("pov"),n=(a.rx||a.x)/100,o=(a.ry||a.y)/100;return e.currentPoint={x:n,y:o,heading:t.heading},e}return null},getIndoorModel:function(){return _},_bindPanoFlashEvents:function(){var e=this,a=e._panoFlashWraper;a.addEventListener("indoor_exit",function(e){e&&e.data&&"topo"===e.data.changeWay&&addStat(STAT_CODE.STAT_PANORAMA,{item:"indoorview-exit-topo"})},"indoor_exit"+this.guid),a.addEventListener("zoom_changed",function(a){addStat(STAT_CODE.STAT_PANORAMA,{item:"pano-zoom"}),e.dispatchEvent("zoom_changed",{data:a.data})}),a.addEventListener("street_drag",function(){addStat(STAT_CODE.STAT_PANORAMA,{item:"pano-drag"})}),a.addEventListener("pov_changed",function(a){"street"==e._returnMarkVars.panoType&&(e._returnMarkVars.panoLastStreetPanoOptions.panoHeading=a.data.heading,e._returnMarkVars.panoLastStreetPanoOptions.panoPitch=a.data.pitch),e.dispatchEvent("pov_changed",{data:{panoHeading:a.data.heading,panoPitch:a.data.pitch}})},"pov_changed"+this.guid),a.addEventListener("once_tiles_complete",function(){_?_.onLoad(function(){e.dispatchEvent("once_tiles_complete",{data:null})}):e.dispatchEvent("once_tiles_complete",{data:null}),a.removeEventListener("once_tiles_complete","once_tiles_complete"+e.guid)}),a.addEventListener("go_to_poi_complete",function(a){e._returnMarkVars.poiDetailUid=a.data.id,e.dispatchEvent("after_go_to_poi",a.data)}),a.addEventListener("go_to_poi_timeout",function(a){e.dispatchEvent("go_to_poi_timeout",a.data)}),a.addEventListener("overlay_mouseover",function(a){a.type="show_position",e.dispatchEvent("show_position",a)}),a.addEventListener("out_of_navigation_range",function(){e.dispatchEvent("pano_error",{data:"OUTOF_RANGE"})}),a.addEventListener("overlay_mouseout",function(){e.dispatchEvent("hide_position")}),a.addEventListener("idata_loaded",function(){}),a.addEventListener("sdata_loaded",function(a){var t=a.data,n=t.panoid||t.panoId;if(""==h)if("street"===t.panoType)e._fireSdataLoaded(a);else{var o=e._getSdata();_=new r(o.inters[0].iid);var i=o.id,d=o.inters&&o.inters[0]&&o.inters[0].floor||0;_.fetch(function(){var t=_.setCurrentPid(i);void 0==t&&(_._currentFloor=d),e.dispatchEvent("indoor_enter",{data:_.getCurrentFloorData(),indoorModel:_}),a.data.floor=d,e._fireSdataLoaded(a)})}else if("street"==h)if("street"===t.panoType)e._fireSdataLoaded(a);else{var o=e._getSdata();_=new r(o.inters[0].iid);var d=o.inters&&o.inters[0]&&o.inters[0].floor||0;_.fetch(function(){_.setCurrentPid(o.id);var t=_.getCurrentFloorData();t.x=(o.rx||o.x)/100,t.y=(o.ry||o.y)/100,e.dispatchEvent("indoor_enter",{data:t,indoorModel:_}),a.data.floor=d,e._fireSdataLoaded(a)})}else if("street"===t.panoType){var s=_.getBasicData();_=null;var p={uid:s.uid,panoId:s.breakid,panoX:s.breakx/100,panoY:s.breaky/100};e.dispatchEvent("indoor_exit",{data:p,pano_change_dispatcher:l}),l=null,e._fireSdataLoaded(a)}else{var c=_.getCurrentFloor(),u=_.setCurrentPid(n);if(void 0===u){var o=e._getSdata(),v=o.inters[0].iid;v==_.getIID()?(_._currentFloor=c,e.dispatchEvent("indoor_plan_id_changed",{data:{x:o.rx/100,y:o.ry/100,heading:t.heading}}),a.data.floor=c,e._fireSdataLoaded(a)):(_=new r(v),_.fetch(function(){e.dispatchEvent("indoor_enter",{data:_.getCurrentFloorData(),indoorModel:_}),e._fireSdataLoaded(a)}))}else if(c===u){var f=_.getCurrentPointData();e.dispatchEvent("indoor_plan_id_changed",{data:f}),e.dispatchEvent("pov_changed",{data:{panoHeading:t.heading,panoPitch:t.pitch}}),e._fireSdataLoaded(a)}else e.dispatchEvent("indoor_floor_changed",{data:_.getCurrentFloorData()}),e.dispatchEvent("pov_changed",{data:{panoHeading:t.heading,panoPitch:t.pitch}}),e._fireSdataLoaded(a)}h=t.panoType},"sdata_loaded"+this.guid),a.addEventListener("interface_ready",function(a){e._flashInterfaceReady=!0;for(var t in e._asynCacheMethodDataMap)e[t](e._asynCacheMethodDataMap[t]);e._asynCacheMethodDataMap={},e.dispatchEvent("interface_ready",a)},"interface_ready"+this.guid),a.addEventListener("pano_error",function(a){e.dispatchEvent("pano_error",{data:a.data})},"pano_error"+this.guid),a.addEventListener("pano_player_error",function(a){e.dispatchEvent("pano_player_error",{data:a.data})},"pano_player_error"+this.guid),a.addEventListener("deselect_poi",function(){e._returnMarkVars.poiDetailUid="",e.dispatchEvent("deselect_poi")},"deselect_poi"+this.guid),a.addEventListener("service_monitor",function(e){var a=e.data,t=a.type,n=a.param.timeLength,o=1!=a.errorCode,i=a.param.url,r=0;switch(t){case"pdata":r=.05;break;case"qsdata":r=1;break;case"routePoints":r=5;break;case"idata":case"plane":r=10;break;default:r=.4}d.monitorReport(t,o,n,i,r)},"service_monitor"+this.guid),a.addEventListener("add_statistic",function(e){var a=e.data;addStat(STAT_CODE.STAT_PANORAMA,a)},"add_statistic"+this.guid),a.addEventListener("update_pano_position",function(a){e.dispatchEvent("routeVideo_pano_changed",{data:{panoType:"street",panoHeading:a.data.heading,panoMCPoint:{x:a.data.x/100,y:a.data.y/100}}})},"update_pano_position"+this.guid)},_fireSdataLoaded:function(e){var a=this;a._mapContext.getCurrentCity(function(e){addStat(STAT_CODE.STAT_PANORAMA,{item:"pano-whole",cityCode:e.cityId})});var t=e.data;t={panoMode:t.mode,panoId:t.panoid,panoPitch:t.pitch,panoHeading:t.heading,panoType:t.panoType,panoMCPoint:{x:t.x,y:t.y},panoCopyright:t.copyright,floor:t.floor};var n=p.panoData;p.panoData=t,a.dispatchEvent("after_pano_changed",{data:t,last_data:n,pano_change_dispatcher:l}),l=void 0,"street"==t.panoType&&(a._returnMarkVars.panoLastStreetPanoOptions=t),a._returnMarkVars.panoType=t.panoType},_removePanoFlashEvents:function(){var e=this._panoFlashWraper;e.removeEventListener("pov_changed","pov_changed"+this.guid),e.removeEventListener("sdata_loaded","sdata_loaded"+this.guid),e.removeEventListener("indoor_enter","indoor_enter"+this.guid),e.removeEventListener("indoor_exit","indoor_exit"+this.guid),e.removeEventListener("indoor_id_changed","indoor_id_changed"+this.guid),e.removeEventListener("floor_changed","floor_changed"+this.guid),e.removeEventListener("interface_ready","interface_ready"+this.guid),e.removeEventListener("pano_error","pano_error"+this.guid),e.removeEventListener("pano_player_error","pano_player_error"+this.guid),e.removeEventListener("deselect_poi","deselect_poi"+this.guid),e.removeEventListener("service_monitor","service_monitor"+this.guid),e.removeEventListener("add_statistic","add_statistic"+this.guid),e.removeEventListener("update_pano_position","update_pano_position"+this.guid)},_initPanoFlash:function(e){this._panoFlashWraper=new o(e,this._panoModuleContainer,this._panoConfigUrl),this._bindPanoFlashEvents(),this._addPanoReturn()},_addPanoReturn:function(){var e=T('<div id="pano-return-btn"><a class="pano_button" href="javascript:void(0);"><span></span><em>返回</em></a></div>')[0],a=this,t=document.getElementById("pano-container");t.appendChild(e),T.on(e,"click",function(e){return e.preventDefault(),addStat(STAT_CODE.STAT_PANORAMA,{item:"return-click"}),2==c?(c=0,a.dispatchEvent("routeVideo_exit"),void d.stopClock("panoVideoPlayTime")):void("inter"==a._returnMarkVars.panoType&&a._returnMarkVars.panoLastStreetPanoOptions?a._returnMarkVars.panoUid?(a._returnMarkVars.panoLastStreetPanoOptions.uid=a._returnMarkVars.panoUid,a.showPano(a._returnMarkVars.panoLastStreetPanoOptions,!0,"returnButton")):a.showPano(a._returnMarkVars.panoLastStreetPanoOptions,null,"returnButton"):(c=0,a.closePano()))})},getPanoStatus:function(){return this._returnMarkVars.panoLastStreetPanoOptions},enableShareMarker:function(e){this._enableShareMarker=e},getShareParam:function(){if(!this._enableShareMarker)return null;var e=this.getMarkerUidInBestPano();return e?{markerUid:e}:null},getMarkerUidInBestPano:function(){var e="";return this._panoFlashWraper&&this._flashInterfaceReady&&(e=this._panoFlashWraper.getMarkerUidInBestPano()),e},setVisibility:function(e){var a=document.getElementById("pano-return-btn");e?(this._panoModuleContainer.style.visibility="",this._isVisiable=!0,a.style.display="block"):(this._panoModuleContainer.style.visibility="hidden",this._isVisiable=!1,a.style.display="none")},getSupportEvents:function(){return["pov_changed","zoom_changed","indoor_enter","indoor_exit","indoor_plan_id_changed","indoor_floor_changed","visible_changed","after_pano_changed","after_go_to_poi","once_tiles_complete","pano_error","pano_player_error","show_position","hide_position","deselect_poi","interface_ready","routeVideo_exit","routeVideo_pano_changed","add_search_marker"]}});t.exports=u});