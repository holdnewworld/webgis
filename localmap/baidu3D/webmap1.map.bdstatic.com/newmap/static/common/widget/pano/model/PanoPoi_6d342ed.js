define("common:widget/pano/model/PanoPoi.js",function(n,e,o){var i=n("common:widget/pano/base/util.js"),t=n("common:widget/pano/base/service.js"),r={},a=function(n){var e={};for(var o in n)e[o.toLowerCase()]=n[o];return e},u=function(n,e,o,i){if(o=o||10,i=i||4,o>=e)return null;n++;var t=Math.ceil(e/o);if(n>t)throw new Error("erro page num");var r,a=[],u=0;if(t-n>=i/2)for(r=n-Math.floor(i/2);a.length<i&&t>=r&&(r>0&&a.push(r),r++,u++,!(u>1e3)););else for(r=t;a.length<i&&r>0&&(a.unshift(r),r--,u++,!(u>1e3)););var c=!1;return{text:a,max:t,index:n,pageSize:o,hasHome:c,hasPrev:n>1?!0:!1,hasNext:t>n?!0:!1}},c={poi:function(n){var e=0;n.ext&&n.ext.other_info&&n.ext.other_info.base&&(e=n.ext.other_info.base.length);var o={name:n.name,poi_type:n.poiType,addr:n.addr,tel:n.tel,uid:n.uid,sid:n.pano&&n.street_id?n.street_id:void 0,src:n.ext?n.ext.src_name:void 0,movie_count:e,city:n.city_id,hasIndoor:!!n.indoor_pano};if(n.geo){var i=n.geo.split("|").pop().replace(";","").split(",");o.x=parseInt(i[0]),o.y=parseInt(i[1])}return o},hotel:function(n){var e=[],o=n.room_info;try{var t=window.place.hotel?window.place.hotel:window.place;t.otaDataDecode(o||[])}catch(r){i.log("ota decode failed"),o=[]}var a=function(n){try{var e={};return e.roomTypeName=n.basic_info.room_type_name,e.roomId=n.basic_info.room_id,i.each(n.ota_list,function(n){i.each(n.price_info,function(n){var n=parseInt(n.room_price.price)-parseInt(n.minus&&n.minus.price||0)-parseInt(n.coupons&&n.coupons.price||0)+parseInt(n.tax_info&&n.tax_info.price||0);e.price=e.price?e.price>n?n:e.price:n})}),e}catch(o){"undefined"!=typeof alog&&alog("http://webmap1.map.bdstatic.com/newmap/static/common/widget/pano/model/exception.fire","catch",{msg:o.message||o.description,path:"common:widget/pano/model/PanoPoi.js",ln:167})}};return i.each(o,function(n){var o;return 2==e.length?!0:void((1==n.basic_info.book_state||2==n.basic_info.book_state)&&(o=a(n),o.roomTypeName&&o.price&&e.push(o)))}),e.length<2&&i.each(o,function(n){var o;return 2==e.length?!0:void(1!=n.basic_info.book_state&&2!=n.basic_info.book_state&&(o=a(n),o.roomTypeName&&o.price&&e.push(o)))}),0==e.length&&e.push({roomTypeName:"标准间",priceInfo:"暂无报价"}),e},movie:function(n){var e=i.each(n,function(n){return{id:n.movie_id,name:n.movie_name,type:n.movie_type,price:n.price||n.origin_price}},!0);return e},pano:a,guide:a,busline:function(n){function e(n){return n=n.match(/[\u4e00-\u9fa5\d]*/)[0]}function o(n,e){var o=90-180*Math.atan2(n.y-e.y,n.x-e.x)/Math.PI;return 0>o&&(o+=360),o}var t={};return n&&(t.buslineName=e(n.buslineName),t.buslineFullName=n.buslineName,t.stations=i.each(n.stations,function(e,i){e.stationName=i+1+"&nbsp;&nbsp;"+e.name;var t=e.pano;if(!t)return e;var r=o({x:e.point.x,y:e.point.y},{x:t.PanoX,y:t.PanoY});return e.pano={poiuid:e.uid,pid:t.PID,name:e.name,index:-1,dir:r,pitch:0,x:e.point.x,y:e.point.y,panox:t.PanoX,panoy:t.PanoY,rank:100,catalog:n.catalog},e},!0)),t},indoorPoi:function(n){if(n.content.base.address||n.content.base.phone){var e=n.content.lvyou;return e&&(e.entrance_price&&e.shop_hours||e.sug_time||e.best_time)||delete n.content.lvyou,n.content}return null}},s=function(n,e){return r[n]?r[n]:(n||(this.poi=null,this.hotel=null,this.pano=null,this.movie=null),r[n]=this,this._uid=n,void(this._cityCode=e))};s.prototype={getUid:function(){return this._uid},extend:function(){var n=Array.prototype.slice.call(arguments,0),e=this._uid,o=this,r=i.each(n,function(n){switch(n){case p.poi:return void 0!==o.poi?void 0:t.getPanoPoiInfoByUid(e).then(function(e){o.poi=c[n](e.content)});case p.pano:return void 0!==o.pano?void 0:t.getPanoInfoByUid(e).then(function(e){e=e.content[0].poiinfo,o.pano=c[n](e)});case p.hotel:return void 0!==o.hotel?void 0:t.getHotelInfoByUid(e).then(function(e){return 0!=e.errorNo?void(o.hotel=null):void(o.hotel=c[n](e))});case p.movie:return void 0!==o.movie?void 0:t.getMovieInfoByUid(e).then(function(e){return 0==e.length?void(o.movie=null):void(o.movie=c[n](e))});case p.indoorPoi:return t.getIndoorPoiInfoByUid(e).then(function(e){return e?void(o.indoorPoi=c[n](e)):void(o.indoorPoi=null)});case p.busline:return t.getBuslineByUid(e,o._cityCode).then(function(e){return e?void(o.busline=c[n](e)):void(o.busline=null)})}},!0);return T.when.apply(T,r)}};var p={poi:"poi",hotel:"hotel",movie:"movie",pano:"pano",busline:"busline",indoorPoi:"indoorPoi"};s.TYPE=p,s.getInstaceByPanoId=function(n){for(var e in r){var o=r[e];if(o.pano&&o.pano.pid===n)return o}return null},s.initWithPoiSearchResult=function(n){var e={},o=i.each(n.content,function(n,e){var o=new s(n.uid);return o.poi=c.poi(n),o.index=e,o},!0);e.content=o,e.wd=n.result.wd;var t=n.result;return e.pageInfo=u(t.page_num,t.total),e},s.initWithBuslineResult=function(n){var e={},o=i.each(n.stations,function(n,e){var o=new s(n.uid);return o.pano=n.pano,o.stationName=n.stationName,o.index=e,o},!0);return e.content=o,e.buslineName=n.buslineName,e},o.exports=s});