define("common:widget/pano/module/PanoOverviewModule/PanoMapComponent/PanoMapComponent.js",function(e,t,o){function n(e,t,o){baidu.lang.Class.call(this),this.mapContainer=e,this._opts=t;var n=t.data.currentPoint||t.data.panoMCPoint;this.point=new BMap.Point(n.x,n.y),this.level=t.level||16,this._map=null,this._fishboneCtrl=null,this._roadnet=null,this._poiClickLayer=null,this._overlay=null,this._indoorModel=o,this._topologyMarkers=[],this.tipLabel=null,this.arrowMarkers=[]}var a=e("common:widget/pano/module/PanoOverviewModule/PanoMapComponent/PanoRoadNetComponent/PanoRoadNetComponent.js"),i=e("common:widget/pano/module/PanoOverviewModule/PanoMapComponent/PanoPoiClickComponent/PanoPoiClickComponent.js"),r=e("common:widget/pano/module/PanoOverviewModule/PanoMapComponent/PanoLocatorComponent/PanoLocatorComponent.js"),s=e("common:widget/pano/base/service.js"),d=e("common:widget/pano/base/util.js"),p=e("common:widget/ui/mapUtil/mapUtil.js"),l=(e("common:widget/ui/Animation/Animation.js"),[{stroke:6,color:"#3a6bdb",opacity:.65},{stroke:6,color:"#3a6bdb",opacity:.95},{stroke:6,color:"#78bc5f",opacity:.95},{stroke:5,color:"#3a6bdb",opacity:.65},{stroke:6,color:"#3a6bdb",opacity:.5},{stroke:4,color:"#78bc5f",opacity:.5},{stroke:6,color:"#688DE1",opacity:.95,strokeStyle:"dashed"},{stroke:6,COLOR:"#575757",OPACITY:.95,STROKESTYLE:"DOTTED"}]);baidu.lang.inherits(n,baidu.lang.Class,"PanoMapComponent"),baidu.object.extend(n.prototype,{initialize:function(){try{this.eventHandlers={},this.initMapLayer(),this.initRoadNetLayer(),this.initPoiClickLayer(),this.initOverlay(),this.updateTopologyMarkers(),this.initScaleControl()}catch(e){"undefined"!=typeof alog&&alog("http://webmap1.map.bdstatic.com/newmap/static/common/widget/pano/module/PanoOverviewModule/PanoMapComponent/exception.fire","catch",{msg:e.message||e.description,path:"common:widget/pano/module/PanoOverviewModule/PanoMapComponent/PanoMapComponent.js",ln:95})}},updateTopologyMarkers:function(e){for(var t,o=this._map,n=this;this._topologyMarkers.length;)t=this._topologyMarkers.pop(),o.removeOverlay(t);if(!e){var a=this._indoorModel;if(a&&a.has2DMap()){var i=a.getTopologyPoints(),r="../../../../../../../../../webmap0.map.bdstatic.com/newmap/static/common/images/panorama/indoor_marker_24_c5cb82c.png"/*tpa=http://webmap0.map.bdstatic.com/newmap/static/common/images/panorama/indoor_marker_24_c5cb82c.png*/,s=new BMap.Icon(r,new BMap.Size(16,16),{imageOffset:new BMap.Size(0,-30)});this._topologyMarkers=d.each(i,function(e){var t=new BMap.Marker(new BMap.Point(e.panox,e.panoy),{icon:s,title:e.name});return t.addEventListener("click",function(){n.dispatchEvent("pano_changed",{data:{panoId:e.id,panoType:"inter"}})}),o.addOverlay(t),t},!0)}}},initScaleControl:function(){var e=this._map,t=T('<div id="scale-controll-area"><a id="map-zoomout" title="放大一级" href="javascript:void(0)" class="fishbone_button"><span></span></a><div id="map-zoom-line"><div></div></div><a id="map-zoomin" href="javascript:void(0)" title="缩小一级" class="fishbone_button"><span></span></a></div>');this._fishBone=t[0],this.mapContainer.appendChild(this._fishBone);var o=T.g("map-zoomout"),n=T.g("map-zoomin");baidu.on(o,"click",function(t){baidu.event.preventDefault(t),baidu.event.stopPropagation(t);var o=e.getZoom();19>o&&e.zoomTo(o+1)}),baidu.on(o,"mouseenter",function(){baidu(o).addClass("hover")}),baidu.on(o,"mouseleave",function(){baidu(o).removeClass("hover")}),baidu.on(n,"click",function(t){baidu.event.preventDefault(t),baidu.event.stopPropagation(t);var o=e.getZoom();o>3&&e.zoomTo(o-1)}),baidu.on(n,"mouseenter",function(){baidu(n).addClass("hover")}),baidu.on(n,"mouseleave",function(){baidu(n).removeClass("hover")})},hideScaleControl:function(){this._fishBone.style.display="none"},showScaleControl:function(){this._fishBone.style.display="block"},initMapLayer:function(){var e=this,t=e._opts,o=(e._fishboneCtrl,T.dom.create("div",{id:"panoOverviewMap",style:"width:100%; height:100%; overflow: hidden; z-index: "+t.zIndex}));this.mapContainer.appendChild(o),t.parent.style.display="block";var n=e._map=new BMap.Map(o,{coordType:BMAP_COORD_MERCATOR,zoomLevelMin:3,mapType:BMAP_NORMAL_MAP,enableResizeOnCenter:!0,enableCanvas2dMap:!1});n.enableScrollWheelZoom(),n.enableInertialDragging(),n.disableContinuousZoom(),n.centerAndZoom(e.point,e.level||n.getZoom()),n.setDefaultCursor("pointer"),e.bindMapEvents()},drawLine:function(e,t){var o=this._map;void 0===t?t=l[0]:"number"==typeof t&&(t=l[t]);var n=new BMap.Polyline(e,t);o.addOverlay(n)},addMarkers:function(e){for(var t=0;t<e.length;t++)p.addDestPoi(e[t].point,e[t].text,e[t].type,void 0,this._map)},addSearchMarker:function(e,t,o){var n=new BMap.Point(e,t),a="../../../../../../../../../webmap0.map.bdstatic.com/newmap/static/common/images/pano_whole/pano-marker_f7456fc.gif"/*tpa=http://webmap0.map.bdstatic.com/newmap/static/common/images/pano_whole/pano-marker_f7456fc.gif*/,i=new BMap.Icon(a,new BMap.Size(18,18));this.removeSearchMarker(),this.searchMarker=new BMap.Marker(n,{icon:i,offset:new BMap.Size(0,-2),title:o}),this._map.addOverlay(this.searchMarker),this.searchMarker.setTop(!0,9999999)},removeSearchMarker:function(){this.searchMarker&&(this._map.removeOverlay(this.searchMarker),this.searchMarker=null)},initRoadNetLayer:function(){var e=this,t=e._map;e._roadnet=new a({context:e._opts.context,map:t}),e._roadnet.addEventListener("photo_tour_enter",function(t){e.dispatchEvent("photo_tour_enter",{data:t.data})}),e._roadnet.show()},initPoiClickLayer:function(){var e=this,t=e._map;e._poiClickLayer=new i({context:e._opts.context,map:t,callback:"panoPoiClick"}),e.bindPoiClickEvents()},removePoiClickLayer:function(){this._roadnet.removeLayer(),this._poiClickLayer.removeEventListener("click",this.eventHandlers.house_click)},initOverlay:function(){var e=this,t=e._map,o=e.point;e.prePos=o,e._overlay=new r({position:o}),t.addOverlay(e._overlay),t.setCenter(o),e._overlay.setDirection(e._opts.data.panoHeading),e.getCurCity(),e.bindOverlayEvents()},initPathLayer:function(){var e=this,t=e._map,o=window.currentComponent;if(o&&o.getOverlays){e.viewportPoints=[];var n,a=o.getOverlays(),i=a.routes;if(i)for(var r=0;r<i.length;r++)n=p.addRoute(i[r].points,i[r].type,void 0,t),e.viewportPoints=e.viewportPoints.concat(n.points);var s=a.drRoutes;if(s)for(var r=0;r<s.length;r++){n=p.addDrRoute(s[r].flag,s[r].obj,!1,t);for(var r=0;r<n.length;r++)e.viewportPoints=e.viewportPoints.concat(n[r].points)}var d=a.transMarkers;if(d)for(var r=0;r<d.length;r++)p.addTransPoi(d[r].point,d[r].type,d[r].text,t);var l=a.destMarkers;if(l)for(var r=0;r<l.length;r++)p.addDestPoi(l[r].point,l[r].text,l[r].type,void 0,t);var v=a.arrows;v&&(e.arrows=v,e.redrawArrow(),t.addEventListener("zoomend",function(){e.redrawArrow()},e.guid+"_zoomend"),t.addEventListener("moveend",function(){e.redrawArrow()},e.guid+"_moveend"));var c=a.tips;if(c)for(var r=0;r<c.length;r++)p.createTip(c[r].content,c[r].className,c[r].opts,t);var m=a.markers;if(m)for(var r=0;r<m.length;r++)t.addOverlay(new BMap.Marker(m[r].point,{icon:m[r].icon,title:m[r].title}))}},setMapClickHook:function(e){this._mapClickHook=e},bindMapEvents:function(){var e=this,t=e._map;e.eventHandlers.map_click=function(t){if("function"==typeof e._mapClickHook){var o=e._mapClickHook(t.point.lng,t.point.lat);if(o===!0)return}e._processMoving||e.getPanoInfo(t.point.lng,t.point.lat)},e.eventHandlers.map_typechange=function(t){t.mapType;e._roadnet&&e._roadnet.update()},e.eventHandlers.map_zoomstart=function(){e._centerPt=t.getCenter()},e.eventHandlers.map_zoomend=function(){t.setCenter(e._centerPt),e.dispatchEvent("level_changed",{data:{level:t.getZoom()}});var o=T.g("map-zoomout"),n=T.g("map-zoomin"),a=t.getZoom();baidu.dom.removeClass(o,"disabled"),baidu.dom.removeClass(n,"disabled"),3==a&&baidu.dom.addClass(n,"disabled"),19==a&&baidu.dom.addClass(o,"disabled"),e._isDrag=!1},e.eventHandlers.map_tilesloaded=function(){e.dispatchEvent("tiles_loaded")},e.eventHandlers.map_dragstart=function(){e._isDrag=!0},e.eventHandlers.map_dragend=function(){e._isDrag&&(e._isDrag=!1,window._pano_overviewmap_leaved&&(window._mouseleave_trigger_source="map",baidu("#panoMapOuterWapper").trigger("mouseleave")))},t.addEventListener("click",e.eventHandlers.map_click),t.addEventListener("maptypechange",e.eventHandlers.map_typechange),t.addEventListener("zoomstart",e.eventHandlers.map_zoomstart),t.addEventListener("zoomend",e.eventHandlers.map_zoomend),t.addEventListener("tilesloaded",e.eventHandlers.map_tilesloaded),baidu.on("panoOverviewMap","mousedown",e.eventHandlers.map_dragstart),baidu.on(document.body,"mouseup",e.eventHandlers.map_dragend),baidu.on("panoOverviewMap","mouseenter",function(){e.dispatchEvent("mouseenter")}),baidu.on("panoOverviewMap","mouseleave",function(){e.dispatchEvent("mouseleave")})},bindPoiClickEvents:function(){var e=this,t=e._poiClickLayer;e.eventHandlers.house_click=function(t){var o={panoIId:t.panoUid,panoType:"inter"};e.dispatchEvent("pano_changed",{data:o})},t.addEventListener("click",e.eventHandlers.house_click)},bindOverlayEvents:function(){var e=this,t=e._overlay;e.eventHandlers.overlay_rotate=function(t){e.setViewPov(t.angle)},e.eventHandlers.overlay_dragend=function(t){e.getPanoInfo(t.point.lng,t.point.lat)},t.addEventListener("oncircleclick",e.eventHandlers.overlay_rotate),t.addEventListener("onrotating",e.eventHandlers.overlay_rotate),t.addEventListener("onrotateend",e.eventHandlers.overlay_rotate),t.addEventListener("ondragend",e.eventHandlers.overlay_dragend)},removeOverlayEvents:function(){var e=this,t=e._overlay;t&&(t.removeEventListener("oncircleclick",e.eventHandlers.overlay_rotate),t.removeEventListener("onrotating",e.eventHandlers.overlay_rotate),t.removeEventListener("onrotateend",e.eventHandlers.overlay_rotate),t.removeEventListener("ondragend",e.eventHandlers.overlay_dragend),e.eventHandlers=null)},setViewPov:function(e){var t=this;if(t.tipLabel&&t.tipLabel.hide(),!isNaN(e)){var o={panoHeading:parseInt(e),panoPitch:0};t.dispatchEvent("pov_changed",{data:o})}},getPanoInfo:function(e,t){var o=this,n=o._map;o.tipLabel&&o.tipLabel.hide();var a=o._opts.context.panoContext.getPanoOptions();s.getStreetBriefByLocation({point:{lng:e,lat:t},level:n.getZoom(),mode:a.mode},function(n){if(0==n.error&&n.content&&n.content.id){var a=n.content.id,i=n.content.point,r=new BMap.Point(i.lng,i.lat);o.prePos=r;var s={panoId:a,panoType:o._opts.data.panoType};o.dispatchEvent("pano_changed",{data:s}),o.getCurCity(),addStat(STAT_CODE.STAT_PANORAMA,{item:Pano.PANO_TYPE_STREET,catalog:"map",func:"click",from:"overview-map"})}else o.showTip(new BMap.Point(e,t)),o.resetPos()},o)},getCurCity:function(e){var t=this,o=t._map,n=o.getBounds(),a=n.minX+","+n.minY+";"+n.maxX+","+n.maxY,i=o.getZoom(),r=(new Date).getTime();baidu.ajax("/?newmap=1&qt=ncent&ie=utf-8&b="+a+"&l="+i+"&t="+r,{dataType:"json",success:function(o){o&&o.content&&o.current_city&&t.setCurCity(o.current_city,e)},error:function(){}})},setCurCity:function(e,t){this._currentCity={cityId:e.code,cityName:e.name},t&&t(this._currentCity)},getCurrentCity:function(e){this._currentCity?e(this._currentCity):this.getCurCity(e)},setOverlayPos:function(e){var t=this;t._processMoving?t._processQueue=e:(t._processMoving=!0,t.eventHandlers.map_movestart=function(){t._processMoving&&(t._map.disableScrollWheelZoom(),t._map.disableDragging())},t.eventHandlers.map_moving=function(){t._processMoving&&t._overlay.setPosition(t._map.getCenter())},t.eventHandlers.map_moveend=function(){t._processMoving&&(t._processMoving=!1,t._overlay.setPosition(t.prePos),t._map.setCenter(t.prePos),t._map.enableScrollWheelZoom(),t._map.enableDragging(),t._map.removeEventListener(t.eventHandlers.map_movestart),t._map.removeEventListener(t.eventHandlers.map_moving),t._map.removeEventListener(t.eventHandlers.map_moveend),t._processQueue&&(t._processMoving=!0,t._map.panTo(t._processQueue),t._processQueue=null))},t._map.addEventListener("movestart",t.eventHandlers.map_movestart),t._map.addEventListener("moving",t.eventHandlers.map_moving),t._map.addEventListener("moveend",t.eventHandlers.map_moveend),t._map.panTo(e))},showTip:function(e){var t=this;if(t.tipLabel)t.tipLabel.setPoint(e),t.tipLabel.show(),t.delayHide();else{var o={point:e,offset:new BMap.Size(0,0)};t.tipLabel=new BMap.Label("<div style='text-align:center;margin-top:5px;'>此处无全景</div ><div style='color:#4869a5;' >请点击蓝色路网</div>",o),t.tipLabel.setStyle({backgroundColor:"#fff",borderColor:"#b1b1b1",borderWidth:"1px",fontSize:"12px",height:"50px",lineHeight:"20px",fontFamily:"微软雅黑"}),t._map.addOverlay(t.tipLabel),t.delayHide()}},delayHide:function(){var e=this;e.tipTimer&&window.clearTimeout(e.tipTimer),e.tipTimer=window.setTimeout(function(){e.tipLabel&&e.tipLabel.hide()},2e3)},resetPos:function(){var e=this;e.prePos&&e._overlay&&(e._overlay.setPosition(e.prePos),e._map.panTo(e.prePos))},update:function(e,t){var o=this;t=t||o.level,e&&t&&o._map.centerAndZoom(e,t)},redrawArrow:function(){for(var e=this._map,t=this.arrows;this.arrowMarkers.length;)e.removeOverlay(this.arrowMarkers.pop());for(var o=0;o<t.length;o++)this.arrowMarkers=this.arrowMarkers.concat(p.addArrow(t[o].split(";"),e))},destroyAll:function(){this.mapContainer.removeChild(this._fishBone);var e=baidu.g("panoOverviewMap");e&&e.parentNode&&e.parentNode.removeChild(e),baidu.un(document.body,"mouseup",this.eventHandlers.map_dragend)},event_povChanged:function(e){var t=this,o=t._overlay;o.setDirection(e)},event_panoChanged:function(e,t){var o,n=this._overlay,a=e.panoHeading||e.heading;o=e.panoMCPoint?new BMap.Point(e.panoMCPoint.x,e.panoMCPoint.y):e.panoPoint?e.panoPoint:new BMap.Point(e.x,e.y),this.prePos=o,this.setOverlayPos(o),n.setDirection(a),this.panoMode=e.mode||this.panoMode,!t||this._indoorModel&&this._indoorModel.equal(t)||(this._indoorModel=t,this.updateTopologyMarkers())},event_floorChanged:function(){this.updateTopologyMarkers(!0)},event_exitIndoor:function(){this.updateTopologyMarkers(!0),this._indoorModel=null},getLevel:function(){return this._map.getZoom()},getBounds:function(){return this._map.getBounds()},getCenter:function(){return this._map.getCenter()},getCenterPointInfo:function(){var e=this;return{panoPoint:e._overlay.getPosition(),panoHeading:e._overlay.getDirection()}},setCenter:function(){var e=this,t=e._overlay;if(t){var o=t.getPosition();t.setOffset(),e._map.panTo(o),e._map.setCenter(o)}},setZoom:function(e){this._map.zoomTo(e)}}),o.exports=n});