define("common:widget/pano/PhotoTour/PhotoTourMain.js",function(o,t,i){function e(o,t){T.lang.Class.call(this),this._container=document.body,this._shareParam={tourIId:o,tourId:t},this.initialize(o,t)}var a=o("common:widget/pano/PhotoTour/PhotoTourModule/PhotoTourModule.js"),n=o("common:widget/pano/PhotoTour/PhotoTourLayout/PhotoTourLayoutManager.js"),r=o("common:widget/pano/PhotoTour/PhotoTourGuide/PhotoTourGuide.js"),u=o("common:widget/pano/PhotoTour/PhotoTourShare/PhotoTourShare.js"),s=o("common:widget/pano/base/service.js"),d=o("common:widget/ui/config/config.js"),h=(o("common:widget/pano/base/util.js"),o("common:widget/com/componentManager.js"));T.inherits(e,T.lang.Class,"PhotoTourMain"),T.extend(e.prototype,{initialize:function(o,t){try{var i=this;this._layout=this.initLayout(this._container),this._showMask();var e=this._layout.getContainer("return");this.bindExitEvent(e),s.getTourGuideData(o).then(function(o){t||(t=o.defaultId,i._shareParam.tourId=t),i._guideData=o;var e=i._layout.getContainer("tour");i._tourModule=i.initPhotoTour(e,t);var a=i._layout.getContainer("guide");i._guideModule=i.initGuide(a,o,t),i._layout.updateCopyRight(i._guideModule.getCopyRightName()),i._guideModule.addEventListener("id_selected",function(o){i._layout.updateCopyRight(o.data.name),i._shareParam.addressName=o.data.name,i._shareParam.tourId=o.data.tourId,i._tourModule.setTourid(o.data.tourId),i._showMask()});var n=i._layout.getContainer("share");i.initShare(n),i._tourModule.addEventListener("photoview_complete",function(){i._layout.showExpandArea(),i._hideMask()}),i._tourModule.addEventListener("id_changed",function(o){i._showMask(),i._guideModule.updateByTourId(o.data.id),i._shareParam.tourId=o.data.id,i._shareParam.addressName=o.data.name})})}catch(a){"undefined"!=typeof alog&&alog("http://webmap1.map.bdstatic.com/newmap/static/common/widget/pano/PhotoTour/exception.fire","catch",{msg:a.message||a.description,path:"common:widget/pano/PhotoTour/PhotoTourMain.js",ln:74})}},_showMask:function(){c.show()},_hideMask:function(){c.hide()},bindExitEvent:function(o){var t=this;T.on(o,"click",function(){var o=t.getTourInfoByTourId(t._shareParam.tourId),i=16,e=new BMap.Point(o.X,o.Y),a={panoId:t._shareParam.tourId,uid:t._shareParam.tourIId,panoType:"photo_tour"};131!=d.modelConfig.cityCode?h.go("cur&wd="+encodeURIComponent("北京市"),{cinfo:{isFromPano:!0},onload:function(){t.initPhotoTourExitMarker(a,e,i)}}):t.initPhotoTourExitMarker(a,e,i),t.dispose()})},initPhotoTourExitMarker:function(t,i,e){window.panoExitMarker?window.panoExitMarker.show(t,i,e):o.async("common:widget/pano/module/PanoExitMarker/PanoExitMarker.js",function(o){var a=new o;a.initialize(t,i,e),window.panoExitMarker=a}),l()},getTourInfoByTourId:function(o){for(var t=this._guideData.Paths,i=t.length-1;i>=0;i--)if(t[i].tourId==o)return t[i];return null},initPhotoTour:function(o,t){var i=new a;return i.initialize(o,t),i},initGuide:function(o,t,i){var e=new r;return e.initialize(o,t,i),e},initLayout:function(o){var t=new n;return t.initialize(o),t},initShare:function(o){function t(){var t=o.offsetTop+"px",e=new u;e.initialize(o.parentNode,{positionTop:t,address:i._shareParam.addressName,shareParam:{tourIId:i._shareParam.tourIId,tourId:i._shareParam.tourId}})}T.on(o,"click",t);var i=this},dispose:function(){this.dispatchEvent("dispose"),this._guideModule.dispose(),this._layout.dispose(),this._tourModule.dispose(),this._tourModule=null,this._guideModule=null,this._layout=null,this._container=null}});var l=function(){window.streetViewTool?(window.streetViewTool.resetStatus(),window.streetViewTool.setStatus()):o.async("common:widget/ui/StreetViewTool/StreetViewTool.js",function(o){var t=new o({map:map});map.addControl(t),t.show(),t.setPostion(),t.setStatus(),window.streetViewTool=t})},c={_mask:null,_timouter:null,_init:function(){if(!this._mask){var o=this._mask=document.createElement("div");o.style.cssText=["top:0","left:0","position:absolute","width:100%","height:100%","background-color:black","filter:alpha(opacity=0)","opacity:0","z-index:200001"].join(";")}},dispose:function(){this._mask.parentNode.removeChild(this._mask),this._mask=null},show:function(){this._mask||c._init();var o=T.g("photo-container");o.appendChild(this._mask),this._timouter=setTimeout(function(){c.hide()},8e3)},hide:function(){this._mask&&(null!==this._timouter&&clearTimeout(this._timouter),this._mask.parentNode&&this._mask.parentNode.removeChild(this._mask))}};i.exports=e});