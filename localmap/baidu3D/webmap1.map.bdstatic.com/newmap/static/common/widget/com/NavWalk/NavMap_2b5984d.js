define("common:widget/com/NavWalk/NavMap.js",function(t,e,i){function o(t){T.lang.Class.call(this),this.noName="未知路段",this.sended=0,this.popWins=[],this.popPois=[],this.walkMkrs=[],this.ajax=new T.Ajax,this.ajax.async=!0,this.queryWalk=[],this.strategy=0,this.tipLabel=r.createDrvMidLabel("拖动以更改路线"),window.dropRoutes=[],this.exportOverlays={drRoutes:[],destMarkers:[]},this.mapZoomLevel=map.zoomLevel,T.object.extend(this,t),map.clearOverlays()}var n=t("common:widget/com/componentManager.js"),a=t("common:widget/ui/util/util.js"),s=t("common:widget/ui/constant/Constant.js"),r=t("common:widget/ui/mapUtil/mapUtil.js"),d=t("common:widget/ui/transInfoWindow/transInfoWindow.js"),p=t("common:widget/ui/config/config.js"),h=p.mapConfig,g=p.modelConfig,u=t("common:widget/ui/PanoEntranceUtil/PanoEntranceUtil.js"),l=t("common:widget/ui/mapShare/MapShare.js");T.inherits(o,T.lang.Class,"NavMap"),T.object.extend(o.prototype,{drawLine:function(){var t=this;if(!t.total||0==t.total){t.dragPoints.push({p:t.start.pt,n:t.start.wd});var e=r.addDestPoi(t.start.pt,"",s.DEST_START);return e.enableDragging(!0),e.addEventListener("ondragging",function(e){t.addViaRoute2(e,1)}),e.addEventListener("onmouseover",function(e){t.onViaPoiOver(e,1)}),e.addEventListener("onmouseout",function(e){t.onRemoveTips(e,1)}),e.addEventListener("ondragend",function(e){t.addViaPoi2(e,1)}),e.index=0,window.startPoi=e,window.startPoi._sc=t.sCity.code,t.dragPoints.push({p:t.end.pt,n:t.end.wd}),e=r.addDestPoi(t.end.pt,"",s.DEST_END),e.addEventListener("ondragging",function(e){t.addViaRoute2(e,2)}),e.addEventListener("onmouseover",function(e){t.onViaPoiOver(e,2)}),e.addEventListener("onmouseout",function(e){t.onRemoveTips(e,2)}),e.addEventListener("ondragend",function(e){t.addViaPoi2(e,2)}),e.index=1,e.enableDragging(!0),window.endPoi=e,void(window.endPoi._ec=t.eCity.code)}r.addDrRoute(!1,this),this.exportOverlays.drRoutes.push({flag:!1,obj:this})},unload:function(){},addDrPoi:function(){for(var t=this.dragPoints,e=t.length,i=this,o=0;e>o;o++){var n;0==o?(n=r.addDestPoi(this.start.pt,"",s.DEST_START),this.exportOverlays.destMarkers.push({point:this.start.pt,text:"",type:s.DEST_START}),n.addEventListener("ondragging",function(t){i.addViaRoute2(t,1)}),n.addEventListener("onmouseover",function(t){i.onViaPoiOver(t,1)}),n.addEventListener("onmouseout",function(t){i.onRemoveTips(t,1)}),n.addEventListener("ondragend",function(t){i.addViaPoi2(t,1)}),window.startPoi=n,window.startPoi._sc=i.sCity.code):o==e-1&&(n=r.addDestPoi(this.end.pt,"",s.DEST_END),this.exportOverlays.destMarkers.push({point:this.end.pt,text:"",type:s.DEST_END}),n.addEventListener("ondragging",function(t){i.addViaRoute2(t,2)}),n.addEventListener("onmouseover",function(t){i.onViaPoiOver(t,2)}),n.addEventListener("onmouseout",function(t){i.onRemoveTips(t,2)}),n.addEventListener("ondragend",function(t){i.addViaPoi2(t,2)}),window.endPoi=n,window.endPoi._ec=i.eCity.code),this.dragPois||(this.dragPois=[]),n.addEventListener("ondragstart",function(t){i.dragViaPoi(t)}),n.enableDragging(!0),n.index=o,this.dragPois.push(n)}},addPopInfoWin:function(){for(var t=this.popPoints.length,e=0;t>e;e++)this.popWins.push(d.createTransInfoWnd({title:this.popInfos[e].title,content:this.popInfos[e].info,curIndex:e,total:t,obj:this,nextInfo:this.popInfos[e].next,nextTransCbk:this.nextTransCbk,zoomTransCbk:this.zoomTransCbk}));var i=this,o=this.popWins[0];i.openSWin=function(){i.getClickMarker(o,i.dragPois[0],0)()};var n=this.popWins[this.popWins.length-1];i.openEWin=function(){i.getClickMarker(n,i.dragPois[i.dragPois.length-1],i.dragPois.length-1)()},this.dragPois&&(this.dragPois[0].addEventListener("click",i.openSWin),this.dragPois[this.dragPois.length-1].addEventListener("click",i.openEWin))},addPopPoi:function(t){for(var e=0;e<this.popPois.length;e++)map.removeOverlay(this.popPois[e]),this.popPois[e]=null;if(this.popPois=[],!this.popPois.length){if(null!=t&&!isNaN(t)){var i=this.popPoints[t+1].p.toString(),o=this.popPoints[t+2].p.toString(),n=parseInt(this.popPoints[t+1].a),a=parseInt(this.popPoints[t+2].a),s=r.addDrvDirIcon(i,n);t+2==this.popPoints.length-2&&(a=12);var d=r.addDrvDirIcon(o,a),p=this.popWins[t+1],h=this.popWins[t+2];s.addEventListener("click",this.getClickMarker(p,s,t+1)),d.addEventListener("click",this.getClickMarker(h,d,t+2))}s.disableDragging(),d.disableDragging(),this.popPois.push(s),this.popPois.push(d)}},addWalkIcon:function(t){this.walkMkrs=[];for(var e=0,i=t.length;i>e;e++)this._addWalkIcon(t[e])},_addWalkIcon:function(t){function e(){map.getZoom()<16?T.browser.ie>=8?setTimeout(function(){p&&p.hide()},100):p&&p.hide():p&&p.show()}if(t.ipt){var i=r.parse2Geo(t.ipt).points,o=a.getPoiPoint(i);if(o&&0!=o.lng&&0!=o.lat){var n=[{wd:"非步行设施"},{wd:"人行道"},{wd:"天桥",img:[0,-20],w:18},{wd:"地下通道",img:[0,0],w:18},{wd:"人行通道"},{wd:"直梯"},{wd:"扶梯"},{wd:"阶梯"},{wd:"斜坡"},{wd:"索道"},{wd:"广场",img:[0,-40],w:18},{wd:"公园"}],s=null;if(1*t.t>19&&1*t.t<25)switch(1*t.t){case 20:case 21:s=n[1*t.t-10];break;case 23:s=n[2];break;case 24:s=n[3]}else s=n[1*t.wt];if(s&&s.img){var d=new BMap.Icon("../../../../../../../webmap2.map.bdstatic.com/newmap/static/common/images/walkflag_16127a7.png"/*tpa=http://webmap2.map.bdstatic.com/newmap/static/common/images/walkflag_16127a7.png*/,new BMap.Size(s.w,s.w),{offset:new BMap.Size(s.w/2,s.w/2),imageOffset:new BMap.Size(s.img[0],s.img[1])}),p=new BMap.Marker(o,{icon:d});map.addOverlay(p),this.walkMkrs.push(p),map.getZoom()<16?p.hide():p.show(),map.addEventListener("zoomend",e),p.addEventListener("remove",function(){map.removeEventListener("zoomend",e)});var h=new BMap.Label(s.wd);map.addOverlay(h),h.setStyle({backgroundColor:"#EEFFED",borderColor:"#6D8760",color:"#4D6B37",lineHeight:"16px",paddingTop:"0px",paddingBottom:"0px"}),h.setPoint(o),h.setOffset(new BMap.Size(1*s.w/2+2,0-1*s.w/2)),h.hide();var g=!1;p.addEventListener("onmouseover",function(){g=!0,setTimeout(function(){g&&h.show()},500)}),p.addEventListener("onmouseout",function(){h.hide(),g=!1})}}}},onRemoveTips:function(){if(this.tipLabel&&map.removeOverlay(this.tipLabel),this.dragVia&&this.dragVia.isVisible()){var t=this.dragVia.getDom().style;t&&(this.dragVia.getDom().style.visibility="hidden")}},removeTimer:function(){this.distime&&window.clearTimeout(this.distime)},dragViaPoi:function(t){var e=this;e.dateStart=(new Date).getTime(),e.removeTimer(t)},onViaPoiOver:function(t,e){if(!this.draging&&window.dropRoutes){var i=t.target.index;switch(e){case 0:this.tempDrag=[window.dropRoutes[i-1],window.dropRoutes[i]];break;case 1:this.tempDrag=[window.dropRoutes[i]];break;case 2:this.tempDrag=[window.dropRoutes[i-1]]}}h.navWalk.enableDragging&&t.target.setLabel(this.tipLabel)},removeDraw:function(){var t=this;if(t.tempDrag&&t.tempDrag.length>0)for(var e=0;e<t.tempDrag.length;e++){var i=t.tempDrag[e];i&&r.removeRoute(i)}},addViaPoi2:function(t,e,i){var o=this;if(1!=o.dflag){o.ajax.duration=1,o.ajax.onsuccess=null,o.draging=!1,o.sended=1;var a=t?t.target:i;a.dis=0;var s=a.index;if(!o.queryWalk||!o.queryWalk.length)return;var r=(o.queryWalk[o.queryWalk.length-1],a.point.lng+","+a.point.lat),d=r,p=a.viaName;p=p||o.noName;var h="",g="",u="";o.dragPoints.splice(s,1,{p:r,n:a.viaName});for(var l=1;l<o.dragPoints.length-1;l++)g+="1$$$$"+o.dragPoints[l].p+"$$$$+to:",u+="0 +to:";switch(e){case 0:h="walk&version=2.0&c="+o.currentCity+"&drag=1&sc="+o.sCity.code+"&ec="+u+o.eCity.code+"&sy="+o.strategy+"&sn=1$$$$"+o.popPoints[1].p+"$$"+encodeURIComponent(o.start.wd)+"$$"+o.start.pt+"$$$$&st=0&en="+g+"1$$$$"+o.popPoints[o.popPoints.length-2].p+"$$"+encodeURIComponent(o.end.wd)+"$$"+o.end.pt+"$$&et=0";break;case 1:h="walk&version=2.0&c="+o.currentCity+"&drag=1&sc="+o.sCity.code+"&ec="+u+o.eCity.code+"&sy="+o.strategy+"&sn=1$$$$"+r+"$$"+encodeURIComponent(p)+"$$"+d+"$$&st=1&en="+g+"1$$$$"+o.end.pt+"$$"+encodeURIComponent(o.end.wd)+"$$&et=0&de=1";break;case 2:h="walk&version=2.0&c="+o.currentCity+"&drag=1&sc="+o.sCity.code+"&ec="+u+o.eCity.code+"&sy="+o.strategy+"&sn=1$$$$"+o.start.pt+"$$"+encodeURIComponent(o.start.wd)+"$$&st=0&en="+g+"1$$$$"+r+"$$"+encodeURIComponent(p)+"$$"+d+"$$&et=1&de=1"}n.go(h),o.dflag=1,o.dragpt=""}},addViaRoute2:function(t,e){for(var i=0,o=this.walkMkrs.length;o>i;i++)this.walkMkrs[i]&&this.walkMkrs[i].hide();this.dateEnd=(new Date).getTime();var n=this.dateEnd-this.dateStart,a=t.target.index,s=t.target;s.failure=0,n>10&&this.dragPois&&(this.dragPois[0].removeEventListener("click",this.openSWin),this.dragPois[this.dragPois.length-1].removeEventListener("click",this.openEWin));var r=s.point,d="",p=1,h=1;switch(this.sp="",this.ep="",e){case 0:this.sp=this.dragPoints[a-1].p,this.ep=this.dragPoints[a+1].p;break;case 1:this.ep=this.dragPoints[a+1].p;break;case 2:this.sp=this.dragPoints[a-1].p}p=1,h=1,d="wdrag&sy="+this.strategy+"&pt="+r.lng+","+r.lat+"&sn="+this.sp+"&st="+p+"&en="+this.ep+"&et="+h+"&r=5000";var g={url:d,flag:0,dragpt:r};if(this.ajax.duration=-1,this.draging){n>2e3&&(this.timeout&&clearTimeout(this.timeout),this.dateStart=(new Date).getTime(),this.dragRequest2(g,a,e,s),this.queryWalk.push(g));var u=this;this.timeout=setTimeout(function(){if(u.queryWalk&&u.queryWalk.length){var t=u.queryWalk[u.queryWalk.length-1];t&&0==t.flag&&u.queryWalk&&!u.draging&&0==u.dflag&&u.dragRequest2(t,a,e,s)}},3e3)}else this.dragRequest2(g,a,e,s),this.queryWalk.push(g)},dragRequest2:function(t,e,i,o){var n=this;n.draging=!0,this.sended=0;var a=Math.pow(2,BMap.MapType[map.mapType].zoomLevelMax-map.zoomLevel-3);this.ajax.onsuccess=function(d){try{if(n.data=baidu.json.parse(d.responseText),n.data&&n.data.result&&0==n.data.result.error&&n.data.content){var p=n.data.result,h=n.data.content,g=r.parse2Geo(h.geo,a),u=g.points,l=h.name;("undefined"==typeof l||""==l)&&(l=n.noName),o.viaName=l,o.dis=h.dis,o.failure=0;var c=o.dis||0,m="0米",v=n.routePoints.length;if(1!=v&&1!=e)for(var f=0;v>f;f++){var w=n.routePoints[f];if(f!=e-1&&1!=i||f!=e&&1==i)for(var P=0;P<w.length;P++)c+=parseFloat(w[P].d)}if(m=10>c?"10米":1e3>c?10*(c/10).toFixed(0)+"米":(c/1e3).toFixed(1)+"公里",n.tipLabel.setContent(l+"("+m+")"),o.setLabel(n.tipLabel),n.dragpt=r.parse2Geo(h.dragpt).points,n.mousept=p.pt,n.popPois){for(var f=0;f<n.popPois.length;f++)map.removeOverlay(n.popPois[f]);n.popPois=null}if(n.tempDrag&&n.tempDrag.length>0)for(var f=0;f<n.tempDrag.length;f++){var k=n.tempDrag[f];k&&r.removeRoute(k)}if(n.tempDrag=[],1==i||2==i){var k=r.addRoute(u,s.ROUTE_TYPE_DRIVE);n.tempDrag.push(k),1==i?(k.index=e,window.dropRoutes.splice(e,1,k)):(k.index=e-1,window.dropRoutes.splice(e-1,1,k))}else for(var f=0;f<u.length;f++){var k=r.addRoute(u[f],s.ROUTE_TYPE_DRIVE);k.index=e-1+f,n.tempDrag.push(k),0==f?window.dropRoutes.splice(e-1,1,k):window.dropRoutes.splice(e-1+f,0,k)}n.draging=!1,n.dflag=0,t.flag=1}else o.failure=1,o.draging=!1,t.flag=0}catch(R){o.failure=1,o.draging=!1,t.flag=0}};var d=map.getBounds(),p=location.pathname+g.DATA_URL+t.url+"&ie=utf-8&l="+map.zoomLevel+"&b=("+d.minX+","+d.minY+";"+d.maxX+","+d.maxY+")&newmap=1&t="+(new Date).getTime();this.ajax.request(p)},onRouteOver:function(){},onRouteOut:function(){},onRouteMove:function(){},removeDrag:function(){},updatePanoPopWins:function(t){if(t&&t.length){var e=T.object.clone(t);e.unshift(e[0]),this.popWins=u.addPanoThumbnailsInInfoWnd(this.popWins,e,t,"walk")}},clickStop:function(t){if(0==t){var e=this.popWins[0];window.startPoi.openInfoWindow(e),l.popIndex=0}else{var e=this.popWins[this.popPoints.length-1];window.endPoi.openInfoWindow(e),l.popIndex=this.popPoints.length-1}},nextTransCbk:function(t,e){for(var i=e.popPoints[t].p,o=e.popPoints[t].a,n=e.popWins[t],a=0;a<e.popPois.length;a++)map.removeOverlay(e.popPois[a]),e.popPois[a]=null;if(e.dispatchEvent("poiinfoopen",{index:t-1}),t>0&&t<e.popPoints.length-1){t==e.popPoints.length-2&&(o=12);var s=r.addDrvDirIcon(i,o);s.addEventListener("click",e.getClickMarker(n,s,t)),e.popPois.push(s),s.openInfoWindow(n)}0==t&&window.startPoi?(window.startPoi.openInfoWindow(n),l.popIndex=0):t==e.popPoints.length-1&&window.endPoi&&(window.endPoi.openInfoWindow(n),l.popIndex=e.popPoints.length-1)},zoomTransCbk:function(t,e){var i=BMap.MapType[map.mapType].zoomLevelMax;map.zoomTo(0==t?i:e.mapZoomLevel!=map.zoomLevel?e.mapZoomLevel:i-3)},getClickMarker:function(t,e,i){return function(){l.popIndex=i,e.openInfoWindow(t)}},addTips:function(t,e){if(!this.draging){var i=Math.pow(2,BMap.MapType[map.mapType].zoomLevelMax-map.zoomLevel-3);this.tempRoute&&(r.unSelectRoute(this.tempRoute),r.removeRoute(this.tempRoute));var o=[];if(null==e||isNaN(e)){var n=r.cutPoints(this.drivePoints[t],i);o.push(this.popPoints[t+1].p),o.push(n)}else if(this.groupPoints[e])for(var a=0;a<this.groupPoints[e].length;a++){var n=r.cutPoints(this.groupPoints[e][a],i);o.push(n)}this.tempRoute=r.addRoute(o.join(";"),s.ROUTE_TYPE_DRIVE),r.selectRoute(this.tempRoute)}},removeTips:function(){this.tempRoute&&(r.unSelectRoute(this.tempRoute),r.removeRoute(this.tempRoute))},highRoute:function(t){if(map.closeInfoWindow(),this.mapZoomLevel=map.zoomLevel,null!=t&&this.driveBounds[t]){var e=[this.driveBounds[t]],i=a.getBPoints(e);r.setViewport(i,60)}r.addDrRoute(!0,this),this.addPopPoi(t),l.listIndex=t+",0",this.addTips(t)},resetDrv:function(){if(window.dropRoutes){for(var t=0;t<window.dropRoutes.length;t++){var e=window.dropRoutes[t];e&&r.removeRoute(e)}window.dropRoutes=[]}if(this.popPois){for(var t=0;t<this.popPois.length;t++)map.removeOverlay(this.popPois[t]);this.popPois=[]}r.addDrRoute(!1,this)}}),i.exports=o});