define("common:widget/ui/TrafficEvent/TrafficEvent.js",function(e,t,i){var a=e("common:widget/ui/areaCfg/areaCfg.js"),n=e("common:widget/ui/config/config.js"),r=(n.mapConfig,n.modelConfig),o=function(){T.lang.Class.call(this),this.opened=!1,this.bindEvent=!1,this.ishide=!1,this.time="",this.markers=[],this.iconType="big",this.bigIconZoom=14,this.baseUrl="http://its.map.baidu.com:8001/showevents.php?qt=traeve_data",this.showCitys=[{code:a["北京"],minZoom:6,ename:"beijing"},{code:a["上海"],minZoom:6,ename:"shanghai"},{code:a["广州"],minZoom:6,ename:"guangzhou"}],this.ctrlTimer="",this.dataTimer="",this.curCityCode="",this.curDataTime="",this.preGetDataTime="",this.data=[],this.intervalTime=3e5,this.markers=[],this.mapEvent=null,this.initialize()};o.prototype=new BMap.Control,o.iconIndex=[0,1,2,0,0,3,4,0,5,0,6,7,8,9,9,10],T.extend(o.prototype,{initialize:function(){try{var e=this;e._cityZoomConfig={},e._cityEnameConfig={};for(var t=0;t<e.showCitys.length;t++)e._cityZoomConfig[e.showCitys[t].code]=e.showCitys[t].minZoom,e._cityEnameConfig[e.showCitys[t].ename]=e.showCitys[t].code}catch(i){"undefined"!=typeof alog&&alog("http://webmap1.map.bdstatic.com/newmap/static/common/pkg/exception.fire","catch",{msg:i.message||i.description,path:"common:widget/ui/TrafficEvent/TrafficEvent.js",ln:78})}},open:function(e){var t=this,e=e||{},i=e.cityName||"";if(19!=map.getZoom()){t.opened||t.bindEvent||t.bind(),t.opened=!0;for(var a=[],n=0;n<t.showCitys.length;n++)a.push(t.showCitys[n].code);if(t.markers&&t.markers.length&&map.getZoom()>=t.bigIconZoom&&"small"==t.iconType||map.getZoom()<t.bigIconZoom&&"big"==t.iconType)for(var n=0;n<t.markers.length;n++){var o=t.markers[n];o.setIcon(t.createIcon(o.trafficEveType))}t.doHideMark(i),t.ctrlTimer&&clearTimeout(t.ctrlTimer),t.ctrlTimer=setTimeout(function(){if(!t.doHideMark(i)){var e=(new Date).getTime(),a=e-t.preGetDataTime,n=i?t._cityEnameConfig[i]:r.cityCode;if(n==t.curCityCode&&a<t.intervalTime){if(t.ishide&&t.markers&&t.markers.length)for(var o=0;o<t.markers.length;o++){var s=t.markers[o];0==s.isVisible()?s.show():null}}else t.update({cityCode:n});t.ishide=!1}},300)}},doHideMark:function(e){e?this._cityEnameConfig[e]:r.cityCode;return map.getZoom()<6?(this.hide(),!0):!1},bind:function(){var e=this,t=function(){return window.trafficCtrl&&(trafficCtrl.opened||trafficCtrl.ishide&&1==trafficCtrl.ishide)?void e.open():void e.close()};e.mapEvent=t,map.addEventListener("load",t,"TrafficEvent"),map.addEventListener("moveend",t,"TrafficEvent"),map.addEventListener("resize",t,"TrafficEvent"),map.addEventListener("dragend",t,"TrafficEvent"),map.addEventListener("zoomend",t,"TrafficEvent"),e.bindEvent=!0},close:function(){var e=this;map.removeEventListener("load",e.mapEvent),map.removeEventListener("moveend",e.mapEvent),map.removeEventListener("resize",e.mapEvent),map.removeEventListener("dragend",e.mapEvent),map.removeEventListener("zoomend",e.mapEvent),e.hide(),e.removeMarker(),e.preGetDataTime="",e.curCityCode="",e.curDataTime="",e.bindEvent=!1,e.opened=!1},hide:function(){for(var e=this,t=0;t<e.markers.length;t++){var i=e.markers[t];i.isVisible()?i.hide():null}e.ishide=!0,e.ctrlTimer&&clearTimeout(e.ctrlTimer),e.dataTimer&&clearTimeout(e.dataTimer)},update:function(e){e=e||{};var t=e.cityCode||"",i=this;i.dataTimer&&clearTimeout(i.dataTimer);var a=t||r.cityCode;i.getData(a),i.dataTimer=setTimeout(function(){i.update()},i.intervalTime)},createIcon:function(e){var t=this,i=map.getZoom(),a=0,n=o.iconIndex[e]||0,r=22,s=20,m="../../../../../webmap0.map.bdstatic.com/newmap/static/common/images/tfc_event_icon_f7bd599.png"/*tpa=http://webmap0.map.bdstatic.com/newmap/static/common/images/tfc_event_icon_f7bd599.png*/;t.iconType="big",i<t.bigIconZoom&&(a=22,r=17,s=15,t.iconType="small");var c=new BMap.Icon(m,new BMap.Size(r,s),{imageOffset:new BMap.Size(-a,20*-n),infoWindowOffset:new BMap.Size(15,0)});return c},formatTrafficTime:function(e,t){e=1e3*e;var i=new Date(e),a="";a+="iw"==t?i.getFullYear()+"年":i.getFullYear()+"-",a+="iw"==t?i.getMonth()+1+"月":i.getMonth()+1+"-",a+="iw"==t?i.getDate()+"日":i.getDate()+"";var n=" ";return"ymd"===t?a:("hm"===t&&(a="",n=""),a+=i.getHours()<10?n+"0"+i.getHours():n+i.getHours(),a+=i.getMinutes()<10?":0"+i.getMinutes():":"+i.getMinutes())},addMarker:function(e){if(e&&e.length){var t=this;t.removeMarker();for(var i=[],a=86400,n=0;n<e.length;n++){var r=e[n];if(r.geo){var o=r.geo.split("|"),s=o[1];2==o[0]&&(s=s.split("|")[0]);var m=s.split(","),c=new BMap.Point(m[0],m[1]),d=t.createIcon(r.type),f=new BMap.Marker(c,{icon:d,enableMassClear:!1});f.trafficEveType=r.type;var p=r.starttime,l=r.endtime,v=t.formatTrafficTime(r.endtime,"ymd");a>l-p&&(v="今天"+t.formatTrafficTime(r.endtime,"hm"));var h=new BMap.Label(r.title+'<br/><span style="color:#676767">预计'+v+"结束</span>",{offset:new BMap.Size(13,-15)});h.setStyle({borderColor:"#acaba9",color:"#4d4a43",cursor:"pointer",padding:"1px 3px"}),h.hide(),f.setLabel(h),function(){var e=f,i='<div class="iw_poi_content" style="color:#4c4942;line-height:23px;">';r.starttime&&(i+="起始时间："+t.formatTrafficTime(r.starttime,"iw")+"<br/>"),r.endtime&&(i+="预计结束时间："+t.formatTrafficTime(r.endtime,"iw")+"<br/>"),r.des&&(i+='<p style="margin-top:10px;">详情：<span style="color:#666666">'+r.des+"</span></p>"),i+="</div>";var a=new BMap.InfoWindow(i,{title:'<span class="iw_poi_title" style="padding-right:10px;white-space:normal;word-wrap:break-word">'+r.title+"</span>",width:304});e.addEventListener("mouseover",function(){if(this.setTop(!0),!a.isOpen()){this.getLabel().show()}}),e.addEventListener("mouseout",function(){a.isOpen()||(this.getLabel().hide(),this.setTop(!1))}),e.addEventListener("click",function(){this.getLabel().hide(),this.openInfoWindow(a)}),e.addEventListener("infowindowopen",function(){this.setTop(!0)}),e.addEventListener("infowindowclose",function(){this.setTop(!1)})}(),map.addOverlay(f),i.push(f)}}t.markers=i}},removeMarker:function(){for(var e=this,t=0;t<e.markers.length;t++)map.removeOverlay(e.markers[t]);e.markers=[]},getData:function(e){var t=this,i=t.baseUrl;i+="&city_code="+e,e==t.curCityCode&&""!=t.curDataTime&&(i+="&time="+t.curDataTime),i+="&call_back="+t.guid+"&t="+(new Date).getTime(),baidu.sio.callByBrowser(i,null,"traffic_event_"+t.guid),t.preGetDataTime=(new Date).getTime()},setData:function(e){if(e&&e.time&&e.city_code&&e.content&&e.content.length){var t=this,i=e;t.curCityCode=i.city_code,t.curDataTime=i.time,t.data=i.content,t.intervalTime=60*i.interval*1e3||t.intervalTime,t.addMarker(t.data)}}}),i.exports=BMap.TrafficEvent=o});
;define("common:widget/com/TrafficControl/TrafficControl.js",function(require,exports,module){var comMgr=require("common:widget/com/componentManager.js"),stat=require("common:widget/ui/stat/CodeStat.js"),config=require("common:widget/ui/config/config.js"),util=require("common:widget/ui/util/util.js"),indexUtil=require("common:widget/ui/indexUtil/IndexUtil.js"),constant=require("common:widget/ui/constant/Constant.js"),TrafficEvent=require("common:widget/ui/TrafficEvent/TrafficEvent.js"),Share=require("common:widget/ui/mapShare/MapShare.js"),traffic=require("common:widget/ui/Traffic/Traffic.js"),tools=require("common:widget/ui/tools/tools.js"),MapConfig=config.mapConfig,modelConfig=config.modelConfig,mapVersion=config.mapVersion;BMap.MapType.B_LiveTraffic_MAP={tileSize:256,baseUnits:256,zoomLevelMin:1,zoomLevelMax:modelConfig.highLevel,zoomLevelBase:18,errorUrl:"../images/blank.gif"/*tpa=http://webmap1.map.bdstatic.com/newmap/static/common/images/blank.gif*/,bounds:new BMap.Bounds(-21364736,-10616832,23855104,15859712),imgExtend:"png"},BMap.MapType.B_ForecastTraffic_MAP={tileSize:256,baseUnits:256,zoomLevelMin:1,zoomLevelMax:modelConfig.highLevel,zoomLevelBase:18,errorUrl:"../images/blank.gif"/*tpa=http://webmap1.map.bdstatic.com/newmap/static/common/images/blank.gif*/,bounds:new BMap.Bounds(-21364736,-10616832,23855104,15859712),imgExtend:"png"};var trafficEvent=null,TrafficControl=function(t){this.c_time="",this.c_mTime="",this.s_time="",this.t_time=Math.abs(this.s_time-this.c_time),this.s_nTime=this.c_mTime+this.t_time,this.ctrlName="trafficCtrl",this.opened=!1,this.anchorFixed=!0,this.defaultAnchor=BMAP_ANCHOR_TOP_RIGHT,this.defaultOffset=new BMap.Size(153,10),this.type="default",this.now="",this.timer=null,this.weeks=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],this.week=0,this.hour=0,this._opts=this._opts||{},this._opts=T.extend(this._opts,{offset:this.defaultOffset,panelOffset:new BMap.Size(this.defaultOffset.width-140,this.defaultOffset.height+20)}),this._hostUrl="http://its.map.baidu.com:8002/traffic/",this._mapType="",this._serverDate=null,this.markers=[],this.city={beijing:{bound:new BMap.Bounds(12913866,4790523,12997546,4875786),point:new BMap.Point(12959415.04,4825643.77)},shanghai:{bound:new BMap.Bounds(13498186,3622031,13562092,3665660),point:new BMap.Point(13525431,3642155)},guangzhou:{bound:new BMap.Bounds(12593673,2615833,12635768,2666103),point:new BMap.Point(12612023,2630443)},shenzhen:{bound:new BMap.Bounds(12669825,2550501,12708116,2575963),point:new BMap.Point(12689847,2569003)},changzhou:{bound:new BMap.Bounds(13346437,3697277,13363737,3729174),point:new BMap.Point(13355087,3713225)},chengdu:{bound:new BMap.Bounds(11575175,3557689,11597068,3577705),point:new BMap.Point(11586121,3567697)},dalian:{bound:new BMap.Bounds(13524453,4672572,13546187,4698377),point:new BMap.Point(13535320,4685474)},chongqing:{bound:new BMap.Bounds(11846022,3408422,11868701,3438052),point:new BMap.Point(11857361,3423237)},nanjing:{bound:new BMap.Bounds(13200780,3728111,13238145,3775676),point:new BMap.Point(13219462,3751893)},nanchang:{bound:new BMap.Bounds(12889546,3297160,12916003,3326234),point:new BMap.Point(12902774,3311697)},wuhan:{bound:new BMap.Bounds(12708207,3539507,12743013,3570727),point:new BMap.Point(12725610,3555117)},ningbo:{bound:new BMap.Bounds(13500417,3407873,13570391,3520223),point:new BMap.Point(13531068,3467898)},shijiazhuang:{bound:new BMap.Bounds(12713985,4521985,12779519,4633440),point:new BMap.Point(12747452,4560506)},fuzhou:{bound:new BMap.Bounds(13238273,2949121,13323037,3014655),point:new BMap.Point(13279676,2990970)},tianjin:{bound:new BMap.Bounds(12976129,4653057,13107199,4784127),point:new BMap.Point(13047484,4713850)},hangzhou:{bound:new BMap.Bounds(13303809,3473409,13434879,3543320),point:new BMap.Point(13379516,3510650)},changsha:{bound:new BMap.Bounds(12517377,3211265,12648447,3276799),point:new BMap.Point(12571580,3259258)},shenyang:{bound:new BMap.Bounds(13640488,5040407,13778686,5260307),point:new BMap.Point(13741087,5105461)},dongguan:{bound:new BMap.Bounds(12637460,2577205,12716534,2631795),point:new BMap.Point(12663327,2618165)},zhuhai:{bound:new BMap.Bounds(12594235,2494469,12648319,2546118),point:new BMap.Point(12641247,2526581)},changchun:{bound:new BMap.Bounds(13910374,5346573,14035474,5568925),point:new BMap.Point(13951071,5415349)},foshan:{bound:new BMap.Bounds(12527923,2583073,12623406,2654521),point:new BMap.Point(12593247,2618805)},jinhua:{bound:new BMap.Bounds(13277359,3325239,13417819,3420354),point:new BMap.Point(13319007,3367093)},qingdao:{bound:new BMap.Bounds(13306561,4217325,13443163,4424518),point:new BMap.Point(13401439,4288693)},taizhou:{bound:new BMap.Bounds(13397772,3281058,13528034,3389925),point:new BMap.Point(13516127,3312565)},wenzhou:{bound:new BMap.Bounds(13382089,3156335,13498397,3301503),point:new BMap.Point(13436255,3229621)},zhongshan:{bound:new BMap.Bounds(12598728,2520946,12641091,2583750),point:new BMap.Point(12623455,2559157)},quanzhou:{bound:new BMap.Bounds(13170808,2818778,13235817,2888153),point:new BMap.Point(13203295,2843829)},wulumuqi:{bound:new BMap.Bounds(9726341,5385226,9767988,5436822),point:new BMap.Point(9753695,5410741)},xiamen:{bound:new BMap.Bounds(13126255,2787468,13170840,2824780),point:new BMap.Point(13151071,2796469)},wuxi:{bound:new BMap.Bounds(13306180,3626438,13428685,3735369),point:new BMap.Point(13395231,3684085)},kunming:{bound:new BMap.Bounds(11374215,2783319,11541734,3047940),point:new BMap.Point(11457974,2915629)},suzhou:{bound:new BMap.Bounds(13350152,3580106,13513616,3745748),point:new BMap.Point(13431884,3662927)},nanning:{bound:new BMap.Bounds(11948706,2520265,12203744,2740475),point:new BMap.Point(12076225,2630370)},jinan:{bound:new BMap.Bounds(12938853,4280134,13108451,4489105),point:new BMap.Point(13023652,4384620)},xian:{bound:new BMap.Bounds(11981885,3964654,12226230,4105288),point:new BMap.Point(12104058,4034971)}},this.has_yc_citycode=["131","289","257","340","348","75","167","132","315","163","218","180","150","300","332","179","158","58","119","140","53","138","333","236","244","178","187","134","92","194","317","104","224","261","288","233"],this.time=18e4,this.tTime="",this.cNewTime="",this.smallHeight=73,this.forecastHeight=170,this.noforecastHeight=110,T.extend(this._opts,t||{}),this.setPanelOffset(this._opts.panelOffset),this.loadRes(),this.initialize()};T.inherits(TrafficControl,T.lang.Class,"TrafficControl"),T.extend(TrafficControl.prototype,{loadRes:function(){var t="#trafficBut{position:absolute;top:10px;width:71px;height:20px;background:url(http://webmap1.map.bdstatic.com/newmap/static/common/images/bgs_6dbfd12.gif) no-repeat -126px -309px;z-index:800;cursor:pointer}.tarffic_ss_con,.tarffic_yc_con{position:relative;width:124px;height:25px;color:#4d4d4d}.tarffic_ss_con .tarffic_ss,.tarffic_ss_con .tarffic_ss_over,.tarffic_ss_con .tarffic_yc,.tarffic_ss_con .tarffic_yc_over,.tarffic_yc_con .tarffic_ss,.tarffic_yc_con .tarffic_ss_over,.tarffic_yc_con .tarffic_yc,.tarffic_yc_con .tarffic_yc_over{position:absolute;top:0;width:62px;height:25px;line-height:25px;background:url(http://webmap2.map.bdstatic.com/newmap/static/common/images/traffic_btn_0c56bd0.png) no-repeat 0 0;cursor:pointer;text-align:center}.tarffic_ss_con .tarffic_ss,.tarffic_ss_con .tarffic_ss_over{left:0;z-index:1;font-weight:700}.tarffic_ss_con .tarffic_ss_over{background-position:0 -28px}.tarffic_ss_con .tarffic_yc,.tarffic_ss_con .tarffic_yc_over{width:63px;background-position:-62px 0;right:0}.tarffic_ss_con .tarffic_yc_over{z-index:2;background-position:-62px -28px}.tarffic_yc_con .tarffic_ss,.tarffic_yc_con .tarffic_ss_over{background-position:0 -56px;left:0}.tarffic_yc_con .tarffic_ss_over{z-index:2;background-position:0 -84px}.tarffic_yc_con .tarffic_yc,.tarffic_yc_con .tarffic_yc_over{width:63px;background-position:-62px -56px;right:0;font-weight:700;z-index:1}.tarffic_yc_con .tarffic_yc_over{background-position:-62px -84px}.traffic_Panel{}.traffic_title{padding:5px;border-bottom:#dadada solid 1px}.traffic_Panel .top{background:url(http://webmap1.map.bdstatic.com/newmap/static/common/images/tools_menu_3d43297.gif) no-repeat 130px -85px;font-weight:700}.traffic_Panel .info{margin-top:5px;height:20px}.traffic_Panel .info span{float:left;color:#666}.traffic_Panel .info a{float:right;color:#00f;text-decoration:none;line-height:15px;*line-height:18px}.traffic_Panel .info .update{width:13px;height:14px;background:url(http://webmap1.map.bdstatic.com/newmap/static/common/images/tools_menu_3d43297.gif) no-repeat -12px -18px;margin-left:5px;cursor:pointer}.traffic_Panel .info .update2{width:33px;height:14px;background:url(http://webmap1.map.bdstatic.com/newmap/static/common/images/tools_menu_3d43297.gif) no-repeat -64px -19px;margin-left:10px;cursor:pointer}.traffic_Panel .info .update1{width:33px;height:14px;background:url(http://webmap1.map.bdstatic.com/newmap/static/common/images/tools_menu_3d43297.gif) no-repeat -31px -19px;margin-left:10px;cursor:pointer}.traffic_Panel table{color:#6688ca;margin-top:5px}.traffic_Panel table span{padding:3px;cursor:pointer}.traffic_Panel table .on{background:#e6eff8}.traffic_Panel div.bar{width:9px;height:18px;background:url(http://webmap1.map.bdstatic.com/newmap/static/common/images/tools_menu_3d43297.gif) no-repeat 0 -32px;float:left;margin-top:0;cursor:pointer}.traffic_opacity img{*filter:alpha(opacity=70)}.traffic_Panel{-moz-user-select:none}.traffic_Panel .traffic_content{padding:5px;height:20px}.update_lbl,.update_time{float:left;color:#666}.traffic_content .update{float:left;width:13px;height:14px;background:url(http://webmap1.map.bdstatic.com/newmap/static/common/images/tools_menu_3d43297.gif) no-repeat -12px -18px;margin-left:5px;cursor:pointer}table.traffic_forecast{font-size:12px;display:none;color:#6688ca;margin:20px auto 5px;width:233px;*margin:0;*margin-top:25px;*margin-left:20px}tr.week_td_lbl{width:35px}td.week_td{width:23px}td.week_td span{padding:3px;cursor:pointer}td.time_lbl{height:42px;width:35px}td.time_lbl div{padding-top:16px;*padding-top:18px}.time_line_arrow{background:url(http://webmap2.map.bdstatic.com/newmap/static/common/images/bar_e549d13.gif) no-repeat 0 10px;width:193px;height:40px;overflow:hidden}.time_line_arrow .time_box{color:#68c;margin-left:74px;font-size:11px;overflow:hidden}.time_line_arrow_cont{height:34px}.time_line_arrow_cont .time_prev_btn{overflow:hidden;width:9px;height:9px;cursor:pointer;float:left;margin-top:5px}.time_line_arrow_cont .time_btn{width:8px;height:17px;background:url(http://webmap1.map.bdstatic.com/newmap/static/common/images/tools_menu_3d43297.gif) no-repeat 0 -33px;float:left;margin-top:0;cursor:pointer;margin-left:74px;_margin-left:42px;margin-top:0}.time_line_arrow_cont .time_next_btn{overflow:hidden;width:11px;*width:10px;height:9px;cursor:pointer;float:right;margin-top:5px}.forecast_info{text-align:center;color:#9a9a9a;display:none;float:left}.forecast_no_data{line-height:20px;padding:5px 10px;white-space:normal;color:gray;padding-right:3px;display:none}.traffic-legend-cont{top:10px;right:23px;position:absolute}.traffic-legend{color:#fff;padding:1px;border:0;margin-right:1px;*padding:2px}.level1{background-color:#b00}.level2{background-color:#f23030}.level3{background-color:#ff9f19}.level4{background-color:#17bf00}";require.loadCss({content:t,name:"TrafficControl"})},initialize:function(){try{this._map=map;var t=this;this.bind(),map.addEventListener("load",function(e){t.showMarker(e)}),map.addEventListener("moveend",function(e){t.showMarker(e)}),map.addEventListener("resize",function(e){t.showMarker(e)}),map.addEventListener("dragend",function(e){t.showMarker(e)}),map.addEventListener("zoomend",function(e){t.showMarker(e)}),map.addEventListener("maptypechange",function(){t.opened&&t._mapType&&map.mapType!=BMAP_PERSPECTIVE_MAP&&t.addTrafficLay(t._mapType,{fromMaptypeChange:!0})}),map.addEventListener("changehybirdmapmode",function(e){t.opened&&t.addTrafficLay(t._mapType,{fromMaptypeChange:e.isHybirdMapShow})})}catch(e){"undefined"!=typeof alog&&alog("http://webmap1.map.bdstatic.com/newmap/static/common/pkg/exception.fire","catch",{msg:e.message||e.description,path:"common:widget/com/TrafficControl/TrafficControl.js",ln:306})}},showMarker:function(t){var e=this;if(e.cNewTime=(new Date).getTime(),e._map){var i=e._map.getBounds(),n=null,a=0,o=map.getZoom();for(var s in e.city)i.containsBounds(e.city[s].bound)&&a++;for(var s in e.city)if(1>=a&&null!=i.intersects(e.city[s].bound)){n=s;break}o>5?(t.type.indexOf("zoom")>0&&e.ishide&&1==e.ishide&&(e.open(),e.ishide=0),e.removeMarker()):(t.type.indexOf("zoom")>0&&1==e.opened&&(e.ishide=1,e.addMarker()),e.close({type:"hide"})),e.adJustPanel()}},adJustPanel:function(){var t=T.g("tarffic_yc"),e=T.g("title_trafficCtrl"),i=this.pop?this.pop.main:null;map.getZoom()>9?t&&i&&(t.style.display="",e.style.cssText="",i.style.width="293px"):t&&i&&(this.switchInfo("default"),t.style.display="none",e.style.backgroundPosition="74px -76px",i.style.width="231px"),this.checkForecastCity("map")},bind:function(){var t=this;baidu("#tool_traffic").on("click",function(){t._toggle()})},_bindBtn:function(){var t=this;baidu("#tarffic_ss").on("click",function(){t.switchInfo("default")}),baidu("#tarffic_yc").on("click",function(){t.switchInfo("forecast")}),baidu("#bt_trafficCtrl").on("click",function(){t.setPanel(this)}),baidu("#bar_prev_trafficCtrl").on("click",function(){t.setBarBut("prev")}),baidu("#bar_next_trafficCtrl").on("click",function(){t.setBarBut("next")}),baidu("#forecast_trafficCtrl").delegate("span","click",function(){t.setWeek(this)})},setWeek:function(t){for(var e=0;7>e;e++)T.g("week_"+this.ctrlName+"_"+e).className="",T.g("week_"+this.ctrlName+"_"+e)==t&&(this.week=e,t.className="on",T.g("font_"+this.ctrlName).innerHTML="星期"+t.innerHTML+"&nbsp;",this.setForecast())},_genHtml:function(){var guid=this.ctrlName,weekName=["一","二","三","四","五","六","日"],template=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="traffic_Panel" onselectstart="return false">  <div class="traffic_title" id="title_',"undefined"==typeof guid?"":guid,'">    <div class="tarffic_ss_con" id="title_nav',"undefined"==typeof guid?"":guid,'">      <span class="tarffic_ss" id="tarffic_ss"  onmouseover="this.className=\'tarffic_ss_over\'" onmouseout="this.className=\'tarffic_ss\'" >实时路况</span>      <span class="tarffic_yc" id="tarffic_yc" onmouseover="this.className=\'tarffic_yc_over\'" onmouseout="this.className=\'tarffic_yc\'" >路况预测</span>    </div>          <div class="traffic-legend-cont">        <span class="traffic-legend level1">严重拥堵</span><span class="traffic-legend level2">拥挤</span><span class="traffic-legend level3">缓行</span><span class="traffic-legend level4">畅通</span>  </div></div><div class="traffic_content" >  <span id="font_',"undefined"==typeof guid?"":guid,'" class="update_lbl" >更新时间：&nbsp;</span><span id="time_',"undefined"==typeof guid?"":guid,'" class="update_time" ></span><span class="update" id="bt_trafficCtrl" title="更新" ></span>  <table id="forecast_trafficCtrl" class="traffic_forecast"  >    <tr class="week_tr">      <td  class="week_td_lbl" >星期</td>      ');for(var index=0;7>index;index++)_template_fun_array.push('        <td class="week_td">          <span id="week_',"undefined"==typeof guid?"":guid,"_","undefined"==typeof index?"":index,'" >',"undefined"==typeof weekName[index]?"":weekName[index],"</span>        </td>      ");_template_fun_array.push('    </tr>    <tr>      <td class="time_lbl"><div >时间</div></td>      <td class="time_line" colspan="7" style="188px">        <div class="time_line_arrow" >            <div><div id="timeBox_',"undefined"==typeof guid?"":guid,'" class="time_box" >12:00</div></div>            <div class="time_line_arrow_cont" >              <div id="bar_prev_',"undefined"==typeof guid?"":guid,'" class="time_prev_btn" ></div>              <div id="bar_',"undefined"==typeof guid?"":guid,'" class="time_btn" onmouseover="this.style.backgroundPosition=&#39;-9px -33px&#39;" onmouseout="this.style.backgroundPosition=&#39;0 -33px&#39;"></div>              <div id="bar_next_',"undefined"==typeof guid?"":guid,'" class="time_next_btn" ></div>          </div>      </div>    </td>    </tr>  </table><div class="forecast_info" id="info_',"undefined"==typeof guid?"":guid,'">（基于历史路况统计预测 仅供参考）</div><div class="forecast_no_data" id="no_city_',"undefined"==typeof guid?"":guid,'" ></div></div>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0];return template({guid:guid,weekName:weekName})},_launch:function(){var t=this;this._getTime(),t.trafficTimer&&clearInterval(t.trafficTimer),t.trafficTimer=setInterval(function(){t._getTime()},t.time),this.setBar(),this.setBarTime(12)},_getTime:function(){if("default"==this.type){var t=this;t.cTime=(new Date).getTime(),baidu.jsonp(t._hostUrl+"GetCurrentTime",function(e){t.getTime(e)}),setTimeout(function(){t._serverDate||t.getTime()},3e3)}},getTime:function(t){t||(t=(new Date).getTime()),this._serverDate=t,this.tTime=t-this.cTime,this.opened&&this.updateTime()},setPanel:function(t){return"update"==t.className?void this._getTime():void("update2"==t.className?(t.className="update1",T.g("forecast_"+this.ctrlName).style.display="none",T.g("info_"+this.ctrlName).style.display="none",T.g("no_city_"+this.ctrlName).style.display="none",this.pop.setHeight(this.getHeight())):(t.className="update2",T.g("forecast_"+this.ctrlName).style.display="block",T.g("info_"+this.ctrlName).style.display="block",this.pop.setHeight(this.forecastHeight)))},checkForecastCity:function(t){function e(){n.checkForecastCity()}var i=modelConfig.cityCode.toString(),n=this;if("forecast"==n.type){"map"!=t||window.hasBindTrafficMapEvent||(window.MC&&window.MC.addCallback(e),window.hasBindTrafficMapEvent=!0);var a=new Date(n.now).getDay(),o=T.g("title_nav"+n.ctrlName),s=T.g("font_"+n.ctrlName),r=n.curFStat;if(T.array.contains(this.has_yc_citycode,i)){if(("yc"!=r||"sw"==t)&&(n.pop.setHeight(this.forecastHeight),T.g("no_city_"+n.ctrlName).innerHTML="",T.g("forecast_"+n.ctrlName).style.display="block",T.g("info_"+n.ctrlName).style.display="block",o.className="tarffic_yc_con",s.innerHTML=n.weeks[a]+"&nbsp;",n.now)){var c=new Date(n.now);T.g("time_"+n.ctrlName).style.display="",T.g("time_"+n.ctrlName).innerHTML=c.getHours()+":00",n.setWeek(T.g("week_"+n.ctrlName+"_"+c.getDay()-1),!0),n.week=c.getDay()-1,n.hour=c.getHours(),n.setForecast()}n.curFStat="yc"}else{if(("lj"!=r||"sw"==t)&&(n.pop.setHeight(n.getHeight(r,t)),T.g("no_city_"+n.ctrlName).style.display="block",T.g("no_city_"+n.ctrlName).innerHTML="正在累积历史路况，路况预测暂未开启，敬请期待。",T.g("forecast_"+n.ctrlName).style.display="none",T.g("info_"+n.ctrlName).style.display="none",o.className="tarffic_yc_con",s.innerHTML="",n.now)){var c=new Date(n.now);T.g("time_"+n.ctrlName).innerHTML="",n.setWeek(T.g("week_"+n.ctrlName+"_"+c.getDay()-1),!0),n.week=c.getDay()-1,n.hour=c.getHours(),n.setForecast()}n.curFStat="lj"}}},switchInfo:function(t){if(this.type!=t){var e=T.g("title_nav"+this.ctrlName),i=(T.g("title_"+this.ctrlName),T.g("font_"+this.ctrlName)),n=T.g("bt_"+this.ctrlName),a=T.g("bt_"+this.ctrlName);"forecast"==t?(this.type="forecast",n.style.display="none",this.preCityCode=null,this.checkForecastCity("sw"),this.setBarTime(this.hour),trafficEvent.close(),a.className="update2"):(this.type="default",n.style.display="",this._getTime(),T.g("forecast_"+this.ctrlName).style.display="none",T.g("no_city_"+this.ctrlName).style.display="none",T.g("info_"+this.ctrlName).style.display="none",T.g("time_"+this.ctrlName).style.display="",T.g("time_"+this.ctrlName).innerHTML="",this.pop.setHeight(this.getHeight()),e.className="tarffic_ss_con",i.innerHTML="更新时间：&nbsp;",a.className="update",this.addTrafficLay("B_LiveTraffic_MAP"),trafficEvent.open())}},addTrafficLay:function(e,i){this.currentTrafficLay&&map.removeTileLayer(this.currentTrafficLay);var n=this;n._mapType=e,n.cNewTime=(new Date).getTime();var a=new BMap.TileLayer({mapType:e,transparentPng:!0});a.zIndex=1,a.getTilesUrl=function(a,o){var s=BMap.MapType[this.mapType];if("object"!=typeof s)return null;var r=s.baseUnits*Math.pow(2,18-o),c=parseInt(a.lng/r),p=parseInt(a.lat/r),f=(Math.floor(c/200),Math.floor(p/200),"../images/transparent.gif"/*tpa=http://webmap1.map.bdstatic.com/newmap/static/common/images/transparent.gif*/);if(6>o)return f;var d=n.cNewTime+n.tTime;if(1==isNaN(d)&&(d=(new Date).getTime()),f=n._hostUrl+"TrafficTileService?level="+o+"&x="+c+"&y="+p+"&time="+d,"B_ForecastTraffic_MAP"==e){if(t=(new Date).getTime(),-1==n.week){var l=[6,0,1,2,3,4,5];n.week=l[(new Date).getDay()]}f=n._hostUrl+"HistoryService?level="+o+"&x="+c+"&y="+p+"&day="+n.week+"&hour="+n.hour+"&t="+t}return map.mapType===BMAP_SATELLITE_MAP&&(f+="&style=weixing"),map.mapType===BMAP_NORMAL_MAP?(f+="&label=web2D&v=",f+=mapVersion&&mapVersion.normalTraffic?mapVersion.normalTraffic:"013"):(i&&i.fromMaptypeChange||!i&&map._isHybirdShow)&&(f+="&label=webSate&v=",f+=mapVersion&&mapVersion.satelliteTraffic?mapVersion.satelliteTraffic:"013"),f=f.replace(/-(\d+)/gi,"M$1")},map.addTileLayer(a),this.currentTrafficLay=a},clearTrafficLay:function(){this.currentTrafficLay&&map.removeTileLayer(this.currentTrafficLay)},setMarker:function(){var t=this,e=new BMap.Icon("../../../../../webmap0.map.bdstatic.com/newmap/static/common/images/traffic_af05714.png"/*tpa=http://webmap0.map.bdstatic.com/newmap/static/common/images/traffic_af05714.png*/,new BMap.Size(28,35),{offset:new BMap.Size(6,35)});for(var i in t.city){var n=t.city[i].point;t._map.config.coordType==BMAP_COORD_LNGLAT&&(n=BMap.Project.convertMC2LL(n)),t.markers||(t.markers=[]);var a=new BMap.Marker(n,{icon:e});a.cityName=i,t.markers.push(a)}},addMarker:function(){var t=this,e=t.markers;for(var i in e)null==e[i].domElement&&(e[i].addEventListener("click",function(){var e=this.cityName||"";t._map&&t._map.centerAndZoom(this.point,11),t.open({cityName:e})}),t._map.addOverlay(e[i]),e[i].domElement.setAttribute("type","system"),e[i].siblingElement.setAttribute("type","system"),e[i].domElement.title="点击查看交通路况"),e[i].show()},removeMarker:function(){var t=this.markers;try{for(var e in t)t[e].hide(),this._map.removeOverlay(t[e])}catch(i){}},updateTime:function(){var t=this._serverDate,e=new Date(t),i=new Date,n=e.getHours()||i.getHours(),a=e.getMinutes()||i.getMinutes(),o=10>n?"0"+n:n,s=10>a?"0"+a:a;T.g("time_"+this.ctrlName).innerHTML=o+":"+s,e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes(),t&&t>this.now&&(this.now=t,this.updateTile())},updateTile:function(){this.addTrafficLay("B_LiveTraffic_MAP")},_getCityCode:function(){{var t=this._map.getCenter();this._map.getZoom()}this._map.config.coordType==BMAP_COORD_LNGLAT&&(t=BMap.Project.convertLL2MC(t))},setBar:function(){function t(){T.on(document,"onmousemove",e),T.on(document,"onmouseup",i)}function e(t){var e=t.clientX||t.x,i=T.dom.getPosition(T.g("bar_prev_"+n.ctrlName)).left+9,o=e-i-4;0>o&&(o=0),o>165&&(o=165),a.style.marginLeft=T.browser.ie<=6&&T.browser.ie>0?.53*o+"px":o+"px",T.g("timeBox_"+n.ctrlName).style.marginLeft=o+"px",n.setTimeBox()}function i(){T.un(document,"onmousemove",e),T.un(document,"onmouseup",i),n.setForecast()}var n=this,a=T.g("bar_"+this.ctrlName);T.on(a,"onmousedown",t)},setBarTime:function(t){0>t&&(t=0),t>24&&(t=24),this.hour=t;var e=6.875*t;T.g("timeBox_"+this.ctrlName).style.marginLeft=e+"px";var i=T.g("bar_"+this.ctrlName);i.style.marginLeft=T.browser.ie<=6&&T.browser.ie>0?.53*e+"px":e+"px",this.setTimeBox()},setTimeBox:function(){var t=modelConfig.cityCode.toString(),e=T.g("timeBox_"+this.ctrlName),i=T.g("time_"+this.ctrlName),n=parseInt(e.style.marginLeft),a=Math.ceil(24*(n-4)/165);this.hour=a,10>a&&(a="0"+a),i.innerHTML=T.array.contains(this.has_yc_citycode,t)?e.innerHTML=a+":00":""},setBarBut:function(t){var e=T.g("timeBox_"+this.ctrlName),i=parseInt(e.style.marginLeft),n=Math.ceil(24*(i-4)/165);this.setBarTime("next"==t?n+1:n-1),this.setForecast()},setForecast:function(){var t=this.hour;24==t&&(t=0);BMap.MapType.B_ForecastTraffic_MAP,BMap.MapType.B_LiveTraffic_MAP;this.addTrafficLay("B_ForecastTraffic_MAP")},setPanelOffset:function(t){t&&"Size"==t.toString()&&(this._opts.panelOffset=new BMap.Size(t.width,t.height),this.pop&&this.pop.getDom()&&(this.pop.getDom().style.right=t.width+"px",this.pop.getDom().style.top=t.height+"px"))},open:function(t){var t=t||{},e=t.cityName||"",i=window,n=this;this.opened||(this.opened=!0,T.g("tool_traffic")._opened=!0,T.g("tool_traffic").className.indexOf("span_focus")<0&&T.ac(T.g("tool_traffic"),"span_focus"),trafficEvent||(trafficEvent=new TrafficEvent),trafficEvent.open({cityName:e}),i.searchInViewCtrl&&i.searchInViewCtrl.exit(),n.setMarker(),this.showPop(),Share.setParam("tfc",1),addStat("indextool.toolbar.trffic"))},close:function(t){{var t=t||{};t.type||""}this.opened&&(this._serverDate=null,this.opened=!1,this.now="",this.type="default",this.pop.close(),this.trafficTimer&&clearInterval(this.trafficTimer),this.clearTrafficLay(),trafficEvent&&trafficEvent.opened&&trafficEvent.close(),T.g("tool_traffic")._opened=!1,T.rc(T.g("tool_traffic"),"span_focus"),Share.setParam("tfc"))},hide:function(){T.g("tool_traffic").style.display="none",tools.resetWidth(),1==this.opened&&this.pop.hide(),trafficEvent&&trafficEvent.opened&&trafficEvent.hide()},show:function(){traffic.need2ShowTraffic()&&(T.g("tool_traffic").style.display="",tools.resetWidth(),1==this.opened&&this.pop.show())},_toggle:function(){this.opened?this.close({type:"btnClose"}):this.open({type:"btnOpen"})},showPop:function(){var t=this,e={height:this.getHeight(),width:295,addDom:"tool_container_con",clickClose:!1,isTitle:!1,close:function(){t.close({type:"popClose"})}};require.async("common:widget/ui/Popup/Popup.js",function(i){var n=t.pop=new i(e);n.render(),n.hide(),n.content.innerHTML=t._genHtml(),n.getDom().style.right="125px",n.getDom().style.top="29px",n.getDom()._anchor=t.defaultAnchor,n.getDom()._offset=t._opts.panelOffset,n.getDom().onclick=function(t){t=t||window.event,util.stopBubble(t)},n.show(),t.adJustPanel();var a=T.g("popup_close");a.onmouseup=function(){if(t.markers){mks=t.markers;for(var e in mks)mks[e].remove()}t.markers=null},t._launch(),t._bindBtn()}),this.getHeight()},getHeight:function(){var t=modelConfig.cityCode.toString(),e=this.smallHeight;return"default"http://webmap1.map.bdstatic.com/newmap/static/common/pkg/==this.type?e=this.smallHeight:"forecast"==this.type&&(e=T.array.contains(this.has_yc_citycode,t)?this.forecastHeight:this.noforecastHeight),e}}),module.exports=BMap.TrafficControl=TrafficControl});