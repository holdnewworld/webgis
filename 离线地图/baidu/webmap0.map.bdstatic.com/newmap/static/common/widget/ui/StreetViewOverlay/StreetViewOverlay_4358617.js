define("common:widget/ui/StreetViewOverlay/StreetViewOverlay.js",function(t,i,e){function o(t,i,e){0!=i.indexOf("on")&&(i="on"+i);var o=new baidu.lang.Event(i);if(e)for(var n in e)o[n]=e[n];t.dispatchEvent(o)}var n=t("common:widget/ui/util/util.js"),s=t("common:widget/ui/PanoService/PanoService.js"),a=t("common:widget/ui/config/config.js"),r=function(t,i){t&&t instanceof BMap.Point&&(this._map=null,this._position=t,this._container=null,this._size=null,this.enableMove=!0,this.hasContent=!1,i=i||{},this._opts=baidu.extend(baidu.extend(this._opts||{},{enableDragging:!1,enableMassClear:!1,anchor:new BMap.Size(0,0)}),i),this.PANO_IMG="url(http://webmap1.map.bdstatic.com/newmap/static/common/images/panorama/pano_markers_1f7469f.png)",this.PANO_IMG_PNG8="url(http://webmap0.map.bdstatic.com/newmap/static/common/images/panorama/pano_markers_png8_17354c0.png)",this.PANO_OFFSET_ICON=["-408px -72px","-384px -72px","-432px -72px"],this.PANO_OFFSET=[25,42],this.MOVE_DIRECT={LEFT:0,MIDDLE:1,RIGHT:2},this.preX=0,this.preY=0,this.BUBBLE_IMG="url(http://webmap0.map.bdstatic.com/newmap/static/common/images/street_overview_04ceb33.gif)",this.BUBBLE_OFFSET=[[0,0],[75,75],[0,165],[-75,75]],this.BUBBLE_CLS=[{width:112,height:122,backgroundPosition:"-2px -2px",_margin:"3px 0px 0 3px",_txtMargin:"auto",_ie6Margin:"5px 3px 3px 3px"},{width:125,height:112,backgroundPosition:"-2px -135px",_margin:"3px 0px 0 16px",_txtMargin:"auto auto auto 17px",_ie6Margin:"5px 3px 3px 17px"},{width:112,height:122,backgroundPosition:"-122px -2px",_margin:"15px 3px 0 3px",_txtMargin:"auto",_ie6Margin:"17px 3px 3px 3px"},{width:122,height:112,backgroundPosition:"-133px -133px",_margin:"3px 17px 0 3px",_txtMargin:"auto 3px",_ie6Margin:"5px 16px 3px 3px"}],this.defPos=new BMap.Pixel(0,0),this.defStatus=0,this.preDirect=1,this.imgSize=75,this.defImg="../../../../../../../webmap1.map.bdstatic.com/newmap/static/common/images/streetview_no_b14ce20.png"/*tpa=http://webmap1.map.bdstatic.com/newmap/static/common/images/streetview_no_b14ce20.png*/)};r.prototype=new BMap.Overlay,r.prototype.initialize=function(t){try{var i=this,e=i._container=document.createElement("div");return i._map=t,baidu.extend(e.style,{zIndex:99999,background:"#FFF",cursor:"pointer"}),i._setOverlayContent(),i._getContainerSize(),e}catch(o){"undefined"!=typeof alog&&alog("http://webmap0.map.bdstatic.com/newmap/static/common/widget/ui/StreetViewOverlay/exception.fire","catch",{msg:o.message||o.description,path:"common:widget/ui/StreetViewOverlay/StreetViewOverlay.js",ln:186})}},r.prototype.draw=function(t){var i=this._map,e=this._opts.anchor,o=i.pointToOverlayPixel(this._position);this._container.style.left=o.x+e.width+"px",this._container.style.top=o.y+e.height+"px",this._drawPano(o),this._drawBubble(o,t)},r.prototype.enable=function(){this.enableMove=!0},r.prototype.disable=function(){this.enableMove=!1},r.prototype.hideBubble=function(){this.bubble.style.display="none"},r.prototype.showBubble=function(){this.bubble.style.display="block"},r.prototype.hidePanoCursor=function(){this.panoCursor.style.display="none"},r.prototype.showPanoCursor=function(){this.panoCursor.style.display="block"},r.prototype.miniful=function(t){t?(this.bubble.style.visibility="hidden",this.panoCursor.style.visibility="hidden",this.panoCursor.style.height="10px"):(this.panoCursor.style.height="40px",this.bubble.style.visibility="",this.panoCursor.style.visibility=""),this.isMiniful=t?!0:!1},r.prototype.enableDragging=function(){this._opts.enableDragging=!0},r.prototype.disableDragging=function(){this._opts.enableDragging=!1},r.prototype.isDraggable=function(){return this._opts.enableDragging},r.prototype.getPosition=function(){return this._position},r.prototype.setPosition=function(t,i,e){!t instanceof BMap.Point||(this._position=t,this._pixel=i,this.draw(e),!e&&this._getPanoInfo(t,e))},r.prototype._getContainerSize=function(){if(this._container){var t=this._container.offsetHeight,i=this._container.offsetWidth;this._size=new BMap.Size(i,t)}},r.prototype.remove=function(){o(this,"onremove"),this._container&&n.purgeEvents(this._container),this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._reset()},r.prototype._setOverlayContent=function(){var t=this.panoCursor=document.createElement("div"),i=this.bubble=document.createElement("div"),e=this.bubImgHolder=document.createElement("div"),o=this.bubbleImg=document.createElement("img"),n=this.bubbleTxt=document.createElement("div"),s=baidu.browser.ie<7?this.PANO_IMG_PNG8:this.PANO_IMG;baidu.extend(t.style,{position:"absolute",backgroundImage:s,backgroundRepeat:"no-repeat",backgroundPosition:"-384px -72px",cursor:"pointer",width:"24px",height:"40px"}),baidu.extend(i.style,{position:"absolute",backgroundImage:this.BUBBLE_IMG,backgroundRepeat:"no-repeat",overflow:"hidden",padding:"3px",zoom:1}),baidu.extend(o.style,{width:"100px",height:"75px"}),baidu.extend(n.style,{width:"100px",height:"19px",lineHeight:"19px",overflow:"hidden",font:"13px '宋体'"}),e.appendChild(o),i.appendChild(e),i.appendChild(n),this._container.appendChild(t),this._container.appendChild(i),this._map.getPanes().labelPane.appendChild(this._container);var a=this.tipDom=document.createElement("div");a.innerHTML='<div class="tip_cont">右键关闭全景模式</div>',baidu.extend(a.style,{border:"1px solid #dbb051",color:"#666",backgroundColor:"#fcfef1",position:"absolute",textAlign:"center",padding:"0 10px",height:"22px",lineHeight:"22px",top:"40px",left:"30px",whiteSpace:"nowrap"}),t.appendChild(a),this._bindEvents(),this.autoHideTipTimer=setTimeout(function(){},5e3)},r.prototype._bindEvents=function(){var t=this,i=(this.bubbleMask,this.bubbleImg),e=this.bubbleTxt;i.src=this.defImg,baidu.on(i,"onload",function(){}),baidu.on(i,"onerror",function(){e.innerHTML="暂无数据",i.src=t.defImg})},r.prototype._drawPano=function(t){var i=this.panoCursor,e=i.clientWidth,o=i.clientHeight,n=t.x-parseInt(e/2),s=t.y-o;i.style.left=n+"px",i.style.top=s+"px",this._setDirectIcon(t)},r.prototype._drawBubble=function(t,i){var e=this.getBubbleStatus(t);if(-1==e)return void(this.bubble.style.display="none");switch(this.isMiniful&&!this.hasContent&&(this.bubble.style.visibility="hidden"),e){case 0:this.tipDom.style.left="40px",this.tipDom.style.top="30px";break;case 1:this.tipDom.style.left="0px",this.tipDom.style.top="70px";break;case 2:this.tipDom.style.left="40px",this.tipDom.style.top="10px";break;case 3:this.tipDom.style.left="-80px",this.tipDom.style.top="70px"}this._setBubble(t,e,i)},r.prototype._setBubble=function(t,i,e){this.bubble.style.display="block";var o=this._getBubPos(t,i,e),n=this.BUBBLE_CLS[i];baidu.setStyles(this.bubble,{width:n.width+"px",height:n.height+"px",backgroundPosition:n.backgroundPosition,left:o.x+"px",top:o.y+"px"}),this.bubImgHolder.style.margin=baidu.browser.ie<=7?n._ie6Margin:n._margin,this.bubbleTxt.style.margin=n._txtMargin},r.prototype.getBubbleStatus=function(t){{var i,e,o,n,s,a,r,p=this._getMapSize(),h=0,l=0,u=p.width,b=p.height;map.getSize()}return i=this._pixel?this._pixel.x:t.x+h,e=this._pixel?this._pixel.y:t.y+l,o=Math.abs(i-h),n=Math.abs(u-i),s=Math.abs(e-l),a=Math.abs(b-e),r=2,r=o>60&&n>60&&s>160?0:o>60&&n>60&&a>160&&160>s?2:n>150&&s>80&&a>80?1:o>160&&60>n&&a>60?3:-1},r.prototype._setDirectIcon=function(t){{var i=t.x,e=t.y,o=1,n=i-this.preX;e-this.preY}Math.abs(n)>0&&(this.preX>1&&0>n?o=this.MOVE_DIRECT.LEFT:this.preX>1&&n>0&&(o=this.MOVE_DIRECT.RIGHT),this.preDirect!=o&&(this.panoCursor.style.backgroundPosition=this.PANO_OFFSET_ICON[o]),this.preX=i,this.preY=e,this.preDirect=o)},r.prototype._setDefDirect=function(){this.panoCursor.style.backgroundPosition=this.PANO_OFFSET_ICON[1]},r.prototype._getPanoInfo=function(t,i){var e=this;this.dragTimer&&window.clearTimeout(this.dragTimer),this.dragTimer=window.setTimeout(function(){e._setDefDirect(),s.getStreetBriefByLocationMove({point:t,level:e._map.getZoom(),from:"mapmove"},function(t){if(window.streetViewTool.isOpen){var o=t.content;if(!o)return void this.hide();this.show(),this.enableMove&&this.draw(i),this.enableMove&&e._setBubInfo(o),this.isMiniful&&(t.content&&t.content.rname?(this.bubble.style.visibility="",this.hasContent=!0):(this.bubble.style.visibility="hidden",this.hasContent=!1))}},e)},200)},r.prototype._setBubInfo=function(t){var i=t.panoImg,e=t.rname;e=baidu.string.getByteLength(e)>15?baidu.string.subByte(e,12)+"...":e,this.bubbleImg.src=i?i:this.defImg,this.bubbleTxt.innerHTML=e||"未知道路"},r.prototype._getBubPos=function(t,i,e){var o=this.BUBBLE_CLS[i],n=this.BUBBLE_OFFSET[i],s=(this.panoCursor.clientWidth,this.panoCursor.clientHeight),a=parseInt(o.width/2),r=parseInt(o.height),p=t.x-a+n[0],h=t.y-r-s+n[1];if(e){var l=[[-55,-135],[15,-55],[-55,13],[-140,-55]];return{x:t.x+l[i][0],y:t.y+l[i][1]}}return{x:p,y:h}},r.prototype.enableIndoorOverlay=function(t,i,e){function o(t,i,e,o){function s(t,i){var e="http://pcsv0.map.bdimg.com/scape/?udt=201400606&qt=idata&iid="+t;baidu.jsonp(e,function(t){var e=t.content[0].interinfo,o=null,n="",s="",r="";if(e&&e.Floors.length>0){for(var p=e.Floors.length-1;p>=0;p--)e.Floors[p].Floor==e.Defaultfloor&&(o=e.Floors[p].Points[0]);o&&(n=o.PID,s=o.movedir,r=0)}var h=a.urlConfig.PANO_3DIMAGE_URL+"/?qt=pr3d&fovy=75&quality=80&panoid="+n+"&heading="+s+"&pitch="+r+"&width=100&height=75";i(h)},{cbtype:"fn"})}var r=o.pointToPixel(t);return r.x+=350,r.y+=110,n.setPosition(t,r,!0),"d270a38b230b50fced74f8f7"==i?void(n.enableMove||n._setBubInfo({panoImg:"../../../../../../photoTureDataRequest/main.png"/*tpa=http://webmap0.map.bdstatic.com/photoTureDataRequest/main.png*/,rname:"故宫照片游"})):void s(i,function(t){n.enableMove||n._setBubInfo({panoImg:t,rname:e})})}this.disable(),this.hidePanoCursor();var n=this;o(t,i,e,this._map)},r.prototype.disableIndoorOverlay=function(){this.enable(),this.showPanoCursor()},r.prototype._getMapSize=function(){var t=this._map.getContainer(),i=T.dom.getPosition(t),e=t.clientWidth,o=t.clientHeight;return{left:i.left,top:i.top,right:i.left+e,bottom:i.top+o,width:e,height:o}},r.prototype._reset=function(){this._setDefDirect(),this._setBubble(this.defPos,this.defStatus),this.bubbleTxt.innerHTML="正在加载中...",this.bubbleImg.src=this.defImg,this.preX=0,this.preY=0},e.exports=r});