define("common:widget/com/NavTrans/NavMap.js",function(t,i,e){function n(t){T.lang.Class.call(this),T.object.extend(this,t),this.ajax=new T.Ajax,this.ajax.async=!0,this.currentCity=h.cityCode,this.queryObj=[],this.popWins=[],this.popPois=[],this.tipLabel=s.createDrvMidLabel("拖动以更改路线"),this.noName="未知路段",this.maxDragVia=10,this.exportOverlays={drRoutes:[],destMarkers:[],markers:[]},TPM.state="nav",TPM.reset()}var a=t("common:widget/com/componentManager.js"),o=t("common:widget/ui/util/util.js"),s=t("common:widget/ui/mapUtil/mapUtil.js"),r=t("common:widget/ui/transUtil/transUtil.js"),d=t("common:widget/ui/transInfoWindow/transInfoWindow.js"),p=t("common:widget/ui/constant/Constant.js"),g=t("common:widget/ui/config/config.js"),u=t("common:widget/ui/PanoEntranceUtil/PanoEntranceUtil.js"),h=g.modelConfig,l=g.mapConfig,c=t("common:widget/ui/mapShare/MapShare.js");T.inherits(n,T.lang.Class,"NavMap"),T.object.extend(n.prototype,{drawLines:function(){var t=this;if(map.clearOverlays(),!t.total||0==t.total){t.dragPoints.push({p:t.start.pt,n:t.start.wd});var i=s.addDestPoi(t.start.pt,"",p.DEST_START);return i.enableDragging(),i.addEventListener("dragging",function(i){t.addViaRoute2(i,1)}),i.addEventListener("mouseover",function(i){t.onViaPoiOver(i,1)}),i.addEventListener("mouseout",function(i){t.onRemoveTips(i,1)}),i.addEventListener("dragend",function(i){t.addViaPoi3(i,1)}),i.index=0,window.startPoi=i,t.dragPoints.push({p:t.end.pt,n:t.end.wd}),i=s.addDestPoi(t.end.pt,"",p.DEST_END),i.addEventListener("dragging",function(i){t.addViaRoute2(i,2)}),i.addEventListener("mouseover",function(i){t.onViaPoiOver(i,2)}),i.addEventListener("mouseout",function(i){t.onRemoveTips(i,2)}),i.addEventListener("dragend",function(i){t.addViaPoi3(i,2)}),i.index=1,i.enableDragging(),void(window.endPoi=i)}this.sended=0,this.addDrPoi(),s.addDrRoute(!1,this,this.cinfo?this.cinfo.fromBdyx:!1),this.exportOverlays.drRoutes.push({flag:!1,obj:this}),this._bindTPM()},unload:function(){this.routePoints=[],this.queryObj=[],this.dragPoints=[]},addDrPoi:function(){for(var i=this.dragPoints,e=i.length,n=this,a=0,r=this.waypoints,d=0;e>d;d++){var g;if(0==d)g=s.addDestPoi(this.start.pt,"",p.DEST_START),this.exportOverlays.destMarkers.push({point:this.start.pt,text:"",type:p.DEST_START}),g.addEventListener("dragging",function(t){n.addViaRoute2(t,1)}),g.addEventListener("mouseover",function(t){n.onViaPoiOver(t,1)}),g.addEventListener("mouseout",function(t){n.onRemoveTips(t,1)}),g.addEventListener("dragend",function(t){n.addViaPoi3(t,1)}),window.startPoi=g;else if(d==e-1)g=s.addDestPoi(this.end.pt,"",p.DEST_END),this.exportOverlays.destMarkers.push({point:this.end.pt,text:"",type:p.DEST_END}),g.addEventListener("dragging",function(t){n.addViaRoute2(t,2)}),g.addEventListener("mouseover",function(t){n.onViaPoiOver(t,2)}),g.addEventListener("mouseout",function(t){n.onRemoveTips(t,2)}),g.addEventListener("dragend",function(t){n.addViaPoi3(t,2)}),window.endPoi=g;else if(d>0&&e-1>d){var u=new BMap.Icon("../../../../../../../webmap2.map.bdstatic.com/newmap/static/common/images/drv_m_234b1a3.png"/*tpa=http://webmap2.map.bdstatic.com/newmap/static/common/images/drv_m_234b1a3.png*/,p.MARKER_11_11_SIZE,{offset:p.MARKER_11_11_OFFSET,infoWindowOffset:p.MARKER_11_11_INFOWND_OFFSET}),h=o.getPoiPoint(i[d].p),c=!1;if(r&&r[d-1].if_wp&&(c=!0),c){var v,m=r[d-1],f={point:o.getPoiPoint(this.endArray[d-1].pt),query:m.wd,addr:m.sug,uid:this.endArray[d-1].uid},P=T.extend({},f);TPM.insertTP(a,P),P.point||(P.point=h),TPM.tpListInMap.push(f),v=!f.query,f.rPoint=h,f.query=v?i[d].n:f.query,g=TPM.createMarkerByTp(f,a),g.addEventListener("mouseover",function(t){n.onViaPoiOver(t,0)}),g.addEventListener("mouseout",function(t){n.onRemoveTips(t,0)}),this.exportOverlays.markers.push({point:f.point,icon:new BMap.Icon("../../../../../../../webmap2.map.bdstatic.com/newmap/static/common/images/tpicon_ea18b98.png"/*tpa=http://webmap2.map.bdstatic.com/newmap/static/common/images/tpicon_ea18b98.png*/,new BMap.Size(36,36),{imageOffset:new BMap.Size(-62-36*a,0)}),title:f.query}),f.query=v?"":f.query,i[d].tp=f,a++}else g=new BMap.Marker(h,{icon:u}),this.exportOverlays.markers.push({point:h,icon:u}),function(){var i=d;g.addEventListener("domready",function(){var e=this;t.async("common:widget/ui/contextMenu/ContextMenu.js",function(t){e.viaContext=t.create([{text:"删除该点",callback:n.delContext(i),width:60}],e.getDom(),"pointer")})})}(),map.addOverlay(g),g.enableDragging(),g.addEventListener("mouseover",function(t){n.onViaPoiOver(t,0)}),g.addEventListener("mouseout",function(t){n.onRemoveTips(t,0)});g._stCode=p.OVERLAY_STYLE.DRV_M_MKR,g.addEventListener("dragging",function(t){n.addViaRoute2(t,0)}),g.addEventListener("dragend",function(t){n.addViaPoi3(t,0)})}this.dragPois||(this.dragPois=[]),g.addEventListener("dragstart",function(t){n.dragViaPoi(t)}),l.navTrans.enableDragging&&g.enableDragging(),g.index=d,this.dragPois.push(g)}},_bindTPM:function(){var t=this;TPM.afterAddByPoint=function(i){var e=t.dragPoints,n=e[e.length-1];e.push(n),e[e.length-2]={p:i.tp.point.lng+","+i.tp.point.lat,n:i.tp.query,tp:i.tp},t.buildQuery(!0,8)},TPM.onDeleteTp=function(i){for(var e,n=t.dragPoints,a=0;e=n[a];a++)if(i.tp&&e.p==i.tp.rPoint.lng+","+i.tp.rPoint.lat){t.delVia(a,8);break}}},delContext:function(t){var i=this;return function(){i.delVia(t)}},onRouteOver:function(t){if(l.navTrans.enableDragging&&!(this.dragPoints&&this.dragPoints.length>=this.maxDragVia+2)){var i=t.target,e=map.pointToPixel(i.getPoints()[0]),n=map.pointToPixel(i.getPoints()[i.getPoints().length-1]);if(!(r.getDistanceByPixel(t.pixel,e)<=20||r.getDistanceByPixel(t.pixel,n)<=20)){var a=this,o=t.point||t.domEvent.point;if(!this.dragVia&&o)this.dragVia=s.addDestPoi(o,"",p.DEST_MIDDLE),this.dragVia.viaName="",this.dragVia.dis="",this.dragVia.setTop(!0),this.dragVia.setLabel(this.tipLabel),this.dragVia.addEventListener("dragstart",function(t){a.dragViaPoi(t)}),this.dragVia.addEventListener("dragging",function(t){a.addViaRoute(t)}),this.dragVia.addEventListener("dragend",function(t){a.addViaPoi(t)});else if(this.dragVia&&o){var d=!0;d?(this.dragVia.setPoint(t.point),this.dragVia.show(),this.dragVia.setLabel(this.tipLabel)):this.dragVia.hide()}this.draging||(this.dragIndex=t.target.index,this.tempDrag=[window.dropRoutes[this.dragIndex]])}}},onRouteMove:function(t){this.distime&&(window.clearTimeout(this.distime),this.distime=null);var i=t.target,e=map.pointToPixel(i.getPoints()[0]),n=map.pointToPixel(i.getPoints()[i.getPoints().length-1]);if(r.getDistanceByPixel(t.pixel,e)<=20||r.getDistanceByPixel(t.pixel,n)<=20)return void(this.dragVia&&this.dragVia.hide());if(this.dragVia){var a=!0;a?(this.dragVia.setPoint(t.point),this.dragVia.show(),this.dragVia.setLabel(this.tipLabel)):this.dragVia.hide()}},onRemoveTips:function(){this.tipLabel&&map.removeOverlay(this.tipLabel);var t=this;t.dragVia&&t.dragVia.hide()},removeTimer:function(){this.distime&&(window.clearTimeout(this.distime),this.distime=null)},dragViaPoi:function(t){var i=this;i.dateStart=(new Date).getTime(),i.removeTimer(t)},onViaPoiOver:function(t,i){if(!this.draging&&window.dropRoutes){var e=t.target.index;switch(i){case 0:this.tempDrag=[window.dropRoutes[e-1],window.dropRoutes[e]];break;case 1:this.tempDrag=[window.dropRoutes[e]];break;case 2:this.tempDrag=[window.dropRoutes[e-1]]}}l.navTrans.enableDragging&&t.target.setLabel(this.tipLabel)},removeDraw:function(){var t=this;if(t.tempDrag&&t.tempDrag.length>0)for(var i=0;i<t.tempDrag.length;i++){var e=t.tempDrag[i];e&&s.removeRoute(e)}},addViaPoi:function(t){var i=this;if(i.ajax.duration=1,!(i.dragVia&&i.dragPoints&&i.dragPoints.length>=i.maxDragVia+2)){i.ajax.onsuccess=null,i.onRouteOut(t);var e=this.dragIndex;if(i.queryObj&&i.queryObj.length){var n=i.queryObj[i.queryObj.length-1],o=i.dragVia.point.lng+","+i.dragVia.point.lat;if(n.flag&&1==n.flag&&n.dragpt){var r=n.dragpt;o=r.lng+","+r.lat}i.dragpt&&(o=i.dragpt),i.dragPoints.splice(e+1,0,{p:o,n:i.dragVia.viaName});var d=s.addDestPoi(o,"",p.DEST_MIDDLE);addStat("navscheme.navscheme.addtp","click"),d.addEventListener("dragstart",function(t){i.dragViaPoi(t)}),d.addEventListener("dragging",function(t){i.addViaRoute2(t)}),d.index=e,i.draging=!1,i.sended=1,i.sp=null,i.ep=null;var g="",u="",n=this.buildQuery(!1,3);g=n.tp,u=n.tc,a.go("nav&c="+i.currentCity+"&drag=1&sc="+i.sCity.code+"&ec="+u+i.eCity.code+"&sy="+i.strategy+"&sn=1$$$$"+i.popPoints[1].p+"$$"+encodeURIComponent(i.start.wd)+"$$$$$$"+i.start.pt+"$$&en="+g+"1$$$$"+i.popPoints[i.popPoints.length-2].p+"$$"+encodeURIComponent(i.end.wd)+"$$$$$$"+i.end.pt+"$$",{keepTpList:!0,isMainRequest:"no"}),i.queryObj=[]}}},dragRequest:function(t){var i=this,e=i.dragIndex;i.draging=!0,this.sended=0;var n=Math.pow(2,BMap.MapType[map.mapType].zoomLevelMax-map.zoomLevel-7);i.ajax.onsuccess=function(a){try{if(i.data=baidu.json.parse(a.responseText),i.data&&i.data.result&&0==i.data.result.error&&i.data.content){var o=i.data.content,r=s.parse2Geo(o.geo,n),d=r.points,g=o.name;("undefined"==typeof g||""==g)&&(g=i.noName),i.dragVia.viaName=g,i.dragVia.dis=o.dis;for(var u=i.dragVia.dis||0,h=0;h<i.routePoints.length;h++){var l=i.routePoints[h];if(h!=e)for(var c=0;c<l.length;c++)u+=l[c].d}0==u&&(u=i.dis);var v=1e3>u?u.toFixed(1)+"米":(u/1e3).toFixed(1)+"公里";if(i.tipLabel.setContent(g+"("+v+")"),i.dragVia.setLabel(i.tipLabel),i.dragpt=s.parse2Geo(o.dragpt).points,i.popPois){for(var h=0;h<i.popPois.length;h++)map.removeOverlay(i.popPois[h]);i.popPois=null}i.removeDraw(),i.dragingSTime=(new Date).getTime(),i.tempDrag=[];for(var h=0;h<d.length;h++){var m=s.addRoute(d[h],p.ROUTE_TYPE_DRIVE);m.index=e+h,i.tempDrag.push(m),0==h?window.dropRoutes.splice(e,1,m):window.dropRoutes.splice(e+h,0,m)}i.draging=!1,t.flag=1,i.dragVia.failure=0}else i.dragVia.failure=1,i.draging=!1,t.flag=0}catch(f){i.dragVia.failure=1,i.draging=!1,t.flag=0}};var a=map.getBounds();this.dragSTime=(new Date).getTime(),this.ajax.request("/"+h.DATA_URL+t.url+"&ie=utf-8&l="+map.zoomLevel+"&b=("+a.minX+","+a.minY+";"+a.maxX+","+a.maxY+")&newmap=1&t="+(new Date).getTime())},addViaRoute:function(){if(!(this.dragVia&&this.dragPoints&&this.dragPoints.length>=this.maxDragVia+2)){this.dateEnd=(new Date).getTime();var t=this.dateEnd-this.dateStart,i=this.dragVia.point;this.dragVia.failure=0;var e=this.dragIndex,n=this.dragVia.viaName;("undefined"==typeof n||""==n)&&(n=this.noName),this.sp="",this.ep="",this.sp||(this.sp=this.dragPoints[e].p),this.ep||(this.ep=this.dragPoints[e+1].p);{var a="";et=1}a="drag&sy="+this.strategy+"&pt="+i.lng+","+i.lat+"&sn="+this.sp+"&st=1&en="+this.ep+"&et=1&r=5000";var o={url:a,flag:0,dragpt:i};this.ajax.duration=-1,this.draging?t>2e3&&(this.timeout&&clearTimeout(this.timeout),this.dateStart=(new Date).getTime(),this.queryObj.push(o),this.dragRequest(o)):(this.queryObj.push(o),this.dragRequest(o));var s=this;this.timeout=setTimeout(function(){if(s.queryObj&&s.queryObj.length){var t=s.queryObj[s.queryObj.length-1];t&&0==t.flag&&s.queryObj&&!s.draging&&0==s.dflag&&s.dragRequest(t)}},3e3)}},addViaPoi3:function(t,i,e){o.stopBubble(t);var n=t?t.target:e;if(0==i&&"image/tpicon.png"/*tpa=http://webmap0.map.bdstatic.com/newmap/static/common/widget/com/NavTrans/image/tpicon.png*/!=n.getIcon().imageUrl)return void this.addViaPoi2(t,i,e);var a=this;s.getGEORevertAddress(o.getOverlayPoint(n),function(t){a.addViaPoiCBK(t)})},addViaPoiCBK:function(t){for(var i,e,n=t.content,a=o.getPoiPoint(t.result.x+","+t.result.y),s=0,r=0;e=this.dragPois[r];r++)if(i=o.getOverlayPoint(e),i.lat==a.lat&&i.lng==a.lng){r==this.dragPois.length-1?s=2:0==r&&(s=1),this.addViaPoi2(null,s,e,n.address);break}},addViaPoi2:function(t,i,e,n){var s=this;if(1!=s.dflag){s.ajax.duration=1,s.ajax.onsuccess=null,s.draging=!1,s.sended=1;var r=t?t.target:e;r.dis=0;var d=r.index;if(!s.queryObj||!s.queryObj.length)return;var p=s.queryObj[s.queryObj.length-1],g=r.point.lng+","+r.point.lat,u=g,h=r.viaName;h=n||h||s.noName;var l="",c="",v="",m=s.dragPoints[d];m.p=g,m.n=h,m.tp&&(m.tp.point=o.getPoiPoint(g),m.tp.query=m.n);var p=this.buildQuery(!1,0!=i?8:m.tp?8:3);switch(c=p.tp,v=p.tc,i){case 0:l="nav&c="+s.currentCity+"&drag=1&sc="+s.sCity.code+"&ec="+v+s.eCity.code+"&sy="+s.strategy+"&sn=1$$$$"+s.popPoints[1].p+"$$"+encodeURIComponent(s.start.wd)+"$$$$$$"+s.start.pt+"$$$$&st=0&en="+c+"1$$$$"+s.popPoints[s.popPoints.length-2].p+"$$"+encodeURIComponent(s.end.wd)+"$$$$$$"+s.end.pt+"$$&et=0";break;case 1:l="nav&c="+s.currentCity+"&drag=1&sc="+s.sCity.code+"&ec="+v+s.eCity.code+"&sy="+s.strategy+"&sn=1$$$$"+g+"$$"+encodeURIComponent(h)+"$$$$$$"+u+"$$&st=1&en="+c+"1$$$$"+s.end.pt+"$$"+encodeURIComponent(s.end.wd)+"$$$$$$&et=0&de=1";break;case 2:l="nav&c="+s.currentCity+"&drag=1&sc="+s.sCity.code+"&ec="+v+s.eCity.code+"&sy="+s.strategy+"&sn=1$$$$"+s.start.pt+"$$"+encodeURIComponent(s.start.wd)+"$$$$$$&st=0&en="+c+"1$$$$"+g+"$$"+encodeURIComponent(h)+"$$$$$$"+u+"$$&et=1&de=1"}a.go(l,{keepTpList:!0,isMainRequest:"no"}),s.dflag=1,s.dragpt=""}s.queryObj=[]},addViaRoute2:function(t,i){this.dateEnd=(new Date).getTime();var e=this.dateEnd-this.dateStart,n=t.target.index,a=t.target;a.failure=0,e>10&&this.dragPois&&(this.dragPois[0].removeEventListener("click",this.openSWin),this.dragPois[this.dragPois.length-1].removeEventListener("click",this.openEWin));var o=a.point,s="",r=1,d=1;switch(this.sp="",this.ep="",i){case 0:this.sp=this.dragPoints[n-1].p,this.ep=this.dragPoints[n+1].p;break;case 1:this.ep=this.dragPoints[n+1].p;break;case 2:this.sp=this.dragPoints[n-1].p}r=1,d=1,s="drag&sy="+this.strategy+"&pt="+o.lng+","+o.lat+"&sn="+this.sp+"&st="+r+"&en="+this.ep+"&et="+d+"&r=5000";var p={url:s,flag:0,dragpt:o};if(this.ajax.duration=-1,this.draging){e>2e3&&(this.timeout&&clearTimeout(this.timeout),this.dateStart=(new Date).getTime(),this.dragRequest2(p,n,i,a),this.queryObj.push(p));var g=this;this.timeout=setTimeout(function(){if(g.queryObj&&g.queryObj.length){var t=g.queryObj[g.queryObj.length-1];t&&0==t.flag&&g.queryObj&&!g.draging&&0==g.dflag&&g.dragRequest2(t,n,i,a)}},3e3)}else this.dragRequest2(p,n,i,a),this.queryObj.push(p)},dragRequest2:function(t,i,e,n){var a=this;a.draging=!0,this.sended=0;var o=Math.pow(2,BMap.MapType[map.mapType].zoomLevelMax-map.zoomLevel-7);this.ajax.onsuccess=function(r){try{if(a.data=baidu.json.parse(r.responseText),a.data&&a.data.result&&0==a.data.result.error&&a.data.content){var d=a.data.result,g=a.data.content,u=s.parse2Geo(g.geo,o),h=u.points,l=g.name;("undefined"==typeof l||""==l)&&(l=a.noName),n.viaName=l,n.dis=g.dis,n.failure=0;var c=n.dis||0,v=a.routePoints.length;if(v>1)for(var m=0;v>m;m++){var f=a.routePoints[m];if(m>i||i-1>m||m>i&&1==i||i-1>m&&i==v-1)for(var P=0;P<f.length;P++)c+=parseFloat(f[P].d)}var $=a.roundDis(c);if(a.tipLabel.setContent(l+"("+$+")"),n.setLabel(a.tipLabel),a.dragpt=s.parse2Geo(g.dragpt).points,a.mousept=d.pt,a.popPois){for(var m=0;m<a.popPois.length;m++)map.removeOverlay(a.popPois[m]);a.popPois=null}if(a.removeDraw(),a.tempDrag=[],1==e||2==e){var y=s.addRoute(h,p.ROUTE_TYPE_DRIVE);a.tempDrag.push(y),1==e?(y.index=i,window.dropRoutes.splice(i,1,y)):(y.index=i-1,window.dropRoutes.splice(i-1,1,y))}else for(var m=0;m<h.length;m++){var y=s.addRoute(h[m],p.ROUTE_TYPE_DRIVE);y.index=i-1+m,a.tempDrag.push(y),0==m?window.dropRoutes.splice(i-1,1,y):window.dropRoutes.splice(i-1+m,0,y)}a.draging=!1,a.dflag=0,t.flag=1}else n.failure=1,n.draging=!1,t.flag=0}catch(w){n.failure=1,n.draging=!1,t.flag=0}};var r=map.getBounds();this.ajax.request("/"+h.DATA_URL+t.url+"&ie=utf-8&l="+map.zoomLevel+"&b=("+r.minX+","+r.minY+";"+r.maxX+","+r.maxY+")&newmap=1&t="+(new Date).getTime())},onRouteOut:function(){var t=this;t.dragVia&&(t.distime=setTimeout(function(){t.removeDrag()},250))},removeDrag:function(){var t=this;t.dragVia&&t.dragVia.hide()},delVia:function(t,i){i=i||3,this.dragPoints.splice(t,1),this.buildQuery(!0,i)},buildQueryOnlyByTp:function(t){for(var i={tp:"",tc:""},e=!1,n=1;n<this.dragPoints.length-1;n++){var a=this.dragPoints[n];a.tp&&(e=!0,i.tp+=TPM.getTPointQueryParam(a.tp,t),this.endCityArray[n]&&(cityCode=this.endCityArray[n].code),i.tc+=cityCode+"+to:")}return i},buildQuery:function(t){var i="",e="",n=h.cityCode,o=!1;n=isNaN(n)?1:n;for(var s=1;s<this.dragPoints.length-1;s++){var r=this.dragPoints[s];r.tp?(i+=TPM.getTPointQueryParam(r.tp),o=!0):i+="1$$$$"+r.p+"$$$$+to:",this.endCityArray[s-1]&&(n=this.endCityArray[s-1].code),e+=n+"+to:"}var d="nav&navtp=2&c="+this.currentCity+"&drag=1&sc="+this.sCity.code+"&ec="+e+this.eCity.code+"&sy="+this.strategy+"&sn=1$$$$"+(this.popPoints[1]?this.popPoints[1].p:"")+"$$"+encodeURIComponent(this.start.wd)+"$$$$$$"+this.start.pt+"$$&en="+i+"1$$$$"+(this.popPoints[this.popPoints.length-2]?this.popPoints[this.popPoints.length-2].p:"")+"$$"+encodeURIComponent(this.end.wd)+"$$$$$$"+this.end.pt+"$$";return t&&a.go(d,{keepTpList:!0,isMainRequest:"no"}),{url:d,tp:i,tc:e}},roundDis:function(t){var i="";return t>0&&10>=t?i="10米":t>10&&(i=1e3>t?10*(t/10).toFixed(0)+"米":(t/1e3).toFixed(1)+"公里"),i},mainRoudeOn:function(t,i){var e=this;e.addTips(t,i)},mainRoudeOut:function(t,i,e,n,a){var o=this;o.removeTips(e)},mainRoudeClick:function(t,i){var e=this;e.highRoute(t,i)},highRoute:function(t,i){if(map.closeInfoWindow(),this.mapZoomLevel=map.zoomLevel,null!=i){if(this.groupBounds[i]){var e=this.groupBounds[i],n=o.getBPoints(e);s.setViewport(n,60)}}else if(null!=t&&this.driveBounds[t]){var e=[this.driveBounds[t]],n=o.getBPoints(e);s.setViewport(n,60)}s.addDrRoute(!0,this),this.addPopPoi(t,i),this.addTips(t,i)},addTips:function(t,i,e){var n=this,a=a||{};if(1!=n._tempLinkOver){var o=Math.pow(2,BMap.MapType[map.mapType].zoomLevelMax-map.zoomLevel-7);if(!n.draging){n.lastOver=e;var r=[];if("mk"==a.from)for(var d=0;d<n.mainRoud[a.i].points.length;d++){var g=s.cutPoints(n.mainRoud[a.i].points[d],o);r.push(g)}else if(null==i||isNaN(i)){var g=s.cutPoints(n.drivePoints[t],o);r.push(n.driveTargetPoints[t+1].p),r.push(g)}else{var u=n.mainRouteIndex.length,h=n.drivePoints.length,l=i+1>=u?h:n.mainRouteIndex[i+1];r.push(n.driveTargetPoints[t+1].p);for(var d=n.mainRouteIndex[i];l>d;d++){var g=s.cutPoints(n.drivePoints[d],o);r.push(g)}}n.tempRoute&&(s.unSelectRoute(n.tempRoute),s.removeRoute(n.tempRoute),n.tempRoute=null),n.tempRoute=s.addRoute(r.join(";"),p.ROUTE_TYPE_DRIVE),s.selectRoute(n.tempRoute)}}},removeTips:function(t){var i=this;return-1==i._tempLinkOver?void(i._tempLinkOver=0):(i.tempRoute&&(s.unSelectRoute(i.tempRoute),s.removeRoute(i.tempRoute),i.tempRoute=null),this.lastOver=t,void(i.tempLink&&(baidu.dom.remove(i.tempLink),i.tempLink=null)))},addPopPoi:function(t,i){for(var e=0;e<this.popPois.length;e++)map.removeOverlay(this.popPois[e]),this.popPois[e]=null;if(this.popPois=[],!this.popPois.length){if(null==i||isNaN(i)){if(null!=t&&!isNaN(t)){var n=this.popPoints[t+1].p.toString(),a=this.popPoints[t+2].p.toString(),o=parseInt(this.popPoints[t+1].a),r=parseInt(this.popPoints[t+2].a),d=s.addDrvDirIcon(n,o);t+2==this.popPoints.length-2&&(r=12);var p=s.addDrvDirIcon(a,r),g=this.popWins[t+1],u=this.popWins[t+2];d.addEventListener("click",this.getClickMarker(g,d,t+1)),p.addEventListener("click",this.getClickMarker(u,p,t+2))}}else{var h=this.groupPopPoints[i][0];if(!h)return;var l=this.groupPopPoints[i][this.groupPopPoints[i].length-1],n=h.p.toString(),a=(this.sgi-1,l.p.toString()),o=parseInt(h.a),r=parseInt(l.a),d=s.addDrvDirIcon(n,o),p=s.addDrvDirIcon(a,r),g=this.popWins[1],u=this.popWins[this.sgi-1];d.addEventListener("click",this.getClickMarker(g,d,1)),p.addEventListener("click",this.getClickMarker(u,p,this.sgi-1))}d.disableDragging(),p.disableDragging(),this.popPois.push(d),this.popPois.push(p)}},getClickMarker:function(t,i,e){return function(){c.popIndex=e,d.transInfoWindow(i,t,{showLine:!1})}},clickStop:function(t){t=this.keyPopInfos[t];var i,e,n=t,a=this;if(0!=n&&n!=a.popPoints.length-1){var r=n.popPoint.p,p=n.popPoint.a,g=T.array.indexOf(this.popPoints,n.popPoint);return e=a.popWins[g],i=s.addDrvDirIcon(r,p),a.popPois.push(i),i.addEventListener("click",a.getClickMarker(e,i,g)),d.transInfoWindow(i,e,{showLine:!1}),c.popIndex=g,void(o.isInBounds(o.getOverlayPoint(i))||map.setCenter(o.getOverlayPoint(i)))}0==n?i=window.startPoi:n==a.popPoints.length-1&&(i=window.endPoi),e=a.popWins[n],d.transInfoWindow(i,e,{showLine:!1}),c.popIndex=t,o.isInBounds(o.getOverlayPoint(i))||map.setCenter(o.getOverlayPoint(i))},addPopInfoWin:function(){for(var t=this.popPoints.length,i=this.start.uid,e=this.end.uid,n=0;t>n;n++){var a=null;0==n&&(a=i),n==t-1&&(a=e),this.popWins.push(d.createTransInfoWnd({title:this.popInfos[n].title,content:this.popInfos[n].info,curIndex:n,total:t,obj:this,nextInfo:this.popInfos[n].next,nextTransCbk:this.nextTransCbk,zoomTransCbk:this.zoomTransCbk,transUid:a}))}var o=this,s=this.popWins[0];o.openSWin=function(){o.getClickMarker(s,o.dragPois[0],0)()};var r=this.popWins[this.popWins.length-1];o.openEWin=function(){o.getClickMarker(r,o.dragPois[o.dragPois.length-1],o.popPoints.length-1)()},this.dragPois&&(this.dragPois[0].addEventListener("click",o.openSWin),this.dragPois[this.dragPois.length-1].addEventListener("click",o.openEWin))},nextTransCbk:function(t,i){for(var e=i.popPoints[t].p,n=i.popPoints[t].a,a=i.popWins[t],o=0;o<i.popPois.length;o++)map.removeOverlay(i.popPois[o]),i.popPois[o]=null;if(i.dispatchEvent("poiinfoopen",{index:t-1}),t>0&&t<i.popPoints.length-1){t==i.popPoints.length-2&&(n=12);var r=s.addDrvDirIcon(e,n);r.addEventListener("click",i.getClickMarker(a,r,t)),i.popPois.push(r),r.openInfoWindow(a)}0==t&&window.startPoi?(d.transInfoWindow(window.startPoi,a,{showLine:!1}),c.popIndex=0):t==i.popPoints.length-1&&window.endPoi&&(d.transInfoWindow(window.endPoi,a,{showLine:!1}),c.popIndex=i.popPoints.length-1)},zoomTransCbk:function(t,i){var e=BMap.MapType[map.mapType].zoomLevelMax;map.zoomTo(0==t?e:i.mapZoomLevel!=map.zoomLevel?i.mapZoomLevel:e-3)},getClickMarker:function(t,i,e){return function(){c.popIndex=e,d.transInfoWindow(i,t,{showLine:!1})}},updatePanoPopWins:function(t,i){if(t&&0!=t.length)for(var e=0,n=this.popWins.length;n>e;e++){var a=i[e],o=t[a];this.popWins[e]=u.addPanoThumbnailsInInfoWnd([this.popWins[e]],[o],t,"nav")[0]}},resetDrv:function(){if(window.dropRoutes){for(var t=0;t<window.dropRoutes.length;t++){var i=window.dropRoutes[t];i&&s.removeRoute(i)}window.dropRoutes=[]}if(this.popPois){for(var t=0;t<this.popPois.length;t++)map.removeOverlay(this.popPois[t]);this.popPois=[]}s.addDrRoute(!1,this)}}),e.exports=n});