define("common:widget/pano/module/TrafficModule/NavModule/NavModule.js",function(require,exports,module){var Animation=require("common:widget/ui/Animation/Animation.js"),TableView=require("common:widget/pano/component/TableView/TableView.js"),ModuleClass=require("common:widget/pano/base/ModuleClass.js"),util=require("common:widget/pano/base/util.js"),NavRoute=require("common:widget/pano/model/NavRoute.js"),service=require("common:widget/pano/base/service.js");require.loadCss({content:".nav-header-icon{background-image:url(http://webmap2.map.bdstatic.com/newmap/static/common/images/pano_whole/nav-icon_1d72d88.png);_background-image:url(http://webmap2.map.bdstatic.com/newmap/static/common/images/pano_whole/nav-icon_8_ebcc315.png)}.nav-trafficbar{position:absolute;width:100%;height:5px;bottom:0;overflow:hidden}.nav-trafficbar-value{float:left;height:5px}.nav-trafficbar-bg-0{background-color:#535353}.nav-trafficbar-bg-1{background-color:#118711}.nav-trafficbar-bg-2{background-color:#B67F24}.nav-trafficbar-bg-3{background-color:#CA3630}"});var ITEM_TEMPLATE=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="traffic-image-item">    <div class="traffic-image-wapper">        '),src?_template_fun_array.push('            <img class="traffic-image" src="',"undefined"==typeof src?"":src,'" onerror="this.src=&#39;',"undefined"==typeof error_src?"":error_src,'&#39;" />        '):_template_fun_array.push('            <img class="traffic-image" src="',"undefined"==typeof error_src?"":error_src,'" />        '),_template_fun_array.push('        <div class="traffic-image-desc-wapper">            <div class="traffic-image-desc-bg"></div>            <div class="traffic-image-desc">                <span class="traffic-image-desc-index">',"undefined"==typeof index?"":index,' ) </span>                <div class="traffic-image-desc-text">',"undefined"==typeof desc?"":desc,'</div>            </div>        </div>    </div>    <div class="nav-trafficbar nav-trafficbar-bg-0">        ');for(var i=0,n=traffic.length;n>i;i++)_template_fun_array.push('            <div class="nav-trafficbar-value nav-trafficbar-bg-',"undefined"==typeof traffic[i].status?"":traffic[i].status,'" style="width:',"undefined"==typeof traffic[i].value?"":traffic[i].value,'%"></div>        ');_template_fun_array.push("    </div></div>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],IMG_ERROR_URL="../../../../../images/pano_whole/img_error_8d3eb72.png"/*tpa=http://webmap0.map.bdstatic.com/newmap/static/common/images/pano_whole/img_error_8d3eb72.png*/,OVERVIEW_SIZE=315,SHOW_DESC_DELAY=400,SHOW_DESC_DURATION=150,privateMethod=function(){function e(){clearTimeout(i)}function t(e){var t=T(e).find(".traffic-image-desc-wapper"),a=t.attr("status");a>0||(-1==a&&r&&r.stop(),t.css("top","100%"),t.css("display","block"),t.attr("status","1"),n=new Animation.Animation,n.build({fps:60,transition:Animation.Transitions.easeOutQuad,duration:SHOW_DESC_DURATION,render:function(e){try{t.css("top",100*(1-e)+"%")}catch(a){"undefined"!=typeof alog&&alog("http://webmap0.map.bdstatic.com/newmap/static/common/widget/pano/module/TrafficModule/NavModule/exception.fire","catch",{msg:a.message||a.description,path:"common:widget/pano/module/TrafficModule/NavModule/NavModule.js",ln:54})}},finish:function(){t.attr("status","2")}}))}function a(e){var t=T(e).find(".traffic-image-desc-wapper"),a=t.attr("status");if(!(0>a)){if(1==a)return n&&n.stop(),t.css("top","100%"),void t.attr("status","-2");r=new Animation.Animation,t.attr("status","-1"),r.build({fps:60,transition:Animation.Transitions.easeOutQuad,duration:SHOW_DESC_DURATION,render:function(e){try{t.css("top",100*e+"%")}catch(a){"undefined"!=typeof alog&&alog("http://webmap0.map.bdstatic.com/newmap/static/common/widget/pano/module/TrafficModule/NavModule/exception.fire","catch",{msg:a.message||a.description,path:"common:widget/pano/module/TrafficModule/NavModule/NavModule.js",ln:82})}},finish:function(){t.attr("status","-2")}})}}var i=0,n=null,r=null,o={renderStepList:function(){try{var e=this.navRoute.getSteps(),t=e.length,a=this.tableView;util.each(e,function(e,i){e.instructions||(e.instructions=0===i?"起点":i==t-1?"终点":"未知路段");var n={index:i+1,src:e.src,error_src:IMG_ERROR_URL,desc:e.instructions,traffic:e.traffic||[]},r=ITEM_TEMPLATE(n);a.addItemContent(r)}),a.resize()}catch(i){"undefined"!=typeof alog&&alog("http://webmap0.map.bdstatic.com/newmap/static/common/widget/pano/module/TrafficModule/NavModule/exception.fire","catch",{msg:i.message||i.description,path:"common:widget/pano/module/TrafficModule/NavModule/NavModule.js",ln:114})}},mouseEnterHandler:function(a,n){var r=this.tableView.getSelectIndex();r!==n&&(e(),i=setTimeout(function(){t(a)},SHOW_DESC_DELAY));var o=this.navRoute.getSteps();this.tableView.fitImage(n);var s=o[n];s.rx&&s.ry&&this.dispatchEvent("show_position",{data:{x:s.rx,y:s.ry}})},mouseLeaveHandler:function(t,i){var n=this.tableView.getSelectIndex();n!==i&&(e(),a(t)),this.dispatchEvent("hide_position")},clickHandler:function(i){var n=this.tableView.getSelectIndex();if(i!==n){var r=this.tableView.getSelectItem();r&&(e(),a(r)),this.tableView.setSelectIndex(i),r=this.tableView.getSelectItem(),t(r);var o=this.navRoute.getSteps(),s=o[i];this.dispatchEvent("hide_position"),this.dispatchEvent("pano_changed",{data:{source:this.getName(),panoHeading:s.dir,panoId:s.pid}})}},renderHeader:function(e,t,a){try{var i=t.wd+" > "+a.wd,n=document.createElement("div");n.className="traffic-header-bar",n.innerHTML=['<p class="traffic-header-wapper">','<i class="traffic-header-icon nav-header-icon"></i>','<span class="traffic-header-text" title="'+i+'">'+i+"</span>","</p>"].join(""),e.appendChild(n)}catch(r){"undefined"!=typeof alog&&alog("http://webmap0.map.bdstatic.com/newmap/static/common/widget/pano/module/TrafficModule/NavModule/exception.fire","catch",{msg:r.message||r.description,path:"common:widget/pano/module/TrafficModule/NavModule/NavModule.js",ln:188})}},addStartEndMarkers:function(e,t){for(var a=e.point.split(","),i=this.navRoute.getSteps(),n=null,r=0,o=0;i[r];){if(n=i[r],n.pid){o=util.getAngleFromP2P({x:n.rx,y:n.ry},{x:a[0],y:a[1]});break}r++}var s={markerId:util.getUniqueId("MARKER_ST"),addr:e.wd,catalog:"FF0201",heading:o,name:e.wd,pid:n.pid,pitch:0,poiuid:e.uid,px:1*n.rx,py:1*n.ry,rank:0,x:1*a[0],y:1*a[1]};r=i.length-1;var d=null;for(o=0,a=t.point.split(",");i[r];){if(d=i[r],d.pid){o=util.getAngleFromP2P({x:d.rx,y:d.ry},{x:a[0],y:a[1]});break}r--}var c={markerId:util.getUniqueId("MARKER_EN"),addr:t.wd,catalog:"FF0202",heading:o,name:t.wd,pid:d.pid,pitch:0,poiuid:t.uid,px:1*d.rx,py:1*d.ry,rank:0,x:1*a[0],y:1*a[1]};this.dispatchEvent("add_markers",[s,c])}};return o}(),NavModule=ModuleClass.extend("NavModule",{initialize:function(e,t,a,i){try{if(!(window.currentComponent&&"NavTrans"===currentComponent.name||this.$shareParam))return;var n=this;this.enterPanoData=a,this.headerContainer=t,this.tableView=e,e.addEventListener("mouseenter",function(e,t){privateMethod.mouseEnterHandler.call(n,t.elem,t.index)}),e.addEventListener("mouseleave",function(e,t){privateMethod.mouseLeaveHandler.call(n,t.elem,t.index)}),e.addEventListener("click",function(e,t){privateMethod.clickHandler.call(n,t.index),addStat(STAT_CODE.STAT_PANORAMA,{item:"navalbum-click"})});var r,o=void 0;if(this.$shareParam&&(o=this.$shareParam.index),r=currentComponent.getPanoNavParams(),r.end.indexOf("to:")>-1){var s=r.end.split("to:");r.end=s.pop()}r.startmatchdis=20,r.turnmatchdis=20;var d=this.navRoute=new NavRoute(r,i);d.on("ready",function(){privateMethod.renderStepList.call(n),n.fire("ready")}),this.navParam=r}catch(c){"undefined"!=typeof alog&&alog("http://webmap0.map.bdstatic.com/newmap/static/common/widget/pano/module/TrafficModule/NavModule/exception.fire","catch",{msg:c.message||c.description,path:"common:widget/pano/module/TrafficModule/NavModule/NavModule.js",ln:329})}},getClosestPoint:function(e,t,a){var i=null,n=1/0,r=0,o=this.navRoute.getSteps();return util.each(o,function(t){return e===t.panoId?(i=t,!0):void 0}),null===i&&util.each(o,function(e){r=Math.pow(e.rx-a,2)+Math.pow(e.ry-t,2),n>r&&(n=r,i=e)}),i},getRoutParam:function(){var e=this.navParam;if(e){var t={};for(var a in e)t[a]=e[a];return t.start=decodeURIComponent(e.start),t.end=decodeURIComponent(e.end),t}return""},getRoutPoints:function(){return this.navRoute.getPoints()},getStartEndPoint:function(){var e=this.navRoute.getStart(),t=this.navRoute.getEnd();return e.point=e.pt,t.point=t.pt,e.type=0,t.type=1,{start:e,end:t}},getSteps:function(){return this.navRoute.getSteps()},getMarkers:function(){var e=this.getStartEndPoint();return[e.start,e.end]},show:function(e){this.dispatchEvent("layout_changed",{display:!0});var t=this.getStartEndPoint();privateMethod.renderHeader.call(this,e,t.start,t.end),privateMethod.addStartEndMarkers.call(this,t.start,t.end)},dispose:function(){this.tableView.dispose(),this.tableView=null,this.navRoute.dispose(),T.un(window,"resize",this._resizeHandler)},getShareParam:function(){var e=this.tableView.getSelectIndex();return{index:e}},event_panoChanged:function(e){if(this.navRoute){var t=void 0,a=this.navRoute.getSteps();if(util.each(a,function(a,i){return e==a.pid?(t=i,!0):void 0}),void 0!==t)privateMethod.clickHandler.call(this,t,!0);else{var i=this.tableView.getSelectItem(),n=this.tableView.getSelectIndex();this.tableView.setSelectIndex(null),privateMethod.mouseLeaveHandler.call(this,i,n)}}}});module.exports=NavModule});