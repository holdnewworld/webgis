define("common:widget/pano/module/TrafficModule/BusModule/BusModule.js",function(require,exports,module){var Animation=require("common:widget/ui/Animation/Animation.js"),TableView=require("common:widget/pano/component/TableView/TableView.js"),ModuleClass=require("common:widget/pano/base/ModuleClass.js"),util=require("common:widget/pano/base/util.js"),BusRoute=require("common:widget/pano/model/BusRoute.js"),service=require("common:widget/pano/base/service.js");require.loadCss({content:".bus-header-icon{background-image:url(http://webmap0.map.bdstatic.com/newmap/static/common/images/pano_whole/bus-icon_9d6dfc3.png);_background-image:url(http://webmap1.map.bdstatic.com/newmap/static/common/images/pano_whole/bus-icon-8_42c212b.png)}#bus-tableview-container .traffic-image{height:105px}#bus-tableview-container .traffic-image-desc-wapper{height:105px}#bus-tableview-container .tableview-selected-border{height:101px}"});var ITEM_TEMPLATE=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="traffic-image-item">    <div class="traffic-image-wapper">        '),src?_template_fun_array.push('            <img class="traffic-image" src="',"undefined"==typeof src?"":src,'" onerror="this.src=&#39;',"undefined"==typeof error_src?"":error_src,'&#39;" />        '):_template_fun_array.push('            <img class="traffic-image" src="',"undefined"==typeof error_src?"":error_src,'" />        '),_template_fun_array.push('        <div class="traffic-image-desc-wapper">            <div class="traffic-image-desc-bg"></div>            <div class="traffic-image-desc">                <span class="traffic-image-desc-index">',"undefined"==typeof index?"":index,' ) </span>                <div class="traffic-image-desc-text">',"undefined"==typeof desc?"":desc,"</div>            </div>        </div>    </div></div>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],IMG_ERROR_URL="../../../../../images/pano_whole/img_error_8d3eb72.png"/*tpa=http://webmap0.map.bdstatic.com/newmap/static/common/images/pano_whole/img_error_8d3eb72.png*/,OVERVIEW_SIZE=315,SHOW_DESC_DELAY=400,SHOW_DESC_DURATION=150,privateMethod=function(){function e(){clearTimeout(a)}function t(e){var t=T(e).find(".traffic-image-desc-wapper"),i=t.attr("status");i>0||(-1==i&&r&&r.stop(),t.css("top","100%"),t.css("display","block"),t.attr("status","1"),n=new Animation.Animation,n.build({fps:60,transition:Animation.Transitions.easeOutQuad,duration:SHOW_DESC_DURATION,render:function(e){try{t.css("top",100*(1-e)+"%")}catch(i){"undefined"!=typeof alog&&alog("http://webmap0.map.bdstatic.com/newmap/static/common/widget/pano/module/TrafficModule/BusModule/exception.fire","catch",{msg:i.message||i.description,path:"common:widget/pano/module/TrafficModule/BusModule/BusModule.js",ln:55})}},finish:function(){t.attr("status","2")}}))}function i(e){var t=T(e).find(".traffic-image-desc-wapper"),i=t.attr("status");if(!(0>i)){if(1==i)return n&&n.stop(),t.css("top","100%"),void t.attr("status","-2");r=new Animation.Animation,t.attr("status","-1"),r.build({fps:60,transition:Animation.Transitions.easeOutQuad,duration:SHOW_DESC_DURATION,render:function(e){try{t.css("top",100*e+"%")}catch(i){"undefined"!=typeof alog&&alog("http://webmap0.map.bdstatic.com/newmap/static/common/widget/pano/module/TrafficModule/BusModule/exception.fire","catch",{msg:i.message||i.description,path:"common:widget/pano/module/TrafficModule/BusModule/BusModule.js",ln:83})}},finish:function(){t.attr("status","-2")}})}}var a=0,n=null,r=null,s={renderStepList:function(e){try{var t=e.steps,i=this.tableView,a=t.length;util.each(t,function(e,n){var r={index:n+1,src:"",error_src:IMG_ERROR_URL,desc:e.text};if(r.src=e.pid?util.getImage3DUrl(null,e.pid,e.dir,10,196,105):IMG_ERROR_URL,n!=a-1||e.pid!=t[a-2].pid){var s=ITEM_TEMPLATE(r);i.addItemContent(s)}}),i.resize()}catch(n){"undefined"!=typeof alog&&alog("http://webmap0.map.bdstatic.com/newmap/static/common/widget/pano/module/TrafficModule/BusModule/exception.fire","catch",{msg:n.message||n.description,path:"common:widget/pano/module/TrafficModule/BusModule/BusModule.js",ln:116})}},mouseEnterHandler:function(i,n){var r=this.tableView.getSelectIndex();r!==n&&(e(),a=setTimeout(function(){t(i)},SHOW_DESC_DELAY)),this.tableView.fitImage(n);var s=this.route.getSchemeTransfer(),o=s.steps,d=o[n].point;d.x&&d.y&&this.dispatchEvent("show_position",{data:{x:d.x,y:d.y}})},mouseLeaveHandler:function(t,a){var n=this.tableView.getSelectIndex();n!==a&&(e(),i(t)),this.dispatchEvent("hide_position")},clickHandler:function(a){var n=this.tableView.getSelectIndex();if(a!==n){var r=this.tableView.getSelectItem();r&&(e(),i(r)),this.tableView.setSelectIndex(a),r=this.tableView.getSelectItem(),t(r);var s=this.route.getSchemeTransfer(),o=s.steps,d=o[a];this.dispatchEvent("hide_position"),this.dispatchEvent("pano_changed",{data:{source:this.getName(),panoHeading:d.dir,panoId:d.pid}})}},renderHeader:function(e,t,i){try{var a=t.wd+" > "+i.wd,n=document.createElement("div");n.className="traffic-header-bar",n.innerHTML=['<p class="traffic-header-wapper">','<i class="traffic-header-icon bus-header-icon"></i>','<span class="traffic-header-text" title="'+a+'">'+a+"</span>","</p>"].join(""),e.appendChild(n)}catch(r){"undefined"!=typeof alog&&alog("http://webmap0.map.bdstatic.com/newmap/static/common/widget/pano/module/TrafficModule/BusModule/exception.fire","catch",{msg:r.message||r.description,path:"common:widget/pano/module/TrafficModule/BusModule/BusModule.js",ln:192})}},addMarkers:function(){var e=this.route.getSchemeTransfer(),t=e.steps,i=t.length,a=util.each(t,function(e,a){if(1==a&&e.pid==t[0].pid||a==i-2&&e.pid==t[i-1].pid)return void 0;var n={markerId:util.getUniqueId("MARKER_ST"),addr:e.name,catalog:e.poiType,heading:e.dir,name:e.name,pid:e.pid,pitch:0,poiuid:e.uid||"",px:1*e.panox,py:1*e.panoy,rank:0,x:1*(e.x||e.point.x),y:1*(e.y||e.point.y)};return n},!0);this.dispatchEvent("add_markers",a)}};return s}(),BusModule=ModuleClass.extend("BusModule",{initialize:function(e,t,i){try{if(!(window.currentComponent&&"BusTrans"===currentComponent.name||this.$shareParam))return;this.enterPanoData=i,this.headerContainer=t,this.tableView=e,e.addEventListener("mouseenter",function(e,t){privateMethod.mouseEnterHandler.call(s,t.elem,t.index)}),e.addEventListener("mouseleave",function(e,t){privateMethod.mouseLeaveHandler.call(s,t.elem,t.index)}),e.addEventListener("click",function(e,t){privateMethod.clickHandler.call(s,t.index),addStat(STAT_CODE.STAT_PANORAMA,{item:"busalbum-click"})});var a,n=void 0,r=this.route=new BusRoute,s=this;r.fetch().then(function(){return r.getSchemeTransfer()}).then(function(e){privateMethod.renderStepList.call(s,e),s.fire("ready")}),this.$shareParam&&(n=this.$shareParam.index),this.busParam=a}catch(o){"undefined"!=typeof alog&&alog("http://webmap0.map.bdstatic.com/newmap/static/common/widget/pano/module/TrafficModule/BusModule/exception.fire","catch",{msg:o.message||o.description,path:"common:widget/pano/module/TrafficModule/BusModule/BusModule.js",ln:272})}},getClosestPoint:function(e,t,i){var a=null,n=1/0,r=0,s=this.route.getSchemeTransfer();return util.each(s.steps,function(t){return e===t.pid?(a=t,!0):void 0}),null===a&&util.each(s.steps,function(e){r=Math.pow(e.panox-i,2)+Math.pow(e.panoy-t,2),n>r&&(n=r,a=e)}),a},getRoutParam:function(){return""},getRoutPoints:function(){return[]},getStartEndPoint:function(){var e=this.route.getStart(),t=this.route.getEnd();return e.type=0,t.type=1,{start:e,end:t}},getMarkers:function(){return[]},show:function(e){this.dispatchEvent("layout_changed",{display:!0});var t=this.getStartEndPoint();privateMethod.renderHeader.call(this,e,t.start,t.end),privateMethod.addMarkers.call(this)},dispose:function(){this.tableView.dispose(),this.tableView=null,this.route.dispose(),T.un(window,"resize",this._resizeHandler)},getShareParam:function(){var e=this.tableView.getSelectIndex();return{index:e}},event_panoChanged:function(e){if(this.route){var t=void 0,i=this.route.getSchemeTransfer(),a=this.tableView.getSelectIndex(),n=i.steps[a];if(!n||e!=n.pid)if(util.each(i.steps,function(i,a){return e==i.pid?(t=a,!0):void 0}),void 0!==t)privateMethod.clickHandler.call(this,t,!0);else{var r=this.tableView.getSelectItem(),s=this.tableView.getSelectIndex();this.tableView.setSelectIndex(null),privateMethod.mouseLeaveHandler.call(this,r,s)}}}});module.exports=BusModule});