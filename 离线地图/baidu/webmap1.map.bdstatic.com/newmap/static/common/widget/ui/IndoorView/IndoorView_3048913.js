define("common:widget/ui/IndoorView/IndoorView.js",function(e,o,t){function i(e){T.lang.Class.call(this),this.cinfo=e||{},this.initialize()}var n=(window.Pano=window.Pano||{},e("common:widget/ui/IndoorOverlay/IndoorOverlay.js")),r=e("common:widget/ui/config/config.js"),a=e("common:widget/ui/util/util.js"),s=r.mapVersion,h=r.urlConfig;T.object.extend(i.prototype,{initialize:function(){try{if(this.isOpen=!1,this.tileSign={},this.viewport=null,this.VIEWPORTLT={x:0,y:0},this.indoorViewContainer=null,this.panoMarker=null,this.mapDragging=!1,this.indoorInfo=null,this.tileWrap=null,this.tileLayer=null,this.markerLayer=null,this.udtVersion=s.UDT_VERSION||"20130819",this.tileUrl=h.PANO_URL+"/scape/?udt="+this.udtVersion+"&qt=tdata",this.markers=[],this.panoView=null,this.EVENT={},this.panoView=this.cinfo.panoView,this.overFrame=this.cinfo.overFrame,this.viewport=this.cinfo.mapContainer,this.camera=new n({x:0,y:0,dom:this.viewport,zIndex:300}),this.addFrame(),this.addPanoInteEvent(),this.indoorInfo=this.adjustIndoorData(this.cinfo.indoorData),!this.indoorInfo)return void this.overFrame.setVisible(!1);this.overFrame.setVisible(!0),this.initIndoorView(),this.addDomEvent();var e=T("#StreetOverViewHolder .BMap_stdMpCtrl");e&&e[0]&&(e[0].style.zIndex=0)}catch(o){"undefined"!=typeof alog&&alog("http://webmap1.map.bdstatic.com/newmap/static/common/widget/ui/IndoorView/exception.fire","catch",{msg:o.message||o.description,path:"common:widget/ui/IndoorView/IndoorView.js",ln:79})}},addPanoInteEvent:function(){var e=this;e.EVENT.floorChanged=function(o){return e.indoorInfo=e.adjustIndoorData(o.data),e.indoorInfo?(e.overFrame.setVisible(!0),void e.initIndoorView()):void e.overFrame.setVisible(!1)},e.EVENT.povChanged=function(o){e.camera.setDirection(o.pov.heading)},e.EVENT.indoorPanoChanged=function(o){var t=o.data.id=o.data.pid;for(var i in e.markers)e.markers[i].id===t&&(o.data.x=e.markers[i].x,o.data.y=e.markers[i].y);e._clickMarker(o.data)},e.EVENT.panoChanged=function(o){o&&o.pano&&e.camera.setDirection(o.pano.heading)},e.EVENT.exitIndoor=function(){e.removeEvents(),e.overFrame.setVisible(!0)},e.panoView.addEventListener("onFloorChanged",e.EVENT.floorChanged),e.panoView.addEventListener("onPanoChanged",e.EVENT.panoChanged),e.panoView.addEventListener("onPovChanged",e.EVENT.povChanged),e.panoView.addEventListener("onIndoorPanoChanged",e.EVENT.indoorPanoChanged),e.panoView.addEventListener("onExitIndoor",e.EVENT.exitIndoor)},initIndoorView:function(){this.tileSign={},this.markers=[],this.markerLayer.innerHTML="",this.tileLayer.innerHTML="",this.indoorInfo.currZoom===this.indoorInfo.zoomLevel&&(this.zoomOut.style.backgroundPosition="-61px -25px"),1===this.indoorInfo.currZoom&&(this.zoomIn.style.backgroundPosition="-61px 0");var e=this.adjustCenter(this.indoorInfo.currPoint);this.tileWrap.style.width=this.indoorInfo.width+"px",this.tileWrap.style.height=this.indoorInfo.height+"px",this.renderView({x:e.left,y:e.top}),this.addMarkers()},addFrame:function(){var e="../../../images/panorama/indoorZoom1_24_e1eac64.png"/*tpa=http://webmap1.map.bdstatic.com/newmap/static/common/images/panorama/indoorZoom1_24_e1eac64.png*/,o="../../../../../../../webmap0.map.bdstatic.com/newmap/static/common/images/panorama/indoorZoom1_8_d555ed3.png"/*tpa=http://webmap0.map.bdstatic.com/newmap/static/common/images/panorama/indoorZoom1_8_d555ed3.png*/;return this.viewport=this.cinfo.mapContainer,this.indoorViewContainer=T.dom.create("div",{id:"IndoorView",style:"position: absolute; overflow: hidden; top: 0; right: 0; width: 100%; height: 100%; background-color: white; z-index: 10;"}),this.tileWrap=T.dom.create("div",{id:"tileWrap",style:"position: absolute; left: 0; top: 0; width: 512px; height: 256px; color: green;"}),this.tileLayer=T.dom.create("div",{style:"position:absolute;top:0;left:0;right:0;bottom:0;z-index:11"}),this.markerLayer=T.dom.create("div",{style:"position:absolute;top:0;left:0;right:0;bottom:0;z-index:12"}),this.zoomIn=T.dom.create("div",{style:"position: absolute; top: 10px; right: 15px; z-index: 13; width: 24px; height: 25px; background: url("+e+") no-repeat 0 0; _background-image: url("+o+");"}),this.zoomOut=T.dom.create("div",{style:"position: absolute; top: 35px; right: 15px; z-index: 13; width: 24px; height: 25px; background: url("+e+") no-repeat -31px -25px; _background-image: url("+o+");"}),this.tileWrap.appendChild(this.tileLayer),this.tileWrap.appendChild(this.markerLayer),this.viewport.appendChild(this.indoorViewContainer),this.indoorViewContainer.appendChild(this.tileWrap),this.indoorViewContainer.appendChild(this.zoomIn),this.indoorViewContainer.appendChild(this.zoomOut),!0},renderView:function(e){try{var o=this.overFrame.frameHolder,t=parseInt(o.style.width),i=parseInt(o.style.height),n=this.overFrame.frameSize;if(t<n.MIN_WIDTH||i<n.MIN_HEIGHT){var r=this.overFrame.getShowRealFrameSize();t=r.width,i=r.height}var a={x:-e.x,y:-e.y},s={x:a.x+t,y:a.y+i};e.x>0&&(a.x=0,s.x=parseInt(this.tileWrap.style.width)),e.y>0&&(a.y=0,s.y=parseInt(this.tileWrap.style.height));var h=this._filterTile(a,s,{mw:this.indoorInfo.width,mh:this.indoorInfo.height,tw:this.indoorInfo.tileWidth,th:this.indoorInfo.tileHeight});this.addTileLayer({dom:this.tileLayer,area:h,tile:{width:this.indoorInfo.tileWidth,height:this.indoorInfo.tileHeight}})}catch(d){"undefined"!=typeof alog&&alog("http://webmap1.map.bdstatic.com/newmap/static/common/widget/ui/IndoorView/exception.fire","catch",{msg:d.message||d.description,path:"common:widget/ui/IndoorView/IndoorView.js",ln:243})}},addDomEvent:function(){this._bindMouseDragEvent(),this._bindMouseWheelEvent(),this._bindViewportEvent(),this._bindClickEvent()},removeEvents:function(){var e=this;if(e.EVENT&&(e.panoView.removeEventListener("onFloorChanged",e.EVENT.floorChanged),e.panoView.removeEventListener("onPanoChanged",e.EVENT.panoChanged),e.panoView.removeEventListener("onPovChanged",e.EVENT.povChanged),e.panoView.removeEventListener("onIndoorPanoChanged",e.EVENT.indoorPanoChanged),e.panoView.removeEventListener("onExitIndoor",e.EVENT.exitIndoor),e.EVENT._viewportChangeEvent)){e.overFrame.removeEventListener("onResize",e.EVENT._viewportChangeEvent),e.overFrame.removeEventListener("onAbsorb",e.EVENT._viewportChangeEvent),e.overFrame.removeEventListener("onEnterFull",e.EVENT._viewportChangeEvent),e.overFrame.removeEventListener("onRetDefault",e.EVENT._viewportChangeEvent),e.overFrame.removeEventListener("onWindowResize",e.EVENT._viewportChangeEvent),e.overFrame.removeEventListener("onHolderResize",e.EVENT._viewportChangeEvent),e.camera.removeEventListener("ondragend",e.EVENT._cameraDragEnd),e.camera.remove(),T(e.indoorViewContainer).off("mousedown",e.EVENT._mouseDown),T(e.indoorViewContainer).off("mousemove",e.EVENT._mouseMove),T(e.indoorViewContainer).off("mouseup",e.EVENT._mouseUp),T(e.indoorViewContainer).off("mouseleave",e.EVENT._mouseOut),T.un(e.viewport,T.browser.firefox?"DOMMouseScroll":"onmousewheel"),T(e.viewport).off("click",e.EVENT._clickPoint),T(e.zoomIn).off("click",e.EVENT._zoomIn),T(e.zoomOut).off("click",e.EVENT._zoomOut),T.on(this.zoomIn,"click",e.EVENT._zoomIn),T.on(this.zoomOut,"click",e.EVENT._zoomOut),T(e.zoomIn).off("mousemove",e.EVENT._zoomInMouseMove),T(e.zoomOut).off("mousemove",e.EVENT._zoomOutMouseMove),T(e.zoomIn).off("mouseleave",e.EVENT._zoomInMouseLeave),T(e.zoomOut).off("mouseleave",e.EVENT._zoomOutMouseLeave),e.EVENT=null;var o=T("#StreetOverViewHolder .BMap_stdMpCtrl");o&&o[0]&&(o[0].style.zIndex=1100)}},_bindMouseDragEvent:function(){function e(e){MS_POS.x=e.pageX,MS_POS.y=e.pageY,a.preventDefault(e)}window.MS_POS={initX:0,initX:0,y:0,MOUSEDOWN:!1,DRAG:!1};var o=(this.tileWrap,this);o.EVENT._mouseDown=function(o){this.style.cursor="url('http://webmap1.map.bdstatic.com/newmap/static/common/images/api/closedhand.cur'), move",MS_POS.MOUSEDOWN=!0,e(o),MS_POS.initX=o.pageX,MS_POS.initY=o.pageY},o.EVENT._mouseMove=function(t){MS_POS.MOUSEDOWN&&(this.style.cursor="url('http://webmap1.map.bdstatic.com/newmap/static/common/images/api/closedhand.cur')",MS_POS.DRAG=!0,o._drag({x:t.pageX-MS_POS.x,y:t.pageY-MS_POS.y}),e(t))},o.EVENT._mouseUp=function(t){this.style.cursor="pointer",MS_POS.DRAG&&Math.abs(t.pageX-MS_POS.initX)<3&&Math.abs(t.pageY-MS_POS.initY)<3&&(MS_POS.DRAG=!1),MS_POS.MOUSEDOWN=!1,e(t),o.renderView({x:parseInt(o.tileWrap.style.left),y:parseInt(o.tileWrap.style.top)})},o.EVENT._mouseOut=function(t){MS_POS.MOUSEDOWN&&(MS_POS.MOUSEDOWN=!1,MS_POS.DRAG=!1,e(t),o.renderView({x:parseInt(o.tileWrap.style.left),y:parseInt(o.tileWrap.style.top)}))},o.EVENT._cameraDragEnd=function(e){o.EVENT._setCameraPos(e.point.x-parseInt(o.tileWrap.style.left),e.point.y-parseInt(o.tileWrap.style.top))},o.camera.addEventListener("ondragend",o.EVENT._cameraDragEnd),T.on(this.indoorViewContainer,"mousedown",o.EVENT._mouseDown),T.on(this.indoorViewContainer,"mousemove",o.EVENT._mouseMove),T.on(this.indoorViewContainer,"mouseup",o.EVENT._mouseUp),T.on(this.indoorViewContainer,"mouseleave",o.EVENT._mouseOut)},_bindMouseWheelEvent:function(){var e=this,o=T.browser.firefox?"DOMMouseScroll":"onmousewheel";e.EVENT._zoomMouseWheel=function(o){a.stopBubble(o);var t=T(this).offset(),i=-o.detail/3||o.wheelDelta/120,n=o.pageX-t.left,r=o.pageY-t.top;e.zoom(i,{x:n,y:r})},T.on(this.viewport,o,e.EVENT._zoomMouseWheel)},_bindViewportEvent:function(){var e=this;e.EVENT._viewportChangeEvent=function(){var o=e.indoorInfo.currPoint;e.adjustCenter(o),e.camera&&e.camera.setPosition({x:o.x+e.tileWrap.offsetLeft,y:o.y+e.tileWrap.offsetTop}),e.renderView({x:parseInt(e.tileWrap.style.left),y:parseInt(e.tileWrap.style.top)})},e.overFrame.addEventListeners("onResize,onAbsorb,onEnterFull,onRetDefault,onWindowResize,onHolderResize",e.EVENT._viewportChangeEvent)},_bindClickEvent:function(){var e=this;e.EVENT._clickPoint=function(o){if(MS_POS.DRAG)return void(MS_POS.DRAG=!1);var t=T(e.tileWrap).offset(),i=o.pageX-t.left,n=o.pageY-t.top;e.EVENT._setCameraPos(i,n),e.renderView({x:parseInt(e.tileWrap.style.left),y:parseInt(e.tileWrap.style.top)})},e.EVENT._setCameraPos=function(o,t){if(e.markers.length){for(var i,n,r=0,a=0,s=0;s<e.markers.length;s++)n=e.markers[s],i=Math.pow(Math.abs(n.x-o),2)+Math.pow(Math.abs(n.y-t),2),0===s?a=i:a>i&&(a=i,r=s);e._clickMarker(e.markers[r])}},e.EVENT._zoomIn=function(o){a.stopBubble(o),e.zoom(1,{x:e.viewport.offsetWidth/2,y:e.viewport.offsetHeight/2})},e.EVENT._zoomOut=function(o){a.stopBubble(o),e.zoom(-1,{x:e.viewport.offsetWidth/2,y:e.viewport.offsetHeight/2})},e.EVENT._zoomInMouseMove=function(){1!=e.indoorInfo.currZoom&&(this.style.backgroundPosition="-31px 0")},e.EVENT._zoomOutMouseMove=function(){e.indoorInfo.currZoom!=e.indoorInfo.zoomLevel&&(this.style.backgroundPosition="0 -25px")},e.EVENT._zoomInMouseLeave=function(){1!=e.indoorInfo.currZoom&&(this.style.backgroundPosition="0 0")},e.EVENT._zoomOutMouseLeave=function(){e.indoorInfo.currZoom!=e.indoorInfo.zoomLevel&&(this.style.backgroundPosition="-31px -25px")},T.on(this.viewport,"click",e.EVENT._clickPoint),T.on(this.zoomIn,"click",e.EVENT._zoomIn),T.on(this.zoomOut,"click",e.EVENT._zoomOut),T.on(this.zoomIn,"mousemove",e.EVENT._zoomInMouseMove),T.on(this.zoomOut,"mousemove",e.EVENT._zoomOutMouseMove),T.on(this.zoomIn,"mouseleave",e.EVENT._zoomInMouseLeave),T.on(this.zoomOut,"mouseleave",e.EVENT._zoomOutMouseLeave)},_drag:function(e){var o,t,i=parseInt(this.tileWrap.style.left),n=parseInt(this.tileWrap.style.top),r=this.viewport.offsetWidth,a=this.viewport.offsetHeight,s=r-parseInt(this.tileWrap.style.width),h=a-parseInt(this.tileWrap.style.height),d=i,p=n;i=i+e.x>0?0:i+e.x,n=n+e.y>0?0:n+e.y,i=i>s?i:s,n=n>h?n:h,this.tileWrap.style.left=i+"px",this.tileWrap.style.top=n+"px",this._checkAdjustTileWrap(r,a,this.tileWrap),o=s>0?0:i-d,t=h>0?0:n-p,this.camera.setPosition({x:this.camera.getPosition().x+o,y:this.camera.getPosition().y+t})},_checkAdjustTileWrap:function(e,o,t){var i=parseInt(t.style.left),n=parseInt(t.style.top),r=parseInt(t.style.width),a=parseInt(t.style.height);return e>r&&(i=(e-r)/2),o>a&&(n=(o-a)/2),t.style.left=i+"px",t.style.top=n+"px",!0},adjustCenter:function(e){var o,t,i=this.overFrame.frameHolder,n=parseInt(i.style.width),r=parseInt(i.style.height),a=this.indoorInfo.width,s=this.indoorInfo.height,h=this.tileWrap,d=this.overFrame.frameSize;if(n<d.MIN_WIDTH||r<d.MIN_HEIGHT){var p=this.overFrame.getShowRealFrameSize();n=p.width,r=p.height}return t=r>=s?(r-s)/2:e.y<=r/2?0:s-e.y<r/2?r-s:r/2-e.y,h.style.top=t+"px",o=n>=a?(n-a)/2:e.x<=n/2?0:a-e.x<n/2?n-a:n/2-e.x,h.style.left=o+"px",{left:o,top:t}},addTileLayer:function(e){for(var o,t,i=(e.dom,e.area),n=(e.tile.height,e.tile.width,e.tile),r=e.dom,a=null,s=i.minCol;s<=i.maxCol;s++)for(var h=i.minRow;h<=i.maxRow;h++)this.tileSign[s+"_"+h]||(this.tileSign[s+"_"+h]=!0,t=n.width*s,o=n.height*h,a=T.dom.create("img",{src:this.tileUrl+"&iid="+this.indoorInfo.innerId+"&f="+this.indoorInfo.floor+"&l="+this.indoorInfo.currZoom+"&pos="+s+"_"+h,style:"position: absolute; top: "+o+"px; left:"+t+"px; width: 256px; height: 256px; display: block;"}),r.appendChild(a))},_filterTile:function(e,o,t){var i=t.tw,n=t.th,r=o.x-e.x>t.mw?e.x+t.mw:o.x,a=o.y-e.y>t.mh?e.y+t.mh:o.y,s=Math.floor(e.y/i),h=Math.floor(e.x/i),d=Math.ceil(a/n)-1,p=Math.ceil(r/i)-1;return{minRow:s,minCol:h,maxRow:d,maxCol:p}},adjustIndoorData:function(e){if(!e.hasImage)return null;e.defZoom=e.zoomLevel>1?2:1,e.tileWidth=256,e.tileHeight=256;var o=Math.pow(2,e.defZoom-1);e.width=e.width/o,e.height=e.height/o,e.currZoom=e.defZoom;for(var t=0,i=e.points.length;i>t;t++)e.points[t].x/=o,e.points[t].y/=o;if(e.currPoint={},e.points.length)for(var t=0;t<e.points.length;t++)if(e.points[t].id===e.uid){e.currPoint.x=e.points[t].x,e.currPoint.y=e.points[t].y;break}return e.uid&&e.currPoint.x&&e.currPoint.y||(e.currPoint.x=e.points[0].x,e.currPoint.y=e.points[0].y),e},_getDefZoom:function(e,o,t){var i=1,n=o+512,r=t+512,a=e.width,s=e.height;if(n>=a||r>=s)i=1;else{for(;a>=n&&s>=r;)a/=2,s/=2,i++;i--}return i},zoom:function(e,o){if(this._zoomData(e)){this.zoomOut.style.backgroundPosition=0>e&&this.indoorInfo.currZoom===this.indoorInfo.zoomLevel?"-61px -25px":"-31px -25px",this.zoomIn.style.backgroundPosition=e>0&&1==this.indoorInfo.currZoom?"-61px 0":"0 0";var t=this.viewport.offsetWidth,i=this.viewport.offsetHeight,n=this.indoorInfo.width,r=this.indoorInfo.height,a=parseInt(this.tileWrap.style.left),s=parseInt(this.tileWrap.style.top),h=o.x-(o.x-a)*Math.pow(2,e),d=o.y-(o.y-s)*Math.pow(2,e);this.tileSign={},this.markerLayer.innerHTML="",this.tileLayer.innerHTML="",this.tileWrap.style.width=this.indoorInfo.width+"px",this.tileWrap.style.height=this.indoorInfo.height+"px",h=h>0?0:h,d=d>0?0:d,h=t>n+h?t-n:h,d=i>r+d?i-r:d,h=t>n?(t-n)/2:h,d=i>r?(i-r)/2:d,this.tileWrap.style.left=h+"px",this.tileWrap.style.top=d+"px",this.renderView({x:h,y:d}),this.addMarkers()}},_zoomData:function(e){var o=this.indoorInfo.zoomLevel,t=this.indoorInfo.currZoom,i=this.indoorInfo;if(0>e&&t===o||e>0&&1===t)return!1;if(e>0){i.currZoom-=1,i.width*=2,i.height*=2;for(var n in i.points)i.points[n].x*=2,i.points[n].y*=2;i.currPoint.x*=2,i.currPoint.y*=2}else{i.currZoom+=1,i.width/=2,i.height/=2;for(var n in i.points)i.points[n].x/=2,i.points[n].y/=2;i.currPoint.x/=2,i.currPoint.y/=2}return!0},render:function(e){try{return e}catch(o){"undefined"!=typeof alog&&alog("http://webmap1.map.bdstatic.com/newmap/static/common/widget/ui/IndoorView/exception.fire","catch",{msg:o.message||o.description,path:"common:widget/ui/IndoorView/IndoorView.js",ln:854})}},addMarkers:function(){var e,o,t,i,n=[[10,10,0,-46],[16,16,0,-30],[30,30,0,0]],r=this.indoorInfo.zoomLevel-this.indoorInfo.currZoom,a=this.indoorInfo.currPoint,s=Math.floor((this.indoorInfo.zoomLevel+1)/3),h=this.indoorInfo.zoomLevel-2*s;s>r&&(i=0),r>=s&&s+h>r&&(i=1),r>=s+h&&(i=2);var d="../../../../../../../webmap0.map.bdstatic.com/newmap/static/common/images/panorama/indoor_marker_24_c5cb82c.png"/*tpa=http://webmap0.map.bdstatic.com/newmap/static/common/images/panorama/indoor_marker_24_c5cb82c.png*/,p="../../../../../../../webmap0.map.bdstatic.com/newmap/static/common/images/panorama/indoor_marker_8_2851109.png"/*tpa=http://webmap0.map.bdstatic.com/newmap/static/common/images/panorama/indoor_marker_8_2851109.png*/;this.markers=[],this.camera.setPosition({x:a.x+parseInt(this.tileWrap.style.left),y:a.y+parseInt(this.tileWrap.style.top)}),this.camera.setDirection(a.defaultAngle);for(var l=0;l<this.indoorInfo.points.length;l++)o=this.indoorInfo.points[l],t=n[i],e={dom:T.dom.create("div",{"data-id":o.id,title:o.name,style:"position:absolute;width:"+t[0]+"px;height:"+t[1]+"px;top:"+(o.y-t[1]/2)+"px;left:"+(o.x-t[0]/2)+"px;background:url("+d+") no-repeat "+t[2]+"px "+t[3]+"px; _background-image:url("+p+");"}),id:o.id,x:o.x,y:o.y},this.markers.push(e),this.markerLayer.appendChild(e.dom)},_clickMarker:function(e){this.adjustCenter(e),this.indoorInfo.currPoint=e,this.camera&&(this.camera.setPosition({x:e.x+this.tileWrap.offsetLeft,y:e.y+this.tileWrap.offsetTop}),e.heading&&this.camera.setDirection(e.heading)),this.renderView({x:parseInt(this.tileWrap.style.left),y:parseInt(this.tileWrap.style.top)}),this.cinfo.panoView.switchPano(e.dom.getAttribute("data-id"))}}),t.exports=i});