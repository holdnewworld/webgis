define("common:widget/ui/PanoOverlay/PanoOverlay.js",function(e,t,i){function o(e,t){e&&e instanceof BMap.Point&&(this._map=null,this._mapc=null,this._container=null,this._position=e,this._size=null,this._viewsetting=0,this._moving=!1,this._nowviewtype=0,this._viewtypetimer=null,this._dragMovePixel=null,this._arrowDirection="-168px -72px",this._direction=null,t=t||{},this._opts=baidu.extend(baidu.extend(this._opts||{},{enableDragging:!0,anchor:new BMap.Size(-40,-18)}),t),this.MAP_PAN_DIRECTION=[[0,0],[-1,-1],[-1,0],[-1,1],[0,1],[1,1],[1,0],[1,-1],[0,-1]],this.DIV_ROTATE_DIRECTION=[[0,-1200],[22.5,-1120],[45,-1040],[67.5,-960],[90,-880],[112.5,-800],[135,-720],[157.5,-640],[180,-560],[202.5,-480],[225,-400],[247.5,-320],[270,-240],[292.5,-160],[315,-80],[337.5,-0]],this.ARROW_ROTATE_DIRECTION=[[0,-360],[22.5,-336],[45,-312],[67.5,-288],[90,-264],[112.5,-240],[135,-216],[157.5,-192],[180,-168],[202.5,-144],[225,-120],[247.5,-96],[270,-72],[292.5,-48],[315,-24],[337.5,-0]])}function n(e,t,i){0!=t.indexOf("on")&&(t="on"+t);var o=new baidu.lang.Event(t);if(i)for(var n in i)o[n]=i[n];e.dispatchEvent(o)}function a(e){var e=window.event||e;baidu.event.preventDefault(e),baidu.event.stopPropagation(e)}var r=e("common:widget/ui/util/util.js");o.prototype=new BMap.Overlay,o.prototype.initialize=function(e){try{var t=this,i=t._container=document.createElement("div"),o=document.createElement("div"),n="url(http://webmap1.map.bdstatic.com/newmap/static/common/images/panorama/pano_markers_1f7469f.png)!important";t._map=e,t._div=i,t._arrow=o,t._mapc=e.getContainer(),t._bgu=n;var a=baidu.dom.getPosition(this._mapc);return this._mapcTop=a.top,this._mapcLeft=a.left,t._rotating=!1,t._setDefCursor(),baidu.extend(i.style,{position:"absolute",zIndex:BMap.Overlay.getZIndex(t._position.lat),backgroundRepeat:"no-repeat",backgroundPosition:"-560px 0",cursor:"pointer",height:"36px",width:"80px"}),baidu(i).addClass("pano-overlay-ie"),baidu.extend(o.style,{position:"absolute",cursor:t.defaultCursor,backgroundRepeat:"no-repeat",backgroundPosition:"-168px -72px",left:"27px",height:"42px",width:"24px",marginTop:"-18px"}),baidu(o).addClass("pano-overlay-ie"),i.appendChild(o),t._map.getPanes().labelPane.appendChild(i),t._setEventDispath(),i}catch(r){"undefined"!=typeof alog&&alog("http://webmap1.map.bdstatic.com/newmap/static/common/widget/ui/PanoOverlay/exception.fire","catch",{msg:r.message||r.description,path:"common:widget/ui/PanoOverlay/PanoOverlay.js",ln:174})}},o.prototype.draw=function(){var e=this._opts.anchor,t=this._map.pointToOverlayPixel(this._position);this._container.style.left=t.x+e.width+"px",this._container.style.top=t.y+e.height+"px"},o.prototype.enableDragging=function(){this._opts.enableDragging=!0},o.prototype.disableDragging=function(){this._opts.enableDragging=!1},o.prototype.getPosition=function(){return this._position},o.prototype.setPosition=function(e){!e instanceof BMap.Point||(this._position=e,this.draw())},o.prototype.getDirection=function(){return this._direction},o.prototype.setDirection=function(e){if(!isNaN(e)){var t=this._direction=e;this._getRotateDirection(t)}},o.prototype.setOffset=function(){var e=baidu.dom.getPosition(this._mapc);this._mapcTop=e.top,this._mapcLeft=e.left},o.prototype.remove=function(){n(this,"onremove"),this._container&&r.purgeEvents(this._container),this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container)},o.prototype._setDefCursor=function(){T.browser.firefox?(this.defaultCursor="-moz-grab",this.draggingCursor="-moz-grabbing"):T.browser.chrome||T.browser.safari?(this.defaultCursor="url(http://webmap0.map.bdstatic.com/newmap/static/common/images/api/openhand.cur) 8 8, default",this.draggingCursor="url(http://webmap1.map.bdstatic.com/newmap/static/common/images/api/closedhand.cur) 8 8, default"):(this.defaultCursor="url(http://webmap0.map.bdstatic.com/newmap/static/common/images/api/openhand.cur)",this.draggingCursor="url(http://webmap1.map.bdstatic.com/newmap/static/common/images/api/closedhand.cur)")},o.prototype._getRotateDirection=function(e){if(!isNaN(e)){{var t=this.DIV_ROTATE_DIRECTION,i=this.ARROW_ROTATE_DIRECTION,o=0,n=e-31.75;i.length}if(n>t[15][0])this._div.style.backgroundPosition=t[15][1]+"px 0",this._arrow.style.backgroundPosition=this._arrowDirection=i[15][1]+"px -72px";else for(var o=0;16>o;o++)if(n<t[o][0]){this._div.style.backgroundPosition=t[o][1]+"px 0",this._arrow.style.backgroundPosition=this._arrowDirection=i[o][1]+"px -72px";break}}},o.prototype._getMoveDirection=function(e,t){if(!isNaN(e)&&!isNaN(t)){var i=-1,o=e-this.preX;return this.preX>5&&0>o?i=0:this.preX>5&&o>0&&(i=1),this.preX=e,this.preY=t,i}},o.prototype._setEventDispath=function(){function e(e){var e=window.event||e,i=e.pageX||e.clientX||0,o=e.pageY||e.clientY||0,n=new BMap.Pixel(i,o),a=t._map.pixelToPoint(n);return{pixel:n,point:a}}var t=this,i=t._container,o=t._arrow,r=t._mapc,p=!1,s=!1,l=null;o.onclick=function(e){n(t,"onarrclick"),a(e)},i.onclick=function(i){var o=e(i),r=o.pixel.x-t._mapcLeft,p=o.pixel.y-t._mapcTop,s=t._map.pointToPixel(t._position).x,l=t._map.pointToPixel(t._position).y,u=180-Math.atan2(r-s,p-l)/3.1415926/2*360;t._getRotateDirection(u),n(t,"oncircleclick",{point:o.point,pixel:o.pixel,angle:u}),a(i)},i.onmousedown=function(o){var s=e(o),u=s.pixel.x-t._mapcLeft,c=s.pixel.y-t._mapcTop,m=t._map.pointToPixel(t._position).x,g=t._map.pointToPixel(t._position).y,h=180-Math.atan2(u-m,c-g)/3.1415926/2*360;l=s.pixel,p=!0,t._rotating||(t._rotating=!0,i.setCapture?(baidu.on(i,"onmousemove",_),baidu.on(i,"onmouseup",d)):(baidu.on(window,"onmousemove",_),baidu.on(window,"onmouseup",d))),n(t,"onrotatestart",{point:s.point,pixel:s.pixel,angle:h}),i.setCapture&&i.setCapture(),r.style.MozUserSelect="none",r.style.KhtmlUserSelect="none",r.style.WebkitUserSelect="none",r.unselectable="on",r.onselectstart=function(){return!1},a(o)},o.onmousedown=function(p){var _=e(p);return o.setCapture?(baidu.on(o,"onmousemove",c),baidu.on(o,"onmouseup",u)):(baidu.on(window,"onmousemove",c),baidu.on(window,"onmouseup",u)),t._opts.enableDragging?(l=_.pixel,n(t,"ondragstart",{point:t._position}),s=!0,o.style.cursor=t.draggingCursor,baidu(i).removeClass("pano-overlay-ie"),o.setCapture&&o.setCapture(),r.style.MozUserSelect="none",r.style.KhtmlUserSelect="none",r.style.WebkitUserSelect="none",r.unselectable="on",r.onselectstart=function(){return!1},void a(p)):void a(p)};var u=function(_){e(_);return n(t,"onmouseup",{point:t._position}),o.releaseCapture?(baidu.un(o,"onmousemove",c),baidu.un(o,"onmouseup",u)):(baidu.un(window,"onmousemove",c),baidu.un(window,"onmouseup",u)),t._opts.enableDragging?(o.releaseCapture&&o.releaseCapture(),o.style.backgroundPosition=t._arrowDirection,baidu(i).addClass("pano-overlay-ie"),o.style.cursor=t.defaultCursor,clearInterval(t._viewtypetimer),n(t,"ondragend",{point:t._position}),s=!1,p=!1,l=null,r.style.MozUserSelect="",r.style.KhtmlUserSelect="",r.style.WebkitUserSelect="",r.unselectable="off",r.onselectstart=function(){},void a(_)):void a(_)},c=function(i){if(t._opts.enableDragging&&s){var r=e(i),p=t._map.pointToPixel(t._position),u=r.pixel.x-l.x+p.x,c=r.pixel.y-l.y+p.y;switch(l=r.pixel,t._getMoveDirection(u,c)){case-1:o.style.backgroundPosition="-168px -72px";break;case 0:o.style.backgroundPosition="-408px -72px";break;case 1:o.style.backgroundPosition="-432px -72px";break;default:o.style.backgroundPosition="-168px -72px"}m(i),n(t,"ondragging",{point:t._position}),a(i)}},_=function(i){if(p){var o=e(i),r=o.pixel.x-t._mapcLeft,s=o.pixel.y-t._mapcTop,l=t._map.pointToPixel(t._position).x,u=t._map.pointToPixel(t._position).y,c=t._direction=180-Math.atan2(r-l,s-u)/3.1415926/2*360;t._getRotateDirection(c),n(t,"onrotating",{point:o.point,pixel:o.pixel,angle:c}),a(i)}},d=function(o){if(t._rotating){t._rotating=!1,i.releaseCapture?(baidu.un(i,"onmousemove",_),baidu.un(i,"onmouseup",d)):(baidu.un(window,"onmousemove",_),baidu.un(window,"onmouseup",d)),i.releaseCapture&&i.releaseCapture();var p=e(o);n(t,"onrotateend",{point:p.point,pixel:p.pixel,angle:t._direction}),r.style.MozUserSelect="",r.style.KhtmlUserSelect="",r.style.WebkitUserSelect="",r.unselectable="off",r.onselectstart=function(){},a(o)}},m=function(i){if(t._opts.enableDragging&&s){var o=e(i),n=(t._map.pointToPixel(t._position),o.pixel.x-t._mapcLeft),a=o.pixel.y-t._mapcTop;l=o.pixel,t._position=t._map.pixelToPoint(new BMap.Pixel(n,a));var p=null,u=n/r.offsetWidth,c=a/r.offsetHeight,p=g(u,c);if(t._nowviewport&&p===t._nowviewport)t.draw();else if(0==p)t._position=t._map.pixelToPoint(new BMap.Pixel(n,a)),t.draw(),t._nowviewport=0,clearInterval(t._viewtypetimer);else{clearInterval(t._viewtypetimer),t._nowviewport=p,t.draw();{var _=t._map.pointToPixel(t._map.getCenter()).x,d=t._map.pointToPixel(t._map.getCenter()).y;t._map.pixelToPoint(new BMap.Pixel(_,d))}t._viewtypetimer=setInterval(function(){t._map.panBy(-8*t.MAP_PAN_DIRECTION[p][0],-8*t.MAP_PAN_DIRECTION[p][1],null,!0),__x=t._map.pointToPixel(t._position).x+8*t.MAP_PAN_DIRECTION[p][0],__y=t._map.pointToPixel(t._position).y+8*t.MAP_PAN_DIRECTION[p][1],t._position=t._map.pixelToPoint(new BMap.Pixel(__x,__y)),t.draw()},30)}}},g=function(e,t){if(!isNaN(e)&&!isNaN(t)){var i,o=.2,n=.2;return o>e?i=n>t?1:t>1-n?3:2:e>1-o?i=n>t?7:t>1-n?5:6:n>t?i=8:t>1-n?i=4:(i=0,i=0),i}}},i.exports=o});