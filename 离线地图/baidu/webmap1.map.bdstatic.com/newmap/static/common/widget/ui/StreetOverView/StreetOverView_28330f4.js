define("common:widget/ui/StreetOverView/StreetOverView.js",function(e,t,n){function i(e){e=e||{},baidu.lang.Class.call(this),this.dom=baidu.g(e.dom),this.cinfo=e,this.arrows=[],this.arrowMarkers=[],this.render(),this.initialize()}var o=window.Pano=window.Pano||{},a=e("common:widget/com/componentManager.js"),r=e("common:widget/ui/fullScreen/fullScreen.js"),s=(e("common:widget/ui/mapInfo/mapInfo.js"),e("common:widget/ui/PanoService/PanoService.js")),d=e("common:widget/ui/PanoOverlay/PanoOverlay.js"),v=e("common:widget/ui/PanoUtil/PanoUtil.js"),p=e("common:widget/ui/config/config.js"),l=p.modelConfig,c=(p.mapConfig,e("common:widget/ui/mapUtil/mapUtil.js"));baidu.lang.inherits(i,baidu.lang.Class,"StreetOverView"),baidu.object.extend(i.prototype,{point:null,level:0,panoType:o.PANO_TYPE_STREET,overFrame:null,mapContainer:null,miniMap:null,panoView:null,panoMode:"day",render:function(){try{var e=this.cinfo;if(!e.point)return;this.point=e.point,this.level=e.level,this.overFrame=e.overFrame,this.panoView=e.panoView,this.mapContainer=e.mapContainer}catch(t){"undefined"!=typeof alog&&alog("http://webmap1.map.bdstatic.com/newmap/static/common/widget/ui/StreetOverView/exception.fire","catch",{msg:t.message||t.description,path:"common:widget/ui/StreetOverView/StreetOverView.js",ln:58})}},initialize:function(){try{this.initMiniMap(this.point,this.level),this.initPanoOverlay(),this.bindPanoEvents(),this.bindFrameEvents(),this.addOverlays()}catch(e){"undefined"!=typeof alog&&alog("http://webmap1.map.bdstatic.com/newmap/static/common/widget/ui/StreetOverView/exception.fire","catch",{msg:e.message||e.description,path:"common:widget/ui/StreetOverView/StreetOverView.js",ln:68})}},initMiniMap:function(e,t){var n=BMAP_NORMAL_MAP,i=this.miniMap=new BMap.Map(this.mapContainer,{coordType:BMAP_COORD_MERCATOR,zoomLevelMin:3,mapType:n});i.enableScrollWheelZoom(),i.enableInertialDragging(),i.enableContinuousZoom(),i.centerAndZoom(e,t),i.setDefaultCursor("pointer"),this.addPanoLayer(i),this.stdMapCtrl=new BMap.NavigationControl({offset:new BMap.Size(10,8),type:BMAP_NAVIGATION_CONTROL_ZOOM,anchor:BMAP_ANCHOR_TOP_RIGHT}),i.addControl(this.stdMapCtrl),this.setPanoPoiClick(i)},addPanoLayer:function(t){var n=this;this.roadLayer?this.roadLayer.show():e.async("common:widget/ui/StreetViewLayer/StreetViewLayer.js",function(e){n.roadLayer=new e({map:t}),n.roadLayer.show()})},setPanoPoiClick:function(t){var n=this;n.panoPoiClick?n.panoPoiClick.refresh(t):e.async("common:widget/ui/PanoPoiClick/PanoPoiClick.js",function(e){n.panoPoiClick=new e(t,"panoPoiClick")})},initPanoOverlay:function(){this.prePos=this.point,this.stOverlay=new d(this.point),this.miniMap.addOverlay(this.stOverlay),this.miniMap.setCenter(this.point),this.getCurCity(),this.bindMkrEvents()},bindFrameEvents:function(){var e=this,t=this.miniMap,n=this.stOverlay,i=this.overFrame,o=this.guid;e.setMapCenter=function(){e._setCenter()},e.setMapCenterDelay=function(){window.setTimeout(function(){e._setCenter()},100)},e.setVisPos=function(e){n.setOffset(),e.visible&&window.setTimeout(function(){t.setCenter(n.getPosition())},100)},e.mapClickFunc=function(t){e.getPanoInfo(t.point)},i.addEventListener("onMiniSize",e.setMapCenter),i.addEventListener("onResize",e.setMapCenter),i.addEventListener("onAbsorb",e.setMapCenter),i.addEventListener("onDragEnd",e.setMapCenter),i.addEventListener("onWindowResize",e.setMapCenter),i.addEventListener("onHolderResize",e.setMapCenterDelay),i.addEventListener("onVisibleChange",e.setVisPos),t.addEventListener("click",e.mapClickFunc),t.addEventListener("maptypechange",function(t){t.mapType;e.roadLayer&&e.roadLayer.update()},o+"_maptypechange"),t.addEventListener("zoomstart",function(){e._centerPt=t.getCenter()},o+"_zoomstart"),t.addEventListener("zoomend",function(){t.setCenter(e._centerPt),v.level=e.level=t.getZoom()},o+"_zoomend"),this.hasFrameEvents=!0},removeFrameEvents:function(){if(this.hasFrameEvents){var e=this,t=this.miniMap,n=this.overFrame,i=this.guid;n.removeEventListener("onMiniSize",e.setMapCenter),n.removeEventListener("onResize",e.setMapCenter),n.removeEventListener("onAbsorb",e.setMapCenter),n.removeEventListener("onDragEnd",e.setMapCenter),n.removeEventListener("onHolderResize",e.setMapCenterDelay),n.removeEventListener("onVisibleChange",e.setVisPos),n.removeEventListener("onWindowResize",e.setMapCenter),t.removeEventListener("click",e.mapClickFunc),t.removeEventListener("maptypechange",i+"_maptypechange"),t.removeEventListener("zoomstart",i+"_zoomstart"),t.removeEventListener("zoomend",i+"_zoomend"),t.removeEventListener("moveend",i+"_moveend"),e.setMapCenter=null,e.setVisPos=null,e.mapClickFunc=null,e.mapZoom=null,this.hasFrameEvents=!1}},bindPanoEvents:function(){{var t=this.panoView,n=r,i=e("common:widget/ui/mapInfo/mapInfo.js"),o=this,a=this.miniMap,s=this.overFrame;this.guid}o.panoChangedFunc=function(e){var t=e.pano,n=new BMap.Point(t.x,t.y),i=t.heading||0;o.prePos=n,o.setMkrPos(n),o.stOverlay.setDirection(i),o.panoMode=t.mode||o.panoMode},o.povChangedFunc=function(e){var t=e.pov;o.stOverlay.setDirection(t.heading)},o.setPosition=function(){if(0!=s.layoutType&&o.stOverlay){o.stOverlay.setOffset();var e=o.stOverlay.getPosition();a.setCenter(e)}},t.addEventListener("onPanoChanged",o.panoChangedFunc),t.addEventListener("onPovChanged",o.povChangedFunc),n.addEventListener("onFullScreen",o.setPosition),n.addEventListener("onExitFull",o.setPosition),i.addEventListener("onShowSide",o.setPosition),i.addEventListener("onHideSide",o.setPosition)},removePanoEvents:function(){var t=this.panoView,n=r,i=e("common:widget/ui/mapInfo/mapInfo.js"),o=this;t.removeEventListener("onPanoChanged",o.panoChangedFunc),t.removeEventListener("onPovChanged",o.povChangedFunc),n.removeEventListener("onFullScreen",o.setPosition),n.removeEventListener("onExitFull",o.setPosition),i.removeEventListener("onShowSide",o.setPosition),i.removeEventListener("onHideSide",o.setPosition),o.panoChangedFunc=null,o.povChangedFunc=null,o.setPosition=null},bindMkrEvents:function(){var e=this.stOverlay,t=this;t.rotatFunc=function(e){t.setViewPov(e.angle)},t.dragendFunc=function(e){t.getPanoInfo(e.point)},e.addEventListener("oncircleclick",t.rotatFunc),e.addEventListener("onrotating",t.rotatFunc),e.addEventListener("onrotateend",t.rotatFunc),e.addEventListener("ondragend",t.dragendFunc)},removeMkrEvents:function(){var e=this.stOverlay,t=this;e&&(e.removeEventListener("oncircleclick",t.rotatFunc),e.removeEventListener("onrotating",t.rotatFunc),e.removeEventListener("onrotateend",t.rotatFunc),e.removeEventListener("ondragend",t.dragendFunc),t.rotatFunc=null,t.dragendFunc=null)},removeEvents:function(){this.removeFrameEvents(),this.removePanoEvents(),this.removeMkrEvents(),this.stOverlay&&this.stOverlay.hide(),this.miniMap=null,this.stOverlay=null,this.tipLabel=null},showTip:function(e){if(this.tipLabel)this.tipLabel.setPoint(e),this.tipLabel.show(),this.delayHide();else{var t={point:e,offset:new BMap.Size(0,0)};this.tipLabel=new BMap.Label("<div style='text-align:center;margin-top:5px;'>此处无全景</div ><div style='color:#4869a5;' >请点击蓝色路网</div>",t),this.tipLabel.setStyle({backgroundColor:"#fff",borderColor:"#b1b1b1",borderWidth:"1px",fontSize:"12px",height:"50px",lineHeight:"20px",fontFamily:"微软雅黑"}),this.miniMap.addOverlay(this.tipLabel),this.delayHide()}},delayHide:function(){var e=this;this.tipTimer&&window.clearTimeout(this.tipTimer),this.tipTimer=window.setTimeout(function(){e.tipLabel&&e.tipLabel.hide()},2e3)},resetPos:function(){this.prePos&&this.stOverlay&&(this.stOverlay.setPosition(this.prePos),this.miniMap.panTo(this.prePos))},getPanoInfo:function(e){this.tipLabel&&this.tipLabel.hide();var t=this,n=e;s.getStreetBriefByLocation({point:n,level:t.miniMap.getZoom(),mode:t.panoMode},function(e){if(0==e.error&&e.content&&e.content.id){var i=e.content.id,o=e.content.point;t.prePos=o,t.setMkrPos(o),t.panoView&&t.panoView.setPano(i,{panoType:t.panoType}),t.getCurCity()}else t.showTip(n),t.resetPos()},this)},setViewPov:function(e){if(this.tipLabel&&this.tipLabel.hide(),!isNaN(e)){var t={heading:parseInt(e),pitch:0};this.panoView.setPov(t)}},setMkrPos:function(e){this.stOverlay.setPosition(e),this.miniMap.setCenter(e)},getCurCity:function(){var e=this,t=this.miniMap,n=t.getBounds(),i=n.minX+","+n.minY+";"+n.maxX+","+n.maxY,o=t.getZoom(),a=(new Date).getTime();baidu.ajax("/?newmap=1&qt=ncent&ie=utf-8&b="+i+"&l="+o+"&t="+a,{dataType:"json",success:function(t){t&&t.content&&t.current_city&&e.setCurCity(t.current_city)},error:function(){}})},setCurCity:function(e){var t=o.PanoInteract.cityName=e.name,n=o.PanoInteract.cityCode=e.code;n!=l.cityCode&&a.go("cur&wd="+encodeURIComponent(t),{cinfo:{isFromPano:!0},onload:function(){}})},_setCenter:function(){if(this.stOverlay){var e=this.stOverlay.getPosition();this.stOverlay.setOffset(),this.miniMap.setCenter(e)}},update:function(e,t){t=t||this.level,e&&t&&this.miniMap.centerAndZoom(e,t)},redrawArrow:function(){for(var e=0;e<this.arrowMarkers.length;e++)this.miniMap.removeOverlay(this.arrowMarkers[e]);this.arrowMarkers=[];for(var e=0;e<this.arrows.length;e++)this.arrowMarkers=this.arrowMarkers.concat(c.addArrow(this.arrows[e].split(";"),this.miniMap))},addOverlays:function(){var e=this,t=window.currentComponent;if(t&&t.getOverlays){this.viewportPoints=[];var n,i=t.getOverlays(),o=i.routes;if(o)for(var a=0;a<o.length;a++)n=c.addRoute(o[a].points,o[a].type,void 0,this.miniMap),this.viewportPoints=this.viewportPoints.concat(n.points);var r=i.drRoutes;if(r)for(var a=0;a<r.length;a++){n=c.addDrRoute(r[a].flag,r[a].obj,!1,this.miniMap);for(var a=0;a<n.length;a++)this.viewportPoints=this.viewportPoints.concat(n[a].points)}var s=i.transMarkers;if(s)for(var a=0;a<s.length;a++)c.addTransPoi(s[a].point,s[a].type,s[a].text,this.miniMap);var d=i.destMarkers;if(d)for(var a=0;a<d.length;a++)c.addDestPoi(d[a].point,d[a].text,d[a].type,void 0,this.miniMap);var v=i.arrows;v&&(this.arrows=v,this.redrawArrow(),this.miniMap.addEventListener("zoomend",function(){e.redrawArrow()},this.guid+"_zoomend"),this.miniMap.addEventListener("moveend",function(){e.redrawArrow()},this.guid+"_moveend"));var p=i.tips;if(p)for(var a=0;a<p.length;a++)c.createTip(p[a].content,p[a].className,p[a].opts,this.miniMap);var l=i.markers;if(l)for(var a=0;a<l.length;a++)this.miniMap.addOverlay(new BMap.Marker(l[a].point,{icon:l[a].icon,title:l[a].title}))}}}),n.exports=i});