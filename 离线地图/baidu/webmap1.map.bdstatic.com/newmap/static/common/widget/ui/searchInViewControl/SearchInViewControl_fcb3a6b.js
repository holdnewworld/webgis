define("common:widget/ui/searchInViewControl/SearchInViewControl.js",function(t,e,i){var o=t("common:widget/ui/tools/tools.js"),n=t("common:widget/com/componentManager.js"),s=(t("common:widget/ui/mapInfo/mapInfo.js"),t("common:widget/ui/config/config.js")),a=t("common:widget/ui/Traffic/Traffic.js"),r=t("common:widget/ui/util/util.js"),c=s.modelConfig,h=(s.mapConfig,t("common:widget/ui/genericRequest/GenericRequest.js"));window.GRControll||(window.GRControll=new h({toolAreaId:"GR_Select"}));var p=function(){var t=this;t.initialize()};p.prototype.initialize=function(t){try{this._map=t,this.isOpen=!1,this.hasResult=!1,this.curKw="",this.listeners=[],this.resultCount=10,this.reqObj=null,this.rightPos=13,this.heightType=-1,this.curSearchCPt=null,this._container=T.g("tool_sehInView")}catch(e){"undefined"!=typeof alog&&alog("http://webmap1.map.bdstatic.com/newmap/static/common/widget/ui/searchInViewControl/exception.fire","catch",{msg:e.message||e.description,path:"common:widget/ui/searchInViewControl/SearchInViewControl.js",ln:59})}},p.prototype.setStatus=function(){var t=this;t.isMoving||(0==t.heightType?(t.sivPop.setHeight(215),t.slideEffect({s_mt:0,e_mt:-182,s_h:215,e_h:33},function(){t.deletePop()}),t.heightType=-1):1==t.heightType&&(t.sivPop.setHeight(65),t.slideEffect({s_mt:0,e_mt:-32,s_h:65,e_h:33},function(){t.deletePop()}),t.heightType=-1))},p.prototype.resetClassName=function(){this._container._opened=!1,T.rc(this._container,"span_focus")},p.prototype.deletePop=function(){this.sivPop&&(this.sivPop.main.parentNode.removeChild(this.sivPop.main),this.sivPop=null,this.exit(!0))},p.prototype.remove=function(){var t=document.getElementById("searchInView"+this.guid);t&&t.parentNode&&(t.onclick=null,t.parentNode.removeChild(t))},p.prototype._getRightPos=function(){if(T.G("MapInfo")&&!isNaN(parseInt(T.G("MapInfo").style.width))){var t=this.rightPos+parseInt(T.G("MapInfo").style.width);return t>0?t:0}return this.rightPos+280},p.prototype.setResult=function(t){this.hasResult=!!t.hasResult,this.curKw=t.kw,this.curSearchCPt=t.cpt},p.prototype.checkNeed2Go=function(){var t=this._map;if(!this.curKw)return!1;if(!this.curSearchCPt)return!1;var e=t.pointToPixel(this.curSearchCPt),i=t.pointToPixel(t.centerPoint),o=Math.abs(e.x-i.x),n=Math.abs(e.y-i.y);return o>=.3*t.width||n>=.3*t.height?!0:!1},p.prototype.rego=function(){var t=this._map,e=t.getBounds(),i="("+e.minX+","+e.minY+";"+e.maxX+","+e.maxY+")";if(this.curKw){var o=window.location.pathname+c.DATA_URL+"bd&c="+c.cityCode+"&format=1&ie=utf-8&pn=0&rn="+this.resultCount+"&wd="+encodeURIComponent(this.curKw)+"&ar="+i+"&b="+i+"&l="+t.zoomLevel+"&t="+(new Date).getTime();baidu.ajax(o,{dataType:"json",success:function(t){if(t&&t.content&&me.inViewHashCode){var e=Instance(me.inViewHashCode);e&&(e.cinfo||(e.cinfo={}),e.cinfo.rego=!0,e.cinfo.isPos=!1,me.sivPop.content.innerHTML=e.render(null,t),e.initialize())}},error:function(t,e){console.log(o,e)}})}},p.prototype.clear=function(){this.inViewHashCode&&Instance(this.inViewHashCode)&&Instance(this.inViewHashCode).unload()},p.prototype.exit=function(t){if(0!=this.isOpen){this.isOpen=!1;var e=this._map,i=this;if(t?i.sivPop&&(i.sivPop.close(),i.sivPop=null):i.deletePop(),i.hasResult&&(e.closeInfoWindow(),window.GRControll.clearCache(),window.GRControll.clearGRMap(),Instance(i.inViewHashCode).clearMarkers(),i.hasResult=!1),Instance(i.inViewHashCode)&&Instance(i.inViewHashCode).restorePreSearch(),i.listeners)for(var o=0,n=i.listeners.length;n>o;o++){var s=i.listeners[o];s.obj.removeEventListener&&s.obj.removeEventListener(s.type,s.cbk)}t||(i.curKw=""),i.curSearchCPt=null,i.resetClassName()}},p.prototype.getResultCount=function(){return this.resultCount},p.prototype.isInUse=function(){return!!this.curKw},p.prototype.getPreModelName=function(){return this.preModel&&this.preModel._className},p.prototype.getPreModel=function(){return this.preModel},p.prototype.prepare=function(){var t=(this._map,this),e=window.currentComponent._className,i=window.currentComponent;"SearchInView"==e&&i&&""!=i.json.result.wd&&""==this.curKw&&(this.curKw=i.json.result.wd),t.hasClickButton||(t.curKw=""),a.exit(),t.sivPop?t.setPopStatus():t.showViewPop()},p.prototype.setPopStatus=function(){var t=this;window.trafficCtrl&&(trafficCtrl.close(),trafficCtrl.markers=null),window.currentComponent&&"NavTrans"===window.currentComponent._className?window.driveCtrl&&driveCtrl.menu(!1):window.driveCtrl&&driveCtrl.hide(!0),t.sivPop.show(),this.setPopupHeight(""==this.curKw?1:2),t.preModel=n.get(window.currentComponent._className),t.isOpen=!0,this._container._opened=!0,this._container.className.indexOf("span_focus")<0&&T.ac(this._container,"span_focus"),baidu("a.siv_result_change_link")&&(baidu("a.siv_result_change_link").off("click"),baidu("a.siv_result_change_link").on("click",function(e){addStat("indextool.searchinview.reopensearchinview"),t.clearGo(),e.preventDefault()}))},p.prototype.showViewPop=function(){var e=this;t.async("common:widget/ui/Popup/Popup.js",function(t){e.sivPop=new t({title:"在屏幕范围内搜索",content:""==e.curKw?e.setSIVContent():e.getResultHTML(e.curKw),width:271,addDom:"tool_container",closeButton:"<button id='sivCtrlCloseBtn' style='position:absolute;border:0;cursor:pointer;top:5px;right:4px;width:12px;height:12px; background:url(http://webmap1.map.bdstatic.com/newmap/static/common/images/sehInView_dce8b8b.png) no-repeat -100px -40px;'></button>",clickClose:!1,closeEffect:function(){0==e.heightType?(e.sivPop.setHeight(215),e.slideEffect({s_mt:0,e_mt:-182,s_h:215,e_h:33},function(){e.deletePop()}),e.heightType=-1):1==e.heightType&&(e.sivPop.setHeight(65),e.slideEffect({s_mt:0,e_mt:-32,s_h:65,e_h:33},function(){e.deletePop()}),e.heightType=-1)}}),e.sivPop.render(),e.sivPop.getDom()._anchor=1,e.sivPop.getDom()._offset={x:8,y:34},e.sivPop.getDom().style.right="125px",e.sivPop.getDom().style.top="29px",e.sivPop.getDom().style.zIndex=1,e.sivPop.content.style.paddingLeft="10px",e.sivPop.getDom().onclick=function(t){t=t||window.event,r.stopBubble(t)},e.bindSearchEvents(),e.setPopStatus()})},p.prototype.bindSearchEvents=function(){var t=this;baidu("ul.siv_list").delegate("a","click",function(e){t.search(this),e.preventDefault()}),baidu("form.search_from").on("submit",function(e){t.search(),e.preventDefault()}),baidu("#siv_kw").on("focus",function(){t.kwFocus(this)}),baidu("#siv_kw").on("blur",function(){t.kwBlur(this)}),baidu("#sivSubmitBtn").on("mouseover",function(e){t.btnOver(e,this)}),baidu("#sivSubmitBtn").on("mouseout",function(e){t.btnOut(e,this)}),baidu("#sivSubmitBtn").on("mouseup",function(e){t.btnOver(e,this)}),baidu("#sivSubmitBtn").on("mousedown",function(e){t.btnDown(e,this)})},p.prototype.setSIVContent=function(){var t={jiudian:["快捷酒店","星级酒店","旅馆","如家","7天"],canyin:["餐馆","快餐","肯德基","麦当劳","咖啡厅"],jiayou:["楼盘小区","公交车站","银行","医院","超市","ATM","停车场","加油站"],dianying:["KTV","电影院","网吧","酒吧","健身中心"]},e='<div id="siv_main" class="blueC"><ul class="siv_list">';for(var i in t){var o=t[i];e+='<li class="'+i+'"><span></span>';for(var n=0;n<o.length;n++)e+='<a href="javascript:void(0)" >'+o[n]+"</a>";e+="</li>"}return e+="</ul>",e+='<div class="siv_sec">',e+='<form class="search_from" >',e+='<input id="siv_kw" value="查找其他关键词" class="siv_txt" type="text" autocomplete="off" />',e+='<input value="搜索" type="submit" class="siv_btn" id="sivSubmitBtn"  />',e+="</form></div>"},p.prototype.kwFocus=function(t){"查找其他关键词"==t.value&&(t.value="",T.ac(t,"siv_txt_hover"))},p.prototype.kwBlur=function(t){""==t.value&&(t.value="查找其他关键词",T.rc(t,"siv_txt_hover"))},p.prototype.search=function(t,e){var i="",o="0",s=t&&t.innerHTML,a=0;switch(s){case"快捷酒店":addStat("indextool.searchinview.expresshotel");break;case"星级酒店":addStat("indextool.searchinview.starratedhotel");break;case"旅馆":addStat("indextool.searchinview.hotel");break;case"餐馆":addStat("indextool.searchinview.restaurant");break;case"公交车站":addStat("indextool.searchinview.busstation");break;case"楼盘小区":addStat("indextool.searchinview.community");break;case"银行":addStat("http://webmap1.map.bdstatic.com/newmap/static/common/widget/ui/searchInViewControl/indextool.searchinview.bank");break;case"如家":addStat("indextool.searchinview.homeinn");break;case"超市":addStat("indextool.searchinview.supermarket");break;case"7天":addStat("indextool.searchinview.7daysinn");break;case"医院":addStat("indextool.searchinview.hospital");break;case"电影院":addStat("indextool.searchinview.cinema");break;case"网吧":addStat("indextool.searchinview.netcafe");break;case"快餐":addStat("indextool.searchinview.fastfood");break;case"肯德基":addStat("http://webmap1.map.bdstatic.com/newmap/static/common/widget/ui/searchInViewControl/indextool.searchinview.kfc");break;case"KTV":addStat("http://webmap1.map.bdstatic.com/newmap/static/common/widget/ui/searchInViewControl/indextool.searchinview.ktv");break;case"ATM":addStat("http://webmap1.map.bdstatic.com/newmap/static/common/widget/ui/searchInViewControl/indextool.searchinview.atm");break;case"停车场":addStat("indextool.searchinview.parkinglot");break;case"麦当劳":addStat("indextool.searchinview.macdonald");break;case"咖啡厅":addStat("http://webmap1.map.bdstatic.com/newmap/static/common/widget/ui/searchInViewControl/indextool.searchinview.cafe");break;case"健身中心":addStat("indextool.searchinview.fittingcentre");break;case"酒吧":addStat("http://webmap1.map.bdstatic.com/newmap/static/common/widget/ui/searchInViewControl/indextool.searchinview.bars");break;default:addStat("indextool.searchinview.userinput")}if(t?i=t.innerHTML:(i=r.filtQuery(e||T.G("siv_kw").value),a=1,o="1"),""==i||"查找其他关键词"==i)return void T.G("siv_kw").focus();{var h=map.getBounds();"("+h.minX+","+h.minY+";"+h.maxX+","+h.maxY+")"}this.setResult({hasResult:!1,kw:i,cpt:map.centerPoint});var p=map.getBounds(),u="&b=("+p.minX+","+p.minY+";"+p.maxX+","+p.maxY+")&l="+map.zoomLevel;window.GRControll.openedMarker=null;var l=this;this.setResultHTML(null,function(){n.go("bd&fstq=1&from=webmap&c="+c.cityCode+"&pn=0&rn="+l.resultCount+"&wd="+encodeURIComponent(i)+"&sivtp="+a+u+"&bdfrom="+o,{cinfo:{exitLargeMapMode:!1},dom:baidu("#MapInfo")})})},p.prototype.setResultHTML=function(t,e){if(this.sivPop.content){var i=this;this.setPopupHeight(0,function(){i.sivPop.content.innerHTML=i.getResultHTML(t),e&&e(),baidu(".siv_result_change_link").on("click",function(t){addStat("indextool.searchinview.reopensearchinview"),i.clearGo(),t.preventDefault()})})}},p.prototype.getResultHTML=function(t){t||this.curKw;return"<div  id='siv_main' style='margin-top:0px;' class='blueC'><p class='siv_resultext'>当前搜索： <span class='important'>"+T.string.subByte(this.curKw,12,"...")+"</span><a class='siv_result_change_link' href='javascript:void(0)' >更改条件</a></p></div>"},p.prototype.clearGo=function(){this.hasResult=!1;var t=this.curKw;this.setResult({hasResult:!1,kw:t,cpt:map.centerPoint,tp:0}),this.sivPop.content&&(this.sivPop.content.innerHTML=this.setSIVContent(),this.setPopupHeight(1),this.bindSearchEvents())},p.prototype.setPopupHeight=function(t,e){this._map;if(this.sivPop)switch(t){case 0:this.sivPop.setHeight(215),this.slideEffect({s_mt:0,e_mt:-150,s_h:215,e_h:65},e),this.heightType=1;break;case 1:this.sivPop.setHeight(33),this.slideEffect({s_mt:-182,e_mt:0,s_h:33,e_h:215}),this.heightType=0;break;case 2:this.sivPop.setHeight(33),this.slideEffect({s_mt:-32,e_mt:0,s_h:33,e_h:65}),this.heightType=1}},p.prototype.hidePopup=function(){this.sivPop&&this.sivPop.hide()},p.prototype.showPopup=function(){this.sivPop&&this.sivPop.show()},p.prototype.slideEffect=function(t,e){if(t.s_mt!=t.e_mt&&t.s_h!=t.e_h&&T.G("siv_main")){var i=T.G("siv_main"),o=this,n=0;n=t.s_mt<t.e_mt?15:-15,o.seTop=t.s_mt,o.seH=t.s_h,o.isMoving=!0,o.seTime=setInterval(function(){(t.s_mt<t.e_mt?o.seTop+n>=t.e_mt:o.seTop+n<=t.e_mt)?(i.style.marginTop=t.e_mt+"px",o.sivPop.setHeight(t.e_h),clearInterval(o.seTime),o.seTime=null,o.isMoving=!1,e&&"function"==typeof e&&e()):(o.seTop+=n,o.seH+=n,i.style.marginTop=o.seTop+"px",o.sivPop.setHeight(o.seH))},20)}},p.prototype.btnOver=function(t,e){t=t||window.event,r.stopBubble(t),e.className="siv_btn siv_btn_over"},p.prototype.btnOut=function(t,e){t=t||window.event,r.stopBubble(t),e.className="siv_btn"},p.prototype.btnDown=function(t,e){t=t||window.event,r.stopBubble(t);var i=1;T.browser.ie||(i=0),t&&t.button!=i||(e.className="siv_btn siv_btn_down")},p.prototype.show=function(){this._container.style.display="block",o&&o.resetWidth()},p.prototype.hide=function(){this._container.style.display="none",o&&o.resetWidth()},i.exports=p});