define("common:widget/ui/SyncMgr/SyncMgr.js",function(t,o,a){var e=t("common:widget/ui/constant/Constant.js"),n=t("common:widget/ui/util/util.js"),i=t("common:widget/ui/userMgr/userMgr.js"),r=t("common:widget/ui/config/config.js"),c=r.modelConfig,s=(r.mapConfig,"/user"),d="/upload",l="/download",u="webmap",p=7,f=0,v={0:{ck:3,txt:"(较快捷)"},4:{ck:6,lk:2,txt:"(不坐地铁)"},2:{ck:4,txt:"(少换乘)"},3:{ck:5,lk:0,txt:"(少步行)"},5:{lk:3},6:{lk:4},t:"公交："},h={0:{ck:0,lk:0,txt:"(最少时间)"},1:{ck:1,lk:1,txt:"(最短路程)"},2:{ck:2,lk:2,txt:"(不走高速)"},t:"自驾："},g={},w={data:null,timer:null,local_data_version:null,server_data_version:null,SORT_TYPE:1,favCloudData:[],pk_dict:{0:h,5:h,1:v,6:v,7:v,2:{t:"步行："},9:{0:{ck:3,txt:"(较快捷)"},1:{ck:7,txt:"(出发较早)"},2:{ck:8,txt:"(到达较早)"},3:{lk:0},7:{lk:1},8:{lk:2},t:"公交："}},init:function(){var t=this;t.download(function(o){t.favCloudData=t.processCloudData(o.content.data),t.showAllPoi()})},processCloudData:function(t){for(var o=[],a=0,e=t.length;e>a;a++)t[a].data&&3!==t[a].data.pathtype&&o.push(t[a]);return o},getData:function(t){if(!t)return this.favCloudData.concat();for(var o=[],a=0;a<this.favCloudData.length;a++)t==this.favCloudData[a].type&&o.push(this.favCloudData[a]);return o},showAllPoi:function(t){t=t||w.favCloudData;for(var o,a=null,e=null,n=null,i=0,r=t.length;r>i;i++)a=t[i],o=parseInt(a.type,10),e=w.converToOriginal(a.data),e&&e.point&&(n=w.createMark(e,{from:"fav"}),g[a.id]=n)},createMark:function(t,o){o=o||{};var a=this,e=t.point.split("|"),n=new BMap.Point(e[0],e[1]),i=t.title,r=new BMap.Marker(n,{enableMassClear:!1,title:i});r.setTop(!0,27e7);var c=new BMap.Icon("../../../../../../../webmap2.map.bdstatic.com/newmap/static/common/images/fav-icon-map_51dcdc8.png"/*tpa=http://webmap2.map.bdstatic.com/newmap/static/common/images/fav-icon-map_51dcdc8.png*/,new BMap.Size(14,14),{infoWindowOffset:new BMap.Size(7,0)});return r.setIcon(c),r.addEventListener("click",function(){a.openInfoWnd(this,{data:t})}),map.addOverlay(r),r},openInfoWnd:function(t,o){o=o||{};var a=this,e=o.data,i=t.getPoint(),r={fav:1,title:e.title||"",content:e.content||"",uid:e.uid||""};if(e.uid){var c="/?qt=inf&uid="+e.uid+"&ie=utf-8&t="+(new Date).getTime();baidu.ajax(c,{dataType:"json",success:function(n){n&&n.content&&a.getInfoData(n,r,i,e,t,o)},error:function(){}})}else r.userSign=1,n.loadSearchInfo(function(a){var n=a.createSearchInfoWnd(r,{x:i.lng,y:i.lat,cityCode:e.cityCode});a.openSearchInfoWndPOI(n,t,o)})},getInfoData:function(t,o,a,i,r,c){var s=t.content,d=s.addr,l=s.tel,u=s.detail&&s.ty==e.GEO_TYPE_POINT||s.poiType==e.POI_TYPE_BUSLINE||s.poiType==e.POI_TYPE_SUBLINE;(s.poiType==e.POI_TYPE_BUSSTOP||s.poiType==e.POI_TYPE_SUBSTOP)&&(d=T.array.unique(d.split(";")).join("; ")),l&&(l=l.replace(/,/g,", ")),n.loadSearchInfo(function(t){var e=t.createSearchInfoWnd(T.object.extend(o,{addr:d,tel:l,hasDetail:u,detail:s.detail,ext_type:s.ext_type,uid:s.uid,poiType:s.poiType,ext:s.ext,cp:s.cp,cla:s.cla,catId:s.new_catalog_id||""}),{x:a.lng,y:a.lat,cityCode:i.cityCode});t.openSearchInfoWndPOI(e,r,c)})},checkInFav:function(t){if(t&&"share"==t.from){for(var o=t.json,a=0;a<this.favCloudData.length;a++){var e=this.converToOriginal(this.favCloudData[a].data);if(e.point==o.point&&e.title==o.title&&e.content==_sign.deCodeShare(o.content))return a}return-1}if(t&&("poi"==t.from||"nomal"==t.from)){var o=t.json;o.content&&(o.content=o.content.replace(/&nbsp;/g," "));for(var a=0;a<this.favCloudData.length;a++){var e=this.converToOriginal(this.favCloudData[a].data);if(e.point==o.point&&e.title==o.title&&e.content==o.content)return a;if(e.uid&&e.uid===o.uid)return a}return-1}},download:function(t,o){o=o||{};var a={plateform:u,local_data_version:"0",type:"",sync_data_version:"",page_index:"",page_size:"",collection:""},e=T.object.extend(a,o),i=s+l+"?"+n.jsonToQuery(e);this._get(i,t)},upload:function(t,o){if(t){"[object Object]"==Object.prototype.toString.call(t)&&(t=[].concat(t));for(var a=0,e=t.length;e>a;a++)2==t[a].action&&delete t[a].data;var n={plateform:u,post_data:this.formatData(t)},i=s+d;this._post(i,n,o)}},converToGe:function(t){if(!t)return"";var o={};if(o.name=t.title||"",o.content=(t.content||"").replace(/&nbsp;/g," "),o.geoptx=12957320,o.geopty=4825100,t.point){var a=t.point.split("|");o.geoptx=parseFloat(a[0],10),o.geopty=parseFloat(a[1],10)}return o.cityid=parseInt(t.cityCode||c.cityCode,10),o.poistyle=parseInt(t.cur||13,10),o.uid=t.uid||"",o.poitype=parseInt(t.poitype||0,10),o.panoGuid=t.panoGuid||"",o},converToOriginal:function(t){if(!t)return null;var o={};return o.title=t.name||"",o.content=(t.content||"").replace(/&nbsp;/g," "),o.point=t.geoptx&&t.geopty?t.geoptx+"|"+t.geopty:null,o.cityCode=t.cityid||"",o.cur=t.poistyle||13,o.uid=t.uid||"",o.poitype=t.poitype||"",o.panoGuid=t.panoGuid||"",o},formatData:function(t){if(t){for(var o=0,a=["["],e=t.length;e>o;o++){var n=T.json.stringify(t[o]);e>o+1&&(n+=","),a.push(n)}return a.push("]"),'{"data":'+a.join("")+"}"}},showError:function(t,o,a){if(1==arguments.length)return void this.showTipInfo(t);if(/\/upload/.test(t)){if(a&&a.json&&a.json.content&&a.json.content.data)for(var e=a.json.content.data,n=0,i=e.length;i>n;n++)if(e[n].status==p)return void this.showTipInfo("已达收藏数量上限");switch(o){case p:this.showTipInfo("已达收藏数量上限");break;default:return void this.showTipInfo("操作失败")}}},showTipInfo:function(t,o,a,e){var a=a||"favBtn",o=o||"J_favInfo",e=e||"",i="",r=this,c=function(){T.rc(T.G(o),"hide"),r.favTime=setTimeout(function(){T.ac(T.G(o),"hide")},2e3)};T.g(o)?(T.g(o).innerHTML='<div class="jct"><div class="j"></div></div><div class="jext">'+t+"</div>",T.g(o).className=e,c()):(6==T.browser.ie&&(n.beforeEndHTML(T.G(a),'<div id="'+o+'_width" style="position:absolute;top:-1000px;"><div class="jct"><div class="j"></div></div><div class="jext">'+t+"</div></div>"),i='style="width:'+T.g(o+"_width").clientWidth+'px"'),n.beforeEndHTML(T.G(a),'<div id="'+o+'" class="'+e+'" '+i+'><div class="jct"><div class="j"></div></div><div class="jext">'+t+"</div></div>"),c())},_get:function(t,o){var a=this,e=(new Date).getTime(),t=t+"&v="+e;T.ajax(t,{dataType:"json",success:function(e,n){return e?(n.slow&&ErrorMonitor("fav","req_slow"+n.slow,"get",void 0,{xhr:n,type:"slow",url:t}),e&&!n.slow&&ErrorMonitor("fav","succ","",void 0,{xhr:n,type:"succ",url:t}),void(e&&e.status==f?o&&o(e):a.showError(t,e.status))):(ErrorMonitor("fav","res_null","get",void 0,{xhr:n,type:"fail",url:t}),void a.showError("数据错误"))},error:function(o){ErrorMonitor("fav","req_fail","get",void 0,{xhr:o,type:"fail",url:t}),a.showError("连接服务失败")}}),ErrorMonitor("fav","BASE")},_post:function(t,o,a){var e=this;baidu.ajax(t,{dataType:"json",method:"post",data:n.jsonToQuery(o),success:function(o,n){if(o=o||{},o.status==f)try{a&&a(o)}catch(i){ErrorMonitor("fav","res_error",t,void 0,{xhr:n,url:t,type:"fail"}),e.showError("执行错误")}else e.showError(t,o.status,{json:o})},error:function(o){ErrorMonitor("fav","res_error",t,void 0,{xhr:o,url:t,type:"fail"}),e.showError("连接服务失败")}})},goFav:function(t){this.checkFav(this.goFavFun,this,t)},goFavFun:function(t){var o,a=this,e=0,n=function(){var t="已从收藏夹中删除",n=o&&T.g("poifav_"+o);if(!e){n&&(T.ac(n,"poi-fav-selected"),n.title="取消收藏");var i=T.G("JiwFav");i&&(T.rc(i,"fav"),T.ac(i,"has_fav"),i.title="取消收藏"),t="成功添加到收藏夹"}a.showTipInfo(t)};if(t){o=t.uid;var i={fav:1,cityCode:t.cityCode,content:t.content,point:t.point,title:t.title,cur:t.cur,uid:t.uid,panoGuid:t.panoGuid||""},r=a.checkInFav({from:"poi",json:i});-1==r?a.addFav(i,n,this):(e=1,a.deleteFavByIndex(r,n,this))}},deleteFavByIndex:function(t,o,a){var e=this,n="",i=e.favCloudData[t],r=i.id,c=Array.prototype.slice.call(arguments,3);r&&(n=i.data.uid,i.action=2,e.upload(i,function(){var i=T.G("JiwFav");i&&(T.rc(i,"has_fav"),T.ac(i,"fav"),i.title="加入收藏夹");var s=n&&T.g("poifav_"+n);s&&(T.rc(s,"poi-fav-selected"),s.title="加入收藏夹"),e.favCloudData.splice(t,1),window.FavInst&&window.FavInst.goPage(window.FavInst.currentPageIndex),g[r]&&map.removeOverlay(g[r]),o&&o.apply(a,c)}))},addFav:function(t,o,a){var e=this,t=this.converToGe(t),n={action:0,data:t,type:0},i=Array.prototype.slice.call(arguments,3);addStat("http://webmap1.map.bdstatic.com/newmap/static/common/widget/ui/SyncMgr/oldfav.poi.add","click"),this.upload(n,function(t){n.id=t.content.data[0].id,e.favCloudData.unshift(n),window.FavInst&&window.FavInst.goPage(),o&&o.apply(a,i)})},checkFav:function(t,o){function a(){1==i.userState.isOnline?t&&t.apply(o||window,n):0==i.userState.isOnline&&(i.login(),window.FavInst&&window.FavInst.showDefText())}var e=this,n=Array.prototype.slice.call(arguments,2);e.checkFavTimer&&window.clearInterval(e.checkFavTimer),i.userState?a():e.checkFavTimer=window.setInterval(function(){i.userState&&(a(),window.clearInterval(e.checkFavTimer))},100)}};window.SyncMgr=w,a.exports=w});