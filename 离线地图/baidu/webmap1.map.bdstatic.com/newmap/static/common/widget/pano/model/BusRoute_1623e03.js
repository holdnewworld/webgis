define("common:widget/pano/model/BusRoute.js",function(e){var t=e("common:widget/pano/base/service.js"),n=e("common:widget/pano/base/util.js"),a="[0,2,4,7,5,8,9,10,11]",r={transfer:"乘坐#line#,#other#在#offName#下车#offExit#",fill:function(e,t){return e.replace(/#([^#]*)#/g,function(e,n){return t[n]?t[n]:""})}},i=function(e,t){var e=n.parse2Geo(e),a=e.points.split(";");return a=t?n.each(a,function(e){var t=e.split(",");return new BMap.Point(t[0],t[1])},!0):n.each(a,function(e){var t=e.split(",");return{x:t[0],y:t[1]}},!0),1===a.length?a[0]:a},o=function(e){return 10>e?e="10米":e>10&&1e3>=e?e=10*(e/10).toFixed(0)+"米":e>1e3&&(e=(e/1e3).toFixed(1)+"公里"),e},s=function(e){var t=e.substring(e.length-1);return"站"==t?e:e+"站"},u=function(e){return e.indexOf("地铁")>-1&&e.indexOf("号线")>-1?(e=e.indexOf("环(")>-1?e.substr(0,e.indexOf("环("))+"环)":e,e=e.indexOf("环")>-1?e:e.replace(/\(.*?-(.*?)\)/,"($1")+"方向)"):(e=e.indexOf("(")>-1?e.substr(0,e.indexOf("(")):e,/^\+?[1-9][0-9]*$/.test(e)&&(e+="路")),e},c=function(e,t,a,c){var f={transfer:[]},d=e.lines,p=e.stops[0].length?e.stops[0]:e.stops,h=null,l=p[0],m=l.walk;if(m&&m.distance>0){{o(m.distance)}h={point:i(l.getOn.geo),text:"步行至"+s(l.getOn.name),name:s(l.getOn.name),distance:o(l.walk.distance)}}var g=null,x=p[p.length-1],v=x.walk;if(v&&v.distance>0){{o(v.distance)}g={uid:c.uid,point:i(x.getOn.geo),text:"步行至"+c.text,name:c.text,distance:o(x.walk.distance)}}return n.each(d,function(e){var t={steps:[],geos:[]};n.each(e,function(a,c){if("object"==typeof a){var f=u(a.name),h=a.uid;a.geo&&t.geos.push(a.geo);var l={lineName:f,other:[],point:[],poiType:1==a.type?"010A03":"010A05"};n.each(d,function(e){if(e[c]&&e[c].uid!==h){var t=u(e[c].name);l.other.push(t)}});{var m=p[c+1],g=m.getOff;m.getOn}l.point=i(g.geo);var x=s(g.name),v=m.walk,y="";v&&v.distance>0&&(y=v.sname?"("+T.trim(v.sname)+")":"");var O=p[c];c>0&&(O.getOff.name!=O.getOn.name||O.walk.distance>=25)&&t.steps.push(1==a.type&&e[c-1]&&1==e[c-1].type?{text:"站内换乘"+f,name:O.getOn.name,distance:o(v.distance),point:i(O.getOn.geo),poiType:1==a.type?"010A03":"010A05"}:{point:i(O.getOn.geo),text:"步行至"+s(O.getOn.name),name:s(O.getOn.name),distance:o(O.walk.distance),poiType:1==a.type?"010A03":"010A05"});var w=l.other.length>0?"(或 "+l.other.join(",")+"),":"";l.text=r.fill(r.transfer,{line:f,other:w,offName:x,offExit:y}),l.name=x,t.steps.push(l)}}),h&&(h.poiType=1==e[0].type?"010A03":"010A05",t.steps.unshift(h)),t.steps.unshift(a),g&&t.steps.push(g),t.steps.push(c),f.transfer.push(t)}),f},f=function(e){var t={},a=n.each([e.result.start,e.result.end],function(e,t){var n=T.isArray(e)?e[0]:e,a=n.pt.split(",");return{wd:n.wd,name:n.wd,poiType:0==t?"FF0101":"FF0102",type:t,uid:n.uid||"",text:n.wd,point:{x:a[0],y:a[1]}}},!0);return t.start=a[0],t.end=a[1],t.schemes=n.each(e.content,function(e,n){var a=c(e,n,t.start,t.end);return a},!0),t},d=function(){this._json={},this._data={},"BusTrans"http://webmap1.map.bdstatic.com/newmap/static/common/widget/pano/model/==currentComponent.name?(this._defaultSchemeIndex=currentComponent.schemeIndex,this._defaultTransferIndex=currentComponent.routeIndex[this._defaultSchemeIndex][0]):(this._defaultSchemeIndex=0,this._defaultTransferIndex=0)};return baidu.lang.inherits(d,baidu.lang.Class),T.object.extend(d.prototype,{setDefaultScheme:function(e,t){this._defaultSchemeIndex=e||0,this._defaultTransferIndex=t||0},fetch:function(e){var r=this;if(!e&&(e="BusTrans"http://webmap1.map.bdstatic.com/newmap/static/common/widget/pano/model/==currentComponent.name?currentComponent.modelQuery:null,!e))return null;var i=window.location.search;if(i&&i.indexOf("shareurl=1")>-1&&currentComponent.cinfo&&void 0===currentComponent.cinfo.trafType)try{i=n.parseUrlParam(i);var o=i.s.replace(/%u[0-9a-zA-Z]{4}/gi,function(e){return encodeURIComponent(unescape(e))}),s=decodeURIComponent(o).split("&");n.each(s,function(t){return"f"==t.split("=")[0]?(e+="&f="+a,!0):void 0})}catch(u){}return t.getComponentResultByQuery(e).then(function(e){r._json=e,r._data=f(e)})},getSchemeTransfer:function(e,a){e=e||this._defaultSchemeIndex,a=a||this._defaultTransferIndex;var r=this._data.schemes[e].transfer[a];if(r.getPanoPoints)return r;var i=n.each(r.steps,function(e){return e.uid||[e.point.x,e.point.y].join(",")},!0);return t.getPanoPoints(i,"bus").then(function(e){return n.each(e.content,function(e,t){if(e){var n=r.steps[t];for(var a in e){var i=a.toLowerCase();"name"!==i&&(n[i]=e[a])}var o=n.point;o&&(n.dir||(n.dir=90-180*Math.atan2(o.y-n.panoy,o.x-n.panox)/Math.PI),n.dir<0&&(n.dir+=360))}}),r.getPanoPoints=!0,r})},getStart:function(){return this._data.start},getEnd:function(){return this._data.end},getPoints:function(e,t){e=e||0,t=t||0;var a=this._data.schemes[e].transfer[t];if(a.points)return a.points;var r=[];return n.each(a.geos,function(e){var t=i(e,!0);r=r.concat(t)}),a.points=r,a.points}}),d});