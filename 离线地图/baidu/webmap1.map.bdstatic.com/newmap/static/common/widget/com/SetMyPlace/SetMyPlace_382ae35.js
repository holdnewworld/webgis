define("common:widget/com/SetMyPlace/SetMyPlace.js",function(require,exports,module){function SetMyPlace(e){e=e||{},T.lang.Class.call(this,e),this.cinfo=e.cinfo||{},this.dom=e.dom||{},this.smp_map=null,this.smp_mkr=null,this.smp_lab=null,this.city_code=null,this.searchRes=null,this.saveJson=null,this._lastAction="",this.render(),this.initialize()}var SmpMgr=require("common:widget/ui/setMyPlace/SetMyPlaceMgr.js"),comMgr=require("common:widget/com/componentManager.js"),config=require("common:widget/ui/config/config.js"),constant=require("common:widget/ui/constant/Constant.js"),searchData=require("common:widget/ui/searchData/searchData.js"),util=require("common:widget/ui/util/util.js"),modelConfig=config.modelConfig,SMP_CONST_TXT={ADDR_DEFAULT:"例如 “北京市海淀区上地十街10号”",ADDR_EMPTY:"请输入地址",NOTE_EMPTY:"请输入备注名",NOTE_ERROR:"不能包含特殊符号",NOTE_REPEAT:"备注名重复，请重新输入",NOTE_OVERLONG:"您最多可输入10个字",LABEL_OK:"就这里了",LABEL_INIT:"拖动此图标到准确位置"};T.lang.inherits(SetMyPlace,T.lang.Class,"SetMyPlace"),T.object.extend(SetMyPlace.prototype,{render:function(){try{var template=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="smp_wrap">    <div id="smp_tip" class="smp_tip">没有找到该地点，重新输入地址或拖动图区图标定位</div>    <ul class="smp_form">        <li>            <form id="form_smp_addr">                <label>地　址：</label>                <input type="text" tabindex="1" class="smp_txt_addr" id="smp_txt_addr" value="',"undefined"==typeof addr_value?"":addr_value,'" />                <input type="submit" id="smp_btn_search" class="iw_bt" onfocus=\'this.blur()\' onmouseover=\'this.className="iw_bt_over"\' onmouseout=\'this.className="iw_bt"\' onmousedown=\'this.className="iw_bt_down"\' onmouseup=\'this.className="iw_bt_over"\' value="搜索" />            </form>        </li>        <li>            <label>备注名：</label>            <input type="text" tabindex="2" class="smp_txt_note" maxlength="20" id="smp_txt_note" value="',"undefined"==typeof note_value?"":note_value,'" />        </li>    </ul>    <div id="smp_error" class="smp_error fail">        <span id="smp_error_txt"></span>        <a href="javascript:void(0)" id="smp_error_close" class="smp_error_close"></a>    </div>    <div id="smp_map" class="smp_map"></div>    <div class="smp_submit">        <input type="button" id="smp_btn_sure" class="iw_bt" onfocus=\'this.blur()\' onmouseover=\'this.className="iw_bt_over"\' onmouseout=\'this.className="iw_bt"\' onmousedown=\'this.className="iw_bt_down"\' onmouseup=\'this.className="iw_bt_over"\' value="确定" />&nbsp;        <input type="button" id="smp_btn_cancel" class="iw_bt" onfocus=\'this.blur()\' onmouseover=\'this.className="iw_bt_over"\' onmouseout=\'this.className="iw_bt"\' onmousedown=\'this.className="iw_bt_down"\' onmouseup=\'this.className="iw_bt_over"\' value="取消" />    </div>    <div id="myaddrShade" class="shade" style="display:none"></div>    <div id="myAddrSetOk" class="tip myAddr" style="display:none">常用地点设置成功！</div></div>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],style=".smp_wrap{position:relative;margin:10px 10px 0}.smp_tip{position:absolute;top:78px;left:70px;padding:2px 18px 2px 3px;color:#b26b47;background:#fff7e5;border:solid 1px #e6b85c;z-index:10;display:none}.smp_map{width:427px;height:184px;border:1px solid #dadada;position:relative}.smp_submit{margin-top:10px;text-align:center}.smp_form{list-style-type:none;margin-bottom:10px;z-index:10}.smp_form li{margin-bottom:5px}.smp_form label{color:#4c4c4c!important}.smp_txt_note,.smp_txt_addr{border:1px solid #B3B3B3;height:21px;line-height:20px;vertical-align:middle;padding-left:2px}.smp_txt_note{width:128px}.smp_txt_addr{width:245px;margin-right:5px}.smp_txt_addr.blank{color:#c9c9c9!important}.smp_txt_error{border-color:#e6b85c}#smp_btn_search{vertical-align:middle;margin-top:1px}#smp_btn_sure,#smp_btn_cancel,#smp_btn_search{color:#4c4c4c!important}.smp_label{color:#b26b47;background:#fff7e5;padding:2px 18px 2px 3px;border:solid 1px #e6b85c;position:relative}#smp_error{position:absolute;left:0;top:0;list-style:none;display:none;color:#b26b47;background:#fff7e5;padding:2px 25px 2px 3px;border:solid 1px #e6b85c;z-index:1}#smp_label_close{background:url(http://webmap2.map.bdstatic.com/newmap/static/common/images/addrPage_6f51ab7.png) 0 -121px no-repeat;position:absolute;right:0;top:0;width:14px;height:13px;cursor:pointer}#smp_error_close{background:url(http://webmap2.map.bdstatic.com/newmap/static/common/images/addrPage_6f51ab7.png) 0 -121px no-repeat;position:absolute;right:0;top:0;width:14px;height:13px;cursor:pointer}.map_popup .tip.myAddr{z-index:50;width:138px;padding:10px;left:120px;top:130px}";require.loadCss({content:style,name:"SetMyPlace"}),SmpMgr.component=this;var json=this.json=this.cinfo||{},note=json.note||"",addr=json.addr||SMP_CONST_TXT.ADDR_DEFAULT,templateObj={note_value:note,addr_value:addr};this.dom.innerHTML=template(templateObj)}catch(e){"undefined"!=typeof alog&&alog("http://webmap1.map.bdstatic.com/newmap/static/common/widget/com/SetMyPlace/exception.fire","catch",{msg:e.message||e.description,path:"common:widget/com/SetMyPlace/SetMyPlace.js",ln:72})}},initialize:function(){try{var e=this;T.g("smp_txt_addr").value==SMP_CONST_TXT.ADDR_DEFAULT&&T.addClass(T.g("smp_txt_addr"),"blank");var t=this.smp_map=SmpMgr.smp_map=new BMap.Map("smp_map",{coordType:BMAP_COORD_MERCATOR,zoomLevelMin:3,enableCanvas2dMap:!1});map.disableScrollWheelZoom(),t.enableLoadTiles=!0,t.enableScrollWheelZoom(),t.enableInertialDragging(),window.setTimeout(function(){e.initSmpMap(),e.bindEvent()},200)}catch(o){"undefined"!=typeof alog&&alog("http://webmap1.map.bdstatic.com/newmap/static/common/widget/com/SetMyPlace/exception.fire","catch",{msg:o.message||o.description,path:"common:widget/com/SetMyPlace/SetMyPlace.js",ln:100})}},initSmpMap:function(){var e=this,t=this.json,o=this.smp_map,i=t.point?util.getPoiPoint(t.point):map.getCenter(),s=t.level||map.getZoom();o.centerAndZoom(i,s),o.addControl(new BMap.NavigationControl({type:BMAP_NAVIGATION_CONTROL_ZOOM}));var n=new BMap.Icon(constant.A_J_MARKER_IMG,constant.A_J_MARKER_RED_SIZE,{offset:constant.A_J_MARKER_OFFSET,imageOffset:new BMap.Size(0,-116),infoWindowOffset:constant.A_J_MARKER_INFOWND_OFFSET}),a="<div class='smp_label'><span id='smp_label_content'>"+SMP_CONST_TXT.LABEL_INIT+"</span><span id='smp_label_close'></span></div>",r=new BMap.Label(a,{offset:new BMap.Size(16,-27)});r.setStyle({padding:"0",border:"none"}),r._showTipText=function(e){r.show(),T.g("smp_label_content").innerHTML=e};var p=new BMap.Marker(o.getCenter(),{icon:n,enableDragging:!0});p.addEventListener("dragstart",function(){T.G("smp_tip").style.display="none",r.hide()}),p.addEventListener("dragend",function(){r.show(),r._showTipText(SMP_CONST_TXT.LABEL_OK),e.rgcSearch(this.getPoint(),function(t){e.rgcCBK(t)})}),p.setLabel(r),o.addOverlay(p),this.smp_mkr=p,this.smp_lab=r,this.city_code=modelConfig.cityCode||1},bindEvent:function(){var e=this,t=T.g("smp_txt_note"),o=T.g("smp_txt_addr"),i=(T.g("smp_btn_search"),T.g("smp_btn_cancel")),s=T.g("smp_btn_sure"),n=(T.g("smp_label_content"),T.g("smp_label_close"));T.on(t,"change",function(){return e.checkNote(this)}),T.on(o,"change",function(){T.G("smp_tip").style.display="none"}),T.on(o,"focus",function(){window.smp_addr_timer&&window.clearTimeout(window.smp_addr_timer),this.value==SMP_CONST_TXT.ADDR_DEFAULT&&(T.removeClass(this,"blank"),this.value="")}),T.on(o,"blur",function(){var e=this;window.smp_addr_timer=window.setTimeout(function(){SmpMgr.helper.isEmpty(e.value)&&(T.addClass(e,"blank"),e.value=SMP_CONST_TXT.ADDR_DEFAULT),T.rc(e,"txt_smp_error")},50)}),T.on(T.G("form_smp_addr"),"submit",function(t){if(e.checkAddr(o)){var i=T.string.trim(o.value);e.localSearch(i,function(t){e.showSearchRes(t)})}t.preventDefault()}),s.onclick=function(){if(e.checkInfo()){e.getSaveJson(function(t){SmpMgr.storer.set(t),SmpMgr.updateOverLay(t),e._showWarn(),window.setTimeout(function(){e._hidenWarn(),SmpMgr.popup.close()},1e3)})}},n.onclick=function(){e.smp_lab.hide()},i.onclick=function(){SmpMgr.popup.close()}},checkInfo:function(){return this.checkNote(T.g("smp_txt_note"))},_showWarn:function(){T.g("myaddrShade").style.display="block",T.g("myAddrSetOk").style.display="block"},_hidenWarn:function(){T.g("myaddrShade").style.display="none",T.g("myAddrSetOk").style.display="none"},checkRepeat:function(e){if(e){var t=T.string.trim(e.value),o=SmpMgr.storer.arr,i=this.json.uid;if(!o)return!1;for(var s=0,n=o.length;n>s;s++)if(t==o[s].note&&""!=t&&i!=o[s].uid)return!0;return!1}},checkAddr:function(e){if(e){var t=T.string.trim(e.value);return this.showError(e,SmpMgr.helper.isEmpty(t),"ADDR_EMPTY")&&this.showError(e,t==SMP_CONST_TXT.ADDR_DEFAULT,"ADDR_EMPTY")}},checkNote:function(e){if(e){var t=T.string.trim(e.value);return this.showError(e,SmpMgr.helper.isEmpty(t),"NOTE_EMPTY")&&this.showError(e,SmpMgr.helper.isNotWord(t),"NOTE_ERROR")&&this.showError(e,SmpMgr.helper.isOverLong(t,20),"NOTE_OVERLONG")&&this.showError(e,this.checkRepeat(e),"NOTE_REPEAT")}},showError:function(e,t,o){var i=this,s=T.g("smp_error"),n=T.g("smp_error_txt"),a=T.g("smp_error_close");if(t){T.ac(e,"txt_smp_error"),s.style.display="block";var r=e.offsetLeft,p=e.offsetTop+26;return T.browser.ie<=7&&(r-=10),s.style.left=r+"px",s.style.top=p+"px",n.innerHTML=SMP_CONST_TXT[o]?SMP_CONST_TXT[o]:o,i._errorTimer&&window.clearTimeout(i._errorTimer),i._errorTimer=window.setTimeout(a.onclick=function(){s.style.display="none",i._errorTimer&&window.clearTimeout(i._errorTimer)},3e3),window.setTimeout(function(){e.focus()},10),!1}return s.style.display="none",T.rc(e,"txt_smp_error"),!0},getSaveJson:function(e){var t=this,o=this.json.uid,i=this.smp_mkr.getPoint(),s=T.string.trim(T.g("smp_txt_note").value),n=this.searchRes||this.json,a=this.smp_map.getZoom();s=T.string.filterFormat.escapeString(s);var r={point:i.lng+","+i.lat,uid:o||(new Date).getTime(),note:s,level:a,ccode:n.ccode||modelConfig.cityCode,name:n.name||"",addr:n.addr||""};r.addr?(e&&e(r),this.saveJson=r):this.rgcSearch(i,function(o){o.content&&o.content.address&&(r.addr=o.content.address,e&&e(r),t.saveJson=r)})},showSearchRes:function(e){var t=this,o=T.G("smp_tip");if(e&&e.name&&e.point&&e.addr){var i=util.getPoiPoint(e.point),s=e.level||16;t.smp_mkr.setPoint(i),t.smp_map.centerAndZoom(i,s),t.city_code=e.ccode,t.smp_lab._showTipText(SMP_CONST_TXT.LABEL_OK),t.searchRes=e,t._lastAction="search",o.style.display="none"}else o.style.display="block",t.smp_lab._showTipText(SMP_CONST_TXT.LABEL_INIT)},rgcSearch:function(e,t){if(e){var o=this,i="http://api.map.baidu.com/?qt=rgc&x="+e.lng+"&y="+e.lat+"&dis_poi=100&poi_num=10&ie=utf-8&oue=1&res=webmap";baidu.jsonp(i,function(e){t(e),o.rgcCBK(e)})}},rgcCBK:function(e){if(e){var t=e.content,o=T.g("smp_txt_addr");if(t&&t.address&&t.address_detail&&o){o.value=t.address,T.removeClass(o,"blank");var i=t.address_detail.city_code;this.searchRes={addr:t.address,ccode:i},this.city_code=i,this._lastAction="drag"}}},localSearch:function(e,t){var o=this,i=e,s=this.city_code||1,n=map.zoomLevel,a=util.formatBounds(map.getBounds()),r={qt:"s",src:"0",ie:"utf-8",wd:i,c:s,l:n,b:a},p="/?"+baidu.url.jsonToQuery(r,encodeURIComponent);baidu.ajax(p,{dataType:"json",success:function(e){t&&t(o.filterJson(e))},error:function(e){t&&t(e)}})},filterJson:function(e){if(e){var t=e.result,o=e.content,i=e.addrs,s="",n="",a="",r="",p=e.current_city.code||this.city_code;if(util.isActiveCity("smp",t.type))if(41==t.type&&i)s=i[0].name,a=i[0].geo,n=i[0].addr;else if(1==t.type||2==t.type)s=o.cname,a=o.geo,n=o.cname,r=o.level;else{if(!o)return;for(var l=0,c=o.length;c>l;l++){var d=o[l];if(d&&d.poiType!=constant.POI_TYPE_BUSLINE&&d.poiType!=constant.POI_TYPE_SUBLINE){s=d.name,n=d.addr,a=d.geo;break}}}return{name:s,addr:n,point:a?util.parseGeo(a).points:"",ccode:p,level:r}}},dispose:function(){this.smp_mkr=null,this.smp_lab=null,this.smp_map=null}}),module.exports=SetMyPlace});