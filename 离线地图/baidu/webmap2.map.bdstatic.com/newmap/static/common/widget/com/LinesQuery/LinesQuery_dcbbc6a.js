define("common:widget/com/LinesQuery/LinesQuery.js",function(require,exports,module){function LinesQuery(){window.LinesQueryInst=this,MapComponent.call(this),this.linesInfo=[],this.resultInfo=[],this.busStopPois=[],this.curline=null,this.sCityCode=modelConfig.cityCode,this.cn=modelConfig.cityName,this.curSelIndex=-1,this.lineType=[[0,2,3,4,5,6,7,9,10,11],[1,12,13,14],[8]],window.GRControll&&window.GRControll.clearGRMap(),Share.setSmSCode(0),this.scrollPanel=new baidu.ui.ScrollPanel({container:"busLineContent",overflow:"overflow-y",autoUpdate:!1,margin:[0,0,0,5]}),this.busPanoData=[],this.cinfo._index&&(this.linedata=this.cinfo._index.split(","))}var componentManager=require("common:widget/com/componentManager.js"),constants=require("common:widget/ui/constant/Constant.js"),mapUtil=require("common:widget/ui/mapUtil/mapUtil.js"),util=require("common:widget/ui/util/util.js"),BoxContainer=require("common:widget/ui/BoxContainer/BoxContainer.js"),BShare=require("common:widget/ui/toolShare/ToolShare.js"),MapComponent=require("common:widget/com/MapComponent.js"),searchData=require("common:widget/ui/searchData/searchData.js"),config=require("common:widget/ui/config/config.js"),modelConfig=config.modelConfig,MapConfig=config.mapConfig,setComplaintCenterURL=require("common:widget/ui/SetComplaintCenter/SetComplaintCenter.js"),PanoEntranceUtil=require("common:widget/ui/PanoEntranceUtil/PanoEntranceUtil.js"),Share=require("common:widget/ui/mapShare/MapShare.js"),mapInfoScrollPanel=require("common:widget/ui/mapInfoScroll/mapInfoScroll.js"),iknow=require("common:widget/ui/iKnow/iKnow.js");T.lang.inherits(LinesQuery,MapComponent,"LinesQuery"),T.object.extend(LinesQuery.prototype,{render:function(){try{this.sCityCode=modelConfig.cityCode;var template=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div id="busLineHead">    <div class="bus_line">公交线路查询</div>    <div class="busLineSearch">        <form onsubmit="LinesQueryInst.submit(this);return false" id="lform">            <input id="lineName" type="text" class="bus_input" name="l" maxlength="256" autocomplete="off" value="请输入要搜索的线路" onfocus="LinesQueryInst._delDefaultValue(this)">            <input value="搜索" type="submit" class="busLine_Submit" onmousedown="LinesQueryInst._btnDown(this)" onmouseup="LinesQueryInst._btnUp(this)" onmouseover="LinesQueryInst._btnOver(this)" onmouseout="LinesQueryInst._btnOut(this)">        </form>    </div></div><div class="busLineWrapper">    <div id="busLineContent" class="busLineContent">        <div id="lines_',"undefined"==typeof guid?"":guid,'" class="bus"></div>        <div id="pctomoLineId" class="pctomo_bottom2">                </div>    </div></div>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],style=".busLineSearch{padding:10px}.busLine_Submit{margin-left:5px;padding:0;_padding-top:3px;width:48px;height:25px;border:0;background:url(http://webmap2.map.bdstatic.com/newmap/static/common/images/btnState_f0c60ed.png) -144px -4px no-repeat}.busLineWrapper{padding:0 5px 0 10px}.busLineContent{width:334px;overflow:hidden}.busLineWrapper .bus a{text-decoration:none}.busLineWrapper .bus a:hover,.busLineWrapper .bus a:focus{text-decoration:underline}#busLineContent .bus-type{margin-top:5px;margin-right:5px;width:41px;height:17px;float:left;background:url(http://webmap1.map.bdstatic.com/newmap/static/common/images/bus_tp_4626a24.gif)}#busLineContent .bus-type-default{background-position:0 0}#busLineContent .bus-type-0{background-position:0 -17px}#busLineContent .bus-type-1{background-position:0 -34px}#busLineContent .bus-type-2{background-position:0 -51px}#busLineContent .bus-type-3{background-position:0 -68px}#busLineContent .bus-type-4{background-position:0 -85px}#busLineContent .buslines-more{color:#999;line-height:20px;margin-top:-2px;margin-bottom:5px;width:100%;float:left}";require.loadCss({content:style,name:"LinesQuery"});var templateObj={guid:this.guid};return template(templateObj)}catch(e){"undefined"!=typeof alog&&alog("http://webmap2.map.bdstatic.com/newmap/static/common/widget/com/LinesQuery/exception.fire","catch",{msg:e.message||e.description,path:"common:widget/com/LinesQuery/LinesQuery.js",ln:82})}},initialize:function(){try{var e=this,t=e.lineName||"";this.linedata&&this.linedata[1]&&(t=decodeURIComponent(this.linedata[1])),""!=t&&(T.G("lineName_"+e.guid).value=t,this.submit(T.G("lform"))),this.cinfo._maplevel&&this.cinfo._centerPoint&&map.centerAndZoom(e.cinfo._centerPoint,e.cinfo._maplevel),mapInfoScrollPanel.hide(),T.un(window,"onresize",e._resizeBusLineCnt),this._resizeBusLineCnt(),T.on(window,"onresize",e._resizeBusLineCnt),this.scrollPanel.render("busLineContent"),this.setCmsAds(),BoxContainer&&BoxContainer.resetStatus()}catch(n){"undefined"!=typeof alog&&alog("http://webmap2.map.bdstatic.com/newmap/static/common/widget/com/LinesQuery/exception.fire","catch",{msg:n.message||n.description,path:"common:widget/com/LinesQuery/LinesQuery.js",ln:120})}},setCmsAds:function(){var e=require("common:widget/ui/CMSUtil/cmsControl.js");baidu.g("pctomoLineId").innerHTML=e.getPc2MoStr("bus")},unload:function(){T.un(window,"onresize",this._resizeBusLineCnt),this.scrollPanel=null},open:function(e,t,n,i){function o(e){if(e&&e.content){var n=e.content[0],i=e.result;a.sCityCode=e.current_city.code,a.linesInfo[t]=n,a.resultInfo[t]=i,a.addRoutePoi(t),T.G("infos_"+t).innerHTML=a.fillInfo(t),a.setPanoEntrances(T("#infos_"+t).find(".list_street_view_poi"),t),a.scrollPanel&&a.scrollPanel.update()}}var a=this;window.searchInViewCtrl&&window.searchInViewCtrl.exit(),Share.listIndex=n+","+encodeURIComponent(i)+","+e+","+t;var s=this.curSelIndex;if(s==t&&-1==t)return void(this.curSelIndex=-1);if(this.curSelIndex=t,this.curline){mapUtil.removeRoute(this.curline),this.curline=null;for(var r=0;r<this.stopsInfo.length;r++)this.stopsInfo[r].remove(),this.stopsInfo[r]=null;this.stopsInfo.length=0}if(this.linesInfo[t])return T.G("infos_"+t)&&(T.G("infos_"+t).innerHTML=this.fillInfo(t)),this.setPanoEntrances(T("#infos_"+t).find(".list_street_view_poi"),t),this.addRoutePoi(t),void(this.scrollPanel&&this.scrollPanel.update());var n=this.sCityCode;this.linedata&&this.linedata[0]&&(n=this.linedata[0]),searchData.fetch("bsl&bsltp=2&c="+n+"&uid="+e,function(e){o(e)})},addRoutePoi:function(e){var t=this.linesInfo[e],n=t.stations;this.stopsInfo=[];for(var i=0;i<n.length;i++){var o=util.parseGeo(n[i].geo),a=mapUtil.addBusStopPoi(o.points,n[i].name);this.stopsInfo.push(a);var s={uid:n[i].uid,name:n[i].name,geo:n[i].geo};a.addEventListener("click",this.getClickMarker(e,i,s))}var o=util.parseGeo(t.geo),r=util.getBPoints([o.bound]);this.cinfo._maplevel&&this.cinfo._centerPoint?(delete this.cinfo._maplevel,delete this.cinfo._centerPoint):mapUtil.setViewport(r,10),this.curline=mapUtil.addRoute(o.points,constants.ROUTE_TYPE_BUS);for(var l=T.G("lines_"+this.guid).getElementsByTagName("dd"),u=T.G("lines_"+this.guid).getElementsByTagName("dt"),i=0;i<l.length;i++){var d=l[i],p=u[i];e==i?(p.className="open"==p.className?"":"open",d.style.display="block"==d.style.display?"none":"block"):(p.className="open"==p.className?"":"",d.style.display="block"==d.style.display?"none":"none")}if(!isNaN(this.cinfo._popIndex)){var i=this.cinfo._popIndex,c=n[i],s={uid:c.uid,name:c.name,geo:c.geo};this.selectBusStop(e,i,s),this.cinfo._popIndex=null}},getClickMarker:function(e,t,n){var i=this;return function(){Share.popIndex=t,i.selectBusStop(e,t,n)}},fillInfo:function(e){var t=this.linesInfo[e],n=this.resultInfo[e],i=t.stations,o=(0==t.isMonTicket?"否":"是",t.kind),a={8:"普通公交",9:"轨道交通",10:"机场专线",11:"旅游线路",12:"轮渡"},s=[];if(this.curBslUid=t.uid,this.curStops=i,s.push("<table cellspacing='1' cellpadding='0' class='info'>"),t.timetable){if(s.push("<tr><th>运营时间</th><td>"),o){for(var r=0;4>=r;r++)o&Math.pow(2,r)&&s.push('<div class="bus-type bus-type-'+r+'"></div>');256==o&&s.push('<div class="bus-type bus-type-default"></div>')}s.push(t.timetable),t.timetable_ext&&s.push('<span class="buslines-more">'+t.timetable_ext+"</span>"),s.push("</td></tr>")}if(o)for(var l=8;12>=l;l++)o&Math.pow(2,l)&&s.push("<tr><th>车辆类型</th><td>"+a[l]+"</td></tr>");t.company&&s.push("<tr><th>所属公司</th><td>"+t.company+"</td></tr>"),s.push("</table>");var u=this.returnLType(n.linetype);s.push(1==u?"沿线地铁站:":"沿线公交车站:"),s.push("<table class='station' id='stations_"+e+"' cellspacing='0' cellpadding='0' class='station'>");for(var r=0;r<i.length;r++){var d=i[r];s.push("<tr id='stop_"+e+"_"+r+"'>"),s.push("<th><img class='list_arrow' src='../../../../../../../webmap1.map.bdstatic.com/newmap/static/common/images/blank.gif'/*tpa=http://webmap1.map.bdstatic.com/newmap/static/common/images/blank.gif*/ />"+(r+1)+"</th>");var p='{uid:"'+d.uid+'",name:"'+d.name+'",geo:"'+d.geo+'"}';s.push("<td>"),s.push('<a data-name="'+d.name+'" data-buslineUid="'+t.uid+'" data-uid="'+d.uid+'"  data-point="'+util.parseGeo(d.geo).points+'" data-poitype="'+(1==u?"010A03":"010A05")+'" href="javascript:void(0);" class="list_street_view_poi" style="visibility:hidden"><img src="../../../images/transparent.gif"/*tpa=http://webmap2.map.bdstatic.com/newmap/static/common/images/transparent.gif*/ ></a>'),s.push("<a onclick='return Instance(\""+this.guid+'").selectBusStop('+e+","+r+","+p+")' href='javascript:void(0)'>"+d.name+"</a></td>"),s.push("</tr>")}return s.push("</table>"),s.join("")},selectBusStop:function(e,t,n){var i=this;window.searchInViewCtrl&&window.searchInViewCtrl.exit(),map.closeInfoWindow();var o=this.sCityCode;this.linedata&&this.linedata[0]&&(o=this.linedata[0]);var a=this.resultInfo[e],s=this.returnLType(a.linetype),r=1!=s?constants.POI_TYPE_BUSSTOP:constants.POI_TYPE_SUBSTOP;Share.popIndex=t;var l=this.linesInfo[e].uid;searchData.fetch("inf&it=2&uid="+n.uid+"&c="+o,function(a){if(a&&(!a||a.content)){var s="";a.content&&a.content.addr&&(s=a.content.addr,s=T.array.unique(s.split(";")).join("; "));var u="";u=a.content&&a.content.primary_uid?a.content.primary_uid:n.uid;var d=i.stopsInfo[t];util.loadSearchInfo(function(a){var p=a.createSearchInfoWnd({title:n.name,addr:s,uid:u,poiType:r},{forBusLine:!0,cityCode:o,x:d.point.lng,y:d.point.lat});if(i.busPanoData&&i.busPanoData[e]&&i.busPanoData[e][t]){var c=i.busPanoData[e][t];c.buslineUid=l,c.uid=u,p=PanoEntranceUtil.addPanoThumbnailsInInfoWnd([p],[c],i.busPanoData[e],"busline")[0]}a.openSearchInfoWnd(p,d)});for(var p=T.G("stations_"+e),c=0;c<p.rows.length;c++){var m=p.rows[c];m.className=t==c?"selected":""}}})},submit:function(e){function t(e){if(e){var t=e.result,a=(t.error,t.total);if(o.json=e,o.sCityCode=e.current_city.code,BShare.getMInfo=function(){var t="";if(a&&0!=a){var n=o.curSelIndex&&-1!=o.curSelIndex?o.curSelIndex:0;t=e.content[n].name}return{text:t,className:o._className}},o.curSelIndex=-1,o.curline){mapUtil.removeRoute(o.curline),o.curline=null;for(var s=0;s<o.stopsInfo.length;s++)o.stopsInfo[s].remove(),o.stopsInfo[s]=null;o.stopsInfo.length=0}if(0>=a){var r=["<p>在<strong>"+o.cn+"</strong>未找到相关线路，抱歉。</p>","<p>您可更换关键词再次尝试。</p>",iknow.getIknowCode("想知道: "+o.cn+" "+n+"公交线路的信息？"),"<div id='route_tips' class='route_tips'>百度提醒您：缺少公交线路？请到<a id='mapComplaintCenter' target='_blank'  href='http://tousu.baidu.com/map/add'>百度地图投诉中心</a>反馈。</div>"];return T.G("lines_"+o.guid).innerHTML=r.join(""),setComplaintCenterURL(map,o),void(o.scrollPanel&&o.scrollPanel.update())}var l=e.content;if(l){Share.listIndex=i+","+encodeURIComponent(n),o.linesInfo=[];for(var u=[],s=(util.getParam(location.href),0);s<l.length;s++){var d=l[s];u.push("<dl>"),u.push("<dt>"),u.push("<span onClick=\"LinesQueryInst.open('"+d.uid+"',"+s+",'"+i+"','"+n+'\')">&nbsp;</span><a href="javascript:void(0)" onClick="LinesQueryInst.open(\''+d.uid+"',"+s+",'"+i+"','"+n+"');return false;\">"+d.name+"</a>"),u.push('</dt><dd id="infos_'+s+'" class="ins">'),u.push("</dd>"),u.push("</dl>"),this.cinfo&&this.cinfo.sms&&this.cinfo.sms==d.uid&&(sms.ready("",d.uid,d.poiType,o.sCityCode),Share.setSmSCode(d.uid))}T.G("lines_"+o.guid).innerHTML=u.join("")+"<div id='route_tips' class='route_tips' style='margin-top:10px'>百度提醒您：以上线路仅供参考，如有问题请到<a id='mapComplaintCenter' target='_blank' href='http://tousu.baidu.com/map/add'>百度地图投诉中心</a>反馈。</div>",1==a&&o.open(l[0].uid,0,i,n),o.linedata&&o.linedata[2]&&o.linedata[3]&&(o.open(o.linedata[2],parseInt(o.linedata[3]),o.linedata[0],parseInt(o.linedata[1])),delete o.linedata),setComplaintCenterURL(map,o),o.scrollPanel&&o.scrollPanel.update()}}}var n=T.trim(e.l.value);if(""==n||"请输入要搜索的线路"==n)return e.l.focus(),!1;var i=this.sCityCode;this.linedata&&this.linedata[0]&&(i=this.linedata[0]),searchData.fetch("bl&c="+encodeURIComponent(i)+"&wd="+encodeURIComponent(n),t);var o=this},loadData:function(e){if(e){var t=e.split("&"),n=t[0].split("=");this.sCityCode=decodeURIComponent(n[1])||this.sCityCode;var n=t[1].split("="),i=decodeURIComponent(n[1])||"";this.lineName=i}},returnLType:function(e){var t=this.lineType.length;for(i=0;t>i;i++){var n=this.lineType[i];for(j=0;j<n.length;j++){var o=n[j];if(o==e)return i}}},_delDefaultValue:function(e){"请输入要搜索的线路"==e.value&&(e.value="",e.style.color="black")},_btnDown:function(e){e.style.backgroundPosition="-144px -68px"},_btnUp:function(e){e.style.backgroundPosition="-144px -36px"},_btnOver:function(e){e.style.backgroundPosition="-144px -36px"},_btnOut:function(e){e.style.backgroundPosition="-144px -4px"},_resizeBusLineCnt:function(){var e=util.getClientSize(),t=e.height,n=T.G("busLineContent"),i=T.G("busLineHead").offsetHeight,o=t-i-124-32-5;o>0&&(n.style.height=o+"px"),mapInfoScrollPanel.update();var a=window.LinesQueryInst;a.scrollPanel&&a.scrollPanel.update()},setPanoEntrances:function(e,t){for(var n=[],i=this,o=0;o<e.length;o++)n.push({mercatorLnglat:e[o].getAttribute("data-point"),poiType:e[o].getAttribute("data-poitype"),name:e[o].getAttribute("data-name")});PanoEntranceUtil.insertPanoInfoInSearch(n,"busline",function(n){i.busPanoData[t]=n,PanoEntranceUtil.walkThroughPanoEntrances(e,n,"busline")})}}),module.exports=LinesQuery});