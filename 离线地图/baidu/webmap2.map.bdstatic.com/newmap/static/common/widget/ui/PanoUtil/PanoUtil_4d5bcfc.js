define("common:widget/ui/PanoUtil/PanoUtil.js",function(e,t,n){function i(){var e=baidu.g("StreetViewHolder"),t=e.clientWidth,n=e.clientHeight,i=map.getSize(),o=t>0?t:i.width,a=n>0?n:i.height;return{width:o,height:a}}var o=window.Pano=window.Pano||{};o.PANO_TYPE_STREET="street",o.PANO_TYPE_INDOOR="inter",o.PANO_TYPE_PARK="park",o.PanoLayoutType={DEFAULT:0,SPLIT_HORIZON:1,SPLIT_VERTICAL:2,DEFINE:3,FULL_HORIZON:4,FULL_VERTICAL:5};var a=e("common:widget/com/componentManager.js"),s=e("common:widget/ui/fullScreen/fullScreen.js"),r=e("common:widget/ui/mapShare/MapShare.js"),h=e("common:widget/ui/toolShare/ToolShare.js"),d=e("common:widget/ui/tools/tools.js"),p=e("common:widget/ui/PanoService/PanoService.js"),c=e("common:widget/ui/util/util.js"),l=e("common:widget/ui/config/config.js"),v=l.modelConfig,u=l.urlConfig,m=function(t,n){var l={curCity:"",curCode:1,panoMarker:null,panoLoad:!1,panoView:null,stOverFrame:null,panoType:"",panoId:"",innerId:"",heading:"",pitch:"",panoPt:null,isOpen:!1,panoOverView:null,indoorOverView:null,stExitMarker:null,from:"",panoPOI:null,pname:"",paddr:"",level:16,poiUid:"",hasPanoEvents:!1,hasOverEvents:!1,showPano:function(e){e=e||{},this.isOpen=!0,this.setData(e),this.panoView?this._setPano():this._showPano(),t.PanoMap&&t.PanoMap.isOpen&&t.PanoMap.hide()},closePano:function(e,n){t.streetViewTool&&t.streetViewTool.isOpen&&!n&&t.streetViewTool.resetStatus(),this.removePanoEvents(),this.removeOverEvents(),this.panoView&&this.panoView.hide(),this.stOverFrame&&this.stOverFrame.hide(),this.panoOverView&&this.panoOverView.removeEvents(),this.indoorOverView&&this.indoorOverView.removeEvents(),this._closeInfoWindow(),this.setTools(!1),this._reset(),baidu.g("messagebox").style.display="none",e&&"tool"==e&&t.streetViewTool&&t.streetViewTool.setStatus()},setData:function(e){this.panoSize=e.size||i(),this.panoId=e.panoId,this.innerId=e.innerId,this.panoType=e.panoType||o.PANO_TYPE_STREET,(e.heading||0===e.heading)&&(this.heading=e.heading),(e.pitch||0===e.pitch)&&(this.pitch=e.pitch),this.from=e.from||"",this.panoPOI=e.poi||{},this.panoPt=e.point||this.panoPt,this.pname=this.panoPOI.name||"",this.paddr=e.addr||"",this.poiUid=e.poiUid,e.poi&&(e.markers=[],e.markers.push(e.poi)),this.panoMarkers=e.markers||[],this.curCity=e.cityname||v.cityName,this.curCode=v.cityCode},hide:function(){this.closePano()},clearStatus:function(){t.streetViewTool&&t.streetViewTool.resetStatus()},createOverFrame:function(e){this.stOverFrame||(this.stOverFrame=new e("StreetOverViewHolder",{mapHolder:"MapHolder",panoHolder:"StreetViewHolder"}))},showOverview:function(t){var i=this;e.async(["common:widget/ui/StreetOverViewFrame/StreetOverViewFrame.js","common:widget/ui/StreetOverView/StreetOverView.js"],function(e,o){i.createOverFrame(e),i.bindOverEvents(),i.panoOverView=new o({dom:i.stOverFrame.contentContainer,panoView:i.panoView,overFrame:i.stOverFrame,mapContainer:i.stOverFrame.contentContainer,point:t,level:i.level||n.getZoom()}),i.stOverFrame.show()})},showIndoorView:function(t){var n=this;e.async(["common:widget/ui/StreetOverViewFrame/StreetOverViewFrame.js","common:widget/ui/IndoorView/IndoorView.js"],function(e,i){n.createOverFrame(e),n.panoOverView&&n.panoOverView.removeEvents(),n.bindOverEvents(),n.indoorOverView=new i({dom:n.stOverFrame.contentContainer,panoView:n.panoView,overFrame:n.stOverFrame,mapContainer:n.stOverFrame.contentContainer,indoorData:t}),n.stOverFrame.show(),t.hasImage||n.stOverFrame.setVisible(!1)})},addFlashMarkers:function(e){this.panoView.addFlashMarkers(e)},clearMarkers:function(){this.panoView.clearMarkers()},bindPanoEvents:function(){if(!this.hasPanoEvents){var e=this,n=this.guid,i=this.panoView,o=s;i.addEventListener("onLoad",function(t){e._setLoaded(t),i.removeEventListener("onLoad",n+"_onLoad")},n+"_onLoad"),i.addEventListener("onError",function(t){e._showErrInf(t)},n+"_onError"),i.addEventListener("onVisibleChange",function(t){e._setVisible(t)},n+"_onVisibleChange"),i.addEventListener("onPanoChanged",function(t){e._setPanoInfo(t)},n+"_onPanoChanged"),i.addEventListener("onPovChanged",function(t){e._setPanoPov(t)},n+"_onPovChanged"),i.addEventListener("onPOIClick",function(t){e._showPOIInf(t)},n+"_onPOIClick"),i.addEventListener("onEnterIndoor",function(t){e._enterIndoor(t)},n+"_onEnterIndoor"),i.addEventListener("onExitIndoor",function(t){e._exitIndoor(t)},n+"_onExitIndoor"),o.addEventListener("onFullScreen",function(){addStat(STAT_CODE.STAT_STREETVIEW,{item:e.panoType,func:"fullscreen"})},n+"_onFullScreen"),baidu(t).resize(function(){setTimeout(function(){e.resizeWindow()},50)}),this.hasPanoEvents=!0}},removePanoEvents:function(){var e=this.panoView,t=this.guid,n=s;e&&(e.removeEventListener("onError",t+"_onError"),e.removeEventListener("onVisibleChange",t+"_onVisibleChange"),e.removeEventListener("onPanoChanged",t+"_onPanoChanged"),e.removeEventListener("onPovChanged",t+"_onPovChanged"),e.removeEventListener("onPOIClick",t+"_onPOIClick"),e.removeEventListener("onEnterIndoor",t+"_onEnterIndoor"),e.removeEventListener("onExitIndoor",t+"_onExitIndoor")),n.removeEventListener("onFullScreen",t+"_onFullScreen"),this.hasPanoEvents=!1},bindOverEvents:function(){if(!this.hasOverEvents){var e=this,t=this.guid,n=this.stOverFrame;n.addEventListener("onVisibleChange",function(t){e.setPanoSize(t),0==t.visible&&addStat(STAT_CODE.STAT_STREETVIEW,{item:e.panoType,catalog:"overview",func:"hide"})},t+"_onVisibleChange"),n.addEventListener("onRetDefault",function(t){e.setPanoSize(t)},t+"_onRetDefault"),n.addEventListener("onEnterFull",function(t){e.setPanoSize(t)},t+"_onRetDefault"),n.addEventListener("onWindowResize",function(t){e.setPanoSize(t)},t+"_onWindowResize"),n.addEventListener("onAbsorb",function(t){e.setPanoSize(t),addStat(STAT_CODE.STAT_STREETVIEW,{item:e.panoType,catalog:"overview",func:"absorb"})},t+"_onAbsorb"),n.addEventListener("onHolderResize",function(t){e.setPanoSize(t)},t+"_onHolderResize"),this.hasOverEvents=!0}},removeOverEvents:function(){var e=this.stOverFrame,t=this.guid;e&&(e.removeEventListener("onEnterFull",t+"_onRetDefault"),e.removeEventListener("onRetDefault",t+"_onRetDefault"),e.removeEventListener("onWindowResize",t+"_onWindowResize"),e.removeEventListener("onAbsorb",t+"_onAbsorb"),e.removeEventListener("onVisibleChange",t+"_onVisibleChange"),e.removeEventListener("onHolderResize",t+"_onHolderResize")),this.hasOverEvents=!1},setPanoSize:function(e){var t=this.panoView,i=this.stOverFrame,a=o.PanoLayoutType,s=e.size,r=e.layout||i.layoutType,h=n.getSize(),d=h.width,p=h.height,c=T.g("StreetOverViewHolder"),l="hidden"===c.style.visibility?!1:!0;switch(r){case a.SPLIT_HORIZON:case a.FULL_HORIZON:p=0==e.visible?h.height:p-s.height,l||(p=h.height);break;case a.SPLIT_VERTICAL:case a.FULL_VERTICAL:d=0==e.visible?h.width:d-s.width,l||(d=h.width)}t.setSize({width:d,height:p})},_showPano:function(){var t=this;e.async("common:widget/ui/StreetView/StreetView.js",function(e){t.panoView=new e("StreetViewHolder",{panoId:t.panoId,innerId:t.innerId,panoType:t.panoType,heading:t.heading,pitch:t.pitch,size:t.panoSize,poiUid:t.poiUid}),t.setStatus()})},_setPano:function(){this.panoPt=this.panoPt||{},this.panoView.setPano(this.panoId,{panoType:this.panoType,heading:this.heading,pitch:this.pitch,size:this.panoSize,x:this.panoPt.lng,y:this.panoPt.lat,poiUid:this.poiUid}),this.clearMarkers(),this.addFlashMarkers(this.panoMarkers),this.setStatus()},setStatus:function(){this.bindPanoEvents(),this.panoView.show(),this._setShareParam(),T.un("tool_street_view_share","click",this.shareTool),T.un("tool_panoClose","click",this.closeTool),T.on("tool_street_view_share","click",this.shareTool),T.on("tool_panoClose","click",this.closeTool)},_reset:function(){this.panoType=o.PANO_TYPE_STREET,this.panoId="",this.innerId="",this.heading="",this.pitch="",this.panoPt=null,this.isOpen=!1,this.panoOverView=null,this.indoorOverView=null,this.from="",this.panoMarkers=[],this.pname="",this.paddr="",this._setShareParam(),T.un("tool_street_view_share","click",this.shareTool),T.un("tool_panoClose","click",this.closeTool)},_setLoaded:function(){this.panoLoad=!0,this.addFlashMarkers(this.panoMarkers)},_setVisible:function(e){var t=e.visible;this.setTools(t),t&&this.panoType==o.PANO_TYPE_STREET&&this.showOverview(this.panoPt)},_setPanoInfo:function(e){var t=e.pano;this.panoType=t.panoType||this.panoType,this.panoId=this.panoType==o.PANO_TYPE_STREET?t.panoid:this.panoId,this.innerId=this.panoType==o.PANO_TYPE_STREET?"":t.panoid,this.heading=t.heading,this.pitch=t.pitch,this.paddr=t.rname||"",this.panoPt=new BMap.Point(t.x,t.y),this._setShareParam(),this._closeInfoWindow(),addStat(STAT_CODE.STAT_STREETVIEW,{item:this.panoType,func:"enter",cityname:this.curCity})},_setPanoPov:function(e){var t=e.pov;this.panoType=t.panoType||this.panoType,this.heading=t.heading,this.pitch=t.pitch,this._setShareParam(),this._closeInfoWindow()},_enterIndoor:function(e){var t=e.data;t&&(this.panoType=o.PANO_TYPE_INDOOR,this.panoId=t.innerId,this.poiUid=t.poiuid,this.panoPt=new BMap.Point(t.x,t.y),this.showIndoorView(t),this._setShareParam(),this._closeInfoWindow(),this._showScenicTheme(this.poiUid))},_showScenicTheme:function(e){function t(e){var t={show:0,baseBlock:0,detailBlock:0};return e&&e.name?(e.entrance_price&&e.shop_hours&&(t.baseBlock=1),(e.sug_time||e.best_time)&&(t.detailBlock=1),(t.baseBlock||t.detailBlock)&&(t.show=1),t):t}var n=this;baidu.ajax("/?qt=panoScenic&uid="+e+"&ie=utf-8&t="+(new Date).getTime(),{dataType:"json",success:function(e){if(e&&e.content){var i=t(e.content);i.show&&a.load("PanoScenicTheme",{dom:T("#PanoramaTheme"),cinfo:{themeData:e.content,baseBlock:i.baseBlock,detailBlock:i.detailBlock,panoramaFlashInteractive:n.panoView}})}},error:function(){}})},_exitIndoor:function(e){if(e&&e.data){var t=e.data,n=new BMap.Point(t.x,t.y);this.panoPt=n,this.panoType=o.PANO_TYPE_STREET,this.panoId=t.pid,this.innerId="",this.showOverview(n),this._setShareParam()}},_setShareParam:function(){var e=r,t=h,n=this.curCity+this.pname,i=this.paddr,o=this.panoId,a=o?this.panoType:"",s="",d="";"inter"==a?(s=this.innerId,d=this.panoId,e.setParam("pid",s),e.setParam("iid",d)):(s=this.panoId,e.setParam("pid",s),e.setParam("iid","")),e.setParam("panoid",o),e.setParam("panotype",a),e.setParam("heading",this.heading+""),e.setParam("pitch",this.pitch+""),t.setShareText({sname:n,saddr:i})},_showPOIInf:function(t){var n=this,i=t.data;e.async("common:widget/ui/PanoInfoUtil/PanoInfoUtil.js",function(e){e.show({panoView:n.panoView,data:i})})},_closeInfoWindow:function(){e.async("common:widget/ui/PanoInfoUtil/PanoInfoUtil.js",function(e){e.close()})},setTools:function(e){var n=T.g("tool_event"),i=T.g("tool_sehInView"),o=T.g("tool_traffic"),a=T.g("tool_tollCon"),s=T.g("tool_fullScr"),r=T.g("tool_pano_share"),h=T.g("tool_street_view_share"),p=T.g("tool_panoClose");1==e?(h.style.display="block",p.style.display="block",s.style.display="block",n.style.display="none",i.style.display="none",o.style.display="none",a.style.display="none",r.style.display="none",t.trafficCtrl&&t.trafficCtrl.close(),t.searchInViewCtrl&&t.searchInViewCtrl.exit(),t.captureCtrl&&t.captureCtrl.endCapture(),t.MapSignInst&&t.MapSignInst.exituserSign()):(h.style.display="none",p.style.display="none",i.style.display="block",o.style.display="block",a.style.display="block"),d&&d.resetWidth()},shareTool:function(){T.rc(this,"span_focus"),h.open(this,{type:"street",from:"streetview"}),addStat(STAT_CODE.STAT_STREETVIEW,{item:m.panoType,func:"share"})},closeTool:function(){T.rc(this,"span_focus"),m.showExitMkr({point:m.panoPt,panoId:m.panoId,panoType:m.panoType,level:m.level}),m.closePano("tool")},setPOI:function(e){"poi"!=this.from&&"alamap"!=this.from||this.panoType!=o.PANO_TYPE_STREET||this.panoView.setPOI(e)},resizeWindow:function(){this.stOverFrame&&this.isOpen&&this.stOverFrame.WindowResize()},showExitMkr:function(n){if(n&&n.panoId&&n.point){var i=this,o=baidu.object.clone(n);t.panoExitMarker?(this.stExitMarker=t.panoExitMarker,this.stExitMarker.show({panoId:o.panoId,panoType:o.panoType},o.point,o.level)):e.async("common:widget/ui/StreetMarker/StreetMarker.js",function(e){i.stExitMarker=new e(o),t.panoExitMarker=i.stExitMarker}),t.panoExitMarker=this.stExitMarker}},isPanoStatus:function(){return t.streetViewTool&&t.streetViewTool.isOpen||this.isOpen?!0:!1},_showErrInf:function(t){var n=this,i="",o="";switch(t.errorType){case"IO_ERROR":i="网络异常，请重新加载!",o="error";break;case"NO_PANO":i="抱歉, 该地方没有全景";break;default:i="抱歉错误了，请重新加载!",o="error"}e.async("common:widget/ui/PanoMsgBox/PanoMsgBox.js",function(e){n.msgBox=new e({data:{info:i,funtype:o}}),n.msgBox.show()})},revert:function(e){var t=this,n=e.panoid,i=e.panotype,a=e.heading?e.heading:"",s=e.pitch?e.pitch:"",r="";i==o.PANO_TYPE_INDOOR&&e.pid&&(n=e.iid,r=e.pid),i==o.PANO_TYPE_INDOOR?baidu.ajax("/?qt=inf&ie=utf-8&uid="+n+"&t="+(new Date).getTime(),{dataType:"json",success:function(e){if(e&&e.content){var o=c.geoToPoint(e.content.geo);t.showPano({point:o,panoId:n,innerId:r,panoType:i,heading:a,pitch:s})}},error:function(){}}):i==o.PANO_TYPE_STREET&&("alamap"http://webmap2.map.bdstatic.com/newmap/static/common/widget/ui/PanoUtil/==e.from&&e.puid?this.revertFromAlamap(e):p.getStreetViewByPID(n,function(e){t.showPano({point:e.content.point,panoId:e.content.panoId,panoType:i,heading:a,pitch:s})},t))},getPanoShare3DImageUrl:function(){var e,t;e=""===this.heading?0:this.heading,t=""===this.pitch?0:this.pitch;var n=u.PANO_URL+"?qt=share",i=o.PanoInteract.getPanoramaPropertyFromFlash("id"),a={panoid:i,heading:e,pitch:t,fovy:65,width:460,height:250,watermark:"baidumap",quality:80};for(var s in a)n=n+"&"+s+"="+a[s];return n},revertFromAlamap:function(e){var t=this,n=e.puid,i=e.pword,a=(e.panoid,"alamap");baidu.ajax("/?qt=inf&ie=utf-8&uid="+n+"&t="+(new Date).getTime(),{dataType:"json",success:function(e){if(e&&e.content){{var s=e.content,r=s.addr;c.geoToPoint(s.geo)}p.getStreetViewByUid(n,function(e){if(0==e.error&&e.content){var s=e.content,h=parseFloat(s.PanoX),d=parseFloat(s.PanoY),p=new BMap.Point(h,d),c={addr:r,uid:n,index:-1,x:s.X,y:s.Y,pid:s.PID,px:h,py:d,name:s.name||"",rank:s.Rank||10,catalog:s.Catalog||"",heading:s.Dir,pitch:s.Pitch},l={point:p,panoId:s.PID,panoType:o.PANO_TYPE_STREET,heading:s.Dir,pitch:s.Pitch,from:a,poi:c};t.showPano(l,a,i),addStat(STAT_CODE.STAT_STREETVIEW,{item:o.PANO_TYPE_STREET,catalog:a,func:"alamap",query:i})}},t)}},error:function(){}})}};return l=baidu.lang.createSingle(l)}(window,map);n.exports=m});