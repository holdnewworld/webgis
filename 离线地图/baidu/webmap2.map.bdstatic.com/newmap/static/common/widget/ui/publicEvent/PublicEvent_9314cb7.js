define("common:widget/ui/publicEvent/PublicEvent.js",function(e,t,n){function i(){T.lang.Class.call(this)}var a=e("common:widget/com/componentManager.js"),s=e("common:widget/ui/config/config.js"),o=e("common:widget/ui/tools/tools.js"),r=e("common:widget/ui/PanoUtil/PanoUtil.js"),c=s.modelConfig;T.lang.inherits(i,T.lang.Class,"PublicEvent"),T.object.extend(i.prototype,{layerUrl:"../../../../../../../map.baidu.com/maps/interfaces/lbscloud/getOnlineLayers.htm"/*tpa=http://map.baidu.com/maps/interfaces/lbscloud/getOnlineLayers*/,dataUrl:"../../../../../../../map.baidu.com/maps/interfaces/lbscloud/getPoisByBounds.htm"/*tpa=http://map.baidu.com/maps/interfaces/lbscloud/getPoisByBounds*/,eventIcons:"../../../../../../../bs.baidu.com/incident-mis/incident-icon.png"/*tpa=http://bs.baidu.com/incident-mis/incident-icon.png*/,iconType:"big",bigIconZoom:14,cityId:1,cityType:2,eventLayers:null,poiData:null,layerUids:"",moveType:"",cacheData:{},eventDataIds:[],curTileId:"",markers:{},opened:!1,mapEvent:null,isInfoMove:!1,clickMkr:null,openInfData:null,init:function(e){window.isPrint||r.isOpen||(e=e||{},this.cityId=e.cityId||c.cityCode,this.cityType=e.cityType||c.cityType,this._map=map,this.bind(),this.getEventsLayers())},bind:function(){},open:function(){var e=this;this.opened||this.mapEvent||this.bindEvents(),this.opened=!0;var t=map.getZoom();t>=8?e.getEventsData():e.addOvMarker()},close:function(){this.opened=!1,this.setEventTool(!0,"show"),this.clearEvents(),this.removeMarker(),this.isInfoMove=!1,this.moveType="",map.closeInfoWindow()},toggle:function(){this.opened?this.close():this.open()},show:function(){for(var e=this,t=0;t<e.markers.length;t++){var n=e.markers[t];n.isVisible()?null:n.show()}e.ishide=!1,e.setEventTool(!0,"hide")},hide:function(){for(var e=this,t=0;t<e.markers.length;t++){var n=e.markers[t];n.isVisible()?n.hide():null}e.ishide=!0,e.setEventTool(!0,"show")},getEventsLayers:function(){var e=this,t=this.layerUrl+"?group=1";baidu.jsonp(t,function(t){e.getLayerCbk(t)})},getLayerCbk:function(e){if(e&&e.contents&&0==e.status&&e.contents.length>0){var t=this.eventLayers=e.contents;this.layerUids=this.getBoundLayers(t),this.bindEvents(),this.open()}},getBoundLayers:function(e){if(e&&!(e.length<1)){for(var t=map.getBounds(),n="",i=null,a=null,s=null,o=null,r=null,c=0,d=e.length;d>c;c++)i=e[c].bounds.split("|"),a=i[0].split(","),s=i[1].split(","),o=new BMap.Bounds(a[0],a[1],s[0],s[1]),r=t.intersects(o),r&&(n=""==n?e[c].uid:n+","+e[c].uid);return n}},bindEvents:function(){var e=this;this.mapEvent=function(t){e.moveType=t.type;var n=map.getZoom();n>=8?e.getEventsData():e.addOvMarker()},this.mapChange=function(t){var n=t.mapType;n===BMAP_TYPE_DIMENSIONAL?e.hide():e.mapEvent(t)},map.addEventListener("load",e.mapEvent),map.addEventListener("moveend",e.mapEvent),map.addEventListener("resize",e.mapEvent),map.addEventListener("zoomend",e.mapEvent),map.addEventListener("dragend",e.mapEvent),map.addEventListener("maptypechange",e.mapChange)},clearEvents:function(){var e=this;map.removeEventListener("load",e.mapEvent),map.removeEventListener("moveend",e.mapEvent),map.removeEventListener("resize",e.mapEvent),map.removeEventListener("zoomend",e.mapEvent),map.removeEventListener("dragend",e.mapEvent),map.removeEventListener("maptypechange",e.mapChange),e.mapEvent=null,e.mapChange=null},getEventsData:function(){var e=this,t=map.getBounds(),n=t.getMin(),i=t.getMax(),a=t.minX+","+t.minY+"|"+t.maxX+","+t.maxY,s=map.getZoom(),o=map.getTileId(n,s),r=map.getTileId(i,s);if(this.curTileId=o.row+"_"+o.column+"_"+r.row+"_"+r.column+"_"+s,this.cacheData&&this.cacheData[this.curTileId])this.addMarkers(this.cacheData[this.curTileId]);else{var c=this.layerUids=this.getBoundLayers(this.eventLayers);if(c){var d=this.dataUrl+"?"+baidu.url.jsonToQuery({bounds:a,ids:c,btype:"mc"},encodeURIComponent);baidu.jsonp(d,function(t){e.getDataCbk(t)})}else this.setEventTool(!1,"hide")}},getDataCbk:function(e){e&&e.contents&&e.contents.length>0?(this.cacheData[this.curTileId]=e.contents,this.addMarkers(e.contents)):this.setEventTool(!1,"hide")},setEventTool:function(e,t){var n=T.g("tool_event");r.isOpen||(n.innerHTML="show"==t?'<span class="toolBtn-cont"><span class="toolBtn-img"></span>显示突发事件</span>':'<span class="toolBtn-cont"><span class="toolBtn-img"></span>隐藏突发事件</span>',n.style.display=1==e?"block":"none"),map.getMapType()==BMAP_TYPE_DIMENSIONAL&&(n.style.display="none"),o.resetWidth()},addOvMarker:function(){if(this.removeMarker(),this.eventLayers&&!(this.eventLayers.length<1)){if(!this.opened)return void this.setEventTool(!0,"show");this.setEventTool(!0,"hide");for(var e=this,t=e.eventLayers,n=[],i=22,a=20,s=0,o=t.length;o>s;s++){var r=t[s].cpoint,c=r.split(","),d=new BMap.Point(c[0],c[1]),p=new BMap.Icon(this.eventIcons,new BMap.Size(i,a),{imageOffset:new BMap.Size(0,-20)}),l=new BMap.Marker(d,{icon:p,enableMassClear:!1});l.addEventListener("click",function(){var t=this.domElement.cpoint,n=t.split(","),i=new BMap.Point(n[0],n[1]);e.switchCity(i)}),map.addOverlay(l),l.domElement=l.domElement||{},l.domElement.title=t[s].title,l.domElement.cpoint=t[s].cpoint,n.push(l)}e.markers=n}},switchCity:function(e){var t,n=this,i=baidu.string.format("http://api.map.baidu.com/?qt=rgc&x=#{0}&y=#{1}&dis_poi=100&poi_num=10&ie=utf-8&oue=1&res=webmap",e.lng,e.lat);baidu.jsonp(i,function(i){i&&i.content&&i.content.address_detail&&(t=i.content.address_detail.city,a.go("cur&wd="+t,function(){map.setCenter(e);var t=n.getBdStr(),i=n.getBoundLayers(n.eventLayers),a=n.dataUrl+"?"+baidu.url.jsonToQuery({bounds:t,ids:i,btype:"mc"},encodeURIComponent);baidu.jsonp(a,function(e){n.getDataCbk(e)})}))})},addMarkers:function(e){var t=this,n=[];if(this.removeMarker(),!this.opened)return void this.setEventTool(!0,"show");this.setEventTool(!0,"hide");for(var i=0;i<e.length;i++){var a=this.createMkr(e[i],e);map.addOverlay(a),n.push(a)}t.markers=n;for(var i=0,s=e.length;s>i;i++)if("onmoveend"==this.moveType&&this.isInfoMove&&e[i].uid==this.openUid){var o=e[i].mercator,r=o.split(","),c=new BMap.Point(r[0],r[1]);map.openInfoWindow(this.openInfWin,c),this.isInfoMove=!1,this.moveType="";break}},removeMarker:function(){for(var e=this,t=0;t<e.markers.length;t++)map.removeOverlay(e.markers[t]);e.markers=[]},createMkr:function(e){if(e&&e.mercator){var t=e.mercator,n=t.split(","),i=new BMap.Point(n[0],n[1]),a=this.createIcon(e),s=this.creteLabel(e),o=new BMap.Marker(i,{icon:a});o.setLabel(s),o._eventData=e;var r=this.createMkrInfWin(e);return this.bindMrkEvents(r,o),o}},creteLabel:function(e){var t=new BMap.Label(e.title,{offset:new BMap.Size(20,18)});return t.setStyle({borderColor:"#acaba9",color:"#4d4a43",cursor:"pointer",padding:"2px 3px"}),t.hide(),t},createIcon:function(e){if(e.icon){var t=this,n=map.getZoom(),i="string"http://webmap2.map.bdstatic.com/newmap/static/common/widget/ui/publicEvent/==typeof e.icon?baidu.json.parse(e.icon):c,a=22,s=20,o=i.offx,r=i.offy;t.iconType="big",n<t.bigIconZoom&&(a=17,s=17,o=i.offx+i.soffx,t.iconType="small");var c=new BMap.Icon(this.eventIcons,new BMap.Size(a,s),{imageOffset:new BMap.Size(o,r),infoWindowOffset:new BMap.Size(15,0)});return c}},createMkrInfWin:function(e){var t,n,i="string"==typeof e.icon?baidu.json.parse(e.icon):i,a=i.soffx,s=i.offx+a,o=i.offy,r=e.desclink?'<a target="_blank" href="'+e.desclink+'" >详情</a>':"",c=e.desclink?baidu.string(e.title).subByte(22,"..."):baidu.string(e.title).subByte(26,"..."),d='<span class="iw_pub_evt_title" title="'+e.title+'"><em style="background-position:'+s+"px "+o+'px; "></em>'+c+r+"</span>";n=""==e.desc||"undefined"http://webmap2.map.bdstatic.com/newmap/static/common/widget/ui/publicEvent/==typeof e.desc?"":'<p class="evt_desc" >'+e.desc+"</p>",t=e.img?e.imglink?'<p class="evt_img" ><a target="_blank" href="'+e.imglink+'" ><img width="260" height="140" src="'+e.img+'"/></a></p>':'<p class="evt_img" ><img width="260" height="140" src="'+e.img+'"/></p>':"";var p='<div class="iw_pub_evt_content" >'+n+t+"</div>",l=new BMap.InfoWindow(p,{margin:[42,10,20,10],title:d,width:280,enableAutoPan:!0,enableCloseOnClick:!1});return l},bindMrkEvents:function(e,t){var n=this;t.addEventListener("mouseover",function(){this.setTop(!0),e.isOpen()||this.getLabel()&&this.getLabel().show()}),t.addEventListener("mouseout",function(){e.isOpen()||(this.getLabel()&&this.getLabel().hide(),this.setTop(!1))}),t.addEventListener("click",function(){n.clickMkr=this,n.openUid=this._eventData.uid,this.openInfoWindow(e),this.getLabel()&&this.getLabel().hide()}),e.addEventListener("open",function(){n.openInfWin=this,n.isInfoMove=!0})},clearCache:function(){this.cacheData={},this.eventDataIds=[]},getBdStr:function(){var e=map.getBounds(),t=e.minX+","+e.minY+"|"+e.maxX+","+e.maxY;return t}}),n.exports=i});